/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/actions/draft","sap/fe/core/actions/sticky","sap/fe/core/actions/operations","sap/fe/core/model/DraftModel","sap/ui/model/json/JSONModel","sap/fe/core/actions/messageHandling","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker"],function(C,d,s,o,D,J,m,P,V,a,T,B,M,b,c,L,e,f,g){"use strict";var I=false,h=false;var p={DRAFT:"Draft",STICKY:"Sticky",NON_DRAFT:"NonDraft"};function j(i){if(i&&i.getMetadata&&i.getMetadata().getName()==="sap.ui.base.Event"){i={};}return i||{};}var E=C.extend("sap.fe.core.controllerextensions.Transaction",{getProgrammingModel:function(i){var t=this,k=i.getModel(),l=i.getModel().getMetaModel().getMetaPath(i.getPath()),n;if(!this.sProgrammingModel){return D.upgradeOnDemand(k).then(function(q){if(q){t.sProgrammingModel=p.DRAFT;}else{if(k.getMetaModel().getObject(l+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=p.STICKY;}else{n=i.getModel().getMetaModel().getObject("/");for(var r in n){if(n[r].$kind==="EntitySet"){if(k.getMetaModel().getObject("/"+r+"@com.sap.vocabularies.Session.v1.StickySessionSupported")){t.sProgrammingModel=p.STICKY;return t.sProgrammingModel;}}}t.sProgrammingModel=p.NON_DRAFT;k.sUpdateGroupId="nondraft";}}return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getUIStateModel:function(){if(!this.uiModel){this.uiModel=new J({editable:"Display",busy:false,busyLocal:{},draftStatus:"Clear"});this.uiModel.setDefaultBindingMode(c.OneWay);}return this.uiModel;},setUIStateModel:function(u){this.uiModel=u;},isBusy:function(i,l){var u=this.getUIStateModel();return u.getProperty("/busy")||u.getProperty("/busyLocal/"+l);},busyHandler:function(i,l,O){var k=O?"lock":"unlock";if(i==="Global"||i==="Local"){g[k](this.getUIStateModel(),i==="Global"?"/busy":"/busyLocal/"+l);}},busyOn:function(i,l){this.busyHandler(i,l,true);},busyOff:function(i,l){this.busyHandler(i,l,false);},createDocument:function(l,k){var n,t=this,S,q,r=l.getModel(),u=r.getMetaModel(),v=u.getMetaPath(l.getPath()),N=!l.isRelative()&&(u.getObject(v+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||u.getObject(v+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction")),w;k=j(k);if(!l){return Promise.reject("Binding required for new document creation");}if(k.busyMode==="Local"){q=l.sId;}if(this.isBusy(k.busyMode,q)){return Promise.reject("Action can only be called once at a time");}S=!k.refreshList;if(!k.parentControl){k.parentControl=t.base.getView();}t.busyOn(k.busyMode,q);if(N){w=this.onCallAction(N,{contexts:l.getHeaderContext(),showActionParameterDialog:true,label:t.getText("SAPFE_ACTION_CREATE"),bindingParameters:{$$patchWithoutSideEffects:true},parentControl:k.parentControl,bIsCreateAction:true});}else{n=l.create(k.data,S,k.createAtEnd);w=n.created();var x=function(y){var z=y.getParameter("context"),A=sap.ui.getCore().getMessageManager(),F,G,H,K;if(z===n){l.detachCreateCompleted(x);if(!y.getParameter("success")){if(k.keepTransientContextOnFailed){F=n.getPath();G=A.getMessageModel().getData();K=false;for(var i=0;i<G.length;i++){if(G[0].target===F){K=true;break;}}if(!K){H=new e({message:t.getText("TRANSIENT_CONTEXT_MESSAGE"),description:t.getText("TRANSIENT_CONTEXT_DESCRIPTION"),target:F,persistent:false,type:"Error"});A.addMessages(H);n.created().then(function(){A.removeMessages(H);},function(){A.removeMessages(H);});}var O=function(y){if(y.getParameter("context")===n){t.busyOn(k.busyMode,q);}};var Q=function(y){if(y.getParameter("context")===n){t.busyOff(k.busyMode,q);m.showUnboundMessages();if(y.getParameter("success")){l.detachCreateSent(O);l.detachCreateCompleted(Q);}}};l.attachCreateSent(O);l.attachCreateCompleted(Q);m.showUnboundMessages();}else{z.created().then(undefined,function(){L.trace("transient creation context deleted");});z.delete();}}}};l.attachCreateCompleted(x);}return w.then(function(R){if(!l.isRelative()){h=true;}n=n||(R&&R.response);t.busyOff(k.busyMode,q);if(R&&R.bConsiderDocumentModified){t.handleDocumentModifications();}return m.showUnboundMessages().then(function(){return n;});}).catch(function(i){t.busyOff(k.busyMode,q);return m.showUnboundMessages().then(function(){return Promise.reject(i);});});},deleteDocument:function(v,i,l){var u=this.getUIStateModel(),r,R,k=[],n=false,q=false,t=false,w,x=this;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}var y,z={title:x.getText("OBJECT_PAGE_DELETE")};u.setProperty("/busy",true);if(i){if(!i.numberOfSelectedContexts){i=j(i);if(i.title){if(i.description){y=[i.title,i.description];z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",y);}else{z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}}else{z.text=x.getText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE");}var A=v.getBinding().getDependentBindings();var F=A&&A[0];if(F&&F.getPath()===""){var G=F.getBoundContext();if(G.getObject()){k=G;}else{k=v;}}else{k=v;}}else{z={title:x.getText("OBJECT_PAGE_DELETE")};if(i.numberOfSelectedContexts===1&&i.numberOfSelectedContexts===v.length){k=v;z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");}else if(i.numberOfSelectedContexts===1&&i.unSavedContexts.length===1){k=i.unSavedContexts;var H=k[0].getObject()["DraftAdministrativeData"]?k[0].getObject()["DraftAdministrativeData"]["LastChangedByUserDescription"]:"";y=[H];z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",y);}else if(i.numberOfSelectedContexts===i.unSavedContexts.length){k=i.unSavedContexts;z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");}else if(i.numberOfSelectedContexts===v.concat(i.unSavedContexts.concat(i.lockedContexts)).length){k=v.concat(i.unSavedContexts);z.text=k.length===1?x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR"):x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL");}else{k=v.concat(i.unSavedContexts);t=true;z.text=k.length===1?x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL"):x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR");z.nonDeletableText=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[i.numberOfSelectedContexts-v.concat(i.unSavedContexts).length,i.numberOfSelectedContexts]);}if(i.lockedContexts.length>0){q=true;z.nonDeletableText=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[i.lockedContexts.length,i.numberOfSelectedContexts]);}if(i.unSavedContexts.length>0&&i.unSavedContexts.length!==i.numberOfSelectedContexts){if((t||q)&&k.length===i.unSavedContexts.length){n=false;k=i.unSavedContexts;if(i.unSavedContexts.length===1){z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR");}else{z.text=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL");}}else{if(i.unSavedContexts.length===1){z.checkBoxText=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR");}else{z.checkBoxText=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL");}n=true;}}if(t&&q){z.nonDeletableText=x.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",[i.numberOfSelectedContexts-v.concat(i.unSavedContexts).length-i.lockedContexts.length,i.lockedContexts.length,i.numberOfSelectedContexts]);}}}var K=new V({items:[new T({text:z.nonDeletableText,visible:q||t}),new T({text:z.text}),new a({text:z.checkBoxText,selected:true,select:function(Q){var S=Q.getSource().getSelected();if(S){k=v.concat(i.unSavedContexts);w=true;}else{k=v;w=false;}},visible:n})]});var N=i.numberOfSelectedContexts?x.getText("OBJECT_PAGE_DELETE_DIALOG",[i.numberOfSelectedContexts]):x.getText("OBJECT_PAGE_DELETE");var O=new b({title:N,state:"Warning",content:[K],beginButton:new B({text:x.getText("OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){u.setProperty("/busy",true);var Q=Array.isArray(k)?k:[k];O.close();return Promise.all(Q.map(function(S){S.delete().then(function(){u.setProperty("/busy",false);if(l.getProperty("/$contexts/"+i.id+"/deleteEnabled")!=undefined){if(n===true&&w===false){l.setProperty("/$contexts/"+i.id+"/deleteEnabled",true);var U=Object.assign(l.getProperty("/$contexts/"+i.id),{});U.selectedContexts=U.selectedContexts.filter(function(W){return U.deletableContexts.indexOf(W)===-1;});U.deletableContexts=[];U.selectedContexts=[];U.numberOfSelectedContexts=U.selectedContexts.length;l.setProperty("/$contexts/"+i.id,U);}else{l.setProperty("/$contexts/"+i.id+"/deleteEnabled",false);l.setProperty("/$contexts/"+i.id+"/selectedContexts",[]);l.setProperty("/$contexts/"+i.id+"/numberOfSelectedContexts",0);}}Q.length===1?M.show(x.getText("OBJECT_PAGE_DELETE_TOAST_SINGULAR")):M.show(x.getText("OBJECT_PAGE_DELETE_TOAST_PLURAL"));m.removeBoundTransitionMessages();I=true;return m.showUnboundMessages().then(R);}).catch(function(U){u.setProperty("/busy",false);return m.showUnboundMessages().then(r);});}));}}),endButton:new B({text:x.getText("OBJECT_PAGE_CANCEL"),press:function(){u.setProperty("/busy",false);O.close();}}),afterClose:function(){O.destroy();}});O.addStyleClass("sapUiContentPadding");u.setProperty("/busy",false);O.open();return new Promise(function(Q,S){r=S;R=Q;});},editDocument:function(i){I=false;var t=this;var u=this.getUIStateModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to active document is required"));}return this.getProgrammingModel(i).then(function(k){switch(k){case p.DRAFT:t.activeContext=i;u.setProperty("/busy",true);return d.createDraftFromActiveDocument(i,{bPreserveChanges:true});case p.NON_DRAFT:return i;case p.STICKY:u.setProperty("/busy",true);return s.editDocumentInStickySession(i);}}).then(function(n){u.setProperty("/editable","Editable");u.setProperty("/busy",false);h=false;return m.showUnboundMessages().then(function(){return n;});}).catch(function(k){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(k);});});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(i,k){var t=this,u=t.getUIStateModel(),l;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject("No context exists. Pass a meaningful context");}var k=j(k),n=i,q=k.cancelButton,r=n.getModel(),v;return this.getProgrammingModel(i).then(function(w){l=w;if(w===p.DRAFT){var x=r.bindContext(n.getPath()+"/DraftAdministrativeData").getBoundContext();if(!I){u.setProperty("/busy",true);return x.requestObject().then(function(y){u.setProperty("/busy",false);I=!(y.CreationDateTime===y.LastChangeDateTime);});}}else if(w===p.NON_DRAFT){I=n.hasPendingChanges();}}).then(function(){return t._showDiscardPopover(q,I);}).then(function(){u.setProperty("/busy",true);switch(l){case p.DRAFT:return n.requestObject("HasActiveEntity").then(function(H){if(!H){if(n&&n.hasPendingChanges()){n.getBinding().resetChanges();}n.delete();return false;}else{var A=t.activeContext||r.bindContext(n.getPath()+"/SiblingEntity").getBoundContext();return A.requestCanonicalPath().then(function(w){v=w;if(A&&A.hasPendingChanges()){A.getBinding().resetChanges();}n.delete();}).then(function(){if(A.getPath()!==v){A=r.bindContext(v).getBoundContext();}return A;});}});case p.STICKY:return s.discardDocument(i).then(function(i){if(i){if(i.hasPendingChanges()){i.getBinding().resetChanges();}if(!h){i.refresh();return i;}}return false;});case p.NON_DRAFT:if(n===i&&I){i.getBinding().resetChanges();}break;}}).then(function(w){I=false;u.setProperty("/editable","Display");u.setProperty("/busy",false);m.removeBoundTransitionMessages();return m.showUnboundMessages().then(function(){return w;});}).catch(function(w){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(w);});});},saveDocument:function(i){var u=this.getUIStateModel(),k,t=this;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}u.setProperty("/busy",true);m.removeBoundTransitionMessages();return this.getProgrammingModel(i).then(function(l){switch(l){case p.DRAFT:return d.activateDocument(i);case p.STICKY:return s.activateDocument(i);case p.NON_DRAFT:k=i.getModel();k.submitBatch(k.getUpdateGroupId());return i;}}).then(function(A){I=false;u.setProperty("/editable","Display");u.setProperty("/busy",false);M.show(t.getText("OBJECT_SAVED"));return m.showUnboundMessages().then(function(){return A;});}).catch(function(l){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(l);});});},onCallAction:function(A,i){i=j(i);var u=this.getUIStateModel(),t=this,k,l,n,N;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!A){return Promise.reject("Provide name of action to be executed");}N=A.split("/")[1];A=N||A;k=N?undefined:i.contexts;if(k&&((Array.isArray(k)&&k.length)||!Array.isArray(k))){k=Array.isArray(k)?k[0]:k;l=k.getModel();}if(i.model){l=i.model;}if(!l){Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var S=t._getBindingParameters(A,k)||{},q=t._getAppComponent();if(k&&l){n=o.callBoundAction(A,i.contexts,l,{invocationGrouping:i.invocationGrouping,label:i.label,showActionParameterDialog:true,mBindingParameters:S.mBindingParameters,additionalSideEffect:S.aAdditionalPropertyPaths,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:i.parentControl||t.getView(),ownerComponent:q,bIsCreateAction:i.bIsCreateAction});}else{n=o.callActionImport(A,l,{label:i.label,showActionParameterDialog:true,bindingParameters:S.mBindingParameters,onSubmitted:function(){u.setProperty("/busy",true);},parentControl:i.parentControl||t.getView(),ownerComponent:q});}return n.then(function(r){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return r;});}).catch(function(r){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return Promise.reject(r);});});},_getBindingParameters:function(A,i){var k=i&&i.getModel().getMetaModel(),l=k&&k.getMetaContext(i.getPath()),S=l&&k.getObject(A+"@com.sap.vocabularies.Common.v1.SideEffects",l);if(!S){return;}var n={},t=S.TargetProperties||[],q=S.TargetEntities||[],r=k.getMetaPath(i.getPath()),u=[];u=u.concat(t).concat(q);t.forEach(function(v){var w=k.getObject(r+"/"+v["$PropertyPath"]+"@com.sap.vocabularies.Common.v1.Text");if(w&&w["$Path"]){u.push({"$PropertyPath":w["$Path"]});}});return{aAdditionalPropertyPaths:u,mBindingParameters:n};},_showDiscardPopover:function(i,I){var t=this;t._bContinueDiscard=false;return new Promise(function(r,k){if(!i){k("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){r();}else{k("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:t.getText("SAPFE_DRAFT_DISCARD_MESSAGE")}),new B({text:t.getText("SAPFE_DRAFT_DISCARD_BUTTON"),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){i.setEnabled(false);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{r();}});},handleDocumentModifications:function(){I=true;},_getAppComponent:function(){return f.getAppComponent(this.base.getView());},getText:function(t,i){if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}return this.oResourceBundle.getText(t,i);},override:{onBeforeRendering:function(){var t=this;var i=this.getView().getModel("sap.fe.i18n");if(i){i.getResourceBundle().then(function(k){t.oResourceBundle=k;});}}}});return E;});
