/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker"],function(M,D,J,X,a,F,m,B){"use strict";function g(C){var i,j,n;i=C.getBinding().getDependentBindings();j=i&&i[0];if(j&&j.getPath()===""){n=j.getBoundContext();if(n.getObject()){return n;}}return C;}function c(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=g(i);i=[i];}var n=j.getMetaModel(),q=n.getMetaPath(i[0].getPath())+"/"+A,r=n.createBindingContext(q+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=h(n,q);return d(A,j,r,P);}function b(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),n=i.bindContext("/"+A).getPath(),q=j.createBindingContext("/"+j.createBindingContext(n).getObject("$Action")+"/0");P.isCriticalAction=h(j,n+"/@$ui5.overload");return d(A,i,q,P);}function d(A,i,j,P){return new Promise(function(r,n){P=P||{};var q=P.actionParameters||[],t={},u,v,w=P.label,S=P.showActionParameterDialog,C=P.aContexts,I=P.bIsCreateAction,x=P.isCriticalAction;if(!j){n("Action not found");}if(S||q.length>0){q=p(j,q);if(!q||q.length===0){S=false;}}if(S){u=s;}else if(x){u=e;}t={fnOnSubmitted:P.onSubmitted,actionName:A,model:i,aActionParameters:q,ownerComponent:P.ownerComponent};if(j.getObject("$IsBound")){t.aContexts=C;t.mBindingParameters=P.mBindingParameters;t.additionalSideEffect=P.additionalSideEffect;t.bGrouped=P.invocationGrouping==="ChangeSet";t.bReturnAsArray=P.bReturnAsArray;}if(I){t.bIsCreateAction=I;}if(u){v=u(A,w,q,j,P.parentControl,t);}else{v=_(t);}return v.then(function(O){if(!O){n(O);}r(O);}).catch(function(O){n(O);});});}function e(A,i){return new Promise(function(r,j){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(n){if(n===M.Action.OK){r(true);}r(false);},title:i||R.getText("SAPFE_ACTION_CONFIRM_TITLE")});});}function s(A,j,n,q,P,r){var t=l(q,A),u=q.getModel().oModel.getMetaModel(),v=u.createBindingContext(t),w=q.getObject("$IsBound")?q.getPath().split("/@$ui5.overload/0")[0]:q.getPath().split("/0")[0],x=u.createBindingContext(w),y=Promise.resolve(),z="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(C,E){var G=X.loadTemplate(z,"fragment"),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),H=new J({$valueState:{},$valueStateText:{},$displayMode:{}}),I={handleChange:function(i,K){var L=i.getParameter("promise");y=y.then(function(){return L.then(function(V){if(!!V){H.setProperty("/$valueState/"+K,"None");H.setProperty("/$valueStateText/"+K,"");}});}).catch(function(){return Promise.resolve();});}};return a.process(G,{name:z},{bindingContexts:{action:q,actionName:x,entitySet:v},models:{action:q.getModel(),actionName:x.getModel(),entitySet:v.getModel()}}).then(function(G){return k(r.ownerComponent,n,H).then(function(){F.load({definition:G,controller:I}).then(function(K){var O;var L=new D({title:j||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[K],escapeHandler:function(W){L.close();L.destroy();C(false);},beginButton:{text:j||R.getText("SAPFE_OK"),type:"Emphasized",press:function(W){var Y=W.getSource();Y.setEnabled(false);B.lock(L);y.then(function(){var Z,i,$,a1=K.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");var b1=function(g1){var h1=[];for(i=0;i<g1.length;i++){var i1=g1[i].getFields()[0];if(i1.getProperty("required")&&i1.mBindingInfos.value.binding){h1.push(i1.mBindingInfos.value.binding.getPath());}}return h1;};var c1=b1(a1);var d1;var e1=O&&O.getParameterContext();for(i=0;i<n.length;i++){d1=n[i].$Name;$=e1.getProperty(d1);if(!$&&c1.indexOf(d1)>=0){Z=true;H.setProperty("/$valueState/"+n[i].$Name,"Error");H.setProperty("/$valueStateText/"+n[i].$Name,R.getText("SAPFE_ACTION_PARAMETER_REQUIRED"));B.unlock(L);Y.setEnabled(true);}}if(!Z){m.removeUnboundTransitionMessages();var f1;for(var i in r.aActionParameters){f1=e1.getProperty(r.aActionParameters[i].$Name);r.aActionParameters[i].value=f1;f1=undefined;}return _(r).then(function(g1){B.unlock(L);L.close();C(g1);}).catch(function(g1){B.unlock(L);Y.setEnabled(true);m.showUnboundMessages();});}});}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){L.close();m.removeUnboundTransitionMessages();C(false);}},afterClose:function(){L.destroy();}});L.setModel(q.getModel().oModel);L.setModel(H,"paramsModel");L.bindElement({path:"/",model:"paramsModel"});var N=A+"(...)";var Q=r.aContexts||[];if(!Q||!Q.length){N="/"+N;}L.bindElement({path:N});if(P){P.addDependent(L);}if(Q&&Q.length>0){L.setBindingContext(Q[0]);}O=L.getObjectBinding();var S=function(U,W){var Y;if(W===undefined&&!H.oData[U]){return;}if(Q.length>0&&W&&W.$Path){Y=Q[0].getProperty(W.$Path);for(var i=1;i<Q.length;i++){if(Q[i].getProperty(W.$Path)!==Y){return;}}}else{Y=W;}if(Y===undefined&&H.oData[U]){Y=H.oData[U];}O.setParameter(U,Y);};var T=function(U){var W=L.getModel().getMetaModel(),N=q.sPath&&q.sPath.split("/@")[0],Y=W.getObject(N),Z=Y&&Y[0]&&Y[0].$Parameter,$=Z&&Z[0]&&Z[0].$Name,a1=N+"/"+U+"@",b1=W.getObject(a1),c1=b1&&b1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];if(c1&&c1.$Path&&c1.$Path.startsWith($+"/")){c1.$Path=c1.$Path.replace($+"/","");}return c1;};var U,V;for(var i in r.aActionParameters){U=r.aActionParameters[i].$Name;V=T(U);S(U,V);}L.open();});});});});}function p(A,P){var i=f(A);P=P||[];if(P.length>0){}return i;}function f(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function h(i,P){return!!i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical");}function _(P){var C=P.aContexts||[],n=P.model,A=P.aActionParameters||[],q=P.actionName,O=P.fnOnSubmitted,I=P.bIsCreateAction,r=false,t;function u(i){return i.then(function(j){return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function v(){if(A&&A.length){r=true;for(var j=0;j<A.length;j++){if(!A[j].value){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}t.setParameter(A[j].$Name,A[j].value);}}}if(C.length){return new Promise(function(j,x){var y=P.mBindingParameters,G=P.bGrouped,R=P.bReturnAsArray,z=[],i,E,H=function(t,K,S){v();E=!G?"$auto."+K:t.getUpdateGroupId();z.push(t.execute(E));if(S&&S.pathExpressions){S.context.requestSideEffects(S.pathExpressions,E);}};for(i=0;i<C.length;i++){t=n.bindContext(q+"(...)",C[i],y);H(t,C.length<=1?null:i,{context:C[i],pathExpressions:P.additionalSideEffect});}(O||jQuery.noop)(z);Promise.all(z.map(u)).then(function(K){var L=[],N=[],Q;for(Q=0;Q<K.length;Q++){if(K[Q].status==="rejected"){L.push(K[Q].response);}if(K[Q].status==="resolved"){if(I&&r){K[Q].bConsiderDocumentModified=true;N.push(K[Q]);}else{N.push(K[Q].response);}}}if(!K||(K&&K.length===0)){x(true);}if(L.length===0){if(R){j(N);}else{j(N[0]);}}else{x({resolvedItems:N,rejectedItems:L});}});});}else{var w;t=n.bindContext("/"+q+"(...)");v();w=t.execute("actionImport");n.submitBatch("actionImport");(O||jQuery.noop)(w);return w;}}function k(A,i,P){return new Promise(function(r,j){var S=A.getComponentData().startupParameters,C=sap.ushell.Container.getService("CrossApplicationNavigation")||{};if(!C.getStartupAppState){i.map(function(n){if(S[n.$Name]){P.setProperty(n.$Name,S[n.$Name][0]);}});return r(true);}return C.getStartupAppState(A).then(function(n){var q=n.getData()||{},E=(q.selectionVariant&&q.selectionVariant.SelectOptions)||[];i.map(function(t){if(S[t.$Name]){P.setProperty("/"+t.$Name,S[t.$Name][0]);}else if(E.length>0){var u;E.some(function(v){if(v.PropertyName===t.$Name){u=v.Ranges;return true;}});if(u&&u.length===1&&u[0].Sign==="I"&&u[0].Option==="EQ"){P.setProperty("/"+t.$Name,u[0].Low);}}});return r(true);});});}function l(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var o={callBoundAction:c,callActionImport:b};return o;});
