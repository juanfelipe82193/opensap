/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataListBinding","sap/ui/model/odata/v4/Context","sap/ui/model/Filter","sap/ui/base/ManagedObject","sap/ui/model/ChangeReason","sap/ui/model/resource/ResourceModel","sap/ui/model/odata/v4/ODataContextBinding","sap/base/Log"],function(J,O,C,F,M,a,R,b,L){"use strict";var c="_$DraftModel";var A=false;var d=/( and )?\(*IsActiveEntity eq.*$/g;var p={};function s(x,K,y){var z=typeof x==="string"?x:x.getId(),P=(p[z]=p[z]||{});P[K]=y;if(A&&!x[c]){x[c]=P;}}function g(x,K){var y=typeof x==="string"?x:x.getId();return p[y]&&p[y][K];}var E={ALL:"0",UNCHANGED:"1",OWN_DRAFT:"2",LOCKED:"3",UNSAVED_CHANGES:"4"};function e(x){var y,z,B;if(!x.getObject()){y=x.getBinding().getDependentBindings();z=y&&y[0];if(z&&z.getPath()===""){B=z.getBoundContext();if(B.getObject()){return B;}}}return x;}function f(x){var y="";switch(x){case E.UNCHANGED:y="(IsActiveEntity eq true and HasDraftEntity eq false)";break;case E.OWN_DRAFT:y="(IsActiveEntity eq false)";break;case E.LOCKED:y="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser ne '')";break;case E.UNSAVED_CHANGES:y="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser eq '')";break;default:y="(IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)";break;}return y;}function h(x){var y=x.getMetaModel(),z=g(x,"aEntitySets"),B=z?Promise.resolve(z):y&&y.requestObject("/").then(function(G){var P=[];Object.keys(G).forEach(function(H){var I=G[H],K;if(I.$kind==="EntitySet"){K=y.requestObject("/"+H+"@");P.push(K.then(function(N){var Q={};Q["@"]=N;Q["@sapui.name"]=H;return Q;}));}});return Promise.all(P);});return B;}function i(x,y,z){var B=x.getModel();z=z||{$$inheritExpandSelect:false};return B.bindContext(y+"(...)",x,z);}function j(){var x=e(this);if(!x.getProperty("IsActiveEntity")){var y=i(this,arguments[0]);return y.execute().then(function(z){return z;});}else{throw new Error("The activation action cannot be executed on an active document");}}function k(x){var y=e(this);if(!y.getProperty("IsActiveEntity")){var z=i(this,arguments[0]);x=arguments[1];if(typeof x==="undefined"){x="";}z.setParameter("SideEffectsQualifier",x);return z.execute().then(function(){return z;});}else{throw new Error("The preparation action cannot be executed on an active document");}}function l(){var x=e(this);if(!x.getProperty("IsActiveEntity")){var y=i(this,arguments[0]);return y.execute().then(function(){return y;});}else{throw new Error("The validation function cannot be executed on an active document");}}function m(x){var y=e(this);if(y.getProperty("IsActiveEntity")){var z=i(this,arguments[0]);x=arguments[1];z.setParameter("PreserveChanges",x);return z.execute().then(function(B){return B;});}else{throw new Error("The edit action cannot be executed on a draft document");}}var o={"ActivationAction":j,"PreparationAction":k,"ValidationFunction":l,"EditAction":m};function n(x,y){var z=y["@"]["@com.sap.vocabularies.Common.v1.DraftRoot"]||y["@"]["@com.sap.vocabularies.Common.v1.DraftNode"];Object.keys(z).forEach(function(B){var G=z[B];if(o[B]){x["executeDraft"+B]=o[B].bind(x,G);}});}function q(x){if(g(x,"bIsDraftEnabled")===undefined){return h(x).then(function(y){var z=y.filter(function(B){var G=B["@"]||{};return(G.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftRoot")||G.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftNode"));}),I=Array.isArray(z)&&z.length>0;if(I){s(x,"aEntitySets",y);s(x,"aDraftEntitySets",z);}s(x,"bIsDraftEnabled",I);return I;});}else{return Promise.resolve(g(x,"bIsDraftEnabled"));}}function r(x,y){var z=f(x,""),B,G;if(y){B=y.match(d);if(Array.isArray(B)&&B[0]){G=B[0];y=y.replace(G,"");y=y.substr(1).slice(0,-1);}}if(y){y="("+y+") and "+z;}else{y=z;}return y;}function _(x){if(g(x,"bUpgraded")){L.warning("Model was already upgraded to DraftModel");return;}var y={},z={},B=-1,G=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),H={"editStates":[{id:E.ALL,name:G.getText("SAPFE_DRAFT_ALL_FILTER")},{id:E.UNCHANGED,name:G.getText("SAPFE_DRAFT_UNCHANGED_FILTER")},{id:E.OWN_DRAFT,name:G.getText("SAPFE_DRAFT_OWN_DRAFT_FILTER")},{id:E.LOCKED,name:G.getText("SAPFE_DRAFT_LOCKED_FILTER")},{id:E.UNSAVED_CHANGES,name:G.getText("SAPFE_DRAFT_UNSAVED_CHANGES_FILTER")}],"entitySets":{}},I,K=g(x,"aDraftEntitySets");s(x,"mListBindings",z);K.forEach(function(P){H.entitySets[P["@sapui.name"]]={editState:"0"};});I=new J(H);s(x,"oDraftAccessModel",I);x.getDraftAccessModel=v;I.attachPropertyChange(function(P){var Q=P.getParameters(),S=Q&&(Q.path.indexOf("/entitySets")===0?Q.path.split("/")[2]:false);if(S){S="/"+S;Object.keys(z).forEach(function(T){var U=z[T],V=U.mParameters,W="",X="",Y=[];if(U instanceof O&&U.getPath()===S){W=V["$filter"];V["$filter"]=r(Q.value,W);U.applyParameters(V);U.reset(sap.ui.model.ChangeReason.Filter);}});}});y.bindList=x.bindList;x.bindList=function(P,Q,S,T,U){var V=I.getObject("/entitySets"+P),W,X;if(V){var Y="";U=U||{};Y=U.$expand;if(Y){if(Y.indexOf("DraftAdministrativeData")<0){Y+=",DraftAdministrativeData";}}else{Y="DraftAdministrativeData";}U.$expand=Y;U.$filter=r(V.editState,U.$filter);}arguments[4]=U;W=y.bindList.apply(this,arguments);if(V){X=W.changeParameters;W._bDraftModelUpgrade=true;W.changeParameters=function(U){var V=I.getObject("/entitySets"+P);U.$filter=r(V.editState,U.$filter);return X.call(this,U);};z[++B]=W;W.destroy=(function(Z){return function(){delete z[Z];return O.prototype.destroy.apply(this,arguments);};})(B);y.bindProperty=y.bindProperty||x.bindProperty.bind(x);x.bindProperty=function(P,Q,U){if(P.indexOf(":$count")>-1){var Z=P.split(":$")[0];return y.bindProperty("$count",x.mNamedBindings[Z].getHeaderContext(),U);}return y.bindProperty.apply(this,arguments);};}return W;};function N(P){var Q=false,S=P.getPath();if(g(x,"bUpgraded")&&S){K.forEach(function(T){var U=!Q&&S.substring(S.indexOf("/")+1,S.indexOf("("))===T["@sapui.name"];if(U){Q=true;n(P,T);}});}return P;}y.create=C.create;C.create=function(x,P,Q,S,T){return N(y.create.apply(null,arguments));};y.createReturnValueContext=C.createReturnValueContext;C.createReturnValueContext=function(x,P,Q){return N(y.createReturnValueContext.apply(null,arguments));};y.modelDestroy=x.destroy;x.destroy=function(){delete p[this.getId()];return y.modelDestroy.apply(this,arguments);};s(x,"bUpgraded",true);return true;}function u(x){return q(x).then(function(y){if(y){return _(x);}else{throw new Error("The model is not draft enabled");}});}function t(x){return q(x).then(function(y){if(y){_(x);}return y;});}function v(){return g(this,"oDraftAccessModel");}var w={};var D={upgrade:u,upgradeOnDemand:t,isDraftModel:q,EDITSTATE:E,_getFilterForEditState:f};return D;},true);
