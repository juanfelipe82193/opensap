sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/core/cache/CacheManager","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/routing/HashChanger","sap/fe/core/controllerextensions/FlexibleColumnLayout"],function(S,a,b,M,C,R,V,c,J,L,H,F){"use strict";function d(n,i){this.name=n;this.currentPath=i||"";this.lastPath="";this.set=function(N){while(N.indexOf("../")===0){this.currentPath=this.currentPath.substr(0,this.currentPath.lastIndexOf(this.lastPath)-1);this.lastPath=this.currentPath.substr(this.currentPath.lastIndexOf("/")+1);N=N.substr(3);}if(N){this.lastPath=N;}this.currentPath+=N;L.info(this.name+" is now : "+this.currentPath);};this.get=function(){return this.currentPath;};this.delete=function(){this.currentPath="";L.info(this.name+" has been deleted");};}function e(p,m){var l=[],s="";if(m&&p){var f=p.split("/");if(F.prototype.isFclEnabled()){f.pop();}f.pop();for(var i=0;i<f.length;i++){s=s+"/"+f[i];l.push({context:m.getMetaContext(s.replace(/ *\([^)]*\) */g,"")+"/")});}}return l;}function g(p){if(p){p="/"+p;}var v=p.split("/").length-1;return v;}var T=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var f=o.scopeObject;var A=c.getOwnerComponentFor(f);var m=A.getMetaModel();var h=A.getMetadata().getComponentName()+"::"+A.getLocalId(f.getId());var E=f.getEnhanceI18n()||[];var j;if(E){j=sap.ui.require.toUrl(A.getMetadata().getComponentName());for(var i=0;i<E.length;i++){E[i]=j+"/"+E[i];}}var k=A.getMetadata().getName()+"_"+h+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:f,settings:{bundles:["sap.fe.core","sap.fe.templates"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(r){return r.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(l){return l.validateCacheKey(k);}));this.initPromise=Promise.all(s).then(function(D){var r=D[0];var l=D[1];return t.createView(r,h,l);}).then(function(l){var n=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);n.invalidateIfNeeded(l,k);});},createView:function(r,s,f){var t=this;var o=this.getContext(),m=o.settings,h=o.scopeObject,E=h.getProperty("entitySet"),A=c.getOwnerComponentFor(h),i=A.getMetaModel();var v={};v.navigation=h.getNavigation();v.links=e(H.getInstance().getHash(),i);v.viewLevel=g(H.getInstance().getHash());v.FCLLevel=0;if(h.getViewData){Object.assign(v,h.getViewData());}var D=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),j=new J(A.getManifest()),k=new J(v),l=new J({currentPath:new d(),navigationPath:new d("NavigationPath")}),n={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:E?i.createBindingContext("/"+E):null,viewData:v?k.createBindingContext("/"):null},models:{entitySet:i,"sap.fe.i18n":r,"sap.ui.mdc.metaModel":i,"sap.fe.deviceModel":D,manifest:j,viewData:k,metaPath:l}}},id:s,viewName:m.viewName,viewData:v,cache:{keys:[f]},height:"100%"};function p(q){L.error(q);n.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";n.preprocessors.xml.models["error"]=new J(q);return h.runAsOwner(function(){return V.create(n);});}return h.runAsOwner(function(){return V.create(n).catch(p).then(function(q){t.oView=q;t.oView.setModel(new M(t.oView),"$view");h.setAggregation("rootControl",t.oView);return f;});});},getView:function(){return this.oView;}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{createInstance:function(s){var t=new T(s);return t.initPromise.then(function(){return t;});}});},true);
