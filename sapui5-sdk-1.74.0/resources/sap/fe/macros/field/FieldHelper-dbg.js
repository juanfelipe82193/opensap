/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/macros/ResourceModel","sap/fe/macros/CommonHelper","sap/ui/mdc/field/FieldBase","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/base/ManagedObject","sap/base/Log","sap/base/strings/formatMessage","sap/ui/model/json/JSONModel"],function(R,C,F,A,M,L,f,J){"use strict";var I="@Org.OData.Measures.V1.ISOCurrency",U="@Org.OData.Measures.V1.Unit",a={},b=", ";a[I]={ui5Type:"sap.ui.model.type.Currency",formatOptions:"parseAsString : true"};function _(i){var m=i.getModel(),o=i.getSetting("sap.fe.macros.Field"),s=o.sideEffects;if(s){return Promise.resolve(s);}s={};return m.requestObject("/$").then(function(e){var d=function(k){return e[k]["$kind"]==="EntityType";},g=function(E,S,j){var q=(S.indexOf("#")>-1&&S.substr(S.indexOf("#")))||"",k=j.SourceProperties||[],l=j.SourceEntities||[],p=[];k.forEach(function(n){var P=n["$PropertyPath"],N=P.indexOf("/")>0?"/"+E+"/"+P.substr(0,P.lastIndexOf("/")+1)+"@sapui.name":false,r=!N?Promise.resolve(E):m.requestObject(N);P=N?P.substr(P.lastIndexOf("/")+1):P;p.push(r.then(function(O){s[O]=s[O]||[[],{}];s[O][1][P]=s[O][1][P]||[];s[O][1][P].push(E+q+((k.length===1&&"$$ImmediateRequest")||""));}));});l.forEach(function(n){var N=n["$NavigationPropertyPath"],r;if(N===""){r=Promise.resolve(E);}else{r=m.requestObject("/"+E+"/"+N+"/@sapui.name");}p.push(r.then(function(O){s[O]=s[O]||[[],{}];s[O][0].push(E+q+"$$ImmediateRequest");}));});return Promise.all(p);},h=function(E){return m.requestObject("/"+E+"@").then(function(j){var S=Object.keys(j).filter(function(k){return k.indexOf("@com.sap.vocabularies.Common.v1.SideEffects")>-1;}).map(function(k){return g(E,k,j[k]);});return Promise.all(S);});};return Promise.all(Object.keys(e).filter(d).map(h)).then(function(){o.sideEffects=s;return s;});});}var c={getFieldDisplay:function(o,d,e,D,E,s,p,g,h){var i="",j="";if(h){return c.displayMode(o,g);}else{j=C.getEditMode(o,d,e,D,E,s,p,false,undefined,undefined);if(j==="Editable"){return"Value";}else{i=c.displayMode(o,g);if(M.bindingParser(j)){if(!j.startsWith("{=")){return"{= $"+j+" === 'Editable' ? 'Value' : '"+i+"' }";}return("{= ("+j.slice(2,j.length-1).trim()+") === 'Editable' ? 'Value' : '"+i+"' }");}return i;}}},displayMode:function(p,o){var t=p["@com.sap.vocabularies.Common.v1.Text"],T=t&&((p&&p["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"])||(o&&o["@com.sap.vocabularies.UI.v1.TextArrangement"]));if(T){if(T.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return"Description";}else if(T.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return"ValueDescription";}return"DescriptionValue";}return t?"DescriptionValue":"Value";},isRequiredInFilter:function(p,d){var e,P,i=false,o,m=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}o=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(o&&o.RequiredProperties){i=o.RequiredProperties.some(function(g){return g.$PropertyPath===P;});}return i;},maxConditions:function(p,d){var e,P,o,m=-1,g=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(g,s);if(typeof p==="string"){P=p;}else{P=g.getObject(s+"@sapui.name");}o=g.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(g.getObject(e+"/"+P).$Type==="Edm.Boolean"){m=1;}else if(o&&o.FilterExpressionRestrictions&&o.FilterExpressionRestrictions.some(function(h){return h.Property.$PropertyPath===P&&h.AllowedExpression==="SingleValue";})){m=1;}return m;},buildExpressionForCriticalityIcon:function(s){if(s){var e="{= (${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Negative') || (${"+s+"} === '1') || (${"+s+"} === 1) ? 'sap-icon://status-negative' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Critical') || (${"+s+"} === '2') || (${"+s+"} === 2) ? 'sap-icon://status-critical' : "+"(${"+s+"} === 'com.sap.vocabularies.UI.v1.CriticalityType/Positive') || (${"+s+"} === '3') || (${"+s+"} === 3) ? 'sap-icon://status-positive' : "+"'sap-icon://status-inactive' }";return e;}return undefined;},buildExpressionForCriticalityColor:function(d){var s=sap.ui.core.ValueState.None;var e;var o=d.Criticality;if(o){e="'{'= ({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Negative'') || ({0} === ''1'') || ({0} === 1) ? ''"+sap.ui.core.ValueState.Error+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Critical'') || ({0} === ''2'') || ({0} === 2) ? ''"+sap.ui.core.ValueState.Warning+"'' : "+"({0} === ''com.sap.vocabularies.UI.v1.CriticalityType/Positive'') || ({0} === ''3'') || ({0} === 3) ? ''"+sap.ui.core.ValueState.Success+"'' : "+"''"+sap.ui.core.ValueState.None+"'' '}'";if(o.$Path){var g="${"+o.$Path+"}";s=f(e,g);}else if(o.$EnumMember){var h="'"+o.$EnumMember+"'";s=f(e,h);}else{L.warning("Case not supported, returning the default sap.ui.core.ValueState.None");}}else{L.warning("Case not supported, returning the default sap.ui.core.ValueState.None");}return s;},buildExpressionForTextValue:function(p,d){var m=d.context.getModel(),P=d.context.getPath(),t=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text"),T=t?A.value(t,d):undefined,e="";p=A.getNavigationPath(p);if(p.indexOf("/")>-1&&T){e="{"+p.substr(0,p.indexOf("/")+1)+T.substr(1,T.length-2)+"}";}else{e=T;}if(e){e="{ path : '"+e.substr(1,e.length-2)+"', mode : 'OneWay'}";}return e;},_buildExpressionForTextProperty:function(p,i){var m=i.context.getModel(),P=i.context.getPath(),d=P.split("/"),t=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text"),T=t?A.value(t,i):undefined,e="";if(T){e=T;T=T.substr(1,T.length-2);if(d.length>2){d.shift();d.shift();d.pop();e="{"+(d.length>0?d.join("/")+"/":"")+T+"}";}}if(e){e="{ path : '"+e.substr(1,e.length-2)+"', mode : 'OneWay'}";}return e;},getStableIdPartFromDataField:function(d,p){var P="",s="";if(d.$Type&&d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"){return C.replaceSpecialCharsInId(d.Action);}else if(d.$Type&&d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){if(typeof d.SemanticObject=="string"){s=C.replaceSpecialCharsInId(d.SemanticObject);}else if(d.SemanticObject.$Path){s=C.replaceSpecialCharsInId(d.SemanticObject.$Path);}if(typeof d.Action=="string"){s=s+"::"+C.replaceSpecialCharsInId(d.Action);}else if(d.Action&&d.Action.$Path){s=s+"::"+C.replaceSpecialCharsInId(d.Action.$Path);}return s;}else if(d.$Type&&d.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"){return C.replaceSpecialCharsInId(d.Target.$AnnotationPath);}else if(d.Value&&d.Value.$Path){return C.replaceSpecialCharsInId(d.Value.$Path);}else if(d.Value&&d.Value.$Apply&&d.Value.$Function==="odata.concat"){for(var i=0;i<d.Value.$Apply.length;i++){if(d.Value.$Apply[i].$Path){if(P){P=P+"::";}P=P+C.replaceSpecialCharsInId(d.Value.$Apply[i].$Path);}}return P;}else if(p&&p.context&&p.context.getObject("@sapui.name")){return C.replaceSpecialCharsInId(p.context.getObject("@sapui.name"));}else{L.error("Annotation Helper: Unable to create a stable ID. Please check the annotations.");}return undefined;},isNotAlwaysHidden:function(d,D){var o=D.context,i=false;if(d.Value&&d.Value.$Path){i=o.getObject("Value/$Path@com.sap.vocabularies.UI.v1.Hidden");}if(!i||i.$Path){i=o.getObject("@com.sap.vocabularies.UI.v1.Hidden");if(!i||i.$Path){i=false;}}return!i;},isSemanticKey:function(s,v){return((v&&s&&!s.every(function(k){return k["$PropertyPath"]!==v["$Path"];}))||false);},isLineItem:function(p,i){if(i.context.getPath().indexOf("@com.sap.vocabularies.UI.v1.LineItem")>-1){return true;}return false;},getRequiredForDataField:function(o,e){var E;if(e==="Display"||e==="ReadOnly"||e==="Disabled"){return false;}if(o&&e){if(e.indexOf("{")>-1){E="%"+e+" === 'Editable'";}if(o.indexOf("{")>-1){var s="%"+o+" === 7";return e==="Editable"?"{="+s+"}":"{= "+s+" && "+E+"}";}else{return e==="Editable"?o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory":o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory"&&"{= "+E+"}";}}return false;},isRequired:function(o,e){if(e==="Display"||e==="ReadOnly"||e==="Disabled"){return false;}if(o){if(M.bindingParser(o)){var E="{= %"+o+" === 7}";return E;}else{return o=="com.sap.vocabularies.Common.v1.FieldControlType/Mandatory";}}return false;},_getDraftAdministrativeDataType:function(m,e){return m.requestObject("/"+e+"/DraftAdministrativeData/");},getBindingForDraftAdminBlockInline:function(i,e){return c._getDraftAdministrativeDataType(i.getModel(),e).then(function(d){var B=[];if(d.InProcessByUserDescription){B.push("${DraftAdministrativeData/InProcessByUserDescription}");}B.push("${DraftAdministrativeData/InProcessByUser}");if(d.LastChangedByUserDescription){B.push("${DraftAdministrativeData/LastChangedByUserDescription}");}B.push("${DraftAdministrativeData/LastChangedByUser}");return"{= %{HasDraftEntity} ? ("+B.join(" || ")+") : '' }";});},getBindingForDraftAdminBlockInPopover:function(i,e){return c._getDraftAdministrativeDataType(i.getModel(),e).then(function(d){var B="{parts: [{path: 'HasDraftEntity', targetType: 'any'}, "+"{path: 'DraftAdministrativeData/InProcessByUser'}, "+"{path: 'DraftAdministrativeData/LastChangedByUser'} ";if(d.InProcessByUserDescription){B+=" ,{path: 'DraftAdministrativeData/InProcessByUserDescription'}";}if(d.LastChangedByUserDescription){B+=", {path: 'DraftAdministrativeData/LastChangedByUserDescription'}";}B+="], formatter: 'sap.fe.macros.field.FieldRuntime.formatDraftOwnerTextInPopover'}";return B;});},propertyName:function(p,i){var P;if(typeof p==="string"){P=p;}else if(p.$Path||p.$PropertyPath){var s=p.$Path?"/$Path":"/$PropertyPath";var d=i.context.getPath();P=i.context.getObject(d+s+"/$@sapui.name");}else{P=i.context.getObject("@sapui.name");}return P;},getConditionsBinding:function(d,p,e,s){var m=d.getInterface(0).getModel();if(!s){s=typeof p==="string"?p:c.propertyName(p,{context:m.createBindingContext(d.getInterface(0).getPath())});}if(s.indexOf("/")>-1){var t,S=s.split("/");for(var i=0;i<S.length-1;i++){var P=m.getObject("/"+e+"/"+S.slice(0,i+1).join("/"));if(P&&P.$kind==="NavigationProperty"&&P.$isCollection){S[i]=S[i]+"*";t=true;}}if(t){s=S.join("/");}}return"{$filters>/conditions/"+s+"}";},typeConstraints:function(p,P){var s="",m,t=p.$Type;s+=p.$Nullable!==undefined&&!p.$Nullable?"nullable: "+p.$Nullable:"";if(["Edm.Decimal","Edm.DateTimeOffset"].indexOf(t)>-1){s+=p.$Precision?(s?b:"")+"precision: "+p.$Precision:"";s+=p.$Scale?(s?b:"")+"scale: "+(p.$Scale==="variable"?"'"+p.$Scale+"'":p.$Scale):"";}else if(t==="Edm.String"){m=p.$MaxLength;if(m){s+=s?b:"";s+="maxLength: "+m;}if(P["@com.sap.vocabularies.Common.v1.IsUpperCase"]){}}return s;},value:function(p,i){var o=i.context,r=o.getObject("./$"),m=typeof p==="string"?p:p.$Name||o.getObject("./$@sapui.name"),P=o.getObject("@");return Promise.resolve().then(function(v){var s="",d="",e="",g,h,u;if(m&&P){h=P.hasOwnProperty(I)&&I;if(h){g=P[h];u=a[h];s="{"+"parts: ["+"'"+m+"','"+g.$Path+"'"+"], type: '"+u.ui5Type+"'";e+=u.formatOptions;}else{s="{path: '"+m+"'";s+=",type: '"+F.mapEdmTypes[r.$Type]+"'";}d+=(d?b:"")+c.typeConstraints(r,P);s+=d?",constraints: {"+d+"}":"";e+=["Edm.Date","Edm.DateTimeOffset"].indexOf(r.$Type)>-1?(e?b:"")+"style : 'medium'":"";s+=e?",formatOptions : {"+e+"}":"";s+="}";}else{s=A.value(p,{context:o});}return s;});},_context:function(p,i){return i;},_formatProperty:function(p,i){var o=i.context,P=o&&o.getPath(),d=P&&P.split("/"),D;if(p.$kind==="Property"){P=d.length>1&&d.join("/").substr(d[1].length+2);D={$PropertyPath:P};}else{D=p;}return A.format(D,{context:o});},constraints:function(p,i){return c.value(p,i).then(function(v){var m=v.match(/constraints:.*?({.*?})/);return(m&&m[1])||undefined;});},formatOptions:function(p,i){return c.value(p,i).then(function(v){var m=v.match(/formatOptions:.*?({.*?})/);return(m&&m[1])||undefined;});},getFieldGroupIds:function(o,p,e){if(!p){return undefined;}var i=o.getInterface(0);return _(i).then(function(s){var m=i.getModel(),P=p,n=P.indexOf("/")>0?"/"+e+"/"+P.substr(0,P.lastIndexOf("/")+1)+"@sapui.name":false,d=!n?Promise.resolve(e):m.requestObject(n),g,h;P=n?P.substr(P.lastIndexOf("/")+1):P;return d.then(function(O){g=(s[O]&&s[O][0].concat(s[O][1][P]||[]))||[];if(g.length){h=g.reduce(function(r,j){return(r&&r+","+j)||j;});}return h;});});},fieldControl:function(p,i){var m=i&&i.context.getModel();var P=i&&i.context.getPath();var o=m&&m.getObject(P+"@com.sap.vocabularies.Common.v1.FieldControl");if(o){if(o.hasOwnProperty("$EnumMember")){return o.$EnumMember;}else if(o.hasOwnProperty("$Path")){return A.value(o,{context:i.context});}}else{return undefined;}},getNavigationEntity:function(p,o){var d=(o&&o.context)||p,P=A.getNavigationPath(d.getPath())+"/",e=d.getObject(P),g=Object.keys(e),l=g.length,i=0;for(;i<l;i++){if(e[g[i]].$kind==="NavigationProperty"&&e[g[i]].$ReferentialConstraint&&e[g[i]].$ReferentialConstraint.hasOwnProperty(d.getObject().$Path)){return o?A.getNavigationBinding(g[i]):P+g[i];}}},valueHelpProperty:function(p){var s=p.getPath(),o=p.getObject()||{},P=o.$Path?s+"/$Path":s,d=P+"@",e=p.getObject(d),g;if(e){g=(e.hasOwnProperty(I)&&I)||(e.hasOwnProperty(U)&&U);if(g){P=P+g+"/$Path";}}return P;},getHiddenPathExpression:function(d,D){var o=D.context,h,p=o.getPath(),e=A.getNavigationPath(p),H,P;if(o.getObject(p+"@com.sap.vocabularies.UI.v1.Hidden")){H=o.getObject(p+"@com.sap.vocabularies.UI.v1.Hidden");}else{if(p.lastIndexOf("/")===p.length-1){P="Value/$Path@com.sap.vocabularies.UI.v1.Hidden";}else{P="/Value/$Path@com.sap.vocabularies.UI.v1.Hidden";}H=o.getObject(p+P);}if(H.$Path){if(H.$Path.indexOf("/")>0){var n=H.$Path.split("/")[0];if(o.getObject(e+"/"+n)&&!o.getObject(e+"/"+n).$isCollection){h="%{"+H.$Path+"}";}else{return true;}}else{h="%{"+H.$Path+"}";}return"{= "+h+"=== true ? false : true }";}else{return"{= "+H+"=== true ? false : true }";}},getSemanticKeyTitle:function(p,P,d){var n=R.getText("field.NEW_OBJECT");var u=R.getText("field.UNNAMED_OBJECT");var N,s;var e=function(v){N="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+n+"': $"+v+")";s="($"+v+" === '' || $"+v+" === undefined || $"+v+" === null ? '"+u+"': $"+v+")";return("{= !%{IsActiveEntity} ? !%{HasActiveEntity} ? "+N+" : "+s+" : "+s+"}");};if(p){return e(p);}else if(P){return e(P);}else{d="{"+d+"}";return e(d);}},getTooltip:function(t,v,e){var T;if(e.indexOf("Rating")!==-1){T=R.getText("table.RATING_INDICATOR_TOOLTIP",[t,v]);}else if(e.indexOf("Progress")!==-1){T=R.getText("table.PROGRESS_INDICATOR_TOOLTIP",[t,v]);}return T;},buildExpressionForProgressIndicatorPercentValue:function(v,t,u){var p="0";var e;v=v.charAt(0)==="{"?"$"+v:v;t=t.charAt(0)==="{"?"$"+t:t;var E="(({0} > 100) ? 100 : (({0} < 0) ? 0 : ({0} * 1)))";var s="(({1} > 0) ? (({0} > {1}) ? 100 : (({0} < 0) ? 0 : ({0} / {1} * 100))) : 0)";if(u){u="'"+u+"'";e="'{'= ({2} === ''%'') ? "+E+" : "+s+" '}'";p=f(e,[v,t,u]);}else{e="'{'= "+s+" '}'";p=f(e,[v,t]);}return p;},buildExpressionForProgressIndicatorDisplayValue:function(v,t,u){var d="";if(v){if(u){if(u==="%"){d=v+" %";}else if(t){d=R.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t])+" "+u;}else{d=v+" "+u;}}else if(t){d=R.getText("progressindicator.PROGRESS_INDICATOR_DISPLAY_VALUE_NO_UOM",[v,t]);}else{d=v;}}else{L.warning("Value property is mandatory, the default (empty string) will be returned");}return d;},getFieldEditModeInValueHelp:function(v,p){var P=(v&&v.Parameters)||[],e="Editable",o;if(P.length){for(var i in P){o=P[i];if(o.ValueListProperty===p){if(o.$Type.indexOf("Out")>48){return"Editable";}else if(o.$Type.indexOf("In")>48){e="ReadOnly";}}}}return e;},joinArray:function(s){return s.join(",");},getSemanticObjectsList:function(p){var d=p;var s=[];for(var k in d.getObject()){if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject")>-1&&k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping")===-1&&k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions")===-1){var e=d.getObject()[k];if(s.indexOf(e)===-1){s.push(e);}}}var S=new J(s);S.$$valueAsPromise=true;return S.createBindingContext("/");},getSemanticObjectsQualifiers:function(p){var d=p;var q=[];var e=function(i){return q.find(function(o){return o.qualifier===i;});};for(var k in d.getObject()){if(k.indexOf("com.sap.vocabularies.Common.v1.SemanticObject#")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectMapping#")>-1||k.indexOf("com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions#")>-1){var g=d.getObject()[k],h=k.split("#")[0],i=k.split("#")[1],j=e(i);if(!j){j={qualifier:i};j[h]=g;q.push(j);}else{j[h]=g;}}}q=q.filter(function(o){return!!o["@com.sap.vocabularies.Common.v1.SemanticObject"];});var Q=new J(q);Q.$$valueAsPromise=true;return Q.createBindingContext("/");}};c.getConditionsBinding.requiresIContext=true;c.buildExpressionForTextValue.requiresIContext=true;c.getRequiredForDataField.requiresIContext=true;c.getBindingForDraftAdminBlockInline.requiresIContext=true;c.getBindingForDraftAdminBlockInPopover.requiresIContext=true;c.value.requiresIContext=true;c.getFieldGroupIds.requiresIContext=true;c.fieldControl.requiresIContext=true;return c;},true);
