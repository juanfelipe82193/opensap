/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper"],function(F,X,a,b,J,C,S,c){"use strict";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1",O=Object.assign({},F),v=[],d={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};function _(p){var i=true;switch(p.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":i=false;break;default:break;}return i;}function e(p,n,k,B,m){var P=m.getObject(n+"/"+k+"@"),o,g,i,I,h,j,l,q,G=m.getObject(B+"@com.sap.vocabularies.Common.v1.Label")||m.getObject(B+"/@com.sap.vocabularies.Common.v1.Label")||"",L=P["@com.sap.vocabularies.Common.v1.Label"]||k,s=n.substr(B.length);i=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.Hidden"]);h=p.$Type&&p.$Type.indexOf("Edm.")!==0;if(i||h){return false;}I=C.getBoolAnnotationValue(P["@com.sap.vocabularies.UI.v1.HiddenFilter"]);j=C.getBoolAnnotationValue(P["@com.sap.vocabularies.Common.v1.IsDigitSequence"]);if(p.$MaxLength||p.$Precision||p.$Scale||j){l={};if(p.$MaxLength){l.maxLength=p.$MaxLength;}if(p.$Precision){l.precision=p.$Precision;}if(p.$Scale){l.scale=p.$Scale;}if(j){l.isDigitSequence=j;}}else{l=null;}g=P["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(g){o=g["$"+d[p.$Type]];}s=s+"/";if(s.indexOf("/")===0){s=s.substr(1);}s=s+k;if(B!==n){var r=n.split("/").filter(function(w){return w!="";});var t="/"+r[0];G="";for(var u=1;u<r.length;u++){t=t+"/"+r[u];G=G+(G?" > ":"")+(m.getObject(t+"@com.sap.vocabularies.Common.v1.Label")||m.getObject(t+"/@com.sap.vocabularies.Common.v1.Label")||"");}}q={name:s,path:s,groupLabel:G,group:n,label:L,tooltip:P["@com.sap.vocabularies.Common.v1.QuickInfo"]||null,hiddenFilter:I,type:p.$Type};if(l){q.constraints=l;}if(o){q.defaultFilterConditions=[{fieldPath:k,operator:"EQ",values:[o]}];}return q;}function f(E,n,B,m,l){return Promise.all([m.requestObject(E+"/"),m.requestObject(E+"@")]).then(function(r){var o=r[0],g=r[1];if(!o||l>2){return Promise.resolve([]);}var h,p,i=[],P=[],j=[],R=[],s=[],A={};var k=g["@Org.OData.Capabilities.V1.FilterRestrictions"];if(k){if(k.NonFilterableProperties){j=k.NonFilterableProperties.map(function(t){return t.$PropertyPath;});}if(k.RequiredProperties){R=k.RequiredProperties.map(function(t){return t.$PropertyPath;});}if(k.FilterExpressionRestrictions){k.FilterExpressionRestrictions.forEach(function(t){A[t.Property.$PropertyPath]=t.AllowedExpressions;});}}k=m.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(k){s=k.map(function(t){return t.$PropertyPath;});}var q;for(var K in o){q=m.getObject(n+"/"+K+"/@sapui.name");h=o[K];if(h){if(h.$kind==="Property"){if(j.indexOf(K)>=0){continue;}p=e(h,n,K,B,m);if(p!==false){p.required=R.indexOf(K)>=0;p.visible=s.indexOf(K)>=0;if(A[K]){p.filterExpression=A[K];}else{p.filterExpression="auto";}p.maxConditions=_(p)?-1:1;i.push(p);}}else if(h.$kind==="NavigationProperty"&&!h.$isCollection&&v.indexOf(q)===-1){v.push(q);P.push(f(E+"/$NavigationPropertyBinding/"+K,n+"/"+K,B,m,l+1));}}}return Promise.all(P).then(function(t){t.forEach(function(u){i=i.concat(u);});return i;});});}O.beforeAddFilterFlex=function(p,o,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),M=P.modifier,i=M.targets==="xmlTree",E;if(!m){return Promise.resolve(null);}if(i){E="/"+o.getAttributeNS(N,"entitySet");}else{E="/"+o.data("entitySet");}var s=E+"/"+p,g,h,n=p.indexOf("/")>=0?p.substring(0,p.lastIndexOf("/")):"";h=n?S.generate([M.getId(o),"FF",n]):S.generate([M.getId(o),"FF"]);g=n?S.generate([M.getId(o),"FFVH",n]):S.generate([M.getId(o),"FFVH"]);var j=m.createBindingContext(s);function t(k){var l=X.loadTemplate(k,"fragment"),q=new J({idPrefix:g,conditionModel:"$filters>/conditions/"+p,navigationPrefix:n?"/"+n:""});return a.process(l,{name:k},{bindingContexts:{"entitySet":m.createBindingContext(E),"property":j,"this":q.createBindingContext("/")},models:{"entitySet":m,"property":m,"this":q}}).then(function(l){var V=l.getElementsByTagNameNS("sap.ui.mdc.field","FieldValueHelp")[0];if(!i&&V){V=b.load({definition:l});}return V;}).then(function(V){if(V){M.insertAggregation(o,"dependents",V,0);}});}function T(k){var l=X.loadTemplate("sap.fe.macros.FilterField","fragment"),q=new J({idPrefix:h,vhIdPrefix:g,propertyPath:p,navigationPrefix:n?"/"+n:""});return a.process(l,{name:k},{bindingContexts:{"entitySet":m.createBindingContext(E),"property":j,"this":q.createBindingContext("/")},models:{"entitySet":m,"property":m,"this":q}}).then(function(l){var r=l.getElementsByTagNameNS("sap.ui.mdc","FilterField")[0];if(r){if(i){return r;}return b.load({definition:l});}});}return Promise.all([m.requestObject(s+"@com.sap.vocabularies.Common.v1.ValueListReferences"),m.requestObject(s+"@com.sap.vocabularies.Common.v1.ValueListMapping"),m.requestObject(s+"@com.sap.vocabularies.Common.v1.ValueList")]).then(function(r){var V=Promise.resolve();var k=r[0]||r[1]||r[2];if(k){var l=c.valueHelpProperty(j),q=p.indexOf("/")>=0?p.substring(p.lastIndexOf("/")+1):p,G=S.generate([g,q]);if(s!==l){G=S.generate([G,l]);}var u=M.getAggregation(o,"dependents").some(function(D){return M.getId(D)===G;});if(!u){V=t("sap.fe.macros.ValueHelp");}}return V;}).then(T.bind(this,"sap.fe.macros.FilterField"));};O.fetchProperties=function(o){var E=o.data("entitySet"),s="/"+E,m,M=o.getDelegate().payload&&o.getDelegate().payload.modelName,g=o.getModel(M?M:undefined);if(!g){return Promise.resolve(null);}m=g.getMetaModel();if(o.getBindingContext()){s=C.getTargetCollection(o.getBindingContext(),E);}v.push(m.getObject(s+"/@sapui.name"));return f(s,s,s,m,0);};return O;},false);
