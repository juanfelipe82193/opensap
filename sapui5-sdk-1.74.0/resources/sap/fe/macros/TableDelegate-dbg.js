/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/TableDelegate","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/StableIdHelper","sap/fe/macros/field/FieldHelper"],function(T,X,a,F,J,C,S,b){"use strict";var N="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1";var O=Object.assign({},T),v=[];function _(p,n,k,B,m){var P=m.getObject(n+"/"+k+"@"),i=false,I=false,g=m.getObject(n+"@com.sap.vocabularies.Common.v1.Label")||m.getObject(n+"/@com.sap.vocabularies.Common.v1.Label")||m.getObject(n+"@sapui.name"),l=P["@com.sap.vocabularies.Common.v1.Label"]||k,s=n.substr(B.length);i=P["@com.sap.vocabularies.UI.v1.Hidden"]||false;i=i===true||(i&&i["Bool"]!=="false");I=p.$Type&&p.$Type.indexOf("Edm.")!==0;if(i||I){return false;}if(s.indexOf("/")===0){s=s.substr(1);}var f,d,e;if(s.split("/").length>1){e=B+"/"+s.substr(0,s.lastIndexOf("/"));f=m.getObject(e+"@com.sap.vocabularies.Common.v1.Label")||m.getObject(e+"/@com.sap.vocabularies.Common.v1.Label");d=g;g=f+" > "+d;}if(s){s=s+"/";}s=s+k;return{name:s,path:s,groupLabel:g||null,group:n,label:l,description:P["@com.sap.vocabularies.Common.v1.Text"]&&P["@com.sap.vocabularies.Common.v1.Text"].$Path,maxLength:p.$MaxLength,precision:p.$Precision,scale:p.$Scale,type:p.$Type,filterable:true};}function c(e,n,B,m){return Promise.all([m.requestObject(e+"/"),m.requestObject(e+"@")]).then(function(r){if(!r[0]&&!r[1]){return Promise.resolve([]);}var E=r[0],d=r[1],s=d["@Org.OData.Capabilities.V1.SortRestrictions"]||{},f=(s["NonSortableProperties"]||[]).map(function(h){return h["$PropertyPath"];}),o,p,g=[],P=[];for(var k in E){o=E[k];if(o&&o.$kind==="Property"){p=_(o,n,k,B,m);if(p!==false){p.sortable=f.indexOf(k)==-1;g.push(p);}}else if(o&&o.$kind==="NavigationProperty"&&!o.$isCollection&&v.indexOf(m.getObject(n+"/"+k+"/@sapui.name"))===-1){v.push(m.getObject(n+"/"+k+"/@sapui.name"));P.push(c(e+"/$NavigationPropertyBinding/"+k,n+"/"+k,B,m));}}return Promise.all(P).then(function(A){A.forEach(function(h){g=g.concat(h);});return g;});});}O.fetchProperties=function(t){var m=t.getDelegate()&&t.getDelegate().payload,f=[],p,o,e,M,d;e=t.data("targetCollectionName");M=t.getModel(m.model);d=M.getMetaModel();return Promise.all([d.requestObject(e+"/"),d.requestObject(e+"@")]).then(function(r){var E=r[0],g=r[1],s=g["@Org.OData.Capabilities.V1.SortRestrictions"]||{},n=(s["NonSortableProperties"]||[]).map(function(h){return h["$PropertyPath"];}),P=[];v.push(d.getObject(e+"/@sapui.name"));for(var k in E){o=E[k];if(o&&o.$kind==="Property"){p=_(o,e,k,e,d);if(p!==false){p.sortable=n.indexOf(k)==-1;f.push(p);}}else if(o&&o.$kind==="NavigationProperty"&&!o.$isCollection&&v.indexOf(d.getObject(e+"/"+k+"/@sapui.name"))===-1){v.push(d.getObject(e+"/"+k+"/@sapui.name"));P.push(c(e+"/$NavigationPropertyBinding/"+k,e+"/"+k,e,d));}}return Promise.all(P).then(function(A){A.forEach(function(h){f=f.concat(h);});v=[];return f;});});};O.updateBindingInfo=function(m,B){if(B.binding&&!B.binding.isSuspended()){B.suspended=false;}T.updateBindingInfo.call(T,m,B);};O.beforeAddColumnFlex=function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),M=P.modifier,i=M.targets==="xmlTree",V=false,s=M.getId(t),d,o,e,f;if(!m){return Promise.resolve(null);}if(i){d=t.getAttributeNS(N,"targetCollectionName");}else{d=t.data("targetCollectionName");}e=m.createBindingContext(d);var g=d+"/"+p,h=m.createBindingContext(g);o=Promise.all([m.requestObject(g+"@com.sap.vocabularies.Common.v1.ValueListReferences"),m.requestObject(g+"@com.sap.vocabularies.Common.v1.ValueListMapping"),m.requestObject(g+"@com.sap.vocabularies.Common.v1.ValueList")]).then(function(r){var l=r[0]||r[1]||r[2];if(l){var n=b.valueHelpProperty(h),G=S.generate([S.generate([M.getId(t),"TableVH"]),p]);if(n.indexOf("$Path")>-1){n=m.getObject(n);}if(g!==n){G=S.generate([G,n]);}V=M.getAggregation(t,"dependents").some(function(D){return M.getId(D)===G;});if(!V){return j("sap.fe.macros.table.ValueHelp");}}return Promise.resolve();});function j(l){var n=X.loadTemplate(l,"fragment"),q=new J({id:s});return a.process(n,{name:l},{bindingContexts:{"collection":e,"item":h,"this":q.createBindingContext("/")},models:{"this":q,"collection":m,"item":m}}).then(function(n){var o=n.getElementsByTagNameNS("sap.ui.mdc.field","FieldValueHelp")[0];if(!i&&o){o=F.load({definition:n});}return o;}).then(function(o){if(o){M.insertAggregation(t,"dependents",o,0);}});}function k(l){var n=X.loadTemplate(l,"fragment"),q;if(i){q=new J({editMode:"{"+t.getAttributeNS(N,"editModePropertyBinding")+"}",onCallAction:t.getAttributeNS(N,"onCallAction"),tableType:t.getAttributeNS(N,"tableType"),parentControl:"Table",id:s,onChange:t.getAttributeNS(N,"onChange"),navigationPropertyPath:p});}else{q=new J({editMode:"{"+t.data("editModePropertyBinding")+"}",onCallAction:t.data("onCallAction"),tableType:t.data("tableType"),parentControl:"Table",id:s,onChange:t.data("onChange"),navigationPropertyPath:p});}return a.process(n,{name:l},{bindingContexts:{"collection":e,"dataField":h,"this":q.createBindingContext("/")},models:{"this":q,"collection":m,"dataField":m}}).then(function(n){var f=n.getElementsByTagNameNS("sap.ui.mdc.table","Column")[0];if(i){return f;}return F.load({definition:n});});}f=o.then(k.bind(this,"sap.fe.macros.table.ColumnProperty"));return f;};return O;},false);
