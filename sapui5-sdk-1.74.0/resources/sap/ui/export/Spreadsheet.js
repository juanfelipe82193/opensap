/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','./ExportDialog','sap/ui/base/EventProvider','sap/ui/Device','sap/ui/export/SpreadsheetExport','sap/base/Log','sap/base/assert','sap/ui/export/ExportUtils'],function(q,l,E,a,D,S,L,b,c){'use strict';var d=a.extend('sap.ui.export.Spreadsheet',{constructor:function(s){a.call(this,s);this._mSettings={fileName:'Export',showProgress:true,worker:true};['count','dataSource','fileName','showProgress','workbook','worker'].forEach(function(P){if(typeof s[P]!=='undefined'){this._mSettings[P]=P!=='dataSource'?s[P]:this.processDataSource(s[P]);}}.bind(this));}});d.prototype.attachBeforeExport=function(o,h,g){return this.attachEvent('beforeExport',o,h,g);};d.prototype.detachBeforeExport=function(h,o){return this.detachEvent('beforeExport',h,o);};d.prototype.attachBeforeSave=function(o,h,g){return this.attachEvent('beforeSave',o,h,g);};d.prototype.detachBeforeSave=function(h,o){return this.detachEvent('beforeSave',h,o);};d.prototype.destroy=function(){a.prototype.destroy.apply(this,arguments);this.cancel();this.bIsDestroyed=true;};d.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}return this;};d.prototype.onprogress=function(P){L.debug('Spreadsheet export: '+P+'% loaded.');};var e=function(B){var o=[];if(B.isA('sap.ui.model.ClientListBinding')){var g=B.getModel().getProperty(B.getPath());o=(g instanceof Array)?g:[];}if(B.isA('sap.ui.model.ClientTreeBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+B.getMetadata().getName());}if(typeof B.getDownloadUrl=='function'){var m=B.getModel();var s=B.getDownloadUrl("json");var h=m.sServiceUrl;s=c.interceptUrl(s);h=c.interceptUrl(h);o={type:"odata",dataUrl:s,serviceUrl:h,headers:m.getHeaders(),count:B.getTotalSize?B.getTotalSize():B.getLength(),useBatch:m.isA('sap.ui.model.odata.v4.ODataModel')||m.bUseBatch};}return o;};d.prototype.processDataSource=function(o){var m=null;var s=typeof o;if(!o){return;}if(s=='string'){return{dataUrl:o,type:'odata',useBatch:false};}if(s!='object'){L.error('Spreadsheet#setDataSource: Unable to apply data source of type '+s);return;}if(o instanceof Array||o.dataUrl){m=o;}if(o.isA&&(o.isA('sap.ui.model.ListBinding')||o.isA('sap.ui.model.TreeBinding'))){m=e(o);}return m;};var p=(function(){var r={};for(var k in l.EdmType){r[k.toLowerCase()]=k;}return r;})();var f='Spreadsheet export: ';function v(P){var g=f;var o='odata';var s='.xlsx';var h=P.count||1;var i;P.fileName=P.fileName||'export';if(!P.fileName.endsWith(s)){P.fileName+=s;}b(P.dataSource,g+'data source is not specified.');var j=P.dataSource;if(typeof j==='string'){P.dataSource={dataUrl:j,type:o,count:h};P.count=h;}else if(Array.isArray(j)){P.dataSource={data:j,type:'array'};}else if(j&&j.dataUrl){i=(j.type||o).toLowerCase();b([o].indexOf(i)>=0,g+'unsupported data source type.');P.dataSource.type=i;if(j.useBatch){b(j.serviceUrl,g+'serviceUrl is required for OData batch requests.');b(j.headers,g+'model.headers is required for OData batch requests.');}}var k=P.dataSource.sizeLimit;if(i===o&&(!k||isNaN(k))){k=Math.round(h/1000)*200;k=Math.min(10000,Math.max(k,200));L.info(g+'dataSource.sizeLimit is not provided. sizeLimit is set to '+k);P.dataSource.sizeLimit=k;}var m=P&&P.workbook;b(m&&Array.isArray(m.columns),g+'column configuration is not provided. Export is not possible');m.columns.forEach(function(n){b(n,g+'column configuration is not provided. Export is not possible.');b(n.property,g+'column property is not provided. The column is not exported.');b(n.label,g+'column label is not provided.');n.label=n.label||(n.property instanceof Array?n.property[0]:n.property)||'';var w=n.width;if(typeof w==='string'){var W=w.toLowerCase();w=parseFloat(W);if(W.indexOf('em')>0){w=w*2;}else if(W.indexOf('px')>0){w=w/8;}}if(isNaN(w)||w<1){w=10;}if(n.label.length<30){w=Math.max(n.label.length,w);}n.width=Math.round(w);if(n.type){n.type=n.type.toLowerCase();if(!p[n.type]){L.warning(g+'unsupported column property type '+n.type+'. Type is reverted to "string".');n.type='';}if(n.type==='currency'&&!n.unitProperty){L.warning(g+'missing unit property for currency column. Type is reverted to "string".');n.type='';}}var r=n.scale;if(n.type==='number'&&isNaN(r)&&r!=='variable'){L.warning(g+'scale parameter for numerical column configuration is missing.');}if(typeof r==='string'){r=parseInt(r);}if(isNaN(r)){r=null;}n.scale=r;var t=(n.textAlign+'').toLowerCase();if(['begin','end'].indexOf(t)>-1){var u=['left','right'];t=(sap.ui.getCore().getConfiguration().getRTL()?u.reverse():u)[['begin','end'].indexOf(t)];}if(t!==''&&['left','right','center','begin','end'].indexOf(t)==-1){L.warning(g+'incorrect column alignment property: '+t+'. Default alignment is used.');t='';}n.textAlign=t;});}d.prototype.build=function(){var s=this;var P=this._mSettings;if(this.bIsDestroyed){var m=f+'Cannot trigger build - the object has been destroyed';L.error(m);return Promise.reject(m);}this.fireEvent('beforeExport',{exportSettings:P},false,false);v(P);return new Promise(function(r,R){var g;var h=D.system.desktop?2000000:100000;var n=P.dataSource.count;var i=P.workbook.columns.length;function o(k){if(!isNaN(k.progress)){if(g){g.updateStatus(k.progress);}s.onprogress(k.progress);}if(k.finish){s.process=null;if(!k.data){R('Spreadsheet export: The process was canceled');return;}var t=s.fireEvent('beforeSave',{data:k.data},true,true);if(g){window.setTimeout(g.finish,1000);}if(t){c.saveAsFile(new Blob([k.data],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),P.fileName);}r();}if(typeof k.error!='undefined'){s.process=null;if(g){g.finish();}R(k.error);E.showErrorMessage(k.error);}}function j(){if(!P.showProgress){if(s.process){R('Cannot start export: the process is already running');return;}s.process=S.execute(P,o);return;}E.getProgressDialog().then(function(k){g=k;if(s.process){R('Cannot start export: the process is already running');return;}g.oncancel=function(){return s.process&&s.process.cancel();};g.open();s.process=S.execute(P,o);});}if(i<=0){R('No columns to export.');}else if(n*i>h){E.showWarningDialog({rows:n,columns:i}).then(j).catch(function(){R('Export cancelled by the user.');});}else{j();}});};return d;});
