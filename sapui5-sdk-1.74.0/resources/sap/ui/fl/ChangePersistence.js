/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/write/_internal/CompatibilityConnector","sap/ui/fl/Cache","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/context/ContextManager","sap/ui/fl/write/_internal/Storage","sap/ui/fl/variants/VariantController","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/base/util/isEmptyObject","sap/base/Log","sap/ui/fl/apply/_internal/flexState/FlexState"],function(D,C,V,U,L,a,b,A,c,S,d,e,J,q,m,i,f,F){"use strict";var g=function(j){this._mComponent=j;this._mChanges=h();this._mChangesInitial=m({},this._mChanges);this._mVariantsChanges={};if(!this._mComponent||!this._mComponent.name){f.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._oVariantController=new d(this._mComponent.name,this._mComponent.appVersion,{});this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function h(){return{mChanges:{},mDependencies:{},mDependentChangesOnMe:{},mControlsWithDependencies:{},aChanges:[]};}g.prototype.getComponentName=function(){return this._mComponent.name;};g.prototype.getCacheKey=function(o){return b.getCacheKey(this._mComponent,o);};g.prototype._preconditionsFulfilled=function(j,I,o){var k=o instanceof C?o.getDefinition():o;if(!k.fileName){f.warning("A change without fileName is detected and excluded from component: "+this._mComponent.name);return false;}function l(){if(I){return(k.fileType==="change")||(k.fileType==="variant");}return(k.fileType==="change")&&(k.changeType!=="defaultVariant");}function n(){if(I){if((k.fileType==="variant")||(k.changeType==="defaultVariant")){return k.selector&&k.selector.persistencyKey;}}return true;}function p(){return c.doesContextMatch(k,j);}function r(){if((k.fileType==="ctrl_variant")||(k.fileType==="ctrl_variant_change")||(k.fileType==="ctrl_variant_management_change")){return k.variantManagementReference||k.variantReference||(k.selector&&k.selector.id);}}if((l()&&n()&&p())||r()){return true;}return false;};g.prototype.getChangesForComponent=function(p,I){return b.getChangesFillingCache(this._mComponent,p,I).then(function(w){var o=m({},w);var l=p&&p.component&&U.getAppComponentForControl(p.component);var n=o.changes&&Array.isArray(o.changes.changes)&&o.changes.changes.length!==0;var v=o.changes&&o.changes.variantSection&&!i(o.changes.variantSection);if(!n&&!v){return[];}var s=l?l.getComponentData():(p&&p.componentData||{});var t=o.changes.changes;if(!this._oMessagebundle&&o.messagebundle&&l){if(!l.getModel("i18nFlexVendor")){if(t.some(function(H){return H.layer==="VENDOR";})){this._oMessagebundle=o.messagebundle;var M=new J(this._oMessagebundle);l.setModel(M,"i18nFlexVendor");}}}var u=p&&p.includeCtrlVariants;var x=p&&p.currentLayer;var y=!(p&&p.ignoreMaxLayerParameter);var z=[o.changes.variantSection];if(x){t=t.filter(this._filterChangeForCurrentLayer.bind(this,x));z.push(false,x);}else if(L.isLayerFilteringRequired()&&y){t=t.filter(this._filterChangeForMaxLayer.bind(this));z.push(true);}else if(this._bHasChangesOverMaxLayer&&!y){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}if(v){if(u||z.length>1){var B=this._getAllCtrlVariantChanges.apply(this,z);t=u?t.concat(B):t;}this._oVariantController.checkAndSetVariantContent(o,s&&s.technicalParameters);}if(!u&&!i(this._oVariantController.getChangeFileContent())){t=t.concat(this._oVariantController.loadInitialChanges());}var E=p&&p.includeVariants;var G=o.changes.contexts||[];return new Promise(function(H){c.getActiveContexts(G).then(function(K){H(t.filter(this._preconditionsFulfilled.bind(this,K,E)).map(k.bind(this,o)));}.bind(this));}.bind(this));}.bind(this));function j(v,o){var l;Object.keys(v).some(function(s){return v[s].variants.some(function(n){if(n.content.fileName===o.getDefinition().variantReference){l=n;return true;}});});return l;}function r(v,o){return v.controlChanges.some(function(l,n){if(l.fileName===o.getDefinition().fileName){v.controlChanges.splice(n,1,o);return true;}});}function k(o,l){var n;if(l instanceof C){n=l;this._mChangesEntries[n.getFileName()]=n;}else{if(!this._mChangesEntries[l.fileName]){this._mChangesEntries[l.fileName]=new C(l);}n=this._mChangesEntries[l.fileName];n.setState(C.states.PERSISTED);if(n.getVariantReference()){var v=this._oVariantController.getChangeFileContent();var s=j.call(this,v,n);if(s&&r(s,n)){b.setVariantManagementSection(this._mComponent,v);}}}return n;}};g.prototype._filterChangeForMaxLayer=function(o){if(L.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(o))){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};g.prototype._filterChangeForCurrentLayer=function(l,o){return l===this._getLayerFromChangeOrChangeContent(o);};g.prototype._getLayerFromChangeOrChangeContent=function(o){var s;if(o instanceof V||o instanceof C){s=o.getLayer();}else{s=o.layer;}return s;};g.prototype._getAllCtrlVariantChanges=function(v,j,s){var k=[];var l=function(){return true;};if(j){l=this._filterChangeForMaxLayer.bind(this);}else if(typeof s==="string"&&s!==""){l=this._filterChangeForCurrentLayer.bind(this,s);}Object.keys(v).forEach(function(n){var o=v[n];o.variants=o.variants.filter(function(p){return!p.content.layer||l(p.content);});o.variants.forEach(function(p){if(Array.isArray(p.variantChanges.setVisible)){p.variantChanges.setVisible=p.variantChanges.setVisible.filter(l);var r=p.variantChanges.setVisible.slice(-1)[0];if(r&&!r.content.visible&&r.content.createdByReset){return;}k=k.concat(p.variantChanges.setVisible);}Object.keys(p.variantChanges).forEach(function(t){if(t!=="setVisible"){p.variantChanges[t]=p.variantChanges[t].filter(l);k=p.variantChanges[t].length>0?k.concat(p.variantChanges[t].slice(-1)[0]):k;}});k=(p.content.fileName!==n)?k.concat([p.content]):k;p.controlChanges=p.controlChanges.filter(l);k=k.concat(p.controlChanges);});Object.keys(o.variantManagementChanges).forEach(function(p){o.variantManagementChanges[p]=o.variantManagementChanges[p].filter(l);k=o.variantManagementChanges[p].length>0?k.concat(o.variantManagementChanges[p].slice(-1)[0]):k;});});return k;};g.prototype.getSmartVariantManagementChangeMap=function(){return this._mVariantsChanges;};g.prototype.getChangesForVariant=function(s,j,p){if(this._mVariantsChanges[j]){return Promise.resolve(this._mVariantsChanges[j]);}var k=function(o){var n=false;var r=o._oDefinition.selector;q.each(r,function(t,v){if(t===s&&v===j){n=true;}});return n;};var l=function(n,t){f.error("key : "+n+" and text : "+t.value);};return this.getChangesForComponent(p).then(function(n){return n.filter(k);}).then(function(n){if(!this._mVariantsChanges[j]){this._mVariantsChanges[j]={};}var I;n.forEach(function(o){I=o.getId();if(o.isValid()){if(this._mVariantsChanges[j][I]&&o.isVariant()){f.error("Id collision - two or more variant files having the same id detected: "+I);q.each(o.getDefinition().texts,l);f.error("already exists in variant : ");q.each(this._mVariantsChanges[j][I].getDefinition().texts,l);}this._mVariantsChanges[j][I]=o;}}.bind(this));return this._mVariantsChanges[j];}.bind(this));};g.prototype.addChangeForVariant=function(s,j,p){var o;var I;var k;var l;var n;if(!p){return undefined;}if(!p.type){f.error("sap.ui.fl.Persistence.addChange : type is not defined");}var r=q.type(p.content);if(r!=='object'&&r!=='array'){f.error("mParameters.content is not of expected type object or array, but is: "+r,"sap.ui.fl.Persistence#addChange");}k={};if(typeof(p.texts)==="object"){q.each(p.texts,function(t,u){k[t]={value:u,type:"XFLD"};});}var v={creation:this._mComponent.appVersion,from:this._mComponent.appVersion};if(this._mComponent.appVersion&&p.developerMode){v.to=this._mComponent.appVersion;}I={changeType:p.type,service:p.ODataService,texts:k,content:p.content,reference:this._mComponent.name,isVariant:p.isVariant,packageName:p.packageName,isUserDependent:p.isUserDependent,validAppVersions:v};I.selector={};I.selector[s]=j;o=C.createInitialFileContent(I);if(p.id){o.fileName=p.id;}l=new C(o);n=l.getId();if(!this._mVariantsChanges[j]){this._mVariantsChanges[j]={};}this._mVariantsChanges[j][n]=l;return l.getId();};g.prototype.saveAllChangesForVariant=function(s){var p=[];q.each(this._mVariantsChanges[s],function(j,o){var k=o.getId();switch(o.getPendingAction()){case"NEW":p.push(a.create(o.getDefinition(),o.getRequest(),o.isVariant()).then(function(r){if(r&&r.response&&r.response[0]){o.setResponse(r.response[0]);}else{o.setState(C.states.PERSISTED);}b.addChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;case"UPDATE":p.push(a.update(o.getDefinition(),o.getRequest()).then(function(r){if(r&&r.response){o.setResponse(r.response);}else{o.setState(C.states.PERSISTED);}b.updateChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;case"DELETE":p.push(a.deleteChange(o.getDefinition(),o.getRequest()).then(function(r){var o=this._mVariantsChanges[s][k];if(o.getPendingAction()==="DELETE"){delete this._mVariantsChanges[s][k];}b.deleteChange({name:this._mComponent.name,appVersion:this._mComponent.appVersion},o.getDefinition());return r;}.bind(this)));break;default:break;}}.bind(this));return Promise.all(p);};function _(s,o){return s.idIsLocal?o.createId(s.id):s.id;}g.prototype.loadChangesMapForComponent=function(o){return this.getChangesForComponent({component:o}).then(j.bind(this));function j(k){this._mChanges=h();k.forEach(this._addChangeAndUpdateDependencies.bind(this,o));this._mChangesInitial=m({},this._mChanges);return this.getChangesMapForComponent.bind(this);}};g.prototype.checkForOpenDependenciesForControl=function(s,M,o){return Object.keys(this._mChanges.mDependencies).some(function(k){return this._mChanges.mDependencies[k].changeObject.getDependentSelectorList().some(function(j){return j===M.getControlIdBySelector(s,o);});},this);};g.prototype.copyDependenciesFromInitialChangesMap=function(o,j,k){var I=m({},this._mChangesInitial.mDependencies);var l=I[o.getId()];if(l){var n=[];l.dependencies.forEach(function(s){if(j(s)){this._mChanges.mDependentChangesOnMe[s]=this._mChanges.mDependentChangesOnMe[s]||[];this._mChanges.mDependentChangesOnMe[s].push(o.getId());n.push(s);}}.bind(this));o.getDependentControlSelectorList().forEach(function(s){this._mChanges.mControlsWithDependencies[_(s,k)]=true;}.bind(this));l.dependencies=n;this._mChanges.mDependencies[o.getId()]=l;}return this._mChanges;};g.prototype._addChangeAndUpdateDependencies=function(o,j){j.setInitialApplyState();D.addChangeAndUpdateDependencies(j,o,this._mChanges);};g.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(o,j){D.addRuntimeChangeAndUpdateDependencies(j,o,this._mChanges,this._mChangesInitial);};g.prototype.getChangesMapForComponent=function(){return this._mChanges;};g.prototype.getChangesForView=function(v,p){return this.getChangesForComponent(p).then(function(k){return k.filter(j.bind(this));}.bind(this));function j(o){var s=o.getSelector();if(!s){return false;}var k=s.id;if(!k||!p){return false;}var l=k.slice(0,k.lastIndexOf("--"));var v;if(o.getSelector().idIsLocal){var n=p.appComponent;if(n){v=n.getLocalId(p.viewId);}}else{v=p.viewId;}return l===v;}};g.prototype.addChange=function(v,o){var j=this.addDirtyChange(v);this._addRunTimeCreatedChangeAndUpdateDependencies(o,j);this._addPropagationListener(o);return j;};g.prototype.addDirtyChange=function(v){var n;if(v instanceof C||v instanceof V){n=v;}else{n=new C(v);}if(this._aDirtyChanges.indexOf(n)===-1){this._aDirtyChanges.push(n);}return n;};g.prototype._addPropagationListener=function(o){var j=U.getAppComponentForControl(o);if(j instanceof e){var k=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var n=j.getPropagationListeners().every(k);if(n){var M=j.getManifestObject();var v=U.getAppVersionFromManifest(M);var l=sap.ui.require("sap/ui/fl/FlexControllerFactory");var p=l.create(this.getComponentName(),v);var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),j,p);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;j.addPropagationListener(P);}}};g.prototype.saveDirtyChanges=function(s,j,k){var l=j||this._aDirtyChanges;var n=l.slice(0);var r=this._getRequests(l);var p=this._getPendingActions(l);if(p.length===1&&r.length===1&&p[0]==="NEW"){var R=r[0];var P=this._prepareDirtyChanges(l);return a.create(P,R,undefined,k).then(function(o){this._massUpdateCacheAndDirtyState(l,n,s);return o;}.bind(this));}return this.saveSequenceOfDirtyChanges(n,s,k);};g.prototype.saveSequenceOfDirtyChanges=function(j,s,k){var l=this.getDirtyChanges();return j.reduce(function(p,o){return p.then(this._performSingleSaveAction(o,k)).then(this._updateCacheAndDirtyState.bind(this,l,o,s));}.bind(this),Promise.resolve());};g.prototype._performSingleSaveAction=function(o,j){return function(){if(o.getPendingAction()==="NEW"){return a.create(o.getDefinition(),o.getRequest(),undefined,j);}if(o.getPendingAction()==="DELETE"){return a.deleteChange(o.getDefinition(),o.getRequest());}};};g.prototype._updateCacheAndDirtyState=function(j,o,s){if(!s){if(o.getPendingAction()==="NEW"){U.isChangeRelatedToVariants(o)?b.setVariantManagementSection(this._mComponent,m({},this._oVariantController.getChangeFileContent())):b.addChange(this._mComponent,o.getDefinition());}else if(o.getPendingAction()==="DELETE"){U.isChangeRelatedToVariants(o)?b.setVariantManagementSection(this._mComponent,m({},this._oVariantController.getChangeFileContent())):b.deleteChange(this._mComponent,o.getDefinition());}}var I=j.indexOf(o);if(I>-1){j.splice(I,1);}};g.prototype._massUpdateCacheAndDirtyState=function(j,k,s){k.forEach(function(o){this._updateCacheAndDirtyState(j,o,s);},this);};g.prototype._getRequests=function(j){var r=[];j.forEach(function(o){var R=o.getRequest();if(r.indexOf(R)===-1){r.push(R);}});return r;};g.prototype._getPendingActions=function(j){var p=[];j.forEach(function(o){var P=o.getPendingAction();if(p.indexOf(P)===-1){p.push(P);}});return p;};g.prototype._prepareDirtyChanges=function(j){var k=[];j.forEach(function(o){k.push(o.getDefinition());});return k;};g.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};g.prototype.deleteChange=function(o,r){var n=this._aDirtyChanges.indexOf(o);if(n>-1){if(o.getPendingAction()==="DELETE"){return;}this._aDirtyChanges.splice(n,1);this._deleteChangeInMap(o,r);return;}o.markForDeletion();this.addDirtyChange(o);this._deleteChangeInMap(o,r);};g.prototype._deleteChangeInMap=function(o,r){var s=o.getId();var j=this._mChanges.mChanges;var M=r?this._mChangesInitial:this._mChanges;var k=M.mDependencies;var l=M.mDependentChangesOnMe;Object.keys(j).some(function(n){var p=j[n];var t=p.map(function(E){return E.getId();}).indexOf(o.getId());if(t!==-1){p.splice(t,1);return true;}});Object.keys(k).forEach(function(n){if(n===s){delete k[n];}else if(k[n].dependencies&&Array.isArray(k[n].dependencies)&&k[n].dependencies.indexOf(s)!==-1){k[n].dependencies.splice(k[n].dependencies.indexOf(s),1);if(k[n].dependencies.length===0){delete k[n];}}});Object.keys(l).forEach(function(n){if(n===s){delete l[n];}else if(Array.isArray(l[n])&&l[n].indexOf(s)!==-1){l[n].splice(l[n].indexOf(s),1);if(l[n].length===0){delete l[n];}}});var I=this._mChanges.aChanges.indexOf(o);if(I!==-1){this._mChanges.aChanges.splice(I,1);}};g.prototype.loadSwitchChangesMapForComponent=function(p){p.changesMap=this._mChanges.mChanges;return this._oVariantController.getChangesForVariantSwitch(p);};g.prototype.transportAllUIChanges=function(r,s,l,j){return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(k){return S.publish({transportDialogSettings:{rootControl:r,styleClass:s},layer:l,reference:this.getComponentName(),appVersion:this._mComponent.appVersion,localChanges:k,appVariantDescriptors:j});}.bind(this));};g.prototype._getChangesFromMapByNames=function(n){return this._mChanges.aChanges.filter(function(o){return n.indexOf(o.getFileName())!==-1;});};g.prototype.resetChanges=function(l,G,s,j){var k=s&&s.length>0;var n=j&&j.length>0;if(!G&&!k&&!n){f.error("Of the generator, selector IDs and change types parameters at least one has to filled");return Promise.reject("Of the generator, selector IDs and change types parameters at least one has to filled");}return this.getChangesForComponent({currentLayer:l,includeCtrlVariants:true}).then(function(o){var p={reference:this.getComponentName(),appVersion:this._mComponent.appVersion,layer:l,changes:o};if(G){p.generator=G;}if(k){p.selectorIds=s;}if(n){p.changeTypes=j;}return a.resetChanges(p);}.bind(this)).then(function(r){var o=[];if(s||j){var N=[];if(r&&r.response&&r.response.length>0){r.response.forEach(function(p){N.push(p.name);});}b.removeChanges(this._mComponent,N);o=this._getChangesFromMapByNames(N);}return o;}.bind(this));};g.prototype.resetVariantMap=function(r){F.clearPreparedMaps(this._mComponent.name);return this._oVariantController.resetMap(r);};g.prototype.getResetAndPublishInfo=function(p){return a.getFlexInfo(p);};return g;},true);
