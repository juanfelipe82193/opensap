/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/LayerUtils"],function(e,L,c,d){"use strict";var A="sap/ui/fl/apply/_internal/connectors/";var S={connector:"StaticFileConnector"};function _(l,v){return l.filter(function(a){return v.indexOf(a)!==-1||v[0]==="ALL";});}function s(r){function b(C,o){return new Date(C.creation)-new Date(o.creation);}["changes","variantChanges","variants","variantDependentControlChanges","variantManagementChanges"].forEach(function(a){r[a]=r[a].sort(b);});return r;}return{getConnectors:function(n,l){var C=sap.ui.getCore().getConfiguration().getFlexibilityServices();var m=[];if(l){m=[S];}m=m.concat(C);return new Promise(function(r){var a=m.map(function(b){var f=b.connector;var g;if(!b.custom){g=n+f;}else{g=l?b.applyConnector:b.writeConnector;}return g;});sap.ui.require(a,function(){Array.from(arguments).forEach(function(o,i){if(!l){if(!m[i].layers){m[i].layers=o.layers;}else{m[i].layers=_(m[i].layers,o.layers);}}if(l){m[i].applyConnectorModule=o;}else{m[i].writeConnectorModule=o;}});r(m);});});},getApplyConnectors:function(){return this.getConnectors(A,true);},logAndResolveDefault:function(r,C,f,E){L.error("Connector ("+C.connector+") failed call '"+f+"': "+E);return r;},filterAndSortResponses:function(g){var r=[];Object.keys(g).forEach(function(l){r.push(g[l]);});r=r.filter(function(R){return R.changes.length>0||R.variants.length>0||R.variantChanges.length>0||R.variantManagementChanges.length>0||R.variantDependentControlChanges.length>0;});r.sort(function(a,b){return a.index-b.index;});return r;},getGroupedFlexObjects:function(f){var g={};Object.keys(c).forEach(function(l){g[l]=this.getEmptyFlexDataResponse();g[l].index=d.getLayerIndex(l);}.bind(this));f.forEach(function(F){var l=F.layer;if(F.fileType==="ctrl_variant"&&F.variantManagementReference){g[l].variants.push(F);}else if(F.fileType==="ctrl_variant_change"){g[l].variantChanges.push(F);}else if(F.fileType==="ctrl_variant_management_change"){g[l].variantManagementChanges.push(F);}else if(F.fileType==="change"||F.fileType==="variant"){if(F.variantReference){g[l].variantDependentControlChanges.push(F);}else{g[l].changes.push(F);}}});Object.keys(g).forEach(function(l){s(g[l]);});return g;},getEmptyFlexDataResponse:function(){return Object.assign({},{appDescriptorChanges:[],changes:[],variants:[],variantChanges:[],variantDependentControlChanges:[],variantManagementChanges:[],ui2personalization:{}});}};});
