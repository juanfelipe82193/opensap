/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/base/Log","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher"],function(C,U,L,m,i,M,h){"use strict";function g(o,N){var d=N.params[c.variantTechnicalParameterName];return d.reduce(function(r,v){var V=o.getVariantManagementReference(v).variantManagementReference;if(V&&o.oData[V].currentVariant!==v){r.updateRequired=true;if(o.oData[V].currentVariant!==o.oData[V].defaultVariant){r.currentVariantReferences.push(o.oData[V].currentVariant);}}else{r.currentVariantReferences.push(v);}return r;},{updateRequired:false,currentVariantReferences:[]});}function n(o,N){var u=U.getUshellContainer();var S=u.getService("ShellNavigation");try{var d=u.getService("URLParsing");var e=d.parseShellHash(N);var r=e&&e.params.hasOwnProperty(c.variantTechnicalParameterName);if(r){var f=g(o,e);if(f.updateRequired){c.update({updateURL:!o._bDesignTimeMode,parameters:f.currentVariantReferences,updateHashEntry:true,model:o});}if(o._bDesignTimeMode){c.clearAllVariantURLParameters({model:o});}}}catch(E){L.error(E.message);}return S.NavigationFilterStatus.Continue;}function s(o,S){var d=S?"registerNavigationFilter":"unregisterNavigationFilter";var u=U.getUshellContainer();if(u){u.getService("ShellNavigation")[d](n.bind(null,o));}}function a(p){var P=U.getParsedURLHash(c.variantTechnicalParameterName);if(P.params){var t=U.getTechnicalParametersForComponent(p.model.oAppComponent);if(!t){L.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged");}if(p.parameters.length===0){delete P.params[c.variantTechnicalParameterName];t&&delete t[c.variantTechnicalParameterName];}else{P.params[c.variantTechnicalParameterName]=p.parameters;t&&(t[c.variantTechnicalParameterName]=p.parameters);}if(p.silent){h.changed.active=false;h.replaceHash(U.getUshellContainer().getService("URLParsing").constructShellHash(P));h.changed.active=true;}else{var o=U.getUshellContainer().getService("CrossApplicationNavigation");o.toExternal({target:{semanticObject:P.semanticObject,action:P.action,context:P.contextRaw},params:P.params,appSpecificRoute:P.appSpecificRoute,writeHistory:false});}}}function b(p){var r={index:-1};var u=U.getParsedURLHash().params;if(u){r.parameters=[];if(p.model._bDesignTimeMode){u[c.variantTechnicalParameterName]=c.getStoredHashParams(p);}if(Array.isArray(u[c.variantTechnicalParameterName])){u[c.variantTechnicalParameterName]=u[c.variantTechnicalParameterName].map(decodeURIComponent);u[c.variantTechnicalParameterName].some(function(P,I){if(p.model.oVariantController.getVariant(p.vmReference,P)){r.index=I;return true;}});}}return m(r,u&&u[c.variantTechnicalParameterName]&&{parameters:u[c.variantTechnicalParameterName]});}var c={variantTechnicalParameterName:"sap-ui-fl-control-variant-id",initialize:function(p){var u=U.getParsedURLHash().params;p.model._oHashData={hashParams:(u&&u[c.variantTechnicalParameterName])||[],controlPropertyObservers:[],variantControlIds:[]};c.attachHandlers(p);},updateVariantInURL:function(p){var u=c.removeURLParameterForVariantManagement(p);if(!u.parameters){return;}var P=u.parameters||[];var I=u.index;var d=p.newVReference===p.model.oData[p.vmReference].defaultVariant;if(!d){if(I===-1){P=P.concat([p.newVReference]);}else{P=P.slice(0,I).concat([p.newVReference],P.slice(I));}}if(!d||I>-1){c.update({parameters:P,updateURL:!p.model._bDesignTimeMode,updateHashEntry:true,model:p.model});}},removeURLParameterForVariantManagement:function(p){var v=b(p);if(v.index>-1){v.parameters.splice(v.index,1);}return v;},attachHandlers:function(p){function o(){return p.model._oVariantSwitchPromise.then(function(){p.model._oHashData.controlPropertyObservers.forEach(function(O){O.destroy();});s(p.model,false);p.model.oChangePersistence.resetVariantMap();p.model.destroy();p.model.oComponentDestroyObserver.unobserve(p.model.oAppComponent,{destroy:true});p.model.oComponentDestroyObserver.destroy();});}s(p.model,true);if(!p.model.oComponentDestroyObserver&&p.model.oAppComponent instanceof C){p.model.oComponentDestroyObserver=new M(o.bind(null));p.model.oComponentDestroyObserver.observe(p.model.oAppComponent,{destroy:true});}if(p.updateURL){p.model._oHashData.variantControlIds.push(p.vmReference);}},update:function(p){if(!p||!Array.isArray(p.parameters)){L.info("Variant URL parameters could not be updated since invalid parameters were received");return;}if(p.updateURL){a(p);}if(p.updateHashEntry&&!i(p.model)){p.model._oHashData.hashParams=p.parameters;}},getStoredHashParams:function(p){return Array.prototype.slice.call(p.model._oHashData.hashParams);},handleModelContextChange:function(p){var d="modelContextChange";function e(E,P){var v=P.model.getVariantManagementReferenceForControl(E.getSource());var V=P.model._oHashData.variantControlIds;var I=V.indexOf(v);if(I>-1){V.slice(I).forEach(function(f){if(b({vmReference:f,model:p.model}).index===-1){P.model.switchToDefaultForVariantManagement(f);}});}}var o=new M(function(E){if(E.current===true&&E.old===false){E.object.attachEvent(d,{model:p.model},e);}else if(E.current===false&&E.old===true){E.object.detachEvent(d,e);}});o.observe(p.vmControl,{properties:["resetOnContextChange"]});p.model._oHashData.controlPropertyObservers.push(o);if(p.vmControl.getResetOnContextChange()!==false){p.vmControl.attachEvent(d,{model:p.model},e);}},clearAllVariantURLParameters:function(p){c.update({updateURL:true,parameters:[],updateHashEntry:false,model:p.model});}};return c;},true);
