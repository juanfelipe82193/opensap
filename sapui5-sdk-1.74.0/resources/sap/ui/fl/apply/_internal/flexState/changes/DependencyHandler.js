/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils"],function(J,U){"use strict";var P="sap.ui.fl:PendingChange";var D={};function _(s,A){return s.idIsLocal?A.createId(s.id):s.id;}function a(s,C,m){if(!m.mChanges[s]){m.mChanges[s]=[];}if(m.mChanges[s].indexOf(C)===-1){m.mChanges[s].push(C);}if(m.aChanges.indexOf(C)===-1){m.aChanges.push(C);}}function b(C,A,m){var s=C.getSelector();if(s&&s.id){var S=_(s,A);a(S,C,m);if(s.idIsLocal===undefined&&S.indexOf("---")!==-1){var h=S.split("---")[0];if(h!==A.getId()){S=S.split("---")[1];S=A.createId(S);a(S,C,m);}}}return m.aChanges;}function c(C,A,h,m){var i=C.getDependentSelectorList();var j=C.getDependentControlSelectorList();d(C,A,j,m);h.slice(0,h.length-1).reverse().forEach(function(E){var k=E.getDependentSelectorList();i.some(function(o){var l=U.indexOfObject(k,o);if(l>-1){e(C,E,m);return true;}});});}function d(o,A,C,m){if(C.length>0){if(!m.mDependencies[o.getId()]){m.mDependencies[o.getId()]={changeObject:o,dependencies:[],controlsDependencies:[]};}m.mDependencies[o.getId()].controlsDependencies=C;var s;C.forEach(function(S){s=_(S,A);m.mControlsWithDependencies[s]=true;});}}function e(o,C,m){if(!m.mDependencies[o.getId()]){m.mDependencies[o.getId()]={changeObject:o,dependencies:[]};}m.mDependencies[o.getId()].dependencies.push(C.getId());if(!m.mDependentChangesOnMe[C.getId()]){m.mDependentChangesOnMe[C.getId()]=[];}m.mDependentChangesOnMe[C.getId()].push(o.getId());}function f(C,A){var h=[];var i=[];var p=[];g(C,A);Object.keys(C.mDependencies).forEach(function(s){var o=C.mDependencies[s];if(o[P]&&o.dependencies.length===0&&!(o.controlsDependencies&&o.controlsDependencies.length>0)){p.push(function(){return o[P]().then(function(){i.push(s);h.push(o.changeObject.getId());});});}});return U.execPromiseQueueSequentially(p).then(function(){for(var j=0;j<i.length;j++){delete C.mDependencies[i[j]];}for(var k=0;k<h.length;k++){D.removeChangeFromDependencies(C,h[k]);}return h;});}function g(C,A){Object.keys(C.mDependencies).forEach(function(s){var o=C.mDependencies[s];if(o.controlsDependencies&&o.controlsDependencies.length>0){var l=o.controlsDependencies.length;while(l--){var S=o.controlsDependencies[l];var h=J.bySelector(S,A);if(h){o.controlsDependencies.splice(l,1);delete C.mControlsWithDependencies[h.getId()];}}}});}D.addChangeAndUpdateDependencies=function(C,A,m){var h=b(C,A,m);c(C,A,h,m);};D.addRuntimeChangeAndUpdateDependencies=function(C,A,m,i){var h=b(C,A,m);c(C,A,h,i);};D.processDependentQueue=function(C,A){return f(C,A).then(function(h){if(h.length>0){return D.processDependentQueue(C,A);}});};D.addChangeApplyCallbackToDependency=function(C,s,h){C.mDependencies[s][P]=h;};D.removeChangeFromDependencies=function(C,s){if(C.mDependentChangesOnMe[s]){C.mDependentChangesOnMe[s].forEach(function(k){var o=C.mDependencies[k];var i=o?o.dependencies.indexOf(s):-1;if(i>-1){o.dependencies.splice(i,1);}});delete C.mDependentChangesOnMe[s];}};return D;});
