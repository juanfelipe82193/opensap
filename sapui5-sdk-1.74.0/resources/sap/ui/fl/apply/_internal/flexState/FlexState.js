/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/Component","sap/ui/fl/apply/_internal/StorageUtils","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/prepareVariantsMap","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(m,O,C,S,L,p,a,b,c,U){"use strict";var F={};var _={};var d={};var e={appDescriptorMap:p,changesMap:a,variantsMap:b};function f(P){var o=C.get(P.componentId);P.componentData=P.componentData||o.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||o.getManifestObject();P.reference=P.reference||U.getComponentClassName(o);}function g(r,M){if(!_[r]){throw Error("State is not yet initialized");}if(!_[r].preparedMaps[M]){var P={storageResponse:_[r].unfilteredStorageResponse,componentId:_[r].componentId};_[r].preparedMaps[M]=F._callPrepareFunction(M,P);}return _[r].preparedMaps[M];}function h(r){return g(r,"appDescriptorMap");}function i(r){return g(r,"changesMap");}function j(r){return g(r,"variantsMap");}function k(P){if(P.reference.endsWith(".Component")){var o=P.reference.split(".");o.pop();var r=o.join(".");_[r]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId});d[r]=d[P.reference];}}function l(r){var o=m({},r);var q=o.changes;var s=["changes","variants","variantChanges","variantDependentControlChanges","variantManagementChanges"];if(c.isLayerFilteringRequired()){s.forEach(function(t){q[t]=c.filterChangeDefinitionsByMaxLayer(q[t]);});}return o;}function n(P){d[P.reference]=L.loadFlexData(P).then(function(r){_[P.reference]=m({},{unfilteredStorageResponse:r,preparedMaps:{},componentId:P.componentId});k(P);return r;});return d[P.reference];}F.initialize=function(P){return Promise.resolve().then(function(P){f(P);if(d[P.reference]){return d[P.reference].then(function(P){if(_[P.reference].componentId!==P.componentId){return n(P);}return _[P.reference].unfilteredStorageResponse;}.bind(null,P));}return n(P);}.bind(null,P)).then(function(P,r){if(!_[P.reference].storageResponse){_[P.reference].storageResponse=l(r);}F.getVariantsState(P.reference);}.bind(null,P));};F.clearAndInitialize=function(P){f(P);var v=!!O.get(["preparedMaps","variantsMap"],_[P.reference]);F.clearState(P.reference);return F.initialize(P).then(function(v,r){if(v){return F.getVariantsState(r);}}.bind(null,v,P.reference));};F.clearState=function(r){if(r){delete _[r];delete d[r];}else{_={};d={};}};F.clearMaxLayerFiltering=function(r){delete _[r].storageResponse;F.clearPreparedMaps(r);};F.getUIChanges=function(r){return i(r).changes;};F.getAppDescriptorChanges=function(r){return h(r).appDescriptorChanges;};F.getVariantsState=function(r){var v=j(r);_[r].unfilteredStorageResponse.changes.variantSection=v;return v;};F._callPrepareFunction=function(M,P){return e[M](P);};F.getStorageResponse=function(r){if(d[r]){return d[r].then(function(){return _[r].unfilteredStorageResponse;});}};F.getFlexObjectsFromStorageResponse=function(r){return _[r].unfilteredStorageResponse.changes;};F.clearPreparedMaps=function(r){_[r].preparedMaps={};};return F;},true);
