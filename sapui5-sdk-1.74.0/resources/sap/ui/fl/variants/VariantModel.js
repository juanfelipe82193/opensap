/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Change","sap/ui/fl/changeHandler/Base","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/base/util/merge","sap/base/util/includes","sap/base/util/ObjectPath"],function(J,a,B,U,L,C,b,R,c,f,i,O){"use strict";function _(){var v=Object.keys(this.oData);v.forEach(function(s){var p={variantManagementReference:s,currentVariantReference:this.oData[s].currentVariant||this.oData[s].defaultVariant,newVariantReference:true};var m=this.oChangePersistence.loadSwitchChangesMapForComponent(p);h(R.revertMultipleChanges.bind(null,m.changesToBeReverted,{appComponent:this.oAppComponent,modifier:a,flexController:this.oFlexController}),this,s).then(function(){delete this.oData[s];delete this.oVariantController.getChangeFileContent()[s];this._ensureStandardVariantExists(s);}.bind(this));}.bind(this));c.initialize({model:this});c.update({parameters:[],updateHashEntry:true,model:this});return this._oVariantSwitchPromise;}function d(E,p){return h(function(P,v){var m=v.model;var s=v.vmReference;var j=false;var t=P.key;var S=P.key;return Promise.resolve().then(function(){if(O.get([s,"currentVariant"],m.oData)&&m.oData[s].currentVariant!==m.oData[s].originalCurrentVariant){S=m.oData[s].originalCurrentVariant;j=true;return m.updateCurrentVariant(s,t,m.oAppComponent,true);}}).then(function(){if(O.get([s,"modified"],m.oData)===true){var k=m.oVariantController.getVariantChanges(s,S,true);return e({changes:k,vmReference:s,vReference:S,revert:!j,model:m}).then(function(){m.oData[s].originalCurrentVariant=t;m.oData[s].modified=false;m.checkUpdate(true);});}});}.bind(null,E.getParameters(),p),p.model,p.vmReference);}function e(p){var v=p.model._getDirtyChangesFromVariantChanges(p.changes);return Promise.resolve().then(function(){if(p.revert){return R.revertMultipleChanges(v,{appComponent:p.model.oAppComponent,modifier:a,flexController:p.model.oFlexController});}}).then(function(){v.forEach(function(o){p.model.oVariantController.removeChangeFromVariant(o,p.vmReference,p.vReference);p.model.oFlexController.deleteChange(o,p.model.oAppComponent);});});}function g(m,v,j){m.oData[v].variantBusy=j;m.checkUpdate();}function h(j,m,v){m._oVariantSwitchPromise=m._oVariantSwitchPromise.catch(function(){}).then(g.bind(null,m,v,true)).then(j).then(g.bind(null,m,v,false)).catch(function(E){g(m,v,false);throw E;});m.oFlexController.setVariantSwitchPromise(m._oVariantSwitchPromise);return m._oVariantSwitchPromise;}var V=J.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,F,A,o){this.pSequentialImportCompleted=Promise.resolve();J.apply(this,arguments);this.bObserve=o;if(!F){F=sap.ui.requireSync("sap/ui/fl/FlexControllerFactory").createForControl(A);}this.oFlexController=F;this.oChangePersistence=this.oFlexController._oChangePersistence;this.oVariantController=this.oChangePersistence._oVariantController;this.oAppComponent=A;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this.oVariantController.assignResetMapListener(_.bind(this));c.initialize({model:this});if(D&&typeof D==="object"){Object.keys(D).forEach(function(k){D[k].variants.forEach(function(v){if(!D[k].currentVariant&&(v.key===D[k].defaultVariant)){D[k].currentVariant=v.key;}v.originalTitle=v.title;v.originalFavorite=v.favorite;v.originalVisible=v.visible;});D[k].originalCurrentVariant=D[k].currentVariant;D[k].originalDefaultVariant=D[k].defaultVariant;});this.setData(D);}}});V.prototype.updateCurrentVariant=function(v,n,A,I){var s=this.oData[v].originalCurrentVariant;var p={variantManagementReference:v,currentVariantReference:s,newVariantReference:n};var S=function(p){var m=this.oChangePersistence.loadSwitchChangesMapForComponent(p);return R.revertMultipleChanges(m.changesToBeReverted,{appComponent:A||this.oAppComponent,modifier:a,flexController:this.oFlexController}).then(this.oFlexController.applyVariantChanges.bind(this.oFlexController,m.changesToBeApplied,A||this.oAppComponent)).then(function(){this.oData[v].originalCurrentVariant=n;this.oData[v].currentVariant=n;if(this.oData[v].updateVariantInURL){c.updateVariantInURL({vmReference:v,newVReference:n,model:this});this.oVariantController.updateCurrentVariantInMap(v,n);}this.checkUpdate();}.bind(this));}.bind(this,p);if(I){return S();}return h(S,this,v);};V.prototype.getCurrentVariantReference=function(v){return this.oData[v].currentVariant;};V.prototype.getVariantManagementReference=function(v){var s="";var I=-1;Object.keys(this.oData).some(function(k){return this.oData[k].variants.some(function(o,j){if(o.key===v){s=k;I=j;return true;}});}.bind(this));return{variantManagementReference:s,variantIndex:I};};V.prototype.getVariant=function(v,s){return this.oVariantController.getVariant(s||this.getVariantManagementReference(v).variantManagementReference,v);};V.prototype.getVariantProperty=function(v,p){return this.getVariant(v).content.content[p];};V.prototype.addChange=function(o){var v=o.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;this.oData[s].modified=!!this.oData[s].variantsEditable;this.checkUpdate(true);return this.oVariantController.addChangeToVariant(o,s,v);};V.prototype.removeChange=function(o){var v=o.getVariantReference();var s=this.getVariantManagementReference(v).variantManagementReference;return this.oVariantController.removeChangeFromVariant(o,s,v);};V.prototype._getVariantTitleCount=function(n,v){var D=this.getData();return D[v].variants.reduce(function(j,o){if(n.toLowerCase()===o.title.toLowerCase()&&o.visible){j++;}return j;},0);};V.prototype._duplicateVariant=function(p){var n=p.newVariantReference;var s=p.sourceVariantReference;var v=p.variantManagementReference;var S=this.getVariant(s);var j=this.oVariantController.getVariantChanges(v,s,true).map(function(m){return m.getDefinition();});var D={content:{},controlChanges:j,variantChanges:{}};var k=L.compareAgainstCurrentLayer(S.content.layer,!this._bDesignTimeMode?"USER":"");Object.keys(S.content).forEach(function(K){if(K==="fileName"){D.content[K]=n;}else if(K==="variantReference"){if(k===0){D.content[K]=S.content["variantReference"];}else if(k===-1){D.content[K]=s;}}else if(K==="content"){D.content[K]=JSON.parse(JSON.stringify(S.content[K]));D.content.content.title=p.title;}else{D.content[K]=S.content[K];}});D.content["layer"]=p.layer;j=D.controlChanges.slice();var o={};var l;D.controlChanges=j.reduce(function(m,q){if(L.compareAgainstCurrentLayer(q.layer,!this._bDesignTimeMode?"USER":"")===0){o=f({},q);o.variantReference=D.content.fileName;if(!o.support){o.support={};}o.support.sourceChangeFileName=q.fileName;o.packageName="$TMP";l=C.createInitialFileContent(o);m.push(new C(l));}return m;}.bind(this),[]);return D;};V.prototype.copyVariant=function(p){var D=this._duplicateVariant(p);var v={key:D.content.fileName,layer:p.layer,title:D.content.content.title,originalTitle:D.content.content.title,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true};var o=this.oFlexController.createVariant(D,p.appComponent);var j=[];[o].concat(o.getControlChanges()).forEach(function(k){j.push(this.oChangePersistence.addDirtyChange(k));}.bind(this));var I=this.oVariantController.addVariantToVariantManagement(f({},o.getDefinitionWithChanges(),{content:{content:{visible:v.visible,favorite:v.favorite}}}),p.variantManagementReference);this.oData[p.variantManagementReference].variants.splice(I,0,v);return this.updateCurrentVariant(p.variantManagementReference,o.getId(),p.appComponent,true).then(function(){return j;});};V.prototype.removeVariant=function(p){var j=this.oChangePersistence.getDirtyChanges().filter(function(o){return(o.getVariantReference&&o.getVariantReference()===p.variant.getId())||o.getId()===p.variant.getId();});return this.updateCurrentVariant(p.variantManagementReference,p.sourceVariantReference,p.component).then(function(){var I=this.oVariantController.removeVariantFromVariantManagement(p.variant,p.variantManagementReference);this.oData[p.variantManagementReference].variants.splice(I,1);this.checkUpdate();j.forEach(function(o){this.oChangePersistence.deleteChange(o);}.bind(this));}.bind(this));};V.prototype.collectModelChanges=function(v,l){var D=this.getData()[v];var m=D.variants;var j=[];var p={};m.forEach(function(o){if(o.originalTitle!==o.title){p={variantReference:o.key,changeType:"setTitle",title:o.title,originalTitle:o.originalTitle,layer:l};j.push(p);}if(o.originalFavorite!==o.favorite){p={variantReference:o.key,changeType:"setFavorite",favorite:o.favorite,originalFavorite:o.originalFavorite,layer:l};j.push(p);}if(!o.visible&&o.originalVisible){p={variantReference:o.key,changeType:"setVisible",visible:false,layer:l};j.push(p);}});if(D.originalDefaultVariant!==D.defaultVariant){p={variantManagementReference:v,changeType:"setDefault",defaultVariant:D.defaultVariant,originalDefaultVariant:D.originalDefaultVariant,layer:l};j.push(p);}return j;};V.prototype.manageVariants=function(v,s,l,j){return new Promise(function(r){v.attachEventOnce("manage",{resolve:r,variantManagementReference:s,layer:l},this.fnManageClickRta,this);v.openManagementDialog(true,j);}.bind(this));};V.prototype.setVariantProperties=function(v,p,A){var j=-1;var o;var k=null;var D=this.getData();if(p.variantReference){j=this.getVariantManagementReference(p.variantReference).variantIndex;o=D[v].variants[j];}var n={};var m={};switch(p.changeType){case"setTitle":m.title=p.title;o.title=p.title;o.originalTitle=o.title;break;case"setFavorite":m.favorite=p.favorite;o.favorite=p.favorite;o.originalFavorite=o.favorite;break;case"setVisible":m.visible=p.visible;m.createdByReset=false;o.visible=p.visible;o.originalVisible=o.visible;break;case"setDefault":m.defaultVariant=p.defaultVariant;D[v].defaultVariant=p.defaultVariant;D[v].originalDefaultVariant=D[v].defaultVariant;var H=c.getStoredHashParams({model:this});if(H){if(D[v].defaultVariant!==D[v].currentVariant&&H.indexOf(D[v].currentVariant)===-1){c.update({parameters:H.concat(D[v].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(D[v].defaultVariant===D[v].currentVariant&&H.indexOf(D[v].currentVariant)>-1){H.splice(H.indexOf(D[v].currentVariant),1);c.update({parameters:H,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(!A&&D[v].currentVariant!==p.defaultVariant){this.updateCurrentVariant(v,p.defaultVariant,p.appComponent);}break;default:break;}if(j>-1){var s=this.oVariantController._setVariantData(m,v,j);D[v].variants.splice(j,1);D[v].variants.splice(s,0,o);}else if(this.oVariantController._mVariantManagement[v]){this.oVariantController._mVariantManagement[v].defaultVariant=p.defaultVariant;}if(A===true){n.changeType=p.changeType;n.layer=p.layer;if(p.changeType==="setDefault"){n.fileType="ctrl_variant_management_change";n.selector=a.getSelector(v,p.appComponent);}else{if(p.changeType==="setTitle"){b.setTextInChange(n,"title",p.title,"XFLD");}n.fileType="ctrl_variant_change";n.selector=a.getSelector(p.variantReference,p.appComponent);}k=this.oFlexController.createBaseChange(n,p.appComponent);k.setContent(m);this.oVariantController._updateChangesForVariantManagementInMap(k.getDefinition(),v,true);this.oChangePersistence.addDirtyChange(k);}else{if(p.change){this.oVariantController._updateChangesForVariantManagementInMap(p.change.getDefinition(),v,false);this.oChangePersistence.deleteChange(p.change);}}this.setData(D);this.checkUpdate(true);return k;};V.prototype._ensureStandardVariantExists=function(v){if(!this.oVariantController){throw new Error("An sap.ui.fl.variants.VariantController instance was not found.");}var D=this.getData();if(!D[v]){D[v]={currentVariant:v,originalCurrentVariant:v,defaultVariant:v,originalDefaultVariant:v,variants:[{key:v,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,visible:true,originalVisible:true,author:this.oVariantController.DEFAULT_AUTHOR}]};this.setData(D);var o={changes:{variantSection:{}}};var j={defaultVariant:v,variantManagementChanges:{},variants:[{content:{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",support:{user:this.oVariantController.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE")}},controlChanges:[],variantChanges:{}}]};o.changes.variantSection[v]=j;this.oVariantController.setChangeFileContent(o,{});}};V.prototype.setModelPropertiesForControl=function(v,D,o){var r=function(k,v,D){if((k.layer===L.getCurrentLayer(!D))&&(k.key!==v)){return true;}return false;};this.oData[v].modified=false;this.oData[v].showFavorites=true;var j=this._bDesignTimeMode;if(j!==D){this._bDesignTimeMode=D;if(D){c.clearAllVariantURLParameters({model:this});}else if(j){c.update({parameters:c.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}o.detachManage(this.fnManageClick,this);if(D){this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(k){k.rename=true;k.change=true;k.remove=r(k,v,D);});}else{if(this.oData[v]._isEditable){o.attachManage({variantManagementReference:v},this.fnManageClick,this);this.oData[v].variantsEditable=true;this.oData[v].variants.forEach(function(k){k.remove=r(k,v,D);if(k.layer===L.getCurrentLayer(true)){k.rename=true;k.change=true;}else{k.rename=false;k.change=false;}});}else{this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(k){k.remove=false;k.rename=false;k.change=false;});}}};V.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var j=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(j);};this.fnManageClick=function(E,D){if(!this.oFlexController||!this.oVariantController){return;}var j=this.collectModelChanges(D.variantManagementReference,L.getCurrentLayer(true));j.forEach(function(o){o.appComponent=this.oAppComponent;this.setVariantProperties(D.variantManagementReference,o,true);}.bind(this));this.oChangePersistence.saveDirtyChanges();};};V.prototype._handleSave=function(E){var v=E.getSource();var A=U.getAppComponentForControl(v);var s=this.getLocalId(v.getId(),A);return h(function(j,A,p){var S=p["def"];var k=this.getCurrentVariantReference(j);var l=this.oVariantController.getVariantChanges(j,k,true);if(p["overwrite"]){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(l)).then(function(r){this.checkDirtyStateForControlModels([j]);return r;}.bind(this));}var n=U.createDefaultFileName();var P={variantManagementReference:j,appComponent:A,layer:L.getCurrentLayer(true),title:p["name"],sourceVariantReference:k,newVariantReference:n};return this.copyVariant(P).then(function(m){if(S){var o={changeType:"setDefault",defaultVariant:n,originalDefaultVariant:this.oData[j].defaultVariant,appComponent:A,layer:L.getCurrentLayer(true),variantManagementReference:j};var q=this.setVariantProperties(j,o,true);m.push(q);}this.oData[j].modified=false;this.checkUpdate(true);return e({changes:l,vmReference:j,vReference:k,model:this}).then(this.oFlexController.saveSequenceOfDirtyChanges.bind(this.oFlexController,m));}.bind(this));}.bind(this,s,A,E.getParameters()),this,s);};V.prototype.getLocalId=function(I,A){return a.getSelector(I,A).id;};V.prototype.getVariantManagementReferenceForControl=function(v){var s=v.getId();var A=U.getAppComponentForControl(v);return(A&&A.getLocalId(s))||s;};V.prototype.switchToDefaultForVariantManagement=function(v){if(this.oData[v].currentVariant!==this.oData[v].defaultVariant){B.show(200);this.updateCurrentVariant(v,this.oData[v].defaultVariant).then(function(){B.hide();});}};V.prototype.switchToDefaultForVariant=function(v){Object.keys(this.oData).forEach(function(s){if(!v||this.oData[s].currentVariant===v){this.switchToDefaultForVariantManagement(s);}}.bind(this));};V.prototype.registerToModel=function(v){var s=this.getVariantManagementReferenceForControl(v);this._ensureStandardVariantExists(s);this.oData[s]._isEditable=v.getEditable();v.attachEvent("select",{vmReference:s,model:this},d);v.attachSave(this._handleSave,this);this.setModelPropertiesForControl(s,false,v);var u=v.getUpdateVariantInURL();this.oData[s].updateVariantInURL=u;c.attachHandlers({vmReference:s,updateURL:!!u,model:this});c.handleModelContextChange({model:this,vmControl:v});};V.prototype._getDirtyChangesFromVariantChanges=function(j){var k=j.map(function(o){return o.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(o){return i(k,o.getId());});};V.prototype.checkDirtyStateForControlModels=function(v){v.forEach(function(s){var m=this.oData[s];if(m.modified===true){var j=this.getCurrentVariantReference(s);var k=this.oVariantController.getVariantChanges(s,j,true);var D=this._getDirtyChangesFromVariantChanges(k);if(D.length===0){m.modified=false;}}}.bind(this));this.checkUpdate(true);};V.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(j,v){return j.concat([this.oData[v].currentVariant]);}.bind(this),[]);};return V;},true);
