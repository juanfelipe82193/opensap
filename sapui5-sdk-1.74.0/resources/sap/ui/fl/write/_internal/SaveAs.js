/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/descriptorRelated/api/DescriptorVariantFactory","sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/Utils","sap/ui/fl/Change","sap/base/Log","sap/base/util/includes","sap/base/util/merge"],function(D,a,C,U,b,L,i,m){"use strict";function _(p){if(p&&p.package&&p.transport&&p.selector&&p.selector.appId){return Promise.resolve({packageName:p.package,transport:p.transport});}return Promise.resolve({packageName:"",transport:""});}function c(A,t){if(t){if(t.transport&&t.packageName!=="$TMP"){return A.setTransportRequest(t.transport).then(A.setPackage(t.packageName));}return Promise.resolve();}return Promise.reject();}function d(n){var I=[];n.forEach(function(o){var p=o.getDefinition();I.push(a.createNew(p.changeType,p.content,p.texts));});return Promise.all(I);}function e(o,A){var p={reference:A.getId()};var s=U.createNamespace(p,"changes");o.setNamespace(s);o.setComponent(A.getId());if(A.getVersion()){o.setValidAppVersions({creation:A.getVersion(),from:A.getVersion()});}}function f(A,o){var n=[];A.forEach(function(I){I.replaceHostingIdForTextKey(o.getId(),o.getReference(),I.getContent(),I.getTexts());n.push(o.addDescriptorInlineChange(I));});return Promise.all(n);}function g(s){var o=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;if(o){var n=o.getDirtyChanges();n=n.slice();return n;}return[];}function h(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;if(F){var u=F.getDirtyChanges();u=u.slice();return u;}return[];}function j(s){var F=C.getFlexControllerInstance(s)._oChangePersistence;var o=C.getDescriptorFlexControllerInstance(s)._oChangePersistence;return F===o;}function k(s,A,o){var n=[];if(A){g(s).forEach(function(p){if(i(a.getDescriptorChangeTypes(),p.getDefinition().changeType)){n.push(p);}else{e(p,o);}});}else{h(s).forEach(function(p){e(p,o);});n=g(s);}return n;}function l(s){g(s).forEach(function(o){if(i(a.getDescriptorChangeTypes(),o.getChangeType())){C.getDescriptorFlexControllerInstance(s)._oChangePersistence.deleteChange(o);}});}var S={saveAs:function(p){var A;var o;var n=false;return D.createAppVariant(p).then(function(q){A=m({},q);return _(p);}).then(function(t){return c(A,t);}).then(function(){n=j(p.selector);var q=k(p.selector,n,A);return d(q);}).then(function(q){return f(q,A);}).then(function(){return A.submit().catch(function(E){E.messageKey="MSG_SAVE_APP_VARIANT_FAILED";E.saveAsFailed=true;throw E;});}).then(function(r){o=m({},r);if(n){l(p.selector);}var F=C.getFlexControllerInstance(p.selector);var u=h(p.selector);if(u.length){return F.saveAll(true).catch(function(E){if(n){l(p.selector);}return this.deleteAppVariant({referenceAppId:p.id}).then(function(){E.messageKey="MSG_COPY_UNSAVED_CHANGES_FAILED";throw E;});}.bind(this));}return Promise.resolve();}.bind(this)).then(function(){if(!n){l(p.selector);}return o;}).catch(function(E){L.error("the app variant could not be created.",E.message||E.name);throw E;});},updateAppVariant:function(p){var A;var o;return D.loadAppVariant(p.referenceAppId,false,p.layer,p.bIsForSapDelivery).then(function(n){if(!n){throw new Error("App variant with ID: "+p.referenceAppId+"does not exist");}A=m({},n);if(p&&p.transport&&p.selector&&p.selector.appId){A.setTransportRequest(p.transport);}}).then(function(){var n=[];g(p.selector).forEach(function(q){if(i(a.getDescriptorChangeTypes(),q.getDefinition().changeType)){n.push(q);}});return d(n);}).then(function(n){return f(n,A);}).then(function(){return A.submit().catch(function(E){if(E==="cancel"){return Promise.reject("cancel");}E.messageKey="MSG_UPDATE_APP_VARIANT_FAILED";throw E;});}).then(function(r){o=m({},r);l(p.selector);return o;}).catch(function(E){if(E!=="cancel"){L.error("the app variant could not be updated.",E.message||E.name);throw E;}});},deleteAppVariant:function(p){var A;return D.loadAppVariant(p.referenceAppId,true,p.layer).catch(function(E){E.messageKey="MSG_LOAD_APP_VARIANT_FAILED";throw E;}).then(function(o){A=m({},o);}).then(function(){return A.submit().catch(function(E){if(E==="cancel"){return Promise.reject("cancel");}E.messageKey="MSG_DELETE_APP_VARIANT_FAILED";throw E;});}).catch(function(E){if(E!=="cancel"){L.error("the app variant could not be deleted.",E.message||E.name);throw E;}});}};return S;},true);
