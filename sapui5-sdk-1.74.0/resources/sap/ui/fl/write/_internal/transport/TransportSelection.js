/*
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/write/_internal/transport/Transports","sap/ui/fl/write/_internal/transport/TransportDialog","sap/ui/fl/registry/Settings","sap/ui/core/BusyIndicator"],function(L,a,T,b,F,B){"use strict";var c=function(){this.oTransports=new sap.ui.fl.write._internal.transport.Transports();};c.prototype.selectTransport=function(o,O,e,C,d,s){var r=function(o,O,e,C,s,A){this.oTransports.getTransports(o).then(function(g){if(this._checkDialog(g,A)){this._openDialog({hidePackage:!L.doesCurrentLayerRequirePackage(),pkg:o.package,transports:g.transports,lrepObject:this._toLREPObject(o)},O,e,C,s);}else{var t=(!g.localonly&&A)?{transportId:"ATO_NOTIFICATION"}:this._getTransport(g);O(this._createEventObject(o,t));}}.bind(this),function(R){e(R);});};var l=L.getCurrentLayer(false);if(l&&((l===a.CUSTOMER)||(l===a.CUSTOMER_BASE))){F.getInstance().then(function(S){if(S.isAtoEnabled()){if(!(o&&o.name&&o.namespace&&o.type)){var t={transportId:"ATO_NOTIFICATION"};O(this._createEventObject(o,t));}else{r.apply(this,[o,O,e,C,s,true]);}}else{r.apply(this,[o,O,e,C,s,false]);}}.bind(this));}else{r.apply(this,[o,O,e,C,s,false]);}};c.prototype._createEventObject=function(o,t){return{mParameters:{selectedTransport:t.transportId,selectedPackage:o["package"],dialog:false},getParameters:function(){return this.mParameters;},getParameter:function(n){return this.mParameters[n];}};};c.prototype._toLREPObject=function(o){var O={};if(o.namespace){O.namespace=o.namespace;}if(o.name){O.name=o.name;}if(o.type){O.type=o.type;}return O;};c.prototype._openDialog=function(C,o,e,d,s){var D=new b(C);D.attachOk(o);D.attachCancel(e);D.addStyleClass(s);if(d){D.addStyleClass("sapUiSizeCompact");}else{D.removeStyleClass("sapUiSizeCompact");}D.open();B.hide();return D;};c.prototype._getTransport=function(t){var o;if(!t.localonly){o=this._hasLock(t.transports);}else{o={transportId:""};}return o;};c.prototype._checkDialog=function(t,A){if(t){if(t.localonly||this._hasLock(t.transports)||(!t.localonly&&A)){return false;}}return true;};c.prototype._hasLock=function(t){var l=t.length;while(l--){var o=t[l];if(o.locked){return o;}}return false;};c.prototype.setTransports=function(C,o){var i=C.length-1;var t=this;var s=function(C,i,o,d,f){if(i>=0){var e=C[i];if(f===true){if(e.getDefinition().packageName!=="$TMP"){e.setRequest(d);}i--;return s(C,i,o,d,f);}if(e.getDefinition().packageName!=="$TMP"){return t.openTransportSelection(e,o).then(function(g){if(g==="cancel"){return Promise.reject("cancel");}e.setRequest(g.transport);if(g.fromDialog===true){d=g.transport;f=true;}i--;return s(C,i,o,d,f);},function(){return null;});}i--;return s(C,i,o,d,f);}return Promise.resolve();};return s(C,i,o);};c.prototype.openTransportSelection=function(C,o,s){var t=this;return new Promise(function(r,d){var O=function(R){if(R&&R.getParameters){var g=R.getParameters().selectedTransport;var p=R.getParameters().selectedPackage;var h=R.getParameters().dialog;var i={transport:g,packageName:p,fromDialog:h};r(i);}else{r({});}};var e=function(E){if(E.sId==='cancel'){r(E.sId);}else{d(E);}};var f={};if(C){f["package"]=C.getPackage();f.namespace=C.getNamespace();f.name=C.getId();f.type=C.getDefinition().fileType;}t.selectTransport(f,O,e,false,o,s);});};c.prototype.checkTransportInfo=function(t){return t&&t.transport&&t.packageName!=="$TMP";};c.prototype._prepareChangesForTransport=function(t,A,d,C){var o=new T();var e=o._convertToChangeTransportData(A,d);var f={};f.package=t.packageName;f.transportId=t.transport;f.changeIds=e;f.reference=C.reference;f.appVersion=C.appVersion;f.layer=C.layer;return o.makeChangesTransportable(f).then(function(){A.forEach(function(g){if(g.getPackage()==='$TMP'){var D=g.getDefinition();D.packageName=t.packageName;g.setResponse(D);}});});};return c;},true);
