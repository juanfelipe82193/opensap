/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/descriptorRelated/api/DescriptorInlineChangeFactory","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/_internal/SaveAs","sap/base/Log"],function(i,_,J,F,C,D,a,S,L){"use strict";function b(o){return(o._getMap&&i(D.getDescriptorChangeTypes(),o._getMap().changeType))||(o.getChangeType&&i(D.getDescriptorChangeTypes(),o.getChangeType()));}function h(p){p.includeCtrlVariants=true;p.invalidateCache=false;return P._getUIChanges(p).then(function(d){return d.length>0;});}function c(p){p.includeCtrlVariants=true;p.invalidateCache=false;return P._getUIChanges(p).then(function(d){return d.some(function(o){return o.packageName==="$TMP"||o.packageName==="";});});}var P={hasHigherLayerChanges:function(p){return C.getFlexControllerInstance(p.selector).hasHigherLayerChanges(_(p,"selector"));},save:function(p){var f=C.getFlexControllerInstance(p.selector);var d=C.getDescriptorFlexControllerInstance(p.selector);if(p.selector.appId){if(!p.layer){return Promise.reject("Layer must be provided");}if(p.isForSAPDelivery&&p.layer==='CUSTOMER'){return Promise.reject("Layer provided is not compatible");}p.referenceAppId=d.getComponentName();return S.updateAppVariant(p);}p.invalidateCache=true;p.componentId=C.getAppComponentForSelector(p.selector).getId();return f.saveAll(p.skipUpdateCache,p.draft).then(d.saveAll.bind(d,p.skipUpdateCache,p.draft)).then(P._getUIChanges.bind(null,_(p,"skipUpdateCache")));},getResetAndPublishInfo:function(p){return Promise.all([h(p),c(p),a.isPublishAvailable()]).then(function(r){var f={isResetEnabled:r[0],isPublishEnabled:r[1]};var d=r[2];var I=!f.isResetEnabled||(d&&!f.isPublishEnabled);if(I){return C.getFlexControllerInstance(p.selector).getResetAndPublishInfo(p).then(function(R){f.isResetEnabled=f.isResetEnabled||R.isResetEnabled;f.isPublishEnabled=f.isPublishEnabled||R.isPublishEnabled;return f;}).catch(function(e){L.error("Sending request to flex/info route failed: "+e.message);return f;});}return f;});},reset:function(p){var A=C.getAppComponentForSelector(p.selector);var f=C.getFlexControllerInstance(A);var d=[p.layer,p.generator,A,p.selectorIds,p.changeTypes];return f.resetChanges.apply(f,d);},publish:function(p){p.styleClass=p.styleClass||"";var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A)._oChangePersistence.transportAllUIChanges({},p.styleClass,p.layer,p.appVariantDescriptors);},add:function(p){if(b(p.change)){return p.change.store();}var A=C.getAppComponentForSelector(p.selector);return C.getFlexControllerInstance(A).addPreparedChange(p.change,A);},remove:function(p){if(!p.selector){throw new Error("An invalid selector was passed so change could not be removed with id: "+p.change.getId());}var A=C.getAppComponentForSelector(p.selector);if(!A){throw new Error("Invalid application component for selector, change could not be removed with id: "+p.change.getId());}if(b(p.change)){var d=C.getDescriptorFlexControllerInstance(A);d.deleteChange(p.change,A);return;}var e=J.bySelector(p.change.getSelector(),A);var f=C.getFlexControllerInstance(A);if(e){F.destroyAppliedCustomData(e,p.change,J);}f.deleteChange(p.change,A);},_getUIChanges:function(p){if(p.layer){p.currentLayer=p.layer;}return C.getFlexControllerInstance(p.selector)._oChangePersistence.getChangesForComponent(_(p,["invalidateCache","selector"]),p.invalidateCache);}};return P;},true);
