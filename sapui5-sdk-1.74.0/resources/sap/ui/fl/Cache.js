/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LrepConnector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Utils","sap/base/Log"],function(L,F,U,a){"use strict";var C=function(){};function _(s){return F.getFlexObjectsFromStorageResponse(s).changes;}function b(s,d){if(!d){return s;}return s===C.NOTAG?s.replace(/>$/,''.concat('-',d,'>')):s.concat('-',d);}function c(s){return s.replace(/(^W\/|")/g,'');}C.NOTAG="<NoTag>";C.clearEntries=function(){F.clearState();};C.getChangesFillingCache=function(m,p,i){var P=Promise.resolve();if(i){P=F.clearAndInitialize(p);}return P.then(function(){return F.getStorageResponse(m.name);}).catch(function(){return{};});};C.getCacheKey=function(m,A){if(!m||!m.name||!A){a.warning("Not all parameters were passed to determine a flexibility cache key.");return Promise.resolve(C.NOTAG);}return this.getChangesFillingCache(m).then(function(w){if(w&&w.etag){return c(w.etag);}return C.NOTAG;}).then(function(s){var v=A.getModel(U.VARIANT_MODEL_NAME);var d=v?v.getCurrentControlVariantIds():[];return b(s,d.join("-"));});};C.addChange=function(o,d){var e=_(o.name);if(!e){return;}e.push(d);};C.setVariantManagementSection=function(o,v){var f=F.getFlexObjectsFromStorageResponse(o.name);if(!f.variantSection){return;}f.variantSection=v;};C.updateChange=function(o,d){var e=_(o.name);if(!e){return;}for(var i=0;i<e.length;i++){if(e[i].fileName===d.fileName){e.splice(i,1,d);break;}}};C.deleteChange=function(o,d){var e=_(o.name);if(!e){return;}for(var i=0;i<e.length;i++){if(e[i].fileName===d.fileName){e.splice(i,1);break;}}};C.removeChanges=function(o,d){var e=F.getFlexObjectsFromStorageResponse(o.name);e.changes=e.changes.filter(function(f){return d.indexOf(f.fileName)===-1;});var v=e.variantSection;Object.keys(v).forEach(function(i){v[i].variants.forEach(function(V){V.controlChanges=V.controlChanges.filter(function(f){return d.indexOf(f.getFileName())===-1;});});});};C.getPersonalization=function(r,s,i){var m={name:r};return this.getChangesFillingCache(m).then(function(R){if(!R||!R.changes||!R.changes.ui2personalization||!R.changes.ui2personalization[s]){return i?undefined:[];}if(!i){return R.changes.ui2personalization[s]||[];}return R.changes.ui2personalization[s].filter(function(e){return e.itemName===i;})[0];});};C.setPersonalization=function(p){if(!p||!p.reference||!p.containerKey||!p.itemName||!p.content){return Promise.reject("not all mandatory properties were provided for the storage of the personalization");}return L.createConnector().send("/sap/bc/lrep/ui2personalization/","PUT",p,{}).then(this._addPersonalizationToEntries.bind(this,p));};C._addPersonalizationToEntries=function(p){var e=F.getFlexObjectsFromStorageResponse(p.reference);var P=e.ui2personalization;if(!P[p.containerKey]){P[p.containerKey]=[];}P[p.containerKey].push(p);};C.deletePersonalization=function(r,s,i){if(!r||!s||!i){return Promise.reject("not all mandatory properties were provided for the storage of the personalization");}var u="/sap/bc/lrep/ui2personalization/?reference=";u+=r+"&containerkey="+s+"&itemname="+i;return L.createConnector().send(u,"DELETE",{}).then(this._removePersonalizationFromEntries.bind(this,r,s,i));};C._removePersonalizationFromEntries=function(r,s,i){var g=C.getPersonalization(r,s);var G=C.getPersonalization(r,s,i);return Promise.all([g,G]).then(function(p){var I=p[0];var t=p[1];var n=I.indexOf(t);I.splice(n,1);});};return C;},true);
