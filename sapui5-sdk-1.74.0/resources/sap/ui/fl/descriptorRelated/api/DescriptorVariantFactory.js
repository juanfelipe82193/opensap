/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/descriptorRelated/internal/Utils","sap/ui/fl/registry/Settings","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/ui/fl/write/_internal/connectors/LrepConnector"],function(L,U,S,q,b,a){"use strict";var D=function(p,f,d,s){if(p&&d){this._id=p.id;this._mode='DELETION';this._mMap=f;}else if(p){this._id=p.id;this._reference=p.reference;this._layer=p.layer;if(typeof p.referenceVersion!=="undefined"){this._referenceVersion=p.referenceVersion;}this._mode='NEW';this._skipIam=p.skipIam;this._version=p.version;}else if(f){this._mMap=f;this._mode='FROM_EXISTING';}this._oSettings=s;this._sTransportRequest=null;this._content=[];};D.prototype.addDescriptorInlineChange=function(d){var t=this;return new Promise(function(r){var s=function(_,i){if(_["setHostingIdForTextKey"]){_.setHostingIdForTextKey(i);}};switch(t._mode){case'NEW':s(d,t._id);t._content.push(d.getMap());break;case'FROM_EXISTING':s(d,t._mMap.id);t._mMap.content.push(d.getMap());break;default:}r(null);});};D.prototype.setTransportRequest=function(t){try{U.checkTransportRequest(t);}catch(e){return Promise.reject(e);}this._sTransportRequest=t;return Promise.resolve();};D.prototype.setPackage=function(p){try{U.checkPackage(p);}catch(e){return Promise.reject(e);}this._package=p;return Promise.resolve();};D.prototype.submit=function(){var m=this._getMap();var p={flexObject:{},settings:this._oSettings,appVariant:this};if(this._sTransportRequest){p.transport=this._sTransportRequest;}if(this._skipIam){p.skipIam=this._skipIam;}if(m.layer){p.layer=m.layer;}if(!p.url){p.url="/sap/bc/lrep";}var B;switch(this._mode){case'NEW':Object.assign(p.flexObject,m);B=a.appVariant.create(p);break;case'FROM_EXISTING':p.reference=m.id;Object.assign(p.flexObject,m);B=a.appVariant.update(p);break;case'DELETION':p.reference=m.id;B=a.appVariant.remove(p);break;default:return Promise.reject("Please provide a valid operation.");}return B.then(function(r){return r;});};D.prototype.getId=function(){return this._getMap().id;};D.prototype.setReference=function(r){if(r===undefined||typeof r!=="string"){throw new Error("No parameter sReference of type string provided");}this._reference=r;};D.prototype.getReference=function(){return this._reference;};D.prototype.getVersion=function(){return this._version;};D.prototype.getNamespace=function(){return this._getMap().namespace;};D.prototype.getPackage=function(){return this._getMap().packageName;};D.prototype.getDefinition=function(){return this._getMap();};D.prototype.getSettings=function(){return this._oSettings;};D.prototype.getJson=function(){return b({},this._getMap());};D.prototype._getMap=function(){switch(this._mode){case'NEW':var r={fileName:this._getNameAndNameSpace().fileName,fileType:"appdescr_variant",namespace:this._getNameAndNameSpace().namespace,layer:this._layer,packageName:this._package?this._package:"",reference:this._reference,id:this._id,content:this._content};if(typeof this._referenceVersion!=="undefined"){r.referenceVersion=this._referenceVersion;}if(this._version){r.version=this._version;}return r;case'FROM_EXISTING':case'DELETION':{return this._mMap;}default:}};D.prototype._getNameAndNameSpace=function(){return U.getNameAndNameSpace(this._id,this._reference);};var c={};c._getDescriptorVariant=function(p){if(!p.url){p.url="/sap/bc/lrep";}return a.appVariant.load(p);};c.createNew=function(p){return c.createAppVariant(p);};c.createAppVariant=function(p){U.checkParameterAndType(p,"reference","string");U.checkParameterAndType(p,"id","string");if(p.version){U.checkParameterAndType(p,"version","string");}if(!p.layer){p.layer='CUSTOMER';}else{U.checkParameterAndType(p,"layer","string");}if(p.skipIam){U.checkParameterAndType(p,"skipIam","boolean");}return S.getInstance().then(function(s){return Promise.resolve(new D(p,null,false,s));});};c.createForExisting=function(i){return c.loadAppVariant(i,false);};c.createFromJson=function(p){if(!q.isPlainObject(p)){throw new Error("Parameter \"mParameters\" must be provided of type object");}return S.getInstance().then(function(s){return Promise.resolve(new D(null,p,false,s));});};c.createDeletion=function(i){return c.loadAppVariant(i,true);};c.loadAppVariant=function(i,d,l,I){if(i===undefined||typeof i!=="string"){throw new Error("Parameter \"sId\" must be provided of type string");}var _;return c._getDescriptorVariant({reference:i,layer:l,isForSAPDelivery:I}).then(function(r){_=r;return S.getInstance();}).then(function(s){var m=_.response;if(!q.isPlainObject(m)){m=JSON.parse(m);}return d?Promise.resolve(new D({id:i},m,d,s)):Promise.resolve(new D(null,m,d,s));});};return c;},true);
