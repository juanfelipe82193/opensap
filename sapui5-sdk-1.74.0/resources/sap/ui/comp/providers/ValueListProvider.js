/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/library','sap/ui/comp/library','sap/m/library','sap/ui/comp/odata/MetadataAnalyser','sap/ui/core/SeparatorItem','sap/m/GroupHeaderListItem','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Token','./BaseValueListProvider','sap/ui/core/ListItem','sap/ui/model/Filter','sap/ui/model/Sorter','sap/ui/model/json/JSONModel','sap/ui/model/FilterOperator','sap/ui/comp/util/FormatUtil','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/Device','sap/base/Log'],function(c,l,L,M,S,G,C,d,T,e,B,f,F,g,J,h,j,k,D,m){"use strict";var n=l.smartfilterbar.DisplayBehaviour;var P=L.PopinDisplay;var W=L.WrappingType;var V=c.ValueState;var H={Recommendations:10,RecentlyUsed:20,Others:30};var o="order";var p="list";var q=B.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(a){if(!k){k=sap.ui.require("sap/ui/comp/smartfilterbar/FilterProvider");}if(a){this.sAggregationName=a.aggregation;this.bTypeAheadEnabled=!!a.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=a.enableShowTableSuggestionValueHelp===undefined?true:a.enableShowTableSuggestionValueHelp;this.dropdownItemKeyType=a.dropdownItemKeyType;this.sDeferredGroupId=a.deferredGroupId;this.sContext=a.context;this._bRecommendationListEnabled=a.recommendationListEnabled;}this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._groupHeaderFactory=this._groupHeaderFactory.bind(this);B.apply(this,arguments);this._onInitialise();}});q.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this);}else if(this.oControl.attachSuggest){this._fSuggest=function(E){this.oControl=E.getSource();if(!this.bInitialised){return;}if(!this.oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate();}var a=E.getParameter("suggestValue");this._fetchData(a);}.bind(this);this.oControl.attachSuggest(this._fSuggest);if(!this.oFilterModel){var t=this;var s=this.oControl.setParent;this.oControl.setParent=function(N,a,b){var O=this.getParent();var r=s.apply(this,arguments);N=this.getParent();var A=!(N&&(O===null));if((N!==O)&&A){t.unbindAggregation();}return r;};}this._handleSelect();}};q.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);}if(this.oPrimaryValueListAnnotation){if(this.sAggregationName&&this.sAggregationName=="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}this._fetchData();}else{m.error("ValueListProvider","Missing primary ValueListAnnotation for "+(this._sFullyQualifiedFieldName||this.sFieldName));}if(this.oAfterRenderingEventDelegate){delete this.oAfterRenderingEventDelegate;}}};q.prototype._isSortable=function(N){if(this.oPrimaryValueListAnnotation){for(var i=0;i<this.oPrimaryValueListAnnotation.valueListFields.length;i++){if(this.oPrimaryValueListAnnotation.valueListFields[i].name===N){return this.oPrimaryValueListAnnotation.valueListFields[i].sortable!==false;}}return false;}return false;};q.prototype._createDropDownTemplate=function(){this._oTemplate=new f({key:{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},text:{parts:[{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},{path:this._resolveSuggestionBindingPath(this.sDescription)}],formatter:j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour)}});if(this._oRecommendationListAnnotation){this._oTemplate.bindProperty("additionalText",{path:this._resolveSuggestionBindingPath(this._oRecommendationListAnnotation.rankProperty)});}this._oSorter=null;if(this.sDDLBDisplayBehaviour===n.idOnly||this.sDDLBDisplayBehaviour===n.idAndDescription){if(this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}else{if(this._isSortable(this.sDescription)){this._oSorter=new g(this.sDescription);}else if((this.sDescription!==this.sKey)&&this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}};q.prototype._createSuggestionTemplate=function(){var i=0,a=0,s=0,b=this._aRecommendationCols||this._aCols;this._oTemplate=new d();if(b){this.oControl.removeAllSuggestionColumns();a=b.length;for(i=0;i<a;i++){var r=false,t="1px",w=b[i].width;if(D.system.phone){w=undefined;if(i>=2){r=true;t=(i+1)*10+"rem";}}this.oControl.addSuggestionColumn(new C({header:new T({wrapping:true,wrappingType:W.Hyphenated,text:b[i].label}),demandPopin:r,popinDisplay:P.Inline,minScreenWidth:t,width:w}));this._oTemplate.addCell(new T({wrapping:true,text:{path:this._resolveSuggestionBindingPath(b[i].template),type:b[i].oType}}));if(w){s+=parseFloat(w.substring(0,w.length-2));}}if(s>0){this.oControl.setProperty('maxSuggestionWidth',s+a+"em",true);}}this.oControl.data("_hassuggestionTemplate",true);};q.prototype._handleRowSelect=function(a,b){var K,t,i;if(a){K=a[this.sKey];t=a[this.sDescription];}if(K||(K==="")){if(this.oControl.addToken){t=j.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,K,t);i=new e();i.setKey(K);i.setText(t);i.setTooltip(t);i.data("row",a);if(b){b(i);}if(this.oControl.getValue()===""){this.oControl.setValue("");}delete this.oControl.__sValidationText;}else{this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}}this._calculateAndSetFilterOutputData([a]);};q.prototype._multiInputValidator=function(a){if(!this.bInitialised){return;}if(this._aValidators){var t;this._aValidators.some(function(v){t=v(a);return t;},this);if(t){return t;}}var r=a.suggestionObject,b,i=a.text;if(r){var s=this._getSuggestionsModelName(),u=r.getBindingContext(s);b=u.getObject();this._handleRowSelect(b,a.asyncCallback);}else if(i){this._validateInput(i,a.asyncCallback);}};q.prototype._validateInput=function(i,a){var b=[],r=this.oControl,s;if(this.sDisplayFormat==="UpperCase"){i=i.toUpperCase();}if(r.__sValidationText!==i){r.__sValidationText=i;if(i===this._truncateSearchText(i)){r.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){b=k.generateFilters(this.aFilterField,this.mFilterInputData);}b.push(new F(this.sKey,h.EQ,i));if(this.bSupportBasicSearch){s={"search-focus":this.sKey};}this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:b,urlParameters:s,success:function(R){if(!this.oControl||!this.oControl.hasOwnProperty("__bValidatingToken")){return;}var t=R;delete this.oControl.__bValidatingToken;if(R){if(R.results&&R.results.length>=1){if(R.results.length===1){t=R.results[0];}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None");}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true);}if(t&&t[this.sKey]){this._handleRowSelect(t,a);}}this._afterTokenValidate();}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None");}delete this.oControl.__bValidatingToken;this._afterTokenValidate();}.bind(this)});}}else{if(r.data("__validationError")){r.setValueState(V.Error);}}};q.prototype._validateStringSingleWithValueList=function(E){var v;if(E.getParameter("validated")){return;}v=E.getParameter("value");if(v===""||v===undefined){return;}this._validateInput(v);};q.prototype._afterTokenValidate=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return;}this.oFilterProvider._oSmartFilter.search();}};q.prototype._onSuggestionItemSelected=function(E){var r=E.getParameter("selectedRow");if(r){var s=this._getSuggestionsModelName();this._handleRowSelect(r.getBindingContext(s).getObject());}};q.prototype._handleSelect=function(){if(this.oControl.addValidator){this._aValidators=this.oControl._tokenizer?this.oControl._tokenizer._aTokenValidators.slice():[];this.oControl.removeAllValidators();this._fValidator=this._multiInputValidator.bind(this);this.oControl.addValidator(this._fValidator);}else if(this.oControl.attachSuggestionItemSelected){this.oControl.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata&&this._fieldViewMetadata.hasValueListAnnotation){this.oControl.attachChange(this._validateStringSingleWithValueList,this);}}this.oControl.setRowResultFunction(function(s){var a,r="",b=this._getSuggestionsModelName();if(s){a=s.getBindingContext(b);}if(a&&this.sKey){r=a.getProperty(this.sKey);}return r;}.bind(this));};q.prototype._fetchData=function(s){if(this._shouldHaveRecommendations()){this._fetchSuggestionsAndRecommendations(s);}else{this._fetchDataSuggestionsOnly(s);}};q.prototype._fetchDataSuggestionsOnly=function(s){var a={},b=[],i,E;if(this.bTypeAheadEnabled){if(s&&this.sDisplayFormat==="UpperCase"){s=s.toUpperCase();}if(this.bSupportBasicSearch){a["custom"]={"search-focus":this.sKey,"search":s};}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){b=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){if(this._sType==="numc"){b.push(new F(this.sKey,h.Contains,s));}else if(this._truncateSearchText(s)===s){b.push(new F(this.sKey,h.StartsWith,s));}else{this.oControl.closeSuggestions();return;}}i=10;if(this.bEnableShowTableSuggestionValueHelp){E={dataReceived:function(r){var t=r.getSource(),u;if(t){u=t.getLength();if(u&&u<=i){this.oControl.setShowTableSuggestionValueHelp(false);}else{this.oControl.setShowTableSuggestionValueHelp(true);}}}.bind(this)};}else{this.oControl.setShowTableSuggestionValueHelp(false);}}if(this.aSelect&&this.aSelect.length){a["select"]=this.aSelect.toString();}if(!this.sValueListEntitySetName){m.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}if(this.sDeferredGroupId){a["batchGroupId"]=this.sDeferredGroupId;}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:i,parameters:a,filters:b,sorter:this._oSorter,events:E,template:this._oTemplate,templateShareable:false});};q.prototype._fetchSuggestionsAndRecommendations=function(s){var a={},b=[],i=100,r="",v;this.oControl.getModel(this._getSuggestionsModelName()).setData([]);s=s||"";if(this.bTypeAheadEnabled){if(s&&this.sDisplayFormat==="UpperCase"){s=s.toUpperCase();}if(this.bSupportBasicSearch){a={"search-focus":this.sKey,"search":s};}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){b=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){if(this._fieldViewMetadata&&this._fieldViewMetadata.filterType==="numc"){b.push(new F(this.sKey,h.Contains,s));}else{r=this._truncateSearchText(s);if(r===s){b.push(new F(this.sKey,h.StartsWith,r));}else{this.oControl.closeSuggestions();return;}}}i=10;}a["$top"]=i;a["$skip"]=0;if(!this.sValueListEntitySetName){m.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}if(this.sDeferredGroupId){a["batchGroupId"]=this.sDeferredGroupId;}if(this.aSelect&&this.aSelect.length){a["$select"]=this.aSelect.toString();}var t=this;v=new Promise(function(u,w){if(!t.sValueListEntitySetName){u({results:[]});}t.oODataModel.read("/"+t.sValueListEntitySetName,{urlParameters:a,filters:b,sorter:t._oSorter,success:function(x){u(x);},error:function(x){w(x);}});});Promise.all([this._oRecommendationListPromise,v]).then(function(R){var u=t._addSuggestionsToGroup(R[1].results),w=[].concat(t._aRecommendations).concat(u),x=t._getSuggestionsModelName();w=t._getDistinctSuggestions(w);t._showSuggestionsMoreButton(u.length>=i);t.oControl.getModel(x).setData(w);});};q.prototype._sortRecommendations=function(a,b){var r=this._oRecommendationListAnnotation.rankProperty,R=parseFloat(a[r]),i=parseFloat(b[r]);return i-R;};q.prototype._showSuggestionsMoreButton=function(s){if(!this.bTypeAheadEnabled){return;}if(this.bEnableShowTableSuggestionValueHelp){this.oControl.setShowTableSuggestionValueHelp(s);}else{this.oControl.setShowTableSuggestionValueHelp(false);}};q.prototype._addRecommendationsToGroup=function(r){if(!r){return[];}return r.map(function(R){R[o]=H.Recommendations;return R;});};q.prototype._addSuggestionsToGroup=function(s){if(!s){return[];}return s.map(function(r){r[o]=H.Others;return r;});};q.prototype._groupHeaderFactory=function(a){var t=this._getGroupHeaderTitle(a.key);if(this._isValueListWithFixedValues(this._fieldViewMetadata)){return new S({text:t});}return new G({title:t});};q.prototype._getGroupHeaderTitle=function(s){var a=this._oResourceBundle.getText("VALUELIST_OTHERS_TITLE");if(s===H.Recommendations){a=this._oResourceBundle.getText("VALUELIST_RECOMMENDATIONS_TITLE");}return a;};q.prototype._getGroupHeaderSorter=function(){if(this._groupHeaderSorter){return this._groupHeaderSorter;}this._groupHeaderSorter=new g({path:o,descending:false,group:function(a){return a.getProperty(o);}});return this._groupHeaderSorter;};q.prototype._getDistinctSuggestions=function(a){var u={},b=[];a.forEach(function(x){var s=x[this.sKey];if(!u[s]){b.push(x);u[s]=true;}},this);return b;};q.prototype._resolveRecommendationListAnnotationData=function(r){var a=r.fieldsToDisplay,b,s;this._aRecommendationCols=[];this.aRecommendationSelect=[];for(var i=0;i<a.length;i++){b=a[i];s=this._getColumnConfigFromField(b);if(b.visible){this._aRecommendationCols.push(s);this.aRecommendationSelect.push(b.name);}}};q.prototype._setupRecommendations=function(){if(this._shouldHaveRecommendations()){this.oControl.setModel(new J(),p);this._resolveRecommendationListAnnotationData(this._getRecommendationListAnnotation());this._fetchRecommendations();if(this.sAggregationName&&this.sAggregationName==="suggestionRows"){this._createSuggestionTemplate();this._setupInputRecommendationInteractions();}else{this._createDropDownTemplate();this._setupComboBoxRecommendationInteractions();}this._bindInnerControlForRecommendations();}};q.prototype._shouldHaveRecommendations=function(){return this._bRecommendationListEnabled&&this._hasRecommendationListAnnotation();};q.prototype._hasRecommendationListAnnotation=function(){return M.isRecommendationList(this._fieldViewMetadata);};q.prototype._getRecommendationListAnnotation=function(){if(!this._oRecommendationListAnnotation){var r=this._oMetadataAnalyser._getRecommendationListAnnotation(this._sFullyQualifiedFieldName);this._oRecommendationListAnnotation=this._oMetadataAnalyser._enrichRecommendationListAnnotation(r);}return this._oRecommendationListAnnotation;};q.prototype._isValueListWithFixedValues=function(){var a=this._fieldViewMetadata;return M.isValueListWithFixedValues(a)||a["sap:value-list"]==="fixed-values";};q.prototype._fetchRecommendations=function(){var t=this;this._oRecommendationListPromise=new Promise(function(r,a){t.oODataModel.read("/"+t._oRecommendationListAnnotation.path,{urlParameters:{$skip:0,$top:5,$select:t.aRecommendationSelect.toString()},sorter:t._oSorter,success:function(b){var R=t._addRecommendationsToGroup(b.results);t._aRecommendations=R.sort(t._sortRecommendations.bind(t));t.oControl.getModel(t._getSuggestionsModelName()).setData(R);t._showSuggestionsMoreButton(false);r(b);},error:function(b){a(b);}});});};q.prototype._bindInnerControlForRecommendations=function(){this.oControl.bindAggregation(this.sAggregationName,{path:this._getSuggestionsModelName()+">/",groupHeaderFactory:this._groupHeaderFactory,sorter:this._getGroupHeaderSorter(),template:this._oTemplate,templateShareable:false});};q.prototype._setupInputRecommendationInteractions=function(){var i=this.oControl;i.setFilterSuggests(true);i.setFilterFunction(function(v,I){var s=this._getSuggestionsModelName(),O=I.getBindingContext(s).getObject()[this.sKey].toLowerCase();return O.indexOf(v.toLowerCase())!==-1;}.bind(this));i.addEventDelegate({onfocusin:function(){if(this._isNotRecommendationItemSelected("suggestionRows",i.getValue())){this._showRecommendations();}}},this);i.attachSuggestionItemSelected(function(E){var s=this._getSuggestionsModelName(),a=E.getParameter("selectedRow"),I;if(a){var b=a.getBindingContext(s).getObject();I=b&&b[this.sKey];}if(this._isNotRecommendationItemSelected("suggestionRows",I)){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);i.attachLiveChange(function(E){var v=E.getParameter("value");if(this._isNotRecommendationItemSelected("suggestionRows",v)){this._setControlValueState(V.Warning);}if(v===""){this.oControl._oSuggPopover._oPopover.close();this._showRecommendations();}},this);};q.prototype._setupComboBoxRecommendationInteractions=function(){var a=this.oControl;a.setShowSecondaryValues(true);a.addEventDelegate({onmousedown:function(E){var t=E.srcControl;a._isTargetControlInputField=!t.isA(a.getMetadata().getName());a._isTargetControlIcon=t.isA("sap.ui.core.Icon");a._isMouseDown=true;},onmouseup:function(){setTimeout(function(){a._isMouseDown=false;});},onfocusin:function(){if(a._isTargetControlInputField&&(a._isMouseDown||a._isTargetControlIcon)){return;}if(this._isNotRecommendationItemSelected("items",a.getValue())){this._showRecommendations();}}},this);a.attachChange(function(E){if(this._isNotRecommendationItemSelected("items",E.getParameter("value"))){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};q.prototype._isNotRecommendationItemSelected=function(a,v){return this._findSuggestionItemGroup(a,v)!==H.Recommendations;};q.prototype._findSuggestionItemGroup=function(a,v){var I=this.oControl.getBinding(a).getCurrentContexts(),s;for(var i=0;i<I.length;i++){var b=I[i].getObject(),K=b[this.sKey],r=b[this.sDescription];if(K===v||r===v){s=b;break;}}return s?s[o]:null;};q.prototype._setControlValueState=function(s){this.oControl.setValueState(s?s:V.None);this.oControl.setValueStateText(" ");};q.prototype._showRecommendations=function(){var t=this;this.oControl.showItems(function(v,i){var s=t._getSuggestionsModelName(),r=t._oRecommendationListAnnotation.rankProperty;return!!i.getBindingContext(s).getObject()[r];});};q.prototype._getSuggestionsModelName=function(){var s;if(this._shouldHaveRecommendations()){s=p;}return s;};q.prototype._resolveSuggestionBindingPath=function(s){var a=this._getSuggestionsModelName();if(a){s=a+">"+s;}return s;};q.prototype._truncateSearchText=function(s){var i=-1;if(this._sMaxLength){i=parseInt(this._sMaxLength);}else if(this._fieldViewMetadata&&this._fieldViewMetadata.maxLength){i=parseInt(this._fieldViewMetadata.maxLength);}if(i>-1&&s.length>i){s=s.substr(0,i);}return s;};q.prototype.unbindAggregation=function(){if(this.oControl){this.oControl.unbindAggregation(this.sAggregationName);}return this;};q.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest&&this._fSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null;}if(this.oControl.removeValidator&&this._fValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null;}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._onSuggestionItemSelected,this);}if(this.oControl.detachChange){this.oControl.detachChange(this._validateStringSingleWithValueList,this);}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken;}B.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null;}if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null;};return q;});
