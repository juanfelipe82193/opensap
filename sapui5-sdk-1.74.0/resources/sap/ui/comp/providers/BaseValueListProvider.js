/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/comp/library','sap/ui/base/EventProvider','sap/ui/comp/odata/ODataType','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/util/FormatUtil','sap/ui/comp/util/DateTimeUtil','sap/base/Log'],function(q,l,E,O,M,F,D,L){"use strict";var a=l.smartfilterbar.DisplayBehaviour;var A=l.ANALYTICAL_PARAMETER_PREFIX;var B=E.extend("sap.ui.comp.providers.BaseValueListProvider",{constructor:function(p){E.call(this);this.sFieldName=p.fieldName;this.oControl=p.control;this.oODataModel=p.model;this.oFilterModel=p.filterModel;this.oFilterProvider=p.filterProvider;this.sDisplayFormat=p.displayFormat;this._oDateFormatSettings=p.dateFormatSettings;if(!this._oDateFormatSettings){this._oDateFormatSettings={};}if(!this._oDateFormatSettings.hasOwnProperty("UTC")){this._oDateFormatSettings["UTC"]=true;}this._fieldViewMetadata=p.fieldViewMetadata;this.sValueListEntitySetName=null;this.bResolveInOutParams=(p.resolveInOutParams===false)?false:true;this.sDisplayBehaviour=p.displayBehaviour;this.sDDLBDisplayBehaviour=this.sDisplayBehaviour;if(!this.sDDLBDisplayBehaviour||this.sDDLBDisplayBehaviour===a.auto){this.sDDLBDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultDropDownDisplayBehaviour:a.descriptionOnly;}this._sType=p.type;this._sMaxLength=p.maxLength;this.sPropertyTypePath="";if(this.bResolveInOutParams&&!this.oFilterModel&&!this.oFilterProvider){this._resolvePropertyPath();}if(p.loadAnnotation&&p.fullyQualifiedFieldName){this._oMetadataAnalyser=p.metadataAnalyser;this._sFullyQualifiedFieldName=p.fullyQualifiedFieldName;this._attachAnnotationLoadOnRender();}else{if(p.loadAnnotation){L.error("BaseValueListProvider","loadAnnotation is true, but no fullyQualifiedFieldName set for field '"+(this._sFullyQualifiedFieldName||this.sFieldName)+"'! Please check your annotations");}this._onAnnotationLoad({primaryValueListAnnotation:p.annotation,additionalAnnotations:p.additionalAnnotations});}}});B.prototype._attachAnnotationLoadOnRender=function(){this.oBeforeRenderingEventDelegate={onBeforeRendering:function(){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate,this);delete this.oBeforeRenderingEventDelegate;if(!this._bValueListRequested){if(this.bInitialised){if(this._onMetadataInitialised&&this.sAggregationName&&!this.bTypeAheadEnabled&&this.oControl.$()){this._onMetadataInitialised();}}else{this._loadAnnotation();}}}};this.oControl.addEventDelegate(this.oBeforeRenderingEventDelegate,this);};B.prototype.loadAnnotation=function(){if(this.oBeforeRenderingEventDelegate){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate,this);delete this.oBeforeRenderingEventDelegate;}if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate,this);delete this.oAfterRenderingEventDelegate;}this._loadAnnotation();};B.prototype._loadAnnotation=function(){if(!this._bValueListRequested){this._bValueListRequested=true;if(!this._oMetadataAnalyser){this._oMetadataAnalyser=new M(this.oODataModel);this._bCleanupMetadataAnalyser=true;}this._oMetadataAnalyser.getValueListAnnotationLazy(this._sFullyQualifiedFieldName).then(this._onAnnotationLoad.bind(this),function(e){this._oError=e;this.bInitialised=true;L.debug(e);}.bind(this));}};B.prototype.attachValueListChanged=function(f,o){this.attachEvent("valueListChanged",f,o);};B.prototype.detachValueListChanged=function(f,o){this.detachEvent("valueListChanged",f,o);};B.prototype._onAnnotationLoad=function(v){this.oPrimaryValueListAnnotation=v.primaryValueListAnnotation;this.additionalAnnotations=v.additionalAnnotations;this._resolveAnnotationData(this.oPrimaryValueListAnnotation);this.bInitialised=true;this._setupRecommendations();if(this._onMetadataInitialised&&this.sAggregationName&&!this.bTypeAheadEnabled&&this.oControl.$()){this._onMetadataInitialised();}};B.prototype._resolvePropertyPath=function(){var b=this.oControl.getBindingInfo("value"),p,P,c;if(b&&b.parts){p=b.parts[0]?b.parts[0].path:"";}if(p){c=p.split("/");if(c.length>1){P=c[c.length-1];this.sPropertyTypePath=p.replace("/"+P,"");}}};B.prototype._resolveAnnotationData=function(o){var b=0,i=0,c,f;if(this.oODataModel&&o){this.bSupportBasicSearch=o.isSearchSupported;this.sValueListTitle=o.valueListTitle||o.qualifier;this.sKey=o.keyField;this._aKeys=o.keys;this.sValueListEntitySetName=o.valueListEntitySetName;this.mInParams=o.inParams;this.mOutParams=o.outParams;this.sTokenDisplayBehaviour=this.sDisplayBehaviour;if(!this.sTokenDisplayBehaviour||this.sTokenDisplayBehaviour===a.auto){this.sTokenDisplayBehaviour=this.oFilterProvider?this.oFilterProvider.sDefaultTokenDisplayBehaviour:a.descriptionAndId;}if(!o.descriptionField){this.sTokenDisplayBehaviour=a.idOnly;}this.sDescription=o.descriptionField||this.sKey;if(this.sValueListEntitySetName&&this.sKey){this._aCols=[];this.aSelect=[];c=o.valueListFields;b=c.length;for(i=0;i<b;i++){f=c[i];if(f.visible){this._aCols.push(this._getColumnConfigFromField(f));}this.aSelect.push(f.name);}if(o.descriptionField){this.aSelect.push(o.descriptionField);}}else{if(!this.sKey){L.error("BaseValueListProvider","key for ValueListEntitySetName '"+this.sValueListEntitySetName+"' missing! Please check your annotations");}}}};B.prototype._getColumnConfigFromField=function(f){var t=null,T=null,c,o;if(f.type==="Edm.Boolean"){t="boolean";}else if(f.type==="Edm.DateTime"&&f.displayFormat==="Date"){t="date";o=this._oDateFormatSettings;c={displayFormat:"Date"};}else if(f.type==="Edm.Decimal"){t="decimal";c={precision:f.precision,scale:f.scale};}else if(f.type==="Edm.String"){if(f.isCalendarDate){t="stringdate";}else{t="string";}}T=O.getType(f.type,o,c,f.isCalendarDate);return{label:f.fieldLabel,tooltip:f.quickInfo||f.fieldLabel,type:t,oType:T,width:F.getWidth(f,15),template:f.name,sort:f.sortable?f.name:undefined,sorted:f.sortable&&f.name===this.sKey,sortOrder:"Ascending"};};B.prototype._getFilterData=function(){var d,f={};if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter){d=this.oFilterProvider._oSmartFilter.getFilterData();if(this.sFieldName&&(this.sFieldName.indexOf(A)===0)){Object.keys(d).forEach(function(n){var b=n.split(A);f[b[b.length-1]]=d[n];});return f;}}return d;};B.prototype._setFilterData=function(f){var d=f,o={};if(this.oFilterProvider){if(this.sFieldName&&(this.sFieldName.indexOf(A)===0)){Object.keys(f).forEach(function(n){o[A+n]=f[n];});d=o;}this.oFilterProvider.setFilterData(d);}};B.prototype._adaptEdmDateTimePropertyValue=function(v,V){var r=V;if(V instanceof Date&&this.oPrimaryValueListAnnotation&&this.oPrimaryValueListAnnotation.fields){var p=null;this.oPrimaryValueListAnnotation.fields.some(function(P){if(P.name===v){p=P;}return p!==null;});if(p&&p.type==="Edm.DateTime"&&p.displayFormat==="Date"){r=D.utcToLocal(V);}}return r;};B.prototype._calculateFilterInputData=function(){var s,v,d=null,b;delete this.mFilterInputData;if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter){d=this._getFilterData();}else if(this.oFilterModel){d=this.oFilterModel.getData();}if(this.mInParams&&d){this.mFilterInputData={};this.aFilterField=[];for(s in this.mInParams){if(s){v=this.mInParams[s];v=v.replace("/",".");if(v!==this.sKey){if(d[s]){this.mFilterInputData[v]=d[s];if(typeof this.mFilterInputData[v]==="object"){if(this.mFilterInputData[v].ranges&&this.mFilterInputData[v].ranges.length>0){for(var i=0;i<this.mFilterInputData[v].ranges.length;i++){this.mFilterInputData[v].ranges[i].keyField=v;}}}this.aFilterField.push(v);}}}}}else if(this.oODataModel&&this.bResolveInOutParams){b=this.oControl.getBindingContext();if(this.mInParams&&b){this.mFilterInputData={};this.aFilterField=[];for(s in this.mInParams){if(s){v=this.mInParams[s];v=v.replace("/",".");if(v!==this.sKey){var p=this.sPropertyTypePath?this.sPropertyTypePath+"/"+s:s;var V=b.getProperty(p);if(V){V=this._adaptEdmDateTimePropertyValue(v,V);this.mFilterInputData[v]=V;this.aFilterField.push(v);}}}}}}};B.prototype._calculateAndSetFilterOutputData=function(d){var s,v,f=null,o,e,n,i,b,c,g;if(this.mOutParams&&d&&(this.oFilterProvider||this.oFilterModel)){f={};b=function(I){return I.key===n.key;};c=function(r){if(n.value1 instanceof Date&&r.value1 instanceof Date){return r.operation==="EQ"&&n.value1.getTime()===r.value1.getTime();}return r.operation==="EQ"&&n.value1===r.value1;};g=function(r){return r.operation==="EQ"&&n.key===r.value1;};for(s in this.mOutParams){if(s){var h=this.oFilterProvider&&this.oFilterProvider._getFieldMetadata(s);v=this.mOutParams[s];if(v!==this.sKey){e=null;i=d.length;while(i--){o=d[i];if(o[v]){var V=o[v];var j=h&&(h.type==="Edm.DateTime"||!h.hasValueListAnnotation);if(j){if(h.type==="Edm.DateTime"&&this._oDateFormatSettings.UTC==true){V=D.utcToLocal(V);}n={"exclude":false,"operation":"EQ","keyField":s,"value1":V,"value2":null};}else{n={key:V};}if(!f[s]){if(!e&&this.oFilterModel){e=this.oFilterModel.getData();}if(e&&e[s]&&e[s].items){f[s]=e[s];if(!f[s].ranges){f[s].ranges=[];}}else{f[s]={items:[],ranges:[]};}}var k=f[s];if(j){if(k.ranges.filter(c).length<=0){k.ranges.push(n);}}else if(k.items.filter(b).length<=0){if(!k.ranges||k.ranges.filter(g).length<=0){k.items.push(n);}}}}}}}if(f){if(this.oFilterProvider){this._setFilterData(f);if(!q.isEmptyObject(f)){this.fireEvent("valueListChanged",{"changes":Object.keys(f)});}}else if(this.oFilterModel){this.oFilterModel.setData(f,true);}}}else if(this.oODataModel&&this.bResolveInOutParams){this._calculateAndSetODataModelOutputData(d[0]);}};B.prototype._calculateAndSetODataModelOutputData=function(d){var b,s,v,p,V,c={};if(d&&this.mOutParams){b=this.oControl.getBindingContext();for(s in this.mOutParams){if(s){v=this.mOutParams[s];if(v!==this.sKey){V=d[v];c[s]=V;p=this.sPropertyTypePath?this.sPropertyTypePath+"/"+s:s;this.oODataModel.setProperty(p,V,b,true);}}}if(c&&!q.isEmptyObject(c)){this.fireEvent("valueListChanged",{"changes":c});}}};B.prototype._setupRecommendations=function(){};B.prototype.destroy=function(){E.prototype.destroy.apply(this,arguments);if(this._bCleanupMetadataAnalyser&&this._oMetadataAnalyser){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(this.oBeforeRenderingEventDelegate){this.oControl.removeEventDelegate(this.oBeforeRenderingEventDelegate);delete this.oBeforeRenderingEventDelegate;}if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);delete this.oAfterRenderingEventDelegate;}this.oControl=null;this.sFieldName=null;this.mFilterInputData=null;this.aFilterField=null;this.sValueListEntitySetName=null;this.oODataModel=null;this.oFilterModel=null;this.oFilterProvider=null;this.oPrimaryValueListAnnotation=null;this.additionalAnnotations=null;this.sDisplayFormat=null;this.bSupportBasicSearch=null;this.bInitialised=null;this._oError=null;this.sValueListTitle=null;this.sKey=null;this._aKeys=null;this.mInParams=null;this.mOutParams=null;this.sDescription=null;this.aSelect=null;this._aCols=null;this.sDDLBDisplayBehaviour=null;this.sTokenDisplayBehaviour=null;this._oDateFormatSettings=null;this._fieldViewMetadata=null;this.bIsDestroyed=true;};return B;});
