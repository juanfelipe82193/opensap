/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/base/util/UriParameters","sap/ui/fl/registry/Settings","sap/ui/fl/descriptorRelated/api/DescriptorVariantFactory","sap/base/util/merge"],function(F,A,B,U,S,D,m){"use strict";var a;var o;var r;var c;var _;var g=function(){return F.getAppDescriptor(r);};var G=function(){return S.getInstance();};var s=function(){window.onbeforeunload=_;};var f=function(C){var M=C?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";_=window.onbeforeunload;window.onbeforeunload=A.handleBeforeUnloadEvent;return A.showMessage(M);};var t=function(h,i){return o.triggerCatalogPublishing(h,i,true);};var T=function(h){return o.triggerCatalogPublishing(h,null,false);};var R=function(i,C){if(a){A.closeOverviewDialog();return this.onGetOverview(true,C);}else if(!a&&i){B.hide();return this.onGetOverview(true,C);}return Promise.resolve();};var b=function(h,i,C){return h?A.navigateToFLPHomepage():R.call(this,!i,C);};var d=function(h,i){if(h&&h.response&&h.response.IAMId){return o.notifyKeyUserWhenPublishingIsReady(h.response.IAMId,i,true);}return Promise.resolve();};var e=function(h,i){if(h&&h.response&&h.response.IAMId&&h.response.inProgress){return o.notifyKeyUserWhenPublishingIsReady(h.response.IAMId,i,false);}return Promise.resolve();};sap.ui.getCore().getEventBus().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(a){a.destroy();a=null;}});return{onGetOverview:function(h,l){var i=g();return new Promise(function(j){var C=function(){A.closeOverviewDialog();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantOverviewDialog"],function(k){if(!a){a=new k({idRunningApp:i["sap.app"].id,isOverviewForKeyUser:h,layer:l});}a.attachCancel(C);a.oPopup.attachOpened(function(){j(a);});a.open();});});},isOverviewExtended:function(){var u=U.fromQuery(window.location.search);var M=u.get("sap-ui-xx-app-variant-overview-extended");if(!M){return false;}return M.toLowerCase()==='true';},isManifestSupported:function(){var h=g();return A.getManifirstSupport(h["sap.app"].id).then(function(i){return i.response;}).catch(function(E){var i=A.buildErrorInfo("MSG_APP_VARIANT_FEATURE_FAILED",E);i.overviewDialog=true;return A.showRelevantDialog(i,false);});},isPlatFormEnabled:function(h,C,l){r=h;c=l;var i=g();if(i["sap.app"]&&i["sap.app"].id){if(F.getUshellContainer()&&!A.isStandAloneApp()&&C==="CUSTOMER"){var I;if(i["sap.app"].crossNavigation&&i["sap.app"].crossNavigation.inbounds){I=A.getInboundInfo(i["sap.app"].crossNavigation.inbounds);}else{I=A.getInboundInfo();}if(I){return true;}}}return false;},getAppVariantDescriptor:function(h,C){r=h;var i=g();if(i["sap.app"]&&i["sap.app"].id){return D.loadAppVariant(i["sap.app"].id,false,C);}return Promise.resolve(false);},onSaveAs:function(h,C,i,j){var I;var k=[];var l;var n=g();if(j&&j["sap.app"].id===n["sap.app"].id){C=true;n=m({},j);j=null;}return new Promise(function(p){var P=function(){return o.processSaveAsDialog(n,h);};var q=function(H){B.show();return o.createAllInlineChanges(H);};var u=function(H){k=H.slice();return A.addChangesToPersistence(H,r);};var v=function(){var H=A.getNewAppVariantId();return o.createAppVariant(H).catch(function(J){var M=J.messageKey;if(!M){M="MSG_SAVE_APP_VARIANT_FAILED";}if(J.saveAsFailed){A.removeChangesFromPersistence(k,r);}return A.catchErrorDialog(J,M,H);});};var w=function(H){l=null;l=m({},H.response);return o.clearRTACommandStack(C);};var x=function(){var H=F.getUshellContainer();if(H&&C){H.setDirtyFlag(false);}};var y=function(H){x();I=A.isS4HanaCloud(H);var J=A.buildSuccessInfo(l.id,h,I);return o.showSuccessMessage(J);};var z=function(){var H=A.buildFinalSuccessInfoS4HANACloud();return o.showSuccessMessage(H);};var E=function(){B.show();if(I){var H;return f().then(function(){return t(l.id,l.reference);}).then(function(J){H=Object.assign({},J);B.hide();return b.call(this,h,null,i);}.bind(this)).then(function(){return d(H,l.id);}).then(function(){return z();}).then(function(){s();return h?p():b.call(this,h,I,i);}.bind(this));}B.hide();return b.call(this,h,I,i);};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(H){if(!o){o=new H({rootControl:r,commandSerializer:c,layer:i});}return P().then(q).then(u).then(v).then(w).then(G).then(y).then(E.bind(this)).then(p).catch(function(J){if(!J){return false;}if(I){s();}return b.call(this,null,I,i).then(p);}.bind(this));}.bind(this));}.bind(this));},onDeleteFromOverviewDialog:function(h,C,i){var I;return new Promise(function(j){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(k){if(!o){o=new k({rootControl:r,commandSerializer:c,layer:i});}var l=function(){return o.deleteAppVariant(h).catch(function(E){var M=E.messageKey;if(!M){M="MSG_DELETE_APP_VARIANT_FAILED";}return A.catchErrorDialog(E,M,h);});};var n=function(){A.closeOverviewDialog();var u=A.buildDeleteSuccessMessage(h);return o.showSuccessMessage(u);};var p=function(u){I=A.isS4HanaCloud(u);if(I){var v;return f(C).then(function(){return T(h);}).then(function(w){v=Object.assign({},w);return R.call(this,!C,i);}.bind(this)).then(function(){return e(v,h);});}B.show();return Promise.resolve();};var q=function(){if(I){s();}B.hide();return C?j():R.call(this,!I,I,i).then(j);};if(C){A.closeOverviewDialog();A.navigateToFLPHomepage();}return G().then(p.bind(this)).then(l).then(n).then(q.bind(this)).catch(function(){if(I){s();}return R.call(this,null,I,i).then(j);}.bind(this));}.bind(this));}.bind(this));}};});
