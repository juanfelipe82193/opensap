/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","jquery.sap.script"],function(O,L,q){"use strict";var C=O.extend("sap.ui.support.supportRules.WindowCommunicationBus",{constructor:function(c){this._oConfig=c;if(window.addEventListener){window.addEventListener("message",this._onmessage.bind(this),false);}else{window.attachEvent("onmessage",this._onmessage.bind(this));}}});C.bSilentMode=false;C.channels={};C.frames={};C.prototype.subscribe=function(c,f,o){if(this._bSilentMode){return;}C.channels[this._oConfig._sNamespace]=C.channels[this._oConfig._sNamespace]||{};C.channels[this._oConfig._sNamespace][c]=C.channels[this._oConfig._sNamespace][c]||[];C.channels[this._oConfig._sNamespace][c].push({callback:f,context:o});};C.prototype.publish=function(c,p){if(this._bSilentMode){return;}var r=this._oConfig.getReceivingWindow();var d={channelName:c,channelNamespace:this._oConfig._sNamespace,params:p,_frameIdentifier:this._getFrameIdentifier(),_origin:window.location.href};r.postMessage(d,this._oConfig.getOrigin());};C.prototype.allowFrame=function(o){C.frames[this._oConfig._sNamespace]={origin:o.origin,identifier:o.identifier,url:o.url.replace(/\.\.\//g,'')};};C.prototype.destroyChannels=function(){C.channels={};};C.prototype._onmessage=function(e){if(!this._validate(e)){L.error("Message was received but failed validation");return;}var c=C.channels[e.data.channelNamespace];var a=c&&c[e.data.channelName]||[];a.forEach(function(b){b.callback.apply(b.context,[e.data.params]);});};C.prototype._validate=function(e){if(q.isEmptyObject(C.frames)){return true;}var f=C.frames[this._oConfig._sNamespace];if(!f){return true;}var m=e.origin===f.origin;var M=e.data._frameIdentifier===f.identifier;var b=e.data._origin.indexOf(f.url)>-1;return m&&M&&b;};C.prototype._getFrameIdentifier=function(){var f=C.frames[this._oConfig._sNamespace]||{};return f.identifier||this._oConfig.getFrameId();};return C;},true);
