/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/Control","./ChartRenderer","sap/ui/base/ManagedObjectObserver","sap/ui/model/json/JSONModel","sap/ui/mdc/library","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Sorter","sap/base/Log","sap/base/util/deepEqual","sap/ui/Device","sap/ui/mdc/chart/ToolbarHandler"],function(C,a,M,J,b,c,S,L,d,D,T){"use strict";var e,f,g,h,l,m,n;var o=C.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",defaultAggregation:"items",properties:{header:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"},conditionModelName:{type:"string",defaultValue:null},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},vizProperties:{type:"object",group:"Misc"},_colorings:{type:"object",visibility:"_hidden",byValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"}},aggregations:{data:{multiple:true},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--toolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},_toolbar:{type:"sap.ui.mdc.ActionToolbar",multiple:false},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}}});o.prototype.init=function(){this._oObserver=new M(this.update.bind(this));this._oObserver.observe(this,{aggregations:["items","_chart"],properties:["ignoreToolbarActions"]});this._oManagedObjectModel=new c(this);this.setModel(this._oManagedObjectModel,"$mdcChart");if(!this.oDelegatePromise){this.setDelegate({name:"sap/ui/mdc/ChartDelegate"});}};o.prototype.applySettings=function(s){s=s||{};var A=s.actions||[];delete s.actions;this.oChartPromise=this._getLibraryPromise().then(function(){if(!this._bIsBeingDestroyed){return this.oDelegatePromise.then(function(i){return i.fetchProperties(this);}.bind(this)).then(function(p){var I={};for(var i=0;i<p.length;i++){I[p[i].name]=p[i];}T.createToolbar(this,A);this._createDrillBreadcrumbs();return this._createInnerChart(s,I);}.bind(this));}else{return null;}}.bind(this));C.prototype.applySettings.apply(this,[s]);};o.prototype.bindAggregation=function(N,B){if(N=="data"){this.oDataInfo=B;var i=this.getAggregation("_chart");if(i){i.bindAggregation("data",B);}else{this.oChartPromise.then(function(i){i.bindAggregation("data",this.oDataInfo);}.bind(this));}return this;}return C.bindAggregation(N,B);};o.prototype.getBindingInfo=function(N){if(N=="data"){return this.oDataInfo;}return C.prototype.getBindingInfo.apply(this,[N]);};o.prototype.setLegendVisible=function(v){this.setVizProperties({'legend':{'visible':v},'sizeLegend':{'visible':v}});return this.setProperty("legendVisible",v);};o.prototype._createInnerChart=function(s,I){var k={},p,v=[],q=[],r=[],V={};k.chartType='{$mdcChart>/chartType}';k.dimensions=[];k.measures=[];k.id=this.getId()+"--innerChart";k.height='100%';k.width='100%';k.vizProperties='{$mdcChart>/vizProperties}';s.items=s.items||[];function t(j){if(this&&this.getVizItemType()=="Dimension"){k.dimensions.push(j);}else{k.measures.push(j);}}function u(p,x){if(p.getCriticality()){x._addCriticality(p);}r.push(p.getKey());if(p.getAdditionalColoringMeasures){for(var j=0;j<p.getAdditionalColoringMeasures().length;j++){if(q.indexOf(p.getAdditionalColoringMeasures()[j])==-1){q.push(p.getAdditionalColoringMeasures()[j]);}}}}function w(j){var K,x;for(var i=0;i<q.length;i++){K=q[i];if(r.indexOf(K)==-1){x=j.retrieveAggregationItem("items",I[K]);x=n.getVizItemSettings(x.settings);v.push(n.createVizChartItem(x).then(t));}}}for(var i=0;i<s.items.length;i++){p=s.items[i];u(p,this);if(I[p.getKey()]){V=this.DELEGATE.retrieveAggregationItem("items",I[p.getKey()]).settings;}else{V=undefined;}v.push(p.toVizChartItem(V).then(t.bind(p)));}w(this.DELEGATE);var W=new Promise(function(j){sap.ui.require(["sap/ui/fl/apply/api/FlexRuntimeInfoAPI"],function(F){if(!F.isFlexSupported({element:this})){return Promise.resolve();}F.waitForChanges({element:this}).then(function(){return j();});}.bind(this));}.bind(this));return Promise.all(v,W).then(function(){var j=new e(k);j.setVisibleDimensions([]);j.setVisibleMeasures([]);j.setInResultDimensions([]);this._oObserver.observe(j,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",j);return j;}.bind(this));};o.prototype.setSelectionMode=function(v){var i=this.getAggregation("_chart");if(i){i.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}else{this.oChartPromise.then(function(i){if(i){i.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}}.bind(this));}return this.setProperty("selectionMode",v,true);};o.prototype._getLibraryPromise=function(){if(!this.oChartLibPromise){this.oChartLibPromise=new Promise(function(r,i){if(!e){sap.ui.require(["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton","sap/ui/mdc/chart/MeasureItem"],function(o,j,k){e=o;m=j;f=sap.ui.getCore().getLibraryResourceBundle("sap.chart.messages");g=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");n=k;r(true);});}else{r(true);}});}return this.oChartLibPromise;};o.prototype.addItem=function(i,s){var j=this.getAggregation("_chart");if(j){i.toChart(j);}else{this.oChartPromise.then(function(j){if(j){this.toChart(j);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,s);};o.prototype.insertItem=function(i,I,s){if(i.getCriticality()){this._addCriticality(i);}var j=this.getAggregation("_chart");if(j){i.toChart(j);}else{this.oChartPromise.then(function(j){if(j){this.toChart(j);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,s);};o.prototype.removeItem=function(i,s){this._oObserver.unobserve(i);return this.removeAggregation("items",i,s);};o.prototype.exit=function(){var i=this.getAggregation("_chart");if(i){i.destroy();}else{this._bIsBeingDestroyed=true;this.oChartPromise.finally(function(){var i=this.getAggregation("_chart");if(i){i.destroy();}}.bind(this));}C.prototype.exit.apply(this,[]);};o.prototype._showDrillDown=function(){if(l){if(!this._oDrillDownPopover){l.createDrillDownPopover(this);}l.showDrillDownPopover(this);}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){l=i;l.createDrillDownPopover(this);l.showDrillDownPopover(this,this.getDelegate().name);}.bind(this));}};o.prototype._createDrillBreadcrumbs=function(){if(l){if(!this._oDrillBreadcrumbs){l.createDrillBreadcrumbs(this);}}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){l=i;l.createDrillBreadcrumbs(this);}.bind(this));}};o.prototype._getPropertyData=function(){return new Promise(function(r,i){if(!this.aFetchedProperties){return this.oDelegatePromise.then(function(j){return j.fetchProperties(this);}.bind(this)).then(function(F){this.aFetchedProperties=F;r(F);}.bind(this));}else{r(this.aFetchedProperties);}}.bind(this));};o.prototype.getAvailableChartTypes=function(){var j=[];var k=this.getAggregation("_chart");if(k){var A=k.getAvailableChartTypes().available;if(j){for(var i=0;i<A.length;i++){var t=A[i].chart;j.push({key:t,icon:m.mMatchingIcon[t],text:f.getText("info/"+t),selected:(t==this.getChartType())});}}}return j;};o.prototype.getTypeInfo=function(){var t=this.getChartType();var i={icon:m.mMatchingIcon[t],text:g.getText("chart.CHART_TYPE_TOOLTIP",[t])};return i;};o.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};o.prototype.update=function(i){var j=this.getAggregation("_chart");if(j){this._update(j,i);}else{this.oChartPromise.then(function(j){if(j){this._update(j,i);}}.bind(this));}};o.prototype._update=function(j,k){var I=this.getItems(),v,p,V=[],q=[],r=[],s={};if(k.name==="ignoreToolbarActions"){T.updateToolbar(this);return;}if(k.name==="data"&&k.type==="binding"&&k.mutation==="prepare"&&k.object.isA("sap.chart.Chart")){k.bindingInfo.sorter=this._getSorters();}this._aInResultProperties=[];for(var i=0;i<I.length;i++){p=I[i];v=p.getVizItemType()=="Measure"?j.getMeasureByName(p.getKey()):j.getDimensionByName(p.getKey());if(!v){continue;}if(p.getVisible()){if(p.getVizItemType()=="Measure"){V.push(v.getName());if(p.getDataPoint()){s[v.getName()]=p.getDataPoint();}}else{q.push(v.getName());}this._aInResultProperties.push(v.getName());}if(p.getVizItemType()=="Dimension"){if(p.getInResult()){r.push(v.getName());this._aInResultProperties.push(v.getName());}}}var R=false;if(!d(q,j.getVisibleDimensions())){j.setVisibleDimensions(q);R=true;}if(!d(V,j.getVisibleMeasures())){j.setVisibleMeasures(V);R=true;}if(!d(r,j.getInResultDimensions())){j.setInResultDimensions(r);R=true;}if(R){this._rebind();this._updateSemanticalPattern(j,V,s);this._updateColoring(j,q,V);}if(l&&this.getAggregation("_breadcrumbs")){l._updateDrillBreadcrumbs(this.getAggregation("_chart"),this.getAggregation("_breadcrumbs"));}};o.prototype._updateSemanticalPattern=function(i,v,j){for(var k=0;k<v.length;k++){var p=j[v[k]];if(p){if(p.targetValue||p.foreCastValue){var A=i.getMeasureByName(v[k]);A.setSemantics("actual");if(p.targetValue!=null){var r=i.getMeasureByName(p.targetValue);if(r){r.setSemantics("reference");}else{L.error("sap.ui.mdc.Chart: "+p.targetValue+" is not a valid measure");}}if(p.foreCastValue){var P=i.getMeasureByName(p.foreCastValue);if(P){P.setSemantics("projected");}else{L.error("sap.ui.comp.SmartChart: "+p.ForecastValue.Path+" is not a valid measure");}}A.setSemanticallyRelatedMeasures({referenceValueMeasure:p.targetValue,projectedValueMeasure:p.foreCastValue});}}}};o.prototype._updateColoring=function(i,v,V,j){var p=this.getProperty("_colorings"),k;if(p&&p.Criticality){var A;for(k=0;k<v.length;k++){if(p.Criticality.DimensionValues[v[k]]){A={coloring:"Criticality",parameters:{dimension:v[k]}};delete p.Criticality.MeasureValues;break;}}if(!A){delete p.Criticality.DimensionValues;for(var s in p.Criticality.MeasureValues){if(V.indexOf(s)==-1){delete p.Criticality.MeasureValues[s];}}A={coloring:"Criticality",parameters:{measure:V}};}if(A){i.setColorings(p);i.setActiveColoring(A);}}};o.prototype._prepareSelection=function(){if(h){h.prepareChart(this);}else{if(!this.oSelectionHandlerPromise){this.oSelectionHandlerPromise=new Promise(function(r,i){sap.ui.require(["sap/ui/mdc/chart/SelectionHandler"],function(j){h=j;r(true);});});}this.oSelectionHandlerPromise.then(function(){h.prepareChart(this);}.bind(this));}};o.prototype._getSorters=function(){var s,i;var j=this.getSortConditions()||{};Object.keys(j).forEach(function(N){if(this._aInResultProperties.indexOf(N)!=-1){i=new S(N,j[N].descending);if(s){s.push(i);}else{s=[i];}}},this);return s;};o.prototype._rebind=function(){if(this.getAggregation("_chart")&&this.getAggregation("_chart").getBinding("data")){this.getAggregation("_chart").getBinding("data").sort(this._getSorters());}};o.prototype._addCriticality=function(i){var j=this.getProperty("_colorings");j=j||{Criticality:{DimensionValues:{},MeasureValues:{}}};var k=i.getCriticality(),p={};if(i.getVizItemType()=="Dimension"){for(var K in k){p[K]={Values:k[K]};}j.Criticality.DimensionValues[i.getKey()]=p;}else{for(var K in k){p[K]=k[K];}j.Criticality.MeasureValues[i.getKey()]=p;}this.setProperty("_colorings",j);};o.prototype.getCollectionModel=function(){var B=this.getBindingInfo("data");return B?this.getModel(B.model):null;};o.prototype.getCollectionPath=function(){var B=this.getBindingInfo("data");return B?B.path:null;};o.prototype.done=function(){return this.oChartPromise;};return o;},true);
