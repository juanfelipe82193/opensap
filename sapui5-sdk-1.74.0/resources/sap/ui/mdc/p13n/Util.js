/*
* ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
*/
sap.ui.define(['sap/ui/model/json/JSONModel',"sap/base/util/array/diff","sap/m/Button",'sap/base/util/merge'],function(J,d,B,m){"use strict";var i=false;var U={showP13nChart:function(c,s,p,a){this.sP13nType="Chart";var P="sap/ui/mdc/p13n/ChartItemPanel";return this._showDialog(c,s,p,a,P);},showP13nColumns:function(c,s,p,a){this.sP13nType="Columns";var P="sap/ui/mdc/p13n/SelectionPanel";return this._showDialog(c,s,p,a,P);},showP13nSort:function(c,s,p,a){this.sP13nType="Sort";var P="sap/ui/mdc/p13n/SortPanel";return this._showDialog(c,s,p,a,P);},showAdaptFilters:function(c,s,p,a,A){this.sP13nType="AdaptFilters";var P="sap/ui/mdc/p13n/AdaptFiltersPanel";return this._showDialog(c,s,p,a,P);},_showDialog:function(c,s,p,a,P){return new Promise(function(r,b){sap.ui.require(i?['sap/m/Dialog',P]:['sap/m/ResponsivePopover',P],function(C,e){this.sortP13nData(p);this.oJSONModel=new J(p);this.oJSONModel.setSizeLimit(10000);this.oState=m({},p);this.oControl=c;var t=this._getPanelTitle(this.sP13nType);this.fnHandleChange=function(f){U.handleUserChanges(f,c).then(function(){if(a){a();}if(this.oJSONModel){this.oState=m({},this.oJSONModel.getData());}}.bind(this));}.bind(this);var o=new e({change:i?function(){}:[this._registerChangeEvent,this]});o.setP13nModel(this.oJSONModel);var D=this._createDialog(C,o,i,this.oJSONModel,c,t,this.fnHandleChange);c.addDependent(D);if(i){D.open();}else{D.openBy(s);}r(o);}.bind(this));}.bind(this));},_registerChangeEvent:function(){var c=[],s,C=[],I=[],a=[];switch(this.sP13nType){case"Sort":s=function(o){return o.name+o.descending;};C=["removeSort","addSort","moveSort"];break;case"Columns":s=function(o){return o.name;};C=["removeColumn","addColumn","moveColumn"];break;case"Chart":s=function(o){return o.name+o.role;};C=["removeItem","addItem","moveItem"];break;case"AdaptFilters":s=function(o){return o.name;};C=["removeFilter","addFilter","moveFilter"];break;}var f=function(o){return o.selected;};I=this.oState.items.filter(f);a=this.oJSONModel.getData().items.filter(f);c=this._processResult(I,a,s,this.oControl,C[0],C[1],C[2]);this.oState=m({},this.oJSONModel.getData());this.fnHandleChange(c);},_createDialog:function(C,p,i,j,c,M,f){var o;var D=m({},j.getProperty("/"));var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(!i){o=new C({title:r.getText(M),horizontalScrolling:false,verticalScrolling:true,contentWidth:"26rem",resizable:true,contentHeight:"40rem",placement:"HorizontalPreferredRight",content:p,afterClose:function(){o.destroy();f([]);}});}else{o=new C({title:r.getText(M),horizontalScrolling:false,verticalScrolling:true,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._registerChangeEvent();o.close();o.destroy();}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){o.close();o.destroy();j.setProperty("/",m({},D));f([]);}})]});}o.addStyleClass("sapUiMdcPersonalizationDialog");o.toggleStyleClass("sapUiSizeCompact",!!jQuery(c.getDomRef()).closest(".sapUiSizeCompact").length);return o;},_processResult:function(e,c,s,C,r,I,M){var R=d(e,c,s);var f=function(F,A){return A.filter(function(E){return E&&(E.name===F.name);})[0];};var g=function(P){var o={name:P.name};if(P.id){o.id=P.id;}if(P.index>=0){o.index=P.index;}if(P.role){o.role=P.role;}if(P.hasOwnProperty("descending")){o.descending=P.descending==="true"||P.descending===true;}return o;};var a=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var P,E,l;if(o.type==="insert"){E=f(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);a.push({selectorElement:C,changeSpecificData:{changeType:r,content:g(E)}});}}P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}if(M){l=a.length;if(l){E=a[l-1];E=E?E.changeSpecificData.content:undefined;}if(E&&E.name===P.name&&o.index!=E.index){a.pop();a.push(this.createMoveChange(E.id,E.name,o.index,M,C,M!=="moveSort"));return;}}a.push({selectorElement:C,changeSpecificData:{changeType:o.type==="delete"?r:I,content:g(P)}});}.bind(this));return a;},createMoveChange:function(I,p,n,M,c,P){var o={selectorElement:c,changeSpecificData:{changeType:M,content:{id:I,name:p,index:n}}};if(!P){delete o.changeSpecificData.content.id;}return o;},sortP13nData:function(D){var l=sap.ui.getCore().getConfiguration().getLocale().toString();var c=window.Intl.Collator(l,{});D.items.sort(function(f,F){if(f.selected&&F.selected){return(f.position||0)-(F.position||0);}else if(f.selected){return-1;}else if(F.selected){return 1;}else if(!f.selected&&!F.selected){return c.compare(f.label,F.label);}});},_getPanelTitle:function(p){var t;switch(p){case"Sort":t="sort.PERSONALIZATION_DIALOG_TITLE";break;case"Columns":t="table.SETTINGS_COLUMN";break;case"Chart":t="chart.PERSONALIZATION_DIALOG_TITLE";break;case"AdaptFilters":t="filterbar.ADAPT_TITLE";break;}return t;},handleUserChanges:function(c,C){return new Promise(function(r,a){sap.ui.require(["sap/ui/fl/write/api/ControlPersonalizationWriteAPI"],function(b){b.add({changes:c}).then(function(D){r(D);});});});}};return U;});
