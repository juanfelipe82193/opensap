/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/ChartDelegate","./ODataMetaModelUtil","sap/base/util/merge"],function(M,B,a,m){"use strict";var A="@Org.OData.Aggregation.V1";function f(H){this.name=H[0];this.label=H[1]||this.name;this.textProperty=H[2];this.type=a.getType(H[3]);if(H[4]||H[5]){var c=H[4],F=H[5];if(F){switch(F){case"year":this.timeUnit="fiscalyear";break;case"yearPeriod":this.timeUnit="fiscalyearperiod";break;default:this.timeUnit=undefined;break;}}if(c&&!this.timeUnit){switch(c){case"yearMonth":this.timeUnit="yearmonth";break;case"date":this.timeUnit="yearmonthday";break;case"yearQuarter":this.timeUnit="yearquarter";break;case"yearWeek":this.timeUnit="yearweek";break;default:this.timeUnit=undefined;break;}}}this.criticality=H[6];return this;}function h(R){var g=R[0],b=R[1];var H={},p={},I;p.inChart=g||b||false;if(p.inChart){p.chartItems=[];if(g){H.kind=M.ChartItemType.Dimension;H.role=M.ChartItemRoleType.category;I=m({},H);p.chartItems.push(I);}if(b){H.kind=M.ChartItemType.Measure;H.role=M.ChartItemRoleType.axis1;H.contextDefiningProperties=R[4]||[];var s=R[2]||[],d=R[3];for(var i=0;i<s.length;i++){I=m({},H);I.aggregationMethod=s[i];I.default=I.aggregationMethod==d;p.chartItems.push(I);}}}var o=this.getModel();return Promise.all([o.requestObject("@sapui.name",this),o.requestObject("@com.sap.vocabularies.Common.v1.Label",this),o.requestObject("@com.sap.vocabularies.Common.v1.Text/$Path",this),o.requestObject("$Type",this),a.fetchCalendarTag(o,this),a.fetchFiscalTag(o,this),a.fetchCriticality(o,this)]).then(f.bind(p));}function r(e,p,o,b){var k,P,c=[],I=[],s,d=[],S,g,K={};var j=a.getAllCustomAggregates(b);for(var l in j){I.push(m({},j[l],{propertyPath:l,kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:j[l].sortable,filterable:j[l].filterable}));}var t=a.getAllAggregatableProperties(b);for(var n in t){k=t[n].propertyPath;K[k]=K[k]||{};K[k][t[n].aggregationMethod]={name:t[n].name,label:t[n].label};}var q=a.getSortRestrictionsInfo(b["@Org.OData.Capabilities.V1.SortRestrictions"]),F=a.getFilterRestrictionsInfo(b["@Org.OData.Capabilities.V1.FilterRestrictions"]);function u(P){d.push(P);a.addSortInfoForProperty(P,q);a.addFilterInfoForProperty(P,F);if(P.inChart){for(var i=0;i<P.chartItems.length;i++){var v=P.chartItems[i];v.propertyPath=P.name;v.type=P.type;v.timeUnit=P.timeUnit;v.criticality=P.criticality;if(v.kind==M.ChartItemType.Measure){if(K[v.propertyPath]&&K[v.propertyPath][v.aggregationMethod]){v.name=K[v.propertyPath][v.aggregationMethod].name;v.label=K[v.propertyPath][v.aggregationMethod].label;}else{v.name=v.aggregationMethod+v.propertyPath;v.label=P.label+" ("+v.aggregationMethod+")";}v.customAggregate=false;v.sortable=true;v.sortDirection="both";v.filterable=true;}else{v.name=P.name;v.textProperty=P.textProperty;v.label=P.label;v.sortable=P.sortable;v.sortDirection=P.sortDirection;v.filterable=P.filterable;v.allowedExpressions=P.allowedExpressions;}I.push(v);}}}for(k in e){if(k[0]!=="$"){P=e[k];if(P&&P.$kind&&(P.$kind=="Property")){s=p+k+A;c.push(Promise.all([o.requestObject(s+".Groupable"),o.requestObject(s+".Aggregatable"),o.requestObject(s+".SupportedAggregationMethods"),o.requestObject(s+".RecommendedAggregationMethod"),o.requestObject(s+".ContextDefiningProperties")]).then(h.bind(o.getMetaContext(p+k))).then(u));}}}return Promise.all(c).then(function(){return[g,S,d,I];});}var C=Object.assign({},B);C.MetadataProperty={kind:"Measure",role:"axis1",contextDefiningProperties:[],className:"sap.ui.mcd.chart.MeasureItem",aggregationMethod:"sum","default":true,custom:false,name:"sumSalesAmount",propertyPath:"SalesAmount",label:"Total Sales Amount",textProperty:"",sortable:true,sortDirection:"both",filterable:true,allowedExpressions:[]};C.fetchProperties=function(c){return this.retrieveAllMetadata(c).then(function(o){return o.properties;});};C.retrieveAggregationItem=function(s,o){var S;var b={className:"",settings:{key:o.name,label:o.label||o.name,type:o.type}};switch(o.kind){case M.ChartItemType.Dimension:b.className="sap.ui.mdc.chart.DimensionItem";S={textProperty:o.textProperty,timeUnit:o.timeUnit,displayText:true,criticality:o.criticality};break;case M.ChartItemType.Measure:b.className="sap.ui.mdc.chart.MeasureItem";S={propertyPath:o.propertyPath,aggregationMethod:o.aggregationMethod};break;}b.settings=Object.assign(b.settings,S);return b;};C.retrieveAllMetadata=function(c){var d=c.getDelegate(),o=c.getModel(d.model),p="/"+d.payload.collectionName,b=o.getMetaModel();if(p.endsWith("/")){throw new Error("The leading path for metadata calculation is the entity set not the path");}var s=p,t=p+"/";function e(R){var g={sortable:R[0],filterable:R[1],attributes:R[2],properties:R[3]};return g;}var S=[b.requestObject(t),b.requestObject(s)];return Promise.all(S).then(function(T){var E=T[0];var g=[a.fetchAllAnnotations(b,t),a.fetchAllAnnotations(b,s)];return Promise.all(g).then(function(i){var j=Object.assign(i[0],i[1]);return r(E,t,b,j);});}).then(e);};return C;});
