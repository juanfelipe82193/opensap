/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/mdc/library",'sap/base/util/merge','sap/ui/mdc/FilterField','sap/ui/mdc/field/FieldBaseDelegate','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator',"sap/ui/model/FilterOperator","sap/ui/model/Filter",'sap/ui/mdc/util/IdentifierUtil'],function(F,m,a,b,c,d,O,M,e,I){"use strict";var f=Object.assign({},F);var D={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};var v=[];f._fetchPropertiesByMetadata=function(o,p){var g,h,C,i;if(p){var j=p.modifier;g=j.getProperty(o,"delegate");h=g.payload.modelName===null?undefined:g.payload.modelName;C=g.payload.collectionName;i=p.appComponent.getModel(h);}else{g=o.getProperty("delegate");h=g.payload.modelName===null?undefined:g.payload.modelName;C=g.payload.collectionName;i=o.getModel(h);}var k={getDelegate:function(){return{payload:{modelName:h,collectionName:C}};},getModel:function(s){return i;}};return this.fetchProperties(k);};f._isMultiValue=function(s){var i=true;switch(s){case"SearchExpression":case"SingleRange":case"SingleValue":i=false;break;default:break;}return i;};f._ensureSingleRangeEQOperators=function(){var o;if(!d.getOperator("SINGLE_RANGE_EQ")){o=a({},d.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GE,C.values[0]),new e(s,M.LE,C.values[0])],and:true});};d.addOperator(o);}if(!d.getOperator("SINGLE_RANGE_EEQ")){o=a({},d.getOperator("EEQ"));o.name="SINGLE_RANGE_EEQ";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GE,C.values[0]),new e(s,M.LE,C.values[0])],and:true});};d.addOperator(o);}};f._ensureMultiRangeBTEXOperator=function(){if(!d.getOperator("MULTI_RANGE_BTEX")){var o=a({},d.getOperator("BT"));o.name="MULTI_RANGE_BTEX";o.getModelFilter=function(C,s){return new e({filters:[new e(s,M.GT,C.values[0]),new e(s,M.LT,C.values[1])],and:true});};d.addOperator(o);}};f._getFilterOperators=function(s){var o=null,g=null;switch(s){case"SingleValue":case"MultiValue":o="EQ,EEQ";break;case"SingleRange":o="SINGLE_RANGE_EQ,SINGLE_RANGE_EEQ,LE,GE";this._ensureSingleRangeEQOperators();break;case"MultiRange":o="EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;case"SearchExpression":o="StartsWith,EndsWith,Contains";break;case"MultiRangeOrSearchExpression":o="StartsWith,EndsWith,Contains,EQ,EEQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;default:break;}if(o){g=o.split(',');}return g;};f._createFilterField=function(p,o,P){var g=P.modifier;var n=p.path||p.name;var s={};if(o.getId){s.id=o.getId();}else{s.id=o.id;}var S=g.getControlIdBySelector(s,P.appComponent);var i=S+"--filter--"+I.replace(n);return g.createControl("sap.ui.mdc.FilterField",P.appComponent,P.view,i,{dataType:p.type,conditions:"{$filters>/conditions/"+n+'}',required:p.required,label:p.label,maxConditions:p.maxConditions},true).then(function(h){if(p.fieldHelp){var j=p.fieldHelp;if(P.view.getId){j=P.view.getId()+"--"+p.fieldHelp;}g.setAssociation(h,"fieldHelp",j);}if(p.filterOperators){g.setProperty(h,"operators",p.filterOperators);}if(p.tooltip){g.setProperty(h,"tooltip",p.tooltip);}var C=p.constraints;if(C){g.setProperty(h,"dataTypeConstraints",C);}var k=p.formatOptions;if(k){g.setProperty(h,"dataTypeFormatOptions",k);}return h;});};f._createFilter=function(p,o,P){return this._fetchPropertiesByMetadata(o,P).then(function(g){var h=g.find(function(C){return((C.path===p)||(C.name===p));});if(!h){return null;}return Promise.resolve(this._createFilterField(h,o,P));}.bind(this));};f.beforeAddFilterFlex=function(p,o,P){return Promise.resolve(this._createFilter(p,o,P));};f.afterRemoveFilterFlex=function(o,g,p){return Promise.resolve(true);};f._getFieldGroupsByFilterFacetsAnnotation=function(o,E){};f._fetchProperties=function(o,E,p,n){var g,A,h,i,s;var N=[],r=[],S=[],j={},k={};var G,l,q;s='/'+E;q=o.getObject(s+"/@sapui.name");h=o.getObject(s);if(h&&h.$NavigationPropertyBinding){k=h.$NavigationPropertyBinding;}G=q;l=o.getObject(s+'/'+"@com.sap.vocabularies.Common.v1.Label");if(!l){l=G;}A=o.getObject(s+"@Org.OData.Capabilities.V1.FilterRestrictions");if(A){if(A.NonFilterableProperties){A.NonFilterableProperties.every(function(P){N.push(P.$PropertyPath);return true;});}if(A.RequiredProperties){A.RequiredProperties.every(function(P){r.push(P.$PropertyPath);return true;});}if(A.FilterExpressionRestrictions){A.FilterExpressionRestrictions.every(function(P){j[P.Property.$PropertyPath]=P.AllowedExpressions;return true;});}}A=o.getObject(s+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(A){A.every(function(P){S.push(P.$PropertyPath);return true;});}A=f._getFieldGroupsByFilterFacetsAnnotation(o,s);if(A){}var H,t,L,T,V,R,u,w,P,C,x;i=o.getObject(s+"/");for(var K in i){g=i[K];if(g){if(g.$kind==="Property"){if(N.indexOf(K)>=0){continue;}if(o.getObject(s+"/"+K+"@com.sap.vocabularies.UI.v1.Hidden")){continue;}H=false;if(o.getObject(s+"/"+K+"@com.sap.vocabularies.UI.v1.HiddenFilter")){H=true;}x=false;if(o.getObject(s+"/"+K+"@com.sap.vocabularies.Common.v1.IsDigitSequence")){x=true;}t=null;w=o.getObject(s+"/"+K+"@com.sap.vocabularies.Common.v1.FilterDefaultValue");if(w){V=w["$"+D[g.$Type]];switch(g.$Type){case"Edm.DateTimeOffset":t=V;break;default:t=V;}}R=(r.indexOf(K)>=0)?true:false;u=(S.indexOf(K)>=0)?true:false;L=o.getObject(s+"/"+K+"@com.sap.vocabularies.Common.v1.Label")||K;T=o.getObject(s+"/"+K+"@com.sap.vocabularies.Common.v1.QuickInfo")||null;if(g.$MaxLength||g.$Precision||g.$Scale||x){C={};if(g.$MaxLength){C.maxLength=g.$MaxLength;}if(g.$Precision){C.precision=g.$Precision;}if(g.$Scale){C.scale=g.$Scale;}if(x){C.isDigitSequence=x;}}else{C=null;}P={name:K,group:G,label:L,tooltip:T,type:c.getDataTypeClass(g.$Type),required:R,hiddenFilter:H,visible:u};if(C){P.constraints=C;}if(t){P.defaultFilterConditions=[{fieldPath:K,operator:"EQ",values:[t]}];}if(j[K]){var y=this._getFilterOperators(j[K]);if(y){P.filterOperators=y;}}P.maxConditions=this._isMultiValue(j[K])?-1:1;if(n){P.path=n+"/"+K;}if(l){P.groupLabel=l||null;}p.push(P);}else if((g.$kind==="NavigationProperty")&&(!g.$isCollection)&&(v.indexOf(q)===-1)){v.push(q);var z=k[K];if(z){f._fetchProperties(o,z,p,K);}}}}};f.fetchProperties=function(o){if(this._aProperties){Promise.resolve(this._aProperties);}var s=o.getDelegate().payload.modelName;var E=o.getDelegate().payload.collectionName;var g=o.getModel(s===null?undefined:s);return new Promise(function(r,h){var i,p=[];if(!g||!E){h("model or entity set name not available");return;}i=g.getMetaModel();if(!i){h("metadata model not available");}else{v=[];this._fetchProperties(i,E,p);this._aProperties=p;r(p);}}.bind(this));};return f;});
