/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/field/FieldValueHelpContentWrapperBase','sap/ui/model/ChangeReason','sap/ui/model/Filter','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/FilterType','sap/ui/base/ManagedObjectObserver','sap/base/strings/capitalize','sap/m/library','sap/base/util/deepEqual','sap/base/Log'],function(F,C,a,b,P,c,M,d,l,e,L){"use strict";var f=l.ListMode;var S;var g=F.extend("sap.ui.mdc.field.FieldValueHelpMTableWrapper",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.m.Table",multiple:false}},defaultAggregation:"table",events:{dataUpdate:{}}}});g.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(m.bind(this));this._oObserver.observe(this,{properties:["selectedItems"],aggregations:["table"]});this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oPromises={};};g.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._oScrollContainer){this._oScrollContainer.destroy();delete this._oScrollContainer;}this._oObserver.disconnect();this._oObserver=undefined;delete this._oTablePromise;delete this._oTablePromiseResolve;};g.prototype.invalidate=function(O){if(O){var T=this.getTable();if(T&&O===T){if(O.bOutput&&!this._bIsBeingDestroyed){var i=this.getParent();if(i){i.invalidate(this);}}return;}}F.prototype.invalidate.apply(this,arguments);};g.prototype.initialize=function(i){if(i||this._oScrollContainer){return this;}if(!S&&!this._bScrollContainerRequested){S=sap.ui.require("sap/m/ScrollContainer");if(!S){sap.ui.require(["sap/m/ScrollContainer"],_.bind(this));this._bScrollContainerRequested=true;}}if(S&&!this._bScrollContainerRequested){this._oScrollContainer=new S(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var j=[];var T=this._oWrapper&&this._oWrapper.getTable();if(T){j.push(T);}return j;};}return this;};function _(i){S=i;this._bScrollContainerRequested=false;if(!this._bIsBeingDestroyed){this.initialize();this.fireDataUpdate({contentChange:true});}}g.prototype.getDialogContent=function(){return this._oScrollContainer;};g.prototype.getSuggestionContent=function(){return this.getTable();};g.prototype.fieldHelpOpen=function(i){F.prototype.fieldHelpOpen.apply(this,arguments);var T=this.getTable();if(T){p.call(this,T,i);u.call(this);if(i){var j=T.getSelectedItem();if(j&&j.getDomRef()){j.getDomRef().scrollIntoView();}}}return this;};g.prototype.navigate=function(i){var T=this.getTable();if(!x(T)){this._bNavigate=true;this._iStep=i;return;}var j=T.getSelectedItem();var I=T.getItems();var y=I.length;var z=0;if(j){z=T.indexOfItem(j);z=z+i;}else if(i>=0){z=i-1;}else{z=y+i;}if(z<0){z=0;}else if(z>=y-1){z=y-1;}var A=I[z];if(A&&A!==j){A.setSelected(true);var V=v.call(this,A);if(A.getDomRef()){A.getDomRef().scrollIntoView();}this._bNoTableUpdate=true;this.setSelectedItems([{key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters}]);this._bNoTableUpdate=false;this.fireNavigate({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}};g.prototype.getTextForKey=function(K,I,O){if(K===null||K===undefined){return null;}var T=this.getTable();if(x(T)){var R={key:K,description:""};var j=T.getItems();var y;var z;var A=false;if(I){y=[];for(var B in I){y.push(B);}}if(O){z=[];for(var D in O){z.push(D);}}for(var i=0;i<j.length;i++){var E=j[i];var V=v.call(this,E,y,z);if(V.key===K&&(!V.inParameters||!I||e(I,V.inParameters))&&(!V.outParameters||!O||e(O,V.outParameters))){R.description=V.description;R.inParameters=V.inParameters;R.outParameters=V.outParameters;A=true;break;}}if(A){return R;}}return h.call(this,this._getKeyPath,K,"description",I,O,true);};g.prototype.getKeyForText=function(T,I){if(!T){return null;}var j=this.getTable();if(x(j)){var R={key:undefined,description:T};var y=j.getItems();var z;var A=false;if(I){z=[];for(var B in I){z.push(B);}}for(var i=0;i<y.length;i++){var D=y[i];var V=v.call(this,D,z);if(V.description===T&&(!V.inParameters||!I||e(I,V.inParameters))){R.key=V.key;R.inParameters=V.inParameters;R.outParameters=V.outParameters;A=true;break;}}if(A){return R;}}return h.call(this,this._getDescriptionPath,T,"key",I,undefined,false);};function h(i,V,R,I,O,U){var j=i.call(this);if(this._oPromises[j]&&this._oPromises[j][V]){return this._oPromises[j][V];}if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=new Promise(function(y,z){this._oTablePromise.then(function(T){var A=j;j=i.call(this);if(!j){z(new Error("missing FieldPath"));}if(j!==A){if(!this._oPromises[j]){this._oPromises[j]={};}this._oPromises[j][V]=this._oPromises[A][V];delete this._oPromises[A][V];}var B=this.getListBinding();var D=B.getModel();var E=B.getPath();var G=new a(j,"EQ",V);var H=B.getContext();var J=[];if(I){for(var K in I){J.push(new a(K,"EQ",I[K]));}}if(O){for(var N in O){if(!I||!I.hasOwnProperty(N)||I[N]!==O[N]){J.push(new a(N,"EQ",O[N]));}}}if(J.length>0){J.push(G);G=new a({filters:J,and:true});}try{var Q=D.bindList(E,H);var W=function(){var Y=Q.getContexts();if(Y.length===1){var Z=w.call(this,Y[0]);var $={key:Z.key,description:Z.description,inParameters:Z.inParameters,outParameters:Z.outParameters};y($);}else if(V===""&&Y.length===0){y(null);}else{var a1;var b1;var c1=false;if(Y.length>1){a1=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[V]);c1=true;}else{a1=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[V]);}if(U){b1=new b(a1);}else{b1=new P(a1);}b1._bNotUnique=c1;z(b1);}Q.destroy();delete this._oPromises[j][V];};if(Q.isA("sap.ui.model.json.JSONListBinding")){Q.filter(G,c.Application);W.call(this);}else{Q.attachEventOnce("dataReceived",W.bind(this));Q.initialize();Q.filter(G,c.Application);Q.getContexts(0,2);}}catch(X){z(X);}}.bind(this));}.bind(this));return this._oPromises[j][V];}g.prototype.getListBinding=function(){var T=this.getTable();var i;if(T){i=T.getBinding("items");}return i;};g.prototype.getAsyncKeyText=function(){return true;};g.prototype.applyFilters=function(i,j){var y=this.getListBinding();if(!y){this._oTablePromise.then(function(T){this.applyFilters(i,j);}.bind(this));return;}var D=this._getDelegate();var U=true;var z=y.getFilterInfo();if(!i){i=[];}if(i.length===0&&!z){U=false;}if(D.delegate&&D.delegate.isSearchSupported(D.payload,y)){if(!y.isSuspended()&&U){y.suspend();}D.delegate.executeSearch(D.payload,y,j);L.info("ValueHelp-Search: "+j);}if(U){y.filter(i,c.Application);L.info("ValueHelp-Filter: "+k.call(this,i));}if(y.isSuspended()){y.resume();}};g.prototype.isSuspended=function(){var i=this.getListBinding();if(!i){return true;}return i.isSuspended();};function k(i){var R;if(!i){return"";}if(Array.isArray(i)){R="";i.forEach(function(i,I,j){R+=k.call(this,i);if(j.length-1!=I){R+=" or ";}},this);return"("+R+")";}else if(i._bMultiFilter){R="";var A=i.bAnd;i.aFilters.forEach(function(i,I,j){R+=k.call(this,i);if(j.length-1!=I){R+=A?" and ":" or ";}},this);return"("+R+")";}else{R=i.sPath+" "+i.sOperator+" '"+i.oValue1+"'";if(i.sOperator==="BT"){R+="...'"+i.oValue2+"'";}return R;}}g.prototype.clone=function(i,j){var T=this.getTable();if(T){T.detachEvent("itemPress",q,this);T.detachEvent("selectionChange",r,this);T.detachEvent("updateFinished",t,this);}var y=F.prototype.clone.apply(this,arguments);if(T){T.attachEvent("itemPress",q,this);T.attachEvent("selectionChange",r,this);T.attachEvent("updateFinished",t,this);}return y;};function m(i){if(i.name==="table"){n.call(this,i.mutation,i.child);}if(i.name==="selectedItems"){u.call(this);}}function n(i,T){if(i==="remove"){T.detachEvent("itemPress",q,this);T.detachEvent("selectionChange",r,this);T.detachEvent("updateFinished",t,this);T.detachEvent("modelContextChange",o,this);T=undefined;this._oTablePromise=new Promise(function(R){this._oTablePromiseResolve=R;}.bind(this));}else{T.setMode(f.SingleSelectMaster);T.setRememberSelections(false);T.attachEvent("itemPress",q,this);T.attachEvent("selectionChange",r,this);T.attachEvent("updateFinished",t,this);p.call(this,T,this._bSuggestion);u.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(this.getListBinding()){this._oTablePromiseResolve(T);}else{T.attachEvent("modelContextChange",o,this);}}this.fireDataUpdate({contentChange:true});}function o(E){if(this.getListBinding()){var T=E.getSource();this._oTablePromiseResolve(T);T.detachEvent("modelContextChange",o,this);}}function p(T,i){if(T&&this.getParent()){if(i){if(this._sTableWidth){T.setWidth(this._sTableWidth);}T.setMode(f.SingleSelectMaster);}else{if(T.getWidth()!=="100%"){this._sTableWidth=T.getWidth();T.setWidth("100%");}if(this._getMaxConditions()===1){T.setMode(f.SingleSelectLeft);}else{T.setMode(f.MultiSelect);}}}}function q(E){var i=E.getParameter("listItem");if(!this._bSuggestion){i.setSelected(!i.getSelected());}s.call(this);}function r(E){if(!this._bSuggestion){s.call(this);}}function s(){var I=[];var T=this.getTable();if(T){var y=this.getSelectedItems();var z=T.getItems();var i=0;var A;var V;if(y.length>0){for(i=0;i<z.length;i++){A=z[i];V=v.call(this,A);if(!V){throw new Error("Key of item cannot be determined"+this);}for(var j=y.length-1;j>=0;j--){var B=y[j];if(B.key===V.key&&(!V.inParameters||!B.inParameters||e(B.inParameters,V.inParameters))&&(!V.outParameters||!B.outParameters||e(B.outParameters,V.outParameters))){y.splice(j,1);break;}}}}if(y.length>0){I=y;}y=T.getSelectedItems();for(i=0;i<y.length;i++){A=y[i];V=v.call(this,A);if(!V){throw new Error("Key of item cannot be determined"+this);}I.push({key:V.key,description:V.description,inParameters:V.inParameters,outParameters:V.outParameters});}}this._bNoTableUpdate=true;this.setSelectedItems(I);this._bNoTableUpdate=false;this.fireSelectionChange({selectedItems:I});}function t(E){if(!this.getParent()){return;}u.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);}if(E.getParameter("reason")!==d(C.Filter)){this.fireDataUpdate({contentChange:false});}}function u(){if(this._bNoTableUpdate){return;}var T=this.getTable();if(x(T)){var y=this.getSelectedItems();var I=T.getItems();for(var j=0;j<I.length;j++){var z=I[j];var A=false;if(y.length>0){var V=v.call(this,z);for(var i=0;i<y.length;i++){var B=y[i];if(V.key===B.key&&(!V.inParameters||!B.inParameters||e(B.inParameters,V.inParameters))&&(!V.outParameters||!B.outParameters||e(B.outParameters,V.outParameters))){A=true;break;}}}if(z.getSelected()!==A){z.setSelected(A);}}}}function v(i,I,O){var V;var B=i.getBindingContext();if(B){V=w.call(this,B,I,O);}if(!V){var K=this._getKeyPath();var j;var D;if(!K&&i.getCells){var y=i.getCells();if(y.length>0&&y[0].getText){j=y[0].getText();}if(y.length>1&&y[1].getText){D=y[1].getText();}if(j!==undefined){V={key:j,description:D};}}}if(!V){throw new Error("Key could not be determined from item "+this);}return V;}function w(B,I,O){var K=this._getKeyPath();var D=this._getDescriptionPath();var j=B.getObject();var y;var z;if(!I){I=this._getInParameters();}if(!O){O=this._getOutParameters();}var A=I.length>0?{}:null;var E=O.length>0?{}:null;var G;if(j){if(K&&j.hasOwnProperty(K)){y=j[K];}if(D&&j.hasOwnProperty(D)){z=j[D];}var i=0;for(i=0;i<I.length;i++){G=I[i];if(j.hasOwnProperty(G)){A[G]=j[G];}}for(i=0;i<O.length;i++){G=O[i];if(j.hasOwnProperty(G)){E[G]=j[G];}else{L.error("FieldValueHelpMTableWrapper","cannot find out-parameter '"+G+"' in item data!");}}}if(y===null||y===undefined){return false;}return{key:y,description:z,inParameters:A,outParameters:E};}function x(T){if(!T){return false;}var B=T.getBinding("items");if(B&&(B.isSuspended()||B.getLength()===0)){return false;}return true;}return g;});
