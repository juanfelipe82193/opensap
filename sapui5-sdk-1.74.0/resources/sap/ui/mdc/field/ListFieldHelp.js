/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/field/FieldHelpBase','sap/ui/mdc/condition/Condition','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/library'],function(F,C,a,P,M,b,l){"use strict";var L;var D;var m;var c;var d=F.extend("sap.ui.mdc.field.ListFieldHelp",{metadata:{library:"sap.ui.mdc",aggregations:{items:{type:"sap.ui.core.ListItem",multiple:true,singularName:"item"}},defaultAggregation:"items"}});d.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oManagedObjectModel=new M(this);this._oObserver=new b(f.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions"],aggregations:["items"]});this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");};d.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oManagedObjectModel.destroy();delete this._oManagedObjectModel;this._oObserver.disconnect();this._oObserver=undefined;};d.prototype._createPopover=function(){var i=F.prototype._createPopover.apply(this,arguments);if((!L||!D||!m)&&!this._bListRequested){L=sap.ui.require("sap/m/List");D=sap.ui.require("sap/m/DisplayListItem");m=sap.ui.require("sap/m/library");c=sap.ui.require("sap/ui/model/Filter");if(!L||!D||!m){sap.ui.require(["sap/m/List","sap/m/DisplayListItem","sap/m/library","sap/ui/model/Filter"],e.bind(this));this._bListRequested=true;}}if(i){var q=this._getField();if(q){i.setInitialFocus(this._getControlForSuggestion());}_.call(this);}return i;};function _(){if(!this._oList&&L&&D&&m&&!this._bListRequested){var i=new D({type:m.ListType.Active,label:"{$field>text}",value:"{$field>additionalText}"});var q=new c("text",k.bind(this));this._oList=new L(this.getId()+"-List",{width:"100%",showNoData:false,mode:m.ListMode.SingleSelectMaster,rememberSelections:false,items:{path:"$field>items",template:i,filters:q},itemPress:g.bind(this)});this._oList.setModel(this._oManagedObjectModel,"$field");this._oList.bindElement({path:"/",model:"$field"});n.call(this);this._setContent(this._oList);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}}function e(i,q,r,s){L=i;D=q;m=r;c=s;this._bListRequested=false;if(!this._bIsBeingDestroyed){_.call(this);}}d.prototype.open=function(s){var i=this.getAggregation("_popover");if(i){i.setInitialFocus(this._getControlForSuggestion());}F.prototype.open.apply(this,arguments);return this;};d.prototype._handleAfterClose=function(E){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;j.call(this);}};function f(i){if(i.object===this){if(i.name==="items"){if(i.mutation==="insert"){this._oObserver.observe(i.child,{properties:true});}else{this._oObserver.unobserve(i.child);}this.fireDataUpdate();}if(i.name==="conditions"){if(!this._bConditionUpdate){n.call(this);}}if(i.name==="filterValue"){if(this._oList){if(this._bClosing){this._bUpdateFilterAfterClose=true;}else{j.call(this);}}}}else{this.fireDataUpdate();}}d.prototype.openByTyping=function(){return true;};d.prototype.navigate=function(s){var i=this._getPopover();if(!i||!this._oList){this._bNavigate=true;this._iStep=s;return;}var S=this._oList.getSelectedItem();var I=this._oList.getItems();var q=I.length;var r=0;if(S){r=this._oList.indexOfItem(S);r=r+s;if(r<0){r=0;}else if(r>=q-1){r=q-1;}}else if(s>=0){r=s-1;}else{r=q+s;}var t=I[r];if(t&&t!==S){var O=h.call(this,t);var K=o.call(this,O);t.setSelected(true);var u=p.call(this,K,t.getLabel());if(!i.isOpen()){this.open();}this.fireNavigate({key:K,value:t.getLabel(),condition:u});}};d.prototype.getTextForKey=function(K){if(K===null||K===undefined){return null;}var I=this.getItems();for(var i=0;i<I.length;i++){var q=I[i];if(o.call(this,q)===K){return q.getText();}}if(K===""){return null;}var E=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[K]);throw new a(E);};d.prototype.getKeyForText=function(t){if(!t){return null;}var I=this.getItems();for(var i=0;i<I.length;i++){var q=I[i];if(q.getText()===t){return o.call(this,q);}}var E=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[t]);throw new P(E);};function g(E){var i=E.getParameter("listItem");var s=i.getSelected();if(s){var O=h.call(this,i);var K=o.call(this,O);p.call(this,K,i.getLabel());this.close();this.fireSelect({conditions:this.getConditions(),add:true});}}function h(i){var s=i.getBindingContextPath();return this._oManagedObjectModel.getProperty(s);}function j(){var B=this._oList.getBinding("items");B.update();this._oList.updateItems();this._oList.invalidate();n.call(this);}function k(t){var s=this.getFilterValue();if(!s||(typeof s==="string"&&t.toLowerCase().startsWith(s.toLowerCase()))){return true;}else{return false;}}function n(){if(this._oList){var q=this.getConditions();var s;if(q.length>0&&(q[0].operator==="EEQ"||q[0].operator==="EQ")){s=q[0].values[0];}var I=this._oList.getItems();for(var i=0;i<I.length;i++){var r=I[i];var O=h.call(this,r);if(o.call(this,O)===s){r.setSelected(true);}else{r.setSelected(false);}}}}function o(i){var B=i.getBinding("key");if(B){return B.getInternalValue();}else{return i.getKey();}}function p(K,v){this._bConditionUpdate=true;var i=C.createItemCondition(K,v);this.setProperty("conditions",[i],true);this._bConditionUpdate=false;return i;}return d;});
