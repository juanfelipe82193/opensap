/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/XMLComposite","sap/ui/mdc/condition/Condition","sap/ui/model/Filter","sap/ui/model/type/String","sap/ui/base/ManagedObjectObserver","sap/m/FlexItemData","sap/base/util/merge","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/util/BaseType","sap/ui/mdc/Field"],function(X,C,F,S,M,a,m,b,B,c){"use strict";var o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");});var D=X.extend("sap.ui.mdc.field.DefineConditionPanel",{metadata:{properties:{conditions:{type:"object[]",group:"Data",defaultValue:[],byValue:true},formatOptions:{type:"object",defaultValue:{}}},events:{}},fragment:"sap.ui.mdc.field.DefineConditionPanel",init:function(){sap.ui.getCore().getMessageManager().registerObject(this,true);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["conditions","formatOptions"]});var v=this.byId("defineCondition");this._oObserver.observe(v,{aggregations:["content"]});},exit:function(){sap.ui.getCore().getMessageManager().unregisterObject(this,true);this._oObserver.disconnect();this._oObserver=undefined;if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}},onBeforeRendering:function(){if(!this.oOperatorModel){var t=j.call(this);var O=h.call(this);var i=o.getText("valuehelp.INCLUDE");var E=o.getText("valuehelp.EXCLUDE");var l=[];O.forEach(function(s){var n=b.getOperator(s);if(n.showInSuggest!==undefined&&n.showInSuggest==false){return;}var T=n.textKey||"operators."+n.name+".longText";var p=n.getTypeText(T,t.getName().toLowerCase());if(p===T){p=n.longText;}l.push({key:n.name,additionalText:p,info:n.exclude?E:i});},this);this.oOperatorModel=new sap.ui.model.json.JSONModel();this.oOperatorModel.setData(l);this.setModel(this.oOperatorModel,"om");}if(this.getConditions().length===0){this.updateDefineConditions();this._updateButtonVisibility();}},_updateButtonVisibility:function(l){var v=this.byId("defineCondition");if(!v){return;}var r=v.getContent();var n=this.getFormatOptions();var p=n.maxConditions;for(var i=0;i<r.length;i++){var R=r[i];var H=R.getContent()[2];var q=H.getItems()[1];q.setVisible((i===r.length-1)&&(p==-1||i<p-1));}},removeCondition:function(E){var s=E.oSource;var i=s.getBindingContext("$this").getObject();var I=C.indexOfCondition(i,this.getConditions());var l=this.getConditions();this._bUpdateConditionsInternal=true;l.splice(I,1);this.setProperty("conditions",l,true);this.updateDefineConditions();this._updateButtonVisibility();this.invalidate();},addCondition:function(E){var s=E.oSource;var i=s.getBindingContext("$this").getObject();var l=this.getConditions();var I=C.indexOfCondition(i,l);var n=this.getFormatOptions();var p=n.maxConditions;if(p==-1||l.length<p){this._bUpdateConditionsInternal=true;this.addDummyCondition(I+1);}},addDummyCondition:function(i){var O=h.call(this);var l=C.createCondition("EQ",[null]);b.checkConditionsEmpty(l,O);var n=this.getConditions();if(i!==undefined){n.splice(i,0,l);}else{n.push(l);}this.setProperty("conditions",n,true);this._updateButtonVisibility();},updateDefineConditions:function(){var i=this.getConditions().filter(function(l){return l.operator!=="EEQ";});if(i.length===0){this._bUpdateConditionsInternal=true;this.addDummyCondition();}},valueCtrlFactory:function(i,l){var n=l.oModel;var p=l.sPath;var q=parseInt(p.split("/")[p.split("/").length-1]);p=p.slice(0,p.lastIndexOf("/"));p=p.slice(0,p.lastIndexOf("/"));var r=n.getProperty(p);var O=h.call(this);var s=b.getOperator(r.operator,O);var t=j.call(this);var v=g.call(this,t,s,"$this>",q);v.addStyleClass("sapUiSmallPaddingBegin");v.setLayoutData(new a({shrinkFactor:0,growFactor:1}));if(v.attachChange){v.attachChange(this.onChange.bind(this));v.onpaste=this.onPaste.bind(this);}return v;},onChange:function(E){var O=h.call(this);var i=this.getConditions();b.checkConditionsEmpty(i,O);b.updateConditionsValues(i,O);this.setProperty("conditions",i,true);},onPaste:function(E){var O,s=E.srcControl;if(window.clipboardData){O=window.clipboardData.getData("Text");}else{O=E.originalEvent.clipboardData.getData('text/plain');}var l=O.split(/\r\n|\r|\n/g);if(l&&l.length>1){setTimeout(function(){var n=h.call(this);var t=j.call(this);var T=k.call(this,t);var L=l.length;var p=this.getConditions();for(var i=0;i<L;i++){if(l[i]){var v=l[i];var V=v.split(/\t/g);var q;if(V.length==2&&V[0]&&V[1]){q=b.getOperator("BT",n);}else{V=[v.trim()];q=b.getDefaultOperator(T);}v=q?q.format(V):V[0];if(q){var r=q.getCondition(v,t);if(r){b.checkConditionsEmpty(r,n);p.push(r);}}}}this.setProperty("conditions",p,true);if(s.setDOMValue){s.setDOMValue("");}}.bind(this),0);}}});function _(i){if(i.name==="content"&&i.mutation==="insert"){d.call(this,i.child);}if(i.name==="selectedKey"){f.call(this,i.object);}if(i.name==="formatOptions"){var l=this.getConditions();if(l.length>0){e.call(this);this.setConditions([]);this.setConditions(l);}}if(i.name==="conditions"){if(this._bUpdateConditionsInternal){this._bUpdateConditionsInternal=false;return;}if(this._sConditionsTimer){clearTimeout(this._sConditionsTimer);this._sConditionsTimer=null;}this._sConditionsTimer=setTimeout(function(){this._sConditionsTimer=null;this.updateDefineConditions();this._updateButtonVisibility();}.bind(this),0);}}function d(G){var i=G.getContent();var s=i[0];var H=i[1];var l=H.getBinding("items");l.suspend();this._oObserver.observe(s,{properties:["selectedKey"]});}function e(){var v=this.byId("defineCondition");var G=v.getContent();for(var i=0;i<G.length;i++){var l=G[i];var n=l.getContent();var H=n[1];var L=H.getBinding("items");L.resume();}}function f(s){var G=s.getParent();var i=G.getContent();var H=i[1];var l=H.getBinding("items");this.onChange();l.checkUpdate(true);}function g(i,O,p,l){if(O.valueTypes[l]&&O.valueTypes[l]!=="self"){i=O._createLocalType(O.valueTypes[l]);}if(O.createControl){return O.createControl(i,O,p,l);}var t=k.call(this,i);var n;var T;var q;var r;switch(t){case B.Boolean:if(i.oConstraints&&i.oConstraints.hasOwnProperty("nullable")&&i.oConstraints.nullable===false){T=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));q=m({},i.oFormatOptions);r=m(i.oConstraints,{nullable:true});n=new T(q,r);}else{n=i;}break;case B.Numeric:if(i.oFormatOptions&&i.oFormatOptions.hasOwnProperty("emptyString")&&i.oFormatOptions.emptyString===null){n=i;}else{T=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));q=m(i.oFormatOptions,{emptyString:null});n=new T(q,i.oConstraints);}break;case B.Date:case B.Time:case B.DateTime:n=i;break;default:n=i;break;}var s=new c({value:{path:p,type:n,mode:'TwoWay',targetType:'raw'},width:"100%"});return s;}function h(){var i=this.getFormatOptions();var O=i&&i.operators;if(!O||O.length===0){O=b.getOperatorsForType(B.String);}return O;}function j(){var i=this.getFormatOptions();var t=i&&i.valueType;if(!t){if(!this._oDefaultType){this._oDefaultType=new S();}t=this._oDefaultType;}return t;}function k(t){var T=t.getMetadata().getName();var i=t.oFormatOptions;var l=t.oConstraints;var n=this.getFormatOptions().delegate;var p=this.getFormatOptions().payload;var s=n?n.getBaseType(p,T,i,l):B.String;if(s===B.Unit){s=B.Numeric;}return s;}return D;});
