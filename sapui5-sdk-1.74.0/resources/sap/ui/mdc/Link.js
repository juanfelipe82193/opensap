/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/mdc/field/FieldInfoBase","sap/m/ResponsivePopover","sap/ui/thirdparty/jquery","sap/ui/core/InvisibleText","sap/ui/model/json/JSONModel","sap/ui/mdc/link/Log","sap/base/Log","sap/ui/mdc/link/Panel","sap/ui/mdc/link/PanelItem","sap/ui/layout/form/SimpleForm","sap/ui/core/Title","sap/ui/layout/library","sap/ui/mdc/link/Factory"],function(F,R,q,I,J,L,S,P,a,b,C,l,c){"use strict";var d=l.form.SimpleFormLayout.ResponsiveGridLayout;var e=F.extend("sap.ui.mdc.Link",{metadata:{library:"sap.ui.mdc",properties:{enablePersonalization:{type:"boolean",defaultValue:true},delegate:{type:"object",defaultValue:{name:"sap/ui/mdc/LinkDelegate",payload:{}}}},associations:{sourceControl:{type:"sap.ui.core.Control",multiple:false}}}});e.prototype.applySettings=function(s,o){F.prototype.applySettings.apply(this,arguments);this.oUseDelegatePromise=this._useDelegate();this.oUseDelegatePromise.then(this._determineContent.bind(this));};e.prototype.init=function(){var m=new J({contentTitle:undefined,bHasPotentialContent:undefined,linkItems:[]});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuimdcLink");this._aAdditionalContent=[];this._aLinkItems=[];};e.prototype.getDirectLinkHrefAndTarget=function(){return this.getDirectLink().then(function(o){return o?{target:o.getTarget(),href:o.getHref()}:null;});};e.prototype.isTriggerable=function(){return this.hasPotentialContent();};e.prototype.getTriggerHref=function(){return this.getDirectLinkHrefAndTarget().then(function(o){return o?o.href:null;});};e.retrieveAllMetadata=function(p){if(!p.getModel||!p.getModel("$sapuimdcLink")){return[];}var m=p.getModel("$sapuimdcLink");return m.getProperty("/metadata").map(function(M){return{id:M.key,text:M.text,description:M.description,href:M.href,target:M.target,visible:M.visible};});};e.retrieveBaseline=function(p){if(!p.getModel||!p.getModel("$sapuimdcLink")){return[];}var m=p.getModel("$sapuimdcLink");return m.getProperty("/baseline").map(function(M){return{id:M.key,visible:true};});};e.prototype.hasPotentialContent=function(){return this._waitForUseDelegatePromise(function(){if(!!this.getAdditionalContent().length){return Promise.resolve(true);}return Promise.resolve(this.hasPotentialLinks());}.bind(this));};e.prototype.getDirectLink=function(){return this._waitForUseDelegatePromise(function(){var f=this.getAdditionalContent().length?[]:this.getLinkItems();var t=f.filter(function(i){return!!i.getHref();});if(t.length!==1){return null;}return t[0];}.bind(this));};e.prototype.getContentTitle=function(){return new I({text:this._getContentTitle()});};e.prototype.getContent=function(g){return this.oUseDelegatePromise.then(function(){return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){return new Promise(function(r){sap.ui.require(['sap/ui/fl/Utils','sap/ui/fl/apply/api/FlexRuntimeInfoAPI'],function(U,f){var h=this.getLinkItems();var A=this.getAdditionalContent();this._setConvertedLinkItems(h,this._getView(U));var m=this._getInternalModel().getProperty("/linkItems");var M=this._getInternalModel().getProperty("/baselineLinkItems");var p=new P(this._createPanelId(U,f),{enablePersonalization:this.getEnablePersonalization(),items:M.map(function(o){return new a(o.key,{text:o.text,description:o.description,href:o.href,target:o.target,icon:o.icon,visible:true});}),additionalContent:!A.length&&!m.length?e._getNoContent():A,beforeSelectionDialogOpen:function(){if(g&&g()){g().setModal(true);}},afterSelectionDialogClose:function(){if(g&&g()){g().setModal(false);}},metadataHelperPath:"sap/ui/mdc/Link"});p.setModel(new J({metadata:q.extend(true,[],this._getInternalModel().getProperty("/linkItems")),baseline:q.extend(true,[],this._getInternalModel().getProperty("/baselineLinkItems"))}),"$sapuimdcLink");return r(p);}.bind(this));}.bind(this));}.bind(this));}.bind(this));};e.prototype.hasPotentialLinks=function(){var p=this.getDelegate().payload;if(this.getLinkItems().length){return Promise.resolve(true);}if(p&&p.semanticObjects){return e.hasDistinctSemanticObject(p.semanticObjects).then(function(h){return Promise.resolve(!!h);});}return Promise.resolve(false);};e.mSemanticObjects={};e.oPromise=null;e.hasDistinctSemanticObject=function(s){if(e._haveBeenRetrievedAllSemanticObjects(s)){return Promise.resolve(e._atLeastOneExistsSemanticObject(s));}return e._retrieveDistinctSemanticObjects().then(function(){return e._atLeastOneExistsSemanticObject(s);});};e._haveBeenRetrievedAllSemanticObjects=function(s){return s.filter(function(f){return!e.mSemanticObjects[f];}).length===0;};e._atLeastOneExistsSemanticObject=function(s){return s.some(function(f){return e.mSemanticObjects[f]&&(e.mSemanticObjects[f].exists===true);});};e._retrieveDistinctSemanticObjects=function(){if(!e.oPromise){e.oPromise=new Promise(function(r){var o=c.getService("CrossApplicationNavigation");if(!o){S.error("Link: Service 'CrossApplicationNavigation' could not be obtained");return r({});}o.getDistinctSemanticObjects().then(function(D){D.forEach(function(s){e.mSemanticObjects[s]={exists:true};});e.oPromise=null;return r(e.mSemanticObjects);},function(){S.error("Link: getDistinctSemanticObjects() of service 'CrossApplicationNavigation' failed");return r({});});});}return e.oPromise;};e.destroyDistinctSemanticObjects=function(){e.mSemanticObjects={};};e.prototype.getLinkItems=function(){return this._aLinkItems;};e.prototype.getAdditionalContent=function(){return this._aAdditionalContent;};e.prototype.getSourceControl=function(){return this.getAssociation("sourceControl");};e.prototype.addLinkItem=function(o){if(o&&o.isA("sap.ui.mdc.link.LinkItem")&&this.oUseDelegatePromise){this.oUseDelegatePromise.then(function(){this.addDependent(o);this.getLinkItems().push(o);this.fireDataUpdate();this._determineContent();}.bind(this));}else{S.error("Link: addLinkItem for "+o+" failed. Please make sure that it's a 'sap.ui.mdc.link.LinkItem'.");}};e.prototype.addAdditionalContent=function(A){if(A&&A.isA("sap.ui.core.Control")&&this.oUseDelegatePromise){this.oUseDelegatePromise.then(function(){this.getAdditionalContent().push(A);this._determineContent();}.bind(this));}else{S.error("Link: addAdditionalContent for "+A+" failed.");}};e.prototype.removeAllLinkItems=function(){if(this.oUseDelegatePromise){this.oUseDelegatePromise.then(function(){this.getLinkItems().forEach(function(o){o.destroy();o=undefined;});this._setLinkItems([]);this._determineContent();}.bind(this));}};e.prototype._getContentTitle=function(){return this._getInternalModel().getProperty("/contentTitle");};e.prototype._getContextObject=function(){var o=sap.ui.getCore().byId(this.getSourceControl());var B=o&&o.getBindingContext()||this.getBindingContext();return B?B.getObject(B.getPath()):undefined;};e.prototype._getInfoLog=function(){if(this.getDelegate().payload&&this.getDelegate().payload.semanticObjects){if(this._oInfoLog){return this._oInfoLog;}if(S.getLevel()>=S.Level.INFO){this._oInfoLog=new L();this._oInfoLog.initialize(this.getDelegate().payload.semanticObjects,this._getContextObject());return this._oInfoLog;}}return undefined;};e.prototype._getInternalModel=function(){return this.getModel("$sapuimdcLink");};e._getLinkItemByKey=function(k,A){return A.filter(function(m){return m.key===k;})[0];};e.prototype._getLinkItemsPromise=function(){return Promise.resolve(this.getLinkItems());};e.prototype._getLogFormattedText=function(){return(this._oInfoLog&&!this._oInfoLog.isEmpty())?"---------------------------------------------\nsap.ui.mdc.Link:\nBelow you can see detailed information regarding semantic attributes which have been calculated for one or more semantic objects defined in a Link control. Semantic attributes are used to create the URL parameters. Additionally you can see all links containing the URL parameters.\n"+this._oInfoLog.getFormattedText():"No logging data available";};e._getNoContent=function(){var s=new b({layout:d,content:[new C({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("info.POPOVER_MSG_NO_CONTENT")})]});s.addStyleClass("mdcbaseinfoPanelDefaultAdditionalContent");return s;};e.prototype._getView=function(U){var f;if(this.getParent()){f=this.getParent();}var o=sap.ui.getCore().byId(this.getSourceControl());if(!o){this.setSourceControl(f);}return U.getViewForControl(o)||U.getViewForControl(f);};e.prototype._setContentTitle=function(t){return this._getInternalModel().setProperty("/contentTitle",t);};e.prototype._setConvertedLinkItems=function(f,v){var m=this._getInternalModel();var M=f.map(function(o){if(!o.getKey()){S.error("sap.ui.mdc.Link: undefined 'key' property of the LinkItem "+o.getId()+". The mandatory 'key' property should be defined due to personalization reasons.");}return{key:v?v.createId(o.getKey()):o.getKey(),text:o.getText(),description:o.getDescription(),href:o.getHref(),target:o.getTarget(),icon:o.getIcon(),isSuperior:o.getIsSuperior(),visible:false};});m.setProperty("/linkItems/",M);var g=M.filter(function(o){return!o.key;});m.setProperty("/baselineLinkItems/",g);};e.prototype._setLinkItems=function(f){var g=f.filter(function(o){return o.getParent()===null;});g.forEach(function(o){this.addDependent(o);}.bind(this));this._aLinkItems=f;};e.prototype._createPanelId=function(U,f){var o;if(this.getParent()){o=this.getParent();}var g=sap.ui.getCore().byId(this.getSourceControl());if(!g){this.setSourceControl(o);}if(!f.isFlexSupported({element:this})){S.error("Invalid component. The mandatory 'sourceControl' association should be assigned to the app component due to personalization reasons.");return this.getId()+"-idInfoPanel";}var A=U.getAppComponentForControl(g)||U.getAppComponentForControl(o);return A.createId("idInfoPanel");};e.prototype._determineContent=function(){this.hasPotentialContent().then(function(h){if(this._getInternalModel().getProperty('/bHasPotentialContent')!==h){this._getInternalModel().setProperty('/bHasPotentialContent',h);}}.bind(this));};e.prototype._useDelegate=function(){if(!this.oDelegatePromise){this.setDelegate(this.getDelegate());}return this.oDelegatePromise.then(function(){return Promise.all([this._useDelegateAdditionalContent(),this._useDelegateItems()]);}.bind(this));};e.prototype._useDelegateAdditionalContent=function(){return new Promise(function(r){this.DELEGATE.fetchAdditionalContent(this.getDelegate().payload).then(function(A){this._aAdditionalContent=A;r();}.bind(this));}.bind(this));};e.prototype._useDelegateItems=function(){var i=this._getInfoLog();var o=this._getContextObject();var p=Object.assign({},this.getDelegate().payload);p.id=this.getId();return new Promise(function(r){this.DELEGATE.fetchLinkItems(o,p,i).then(function(f){this._setLinkItems(f);r();}.bind(this));}.bind(this));};e.prototype._waitForUseDelegatePromise=function(f){return this.oUseDelegatePromise.then(function(){return f();});};e.prototype.exit=function(){this.oUseDelegatePromise=undefined;};return e;});
