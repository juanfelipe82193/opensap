/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/condition/ConditionModelPropertyBinding','sap/ui/model/json/JSONModel','sap/ui/model/Filter','sap/ui/model/ChangeReason','sap/ui/mdc/condition/FilterOperatorUtil','sap/base/util/merge','sap/base/util/deepEqual','sap/base/Log','sap/ui/mdc/condition/Condition'],function(C,J,F,b,c,m,d,L,e){"use strict";var f=J.extend("sap.ui.mdc.condition.ConditionModel",{constructor:function(){J.apply(this,arguments);this.setSizeLimit(1000);this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}.bind(this));if(!this.getProperty("/conditions")){this.setProperty("/conditions",{});}if(!this.getProperty("/fieldPath")){this.setProperty("/fieldPath",{});}this._mFieldPath={};}});f.prototype.bindProperty=function(p,o,P){if(p.startsWith("/conditions/")){var s=p.slice(12);this._getFieldPathProperty(s);s=g.call(this,s);p="/conditions/"+s;}var B=new C(this,p,o,P);return B;};f.prototype.getContext=function(p){if(p.startsWith("/conditions/")){var s=p.slice(12);s=g.call(this,s);p="/conditions/"+s;}return J.prototype.getContext.apply(this,[p]);};f.prototype.bindList=function(p,o,s,a,P){var B=J.prototype.bindList.apply(this,arguments);B.enableExtendedChangeDetection(true);return B;};f.prototype.destroy=function(){J.prototype.destroy.apply(this,arguments);delete this._mFieldPath;delete this._oMessageBundle;};f.prototype.clone=function(s){var o=new f();o._sName=this._sName+"_clone";if(s===undefined){var a=this.getFilterFields();if(a){a.forEach(function(h){o.addFilterField(h);},this);}}else{var h=this.getFilterField(s);if(h){o.addFilterField(h);}else{L.error("ConditionModel","clone of ConditionModel for fieldPath '"+s+"' failed!");return o;}}var j={};if(typeof s==="string"){var k=this.getConditions(s);for(var i=0;i<k.length;i++){var l=k[i];var M=g.call(this,s);if(!j[M]){j[M]=[];}j[M].push(m({},l));}}else{j=m({},this.getAllConditions());}o.setConditions(j);return o;};f.prototype.merge=function(s,S,a){this.removeAllConditions(s);var o=m({},S.getAllConditions());for(var M in o){if(!(typeof a==="string")||M===a){var h=e._removeEmptyConditions(o[M]);for(var i=0;i<h.length;i++){var j=h[i];this.addCondition(M,j);}}}this.checkUpdate(true,true);};f.prototype.getConditions=function(s){return _.call(this,s);};function _(s,a){var o=this.getProperty("/conditions");var h;if(typeof s=="string"){s=g.call(this,s);if(!o[s]&&a){o[s]=[];}h=o[s]||[];}else{L.error("ConditionModel","getConditions without FieldPath is not supported!");h=[];for(var M in o){for(var i=0;i<o[M].length;i++){var j=o[M][i];h.push(j);}}}return h;}f.prototype.getAllConditions=function(s){var o=this.getProperty("/conditions");var r={};for(var M in o){var a=this.getProperty("/fieldPath");var h=a[M];var s=h?h.fieldPath:M;r[s]=m([],o[M]);}return r;};f.prototype.indexOf=function(s,o){if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var I=-1;var a=this.getConditions(s);var h=JSON.stringify(o,['operator','values']);a.some(function(o,i){if(JSON.stringify(o,['operator','values'])===h){I=i;return true;}return false;});return I;};f.prototype.exist=function(o,s){if(typeof s==="string"){return this.indexOf(s,o)>=0;}else{throw new Error("sFieldPath must be provided "+this);}};f.prototype.setConditions=function(o){var i=0;var a;this.setProperty("/conditions",{});if(Array.isArray(o)){throw new Error("setConditions with an Array of condition is not supported! "+this);}else{this._bNoSingleEvent=true;for(var M in o){this._getFieldPathProperty(M);for(i=0;i<o[M].length;i++){a=o[M][i];this.insertCondition(M,-1,a,true);}M=g.call(this,M);this.firePropertyChange({reason:b.Add,path:"/conditions/"+M,context:undefined,value:o[M]});}this.checkUpdate(true,true);this._bNoSingleEvent=false;}return this;};f.prototype.addCondition=function(s,o,a){if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}return this.insertCondition(s,-1,o,a);};f.prototype.insertCondition=function(s,I,o,a){if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var h;c.checkConditionsEmpty(o);this._updateValues(o);this._getFieldPathProperty(s);if(!a){var i=this.indexOf(s,o);if(i>=0){return this;}}h=_.call(this,s,true);if(I==-1){h.push(o);}else{h.splice(I,0,o);}this._checkMaxConditions(s);if(!this._bNoSingleEvent){this.checkUpdate(true,true);s=g.call(this,s);this.firePropertyChange({reason:b.Add,path:"/conditions/"+s,context:undefined,value:h});}return this;};f.prototype.createItemCondition=function(s,k,D){L.error("ConditionModel","createItemCondition is deprecated");return e.createItemCondition(k,D);};f.prototype.createCondition=function(s,o,v){L.error("ConditionModel","createCondition is deprecated");return e.createCondition(o,v);};f.prototype.removeCondition=function(s,v){if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var i=-1;if(typeof v==="object"){i=this.indexOf(s,v);}else if(typeof v==="number"){i=v;}var a=this.getConditions(s);if(a.length>i){a.splice(i,1);this.checkUpdate(true,true);this._checkMaxConditions(s);s=g.call(this,s);this.firePropertyChange({reason:b.Remove,path:"/conditions/"+s,context:undefined,value:a});return true;}return false;};f.prototype.removeAllConditions=function(s){var o=this.getProperty("/conditions");if(typeof s==="string"){s=g.call(this,s);delete o[s];this.firePropertyChange({reason:b.Remove,path:"/conditions/"+s,context:undefined,value:o[s]});}else{for(var M in o){delete o[M];M=g.call(this,M);this.firePropertyChange({reason:b.Remove,path:"/conditions/"+M,context:undefined,value:o[M]});}}this.checkUpdate(true,true);return this;};f.prototype._updateValues=function(a){a=a||this.getConditions();c.updateConditionsValues(a);};f.prototype._checkRequiredConditions=function(s,a){var h=a?[a]:Object.keys(this._mFieldPath||{});var E=false;var M=this._oMessageBundle.getText("conditionmodel.REQUIRED_CONDITION_MISSING");h.forEach(function(a){if(this._mFieldPath&&this._mFieldPath[a]){var o=this._mFieldPath[a];if(o.getRequired()&&this.getConditions(a).length<=0){if(s){this.addFieldPathMessage(a,M);}E=true;}else{this.removeFieldPathMessage(a,M);}}},this);return!E;};f.prototype._checkMaxConditions=function(s){var a=s?[s]:Object.keys(this._mFieldPath||{});a.forEach(function(s){if(this._mFieldPath&&this._mFieldPath[s]){var o=this._mFieldPath[s];var h=this.getConditions(s);var l=0;for(var i=0;i<h.length;i++){if(!h[i].isEmpty){l++;}}while(o.getMaxConditions()>=0&&l>o.getMaxConditions()){this.removeCondition(s,0);l--;}}},this);};f.prototype.addFilterField=function(o){var s=o.getFieldPath();this._mFieldPath[s]=o;this._getFieldPathProperty(s);};f.prototype.getFilterField=function(s){var a=Object.keys(this._mFieldPath||{});return this._mFieldPath[s||a[0]];};f.prototype.getFilterFields=function(){var a=Object.keys(this._mFieldPath||{});var h=[];a.forEach(function(s){h.push(this._mFieldPath[s]);},this);return h;};f.prototype.removeFilterField=function(o){var s=o.getFieldPath();if(this._mFieldPath&&this._mFieldPath[s]){delete this._mFieldPath[s];}var a=this.getProperty("/fieldPath");if(a&&a[s]){delete a[s];}};f.prototype._getFieldPathProperty=function(s){var E=g.call(this,s);var o=this.getProperty("/fieldPath");if(!o[E]){o[E]={fieldPath:s,valueState:"None",valueStateText:"",messages:[]};}var a=this.getProperty("/conditions");if(!a[E]){a[E]=[];}return o[E];};f.prototype.addFieldPathMessage=function(s,M){var o=this._getFieldPathProperty(s);if(!o.messages.some(function(I,i){if(I===M){return true;}return false;})){o.messages.push(M);}this._updateValueState(s);};f.prototype.setUIMessage=function(s,M){var o=this._getFieldPathProperty(s);o.uiMessage=M;this._updateValueState(s);};f.prototype.removeFieldPathMessage=function(s,M){var I;var o=this._getFieldPathProperty(s);if(o.messages.some(function(a,i){if(a===M){I=i;return true;}return false;})){o.messages.splice(I,1);this._updateValueState(s);}};f.prototype.removeUIMessage=function(s){var o=this._getFieldPathProperty(s);delete o.uiMessage;this._updateValueState(s);};f.prototype._updateValueState=function(s){var u=false,o=this._getFieldPathProperty(s),v="None",V="";if(o.uiMessage){v="Error";V=o.uiMessage;}else if(o.messages.length>0){v="Error";V=o.messages[o.messages.length-1];}if(o.valueState!==v){o.valueState=v;u=true;}if(o.valueStateText!==V){o.valueStateText=V;u=true;}if(u){this.checkUpdate(true,true);}};f.prototype.isValid=function(v,s){var a=s?[s]:Object.keys(this._mFieldPath||{});var V=this._checkRequiredConditions(v);a.forEach(function(s){var o=this._getFieldPathProperty(s);V=V&&o.valueState=="None";},this);return V;};f.prototype._prettyPrintFilters=function(o){var r;if(!o){return"";}if(o._bMultiFilter){r="";var a=o.bAnd;o.aFilters.forEach(function(o,i,h){r+=this._prettyPrintFilters(o);if(h.length-1!=i){r+=a?" and ":" or ";}},this);return"("+r+")";}else{r=o.sPath+" "+o.sOperator+" '"+o.oValue1+"'";if(o.sOperator==="BT"){r+="...'"+o.oValue2+"'";}return r;}};f.prototype.getFilters=function(s){var i,l,a,o=[],h,t,S,n,p;if(s===undefined){h=this.getAllConditions();}else if(typeof s==="string"){h={};h[s]=this.getConditions(s);}else{h={};}var O,k;for(var M in h){l=[];a=[];t=null;var q=h[M];var r=this.getProperty("/fieldPath");var u=r[M];var v=u?u.fieldPath:M;for(i=0;i<q.length;i++){O=c.getOperator(q[i].operator);k=O.getModelFilter(q[i],v);if(!O.exclude){if(k.sPath==="$search"){continue;}var $=/^\*(.+)\*$/.exec(k.sPath);if($){var w=$[1].split(',');for(var j=0;j<w.length;j++){l.push(new F(w[j],k.sOperator,k.oValue1));}continue;}if(k.sPath&&k.sPath.indexOf('*/')>-1){S=k.sPath.split('*/');if(S.length===2){n=S[0];p=S[1];k.sPath='L1/'+p;if(!t){t={path:n,operator:'Any',variable:'L1'};}l.push(k);}else{throw new Error("Not Implemented");}}else{l.push(k);}}else{a.push(k);}}if(t){if(l.length===1){t.condition=l[0];}else if(l.length>1){t.condition=new F({filters:l,and:false});}l=[new F(t)];}k=undefined;if(l.length===1){k=l[0];}else if(l.length>1){k=new F({filters:l,and:false});}if(k){a.unshift(k);}if(a.length===1){o.push(a[0]);}else if(a.length>1){o.push(new F({filters:a,and:true}));}}if(o.length===1){return o[0];}else if(o.length>1){return new F({filters:o,and:true});}else{return null;}};f.prototype.serialize=function(){var o=m({},this.getAllConditions());for(var M in o){var a=o[M];a.forEach(function(h){delete h.isEmpty;},this);if(a.length===0){delete o[M];}}return'{"conditions":'+JSON.stringify(o)+"}";};f.prototype.serializeMeta=function(){var a=Object.keys(this._mFieldPath||{});var r="";a.forEach(function(s){if(this.getData().fieldPath[s].valueState!=="None"){r+=JSON.stringify(this.getData().fieldPath[s]);}},this);return'{"fieldPath":'+r+"}";};f.prototype.parse=function(o){var h=function(k,v){var a;if(!isNaN(parseInt(k))&&(typeof v==='string')){a=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).(\d{3})Z$/.exec(v);if(a){return new Date(v);}}return v;};this.setConditions(JSON.parse(o,h).conditions);};function g(s){if(s){var p=s.split("/");if(p.length>1){s="";for(var i=0;i<p.length;i++){var P=p[i];if(i>0){if(!isNaN(P)||!isNaN(p[i-1])){s=s+"/";}else{s=s+"_";}}s=s+P;}}}return s;}return f;});
