/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","../ObjectType","../getResourceBundle","../NodeContentType","./ThreeExtensions"],function(q,t,L,B,U,T,O,P,D,A,a,V,b,C,c,d,f,g,h,j,k,m,n,o,R,M,p,r,N,s){"use strict";var S=function(e,i,l,d1){this._id=S._nextId++;S._add(this);this._callouts=new Map();this._cameras=new Map();this._images=new Map();this._imageIdsAndTileWidths=new Map();this._imageTextures=new Map();this._geometries=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._geometryMeshes=new Map();this._materialMeshes=new Map();this._materialClones=new Map();this._joints=[];if(e){this._rootNode=e;this._nodes=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();this._animationHelper=new A(this);if(i){this._countentResource=i;var e1=i.getNodeProxy();var f1=e1.getNodeHierarchy();this._vkScene=f1.getScene();var g1=i.getSource();if(g1&&g1.name){this._sceneIdTreeNodesMap.set(g1.name,this._nodes);this._sceneIdRootNodeMap.set(g1.name,e);this._sceneIdViewGroupMap.set(g1.name,this._viewGroups);this._sceneIdViewMap.set(g1.name,this._views);this._currentSceneId=g1.name;}if(this._rootNode){if(!this._rootNode.userData){this._rootNode.userData={};}this._rootNode.userData.skipIt=!i.name;}}this._viewThumbnails=new Map();this._thrustlines=new Map();this._animations=new Map();this._animationTracks=new Map();this._resolve=l;this._reject=d1;};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S.getById=function(i){return this._map.get(i);};S._add=function(e){S._map.set(e.getId(),e);return this;};var u=[R.Default,R.Default,R.Default,R.LineIllustration,R.SolidOutline,R.ShadedIllustration];S.prototype.setScene=function(i){if(i.result!==1){var e={status:i.result};switch(i.result){case-1:e.errorText=r().getText("LOADER_FILENOTFOUND");break;case-2:e.errorText=r().getText("LOADER_WRONGFILEFORMAT");break;case-3:e.errorText=r().getText("LOADER_WRONGPASSWORD");break;case-4:e.errorText=r().getText("LOADER_ERRORREADINGFILE");break;case-5:e.errorText=r().getText("LOADER_FILECONTENT");break;default:e.errorText=r().getText("LOADER_UNKNOWNERROR");}this._reject(e);}else{var l=this._cameras.get(i.cameraId);this._resolve({node:this._parentNode,camera:l,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(e,i,l,d1){this._rootNode=e;this._nodes=new Map();this._nodes.set(i,e);if(!this._rootNode.userData){this._rootNode.userData={};}this._tracks=new Map();this._trackIdSequenceNodeMap=new Map();this._sequenceIdToPlaybacks=new Map();this._viewGroups=new Map();this._views=new Map();if(l){this._sceneIdTreeNodesMap.set(l,this._nodes);this._sceneIdRootNodeMap.set(l,e);this._sceneIdViewGroupMap.set(l,this._viewGroups);this._sceneIdViewMap.set(l,this._views);this._currentSceneId=l;}if(d1){this._vkScene=d1;}return this;};S.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var i=this._sceneIdTreeNodesMap.get(e);if(i){this._nodes=i;}else{this._nodes=null;}var l=this._sceneIdRootNodeMap.get(e);if(l){this._rootNode=l;}else{this._rootNode=null;}this._currentSceneId=e;}};S.prototype.getNode=function(e,i){if(i){this._resetCurrentScene(i);if(this._nodes){return this._nodes.get(e);}}else{var l=this._sceneIdTreeNodesMap.values();var d1=l.next();while(!d1.done){var e1=d1.value.get(e);if(e1){return e1;}d1=l.next();}}return null;};S.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e);};S.prototype.hasImage=function(i){return this._images.has(i);};S.prototype.setNodePersistentId=function(e,i,l){if((e.userData.treeNode&&e.userData.treeNode.sid)||this.getNode(i,l)){return false;}this._resetCurrentScene(l);if(!e.userData.treeNode){e.userData.treeNode={};}e.userData.treeNode.sid=i;if(this._nodes){this._nodes.set(i,e);}return true;};var v=function(e){var i=new THREE.Matrix4();if(e.length===3){i.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){i.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){i.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return i;};var w={r:0.0235,g:0.0235,b:0.0235};var x={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(e){var i=new THREE.MeshPhongMaterial({color:0xaaaaaa});i.userData.defaultHighlightingEmissive=w;i.userData.defaultHighlightingSpecular=x;i.userData.materialUsed=0;i.userData.materialId=e;i.userData.toBeUpdated=true;var l=new M();l.setMaterialRef(i);this._vkScene.setMaterial(e,l);return i;};S.prototype._getMaterialRef=function(e){var i=this._vkScene.getMaterial(e);return i?i.getMaterialRef():null;};S.prototype.checkMaterialExists=function(e){if(this._getMaterialRef(e)===null){this._createTemporaryMaterial(e);return false;}return true;};S.prototype._attachMaterialClone=function(e,i){T.pushElementIntoMapArray(this._materialClones,e,i);};S.prototype._addDynamicObject=function(e,i){if(!this._rootNode.userData._vkDynamicObjects){this._rootNode.userData._vkDynamicObjects=[];}this._rootNode.userData._vkDynamicObjects.push(e);e._vkUpdate=i;};S.prototype.createNode=function(e,i){this._resetCurrentScene(i);var l=new THREE.Group();this._nodes.set(e.sid,l);var d1=this._nodes.get(e.parentId);(d1||this._rootNode).add(l);var e1=l.userData;e1.treeNode=e;if(e.closed){e1.closed=true;}if(e.selectable===false){e1.selectable=false;}if(e.visualisable===false){e1.skipIt=true;}if(e.metadata){e1.metadata=e.metadata;}if(e.veids){e1.veids=e.veids;}if(e.name){l.name=e.name;}if(e.visible!==undefined){l.layers.mask=e.visible?(1|0):0;}if(d1&&d1.name&&l.name&&l.name===d1.name+" offset geometry"){l.layers=d1.layers;}else{var f1=d1;while(f1){if(f1.userData.closed){l.layers=f1.layers;break;}f1=f1.parent;}}if(i){var g1=d1;while(g1){if((g1.layers.mask&1)===0){l.layers.mask&=~1;break;}g1=g1.parent;}}if(e.renderOrder){l.renderOrder=e.renderOrder;}if(e.opacity!==undefined){e1.opacity=e.opacity;}if(e.transform){l.applyMatrix(v(e.transform));}l.updateMatrixWorld(true);if(e.transformType){e1.transformType=e.transformType;switch(e.transformType){case"BILLBOARD_VIEW":this._addDynamicObject(l,b.prototype._billboardViewUpdate);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(l,b.prototype._lockToViewportUpdate);break;default:break;}}if(e.materialId){e1.materialId=e.materialId;}if(e.meshId){this.setMeshNode(e.sid,e.meshId);}if(l.parent.userData.objectType===p.Hotspot){e1.objectType=p.Hotspot;}else if(l.parent.userData.objectType===p.PMI){e1.objectType=p.PMI;}else if(e.contentType==="HOTSPOT"){e1.objectType=p.Hotspot;}else if(e.contentType==="PMI"){e1.objectType=p.PMI;}if(e.contentType==="REFERENCE"){l._vkSetNodeContentType(N.Reference);}return l;};function y(e,i,l){var d1;if(e.isPolyline){var e1=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1});if(i){e1.color.copy(i.color);}d1=new THREE.LineSegments(e,e1);}else{d1=new THREE.Mesh(e,i);}if(e.isPositionQuantized){F(d1,l.boundingBox);}U.increaseGeometryUsed(e);return d1;}S.prototype.getChildNodeIds=function(e,l,d1){this._resetCurrentScene(l);var e1=this._nodes.get(e);var f1=[];if(!e1){return f1;}if(e1&&e1.children){for(var i=0;i<e1.children.length;i++){var g1=e1.children[i];if(g1.userData.treeNode&&g1.userData.treeNode.sid){f1.push(g1.userData.treeNode.sid);}else if(d1&&g1.userData.submeshInfo&&g1.userData.submeshInfo.id){f1.push(g1.userData.submeshInfo.id);}}}return f1;};function z(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}return null;}function E(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}function F(e,i){if(i&&i.length===6){e.position.set((i[3]+i[0])*0.5,(i[4]+i[1])*0.5,(i[5]+i[2])*0.5);e.scale.set(Math.max(i[3]-i[0],Number.EPSILON),Math.max(i[4]-i[1],Number.EPSILON),Math.max(i[5]-i[2],Number.EPSILON));}}S.prototype.insertSubmesh=function(i){var l=this._getMaterialRef(i.materialId)||this._createTemporaryMaterial(i.materialId);var d1,e1;if(i.lods){var f1=E(i.lods);if(!f1){return false;}e1=this._geometries.get(f1.id);if(e1){d1=y(e1,l,f1);if(e1.userData&&e1.userData.noNormal&&i.materialId){this.updateMaterialForGeometryWithoutNormal(i.materialId);}}else{var g1;try{var h1=z(i.lods);if(h1&&h1.data){var i1=T.base64ToUint8Array(h1.data);var j1=B.unpackSubDividedBoundingBox(i1);g1=B.makeSubDividedBoundingBoxGeometry(j1);}}catch(e){}d1=new THREE.Mesh(g1?g1:new THREE.BoxBufferGeometry(1,1,1),l);var k1=f1.boundingBox;if(k1&&k1.length===6){var l1=new THREE.Matrix4();l1.scale(new THREE.Vector3(Math.max(k1[3]-k1[0],Number.EPSILON),Math.max(k1[4]-k1[1],Number.EPSILON),Math.max(k1[5]-k1[2],Number.EPSILON)));l1.setPosition(new THREE.Vector3((k1[3]+k1[0])*0.5,(k1[4]+k1[1])*0.5,(k1[5]+k1[2])*0.5));d1.geometry.applyMatrix(l1);}d1.userData.geometryId=f1.id;d1.userData.lodInfo=f1;T.pushElementIntoMapArray(this._geometryMeshes,f1.id,i.meshId);}}else{return false;}if(i.transform){d1.applyMatrix(v(i.transform));}d1.userData.submeshId=i.id;d1.userData.initialMaterialId=i.materialId;d1.userData.meshId=i.meshId;d1.userData.materialId=i.materialId;d1.userData.submeshInfo=i;T.pushElementIntoMapArray(this._materialMeshes,i.materialId,i.meshId);T.pushElementIntoMapArray(this._meshSubmeshes,i.meshId,d1);var m1=this._meshNodes.get(i.meshId);if(m1){m1.forEach(function(n1){var o1=d1.clone();o1.layers=n1.layers;if(n1.userData.materialId){o1.material=this._getMaterialRef(n1.userData.materialId)||d1.material;}n1.add(o1);I(n1,i.materialId,this._materialClones);}.bind(this));}return true;};function G(e,l,d1,e1){for(var i=0;i<e.length;i++){var f1=e[i];if(l&&f1.userData.geometryId===l&&f1.geometry!==d1){if(f1.type==="Mesh"&&!d1.isPolyline){f1.geometry=d1;if(d1.isPositionQuantized){F(f1,f1.userData.lodInfo.boundingBox);}U.increaseGeometryUsed(d1);}else{var g1=y(d1,f1.material,f1.userData.lodInfo);g1.userData=f1.userData;g1.layers=f1.layers;g1.parent=f1.parent;e[i]=g1;f1.parent=null;}}}}function H(e,i,l,d1){var e1=e.userData.opacity!==undefined?e.userData.opacity:1;var f1=e.children;f1.forEach(function(g1){if(g1.userData.materialId===i){U.increaseMaterialUsed(l);g1.material=l;g1.userData.opacity=e1;delete g1.userData.originalMaterial;g1._vkUpdateMaterialOpacity();if(g1.material!==l){T.pushElementIntoMapArray(d1,i,g1.material);}}});}function I(e,i,l){var d1=e.userData.opacity!==undefined?e.userData.opacity:1;e.children.forEach(function(e1){if(e1.material&&(!i||i===e1.material.userData.materialId)){var f1=e1.material;e1.userData.opacity=d1;e1._vkUpdateMaterialOpacity();if(e1.material!==f1){T.pushElementIntoMapArray(l,e1.material.userData.materialId,e1.material);}}});}S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var l=new THREE.BufferAttribute(new Uint16Array(e.data.indices),1);var d1=new THREE.BufferAttribute(new Float32Array(e.data.points),3);i.setIndex(l);i.addAttribute("position",d1);if(!i.userData){i.userData={};}if(!e.isPolyline){if(e.data.normals&&e.data.normals.length===e.data.points.length){var e1=new THREE.BufferAttribute(new Float32Array(e.data.normals),3);i.addAttribute("normal",e1);}else{i.userData.noNormal=true;}if(e.data.uvs&&e.data.uvs.length*3===e.data.points.length*2){i.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingBox();i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);var f1=this._geometryMeshes.get(e.id);if(f1){for(var mi=0;mi<f1.length;mi++){var h1=f1[mi];var i1=this._meshNodes.get(h1);if(i1){for(var ni=0;ni<i1.length;ni++){G(i1[ni].children,e.id,i);}}var k1=this._meshSubmeshes.get(h1);if(k1){G(k1,e.id,i);}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype.setMeshNode=function(e,i){var l=this._nodes.get(e);if(l){T.pushElementIntoMapArray(this._meshNodes,i,l);var d1=this._meshSubmeshes.get(i);if(d1){d1.forEach(function(e1){var f1=e1.clone();f1.layers=l.layers;if(l.userData.materialId){f1.material=this._getMaterialRef(l.userData.materialId)||e1.material;}l.add(f1);}.bind(this));I(l,null,this._materialClones);}}};S.prototype.progress=function(e){L.log("reading progress:",e);};S.prototype.loadingFinished=function(i){if(this._fireLoadingFinished){this._fireLoadingFinished(i);}};S.prototype.getGeometry=function(e){return this._geometries.get(e);};var J=[f.RectangularShape,f.CircularShape,f.None,f.TextGlow];var K=[c.Viewport,c.Screen,c.World];var Q=[g.None,g.Solid,g.Dash,g.Dot,g.DashDot,g.DashDotDot];var W=[j.None,j.Point,j.Arrow];var X=[d.PlainText,d.HtmlText];var Y=[h.Left,h.Center,h.Right];function Z(e){var i=e.toString(16);if(e.length>=3){i=(((e[0]*255)<<16)|((e[1]*255)<<8)|(e[2]*255)).toString(16);}return"#"+"000000".substring(i.length)+i;}function $(e){for(var i=0,l=e.length;i<l;i++){if(!isFinite(e[i])){return false;}}return true;}S.prototype.createAnnotation=function(e,i){if(!$(e.position)){return;}this._resetCurrentScene(i);var l=this._nodes.get(e.nodeId);var d1=e.position;e.coordinateSpace|=0;var e1=e.backgroundOpacity;if(!e1){e1=e.backgroundColour?e.backgroundColour[3]:0;}var f1=e.borderOpacity;if(!f1){f1=e.borderColour?e.borderColour[3]:0;}var g1={node:l,coordinateSpace:K[e.coordinateSpace],style:J[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?Z(e.backgroundColour):"#fff",backgroundOpacity:e1,borderColor:e.borderColour?Z(e.borderColour):"#000",borderOpacity:f1,borderWidth:e.borderWidth,borderLineStyle:Q[e.borderLineStyle]};if(e.encoding!==undefined){g1.encoding=X[e.encoding];g1.font=e.font;g1.fontSize=e.fontSize;g1.fontWeight=Math.min(e.fontWeight,900);g1.fontItalic=e.fontItalic;g1.textColor=Z(e.textColor);g1.link=e.link;g1.horizontalAlignment=Y[e.textHorizontalAlignment];g1.position=new THREE.Vector3().fromArray(d1);}else if(e.fontFace){g1.encoding=d.PlainText;g1.font=e.fontFace;g1.fontSize=Math.abs(e.fontSize);g1.fontWeight=Math.min(e.fontWeight,900);g1.textColor=Z(e.textColour);}else{g1.encoding=d.HtmlText;}if(e.coordinateSpace<2){if(!g1.positions){g1.position=new THREE.Vector3(d1[0]*2-1,d1[1]*-2+1,d1[2]);}g1.renderOrder=(e.order|0)+1000;var h1=new b(g1);h1.setText(e.text);this._addDynamicObject(l,h1._update.bind(h1));}else{g1.anchorNode=this._nodes.get(e.sid)||this._rootNode;if(!g1.postion){g1.position=new THREE.Vector3().fromArray(d1);}g1.depthTest=false;g1.renderOrder=e.order|0;if(e.alwaysOnTop){g1.renderOrder=1;}var i1=new C(g1);i1.setText(e.text);this._callouts.set(e.id,i1);this._addDynamicObject(l,i1._update.bind(i1));}};S.prototype.createImageNote=function(e,i){this._resetCurrentScene(i);var l=this._nodes.get(e.nodeId);l.updateMatrix();var d1=new THREE.Vector3().fromArray(e.position);var e1=e.width;var f1=e.height;if(!e.properlyAligned){d1.x+=e.width*0.5;d1.y+=e.height*0.5;d1.applyMatrix4(l.matrix);e1=e.width*0.5*l.matrix.elements[0];f1=e.height*0.5*l.matrix.elements[5];}var g1=new b({node:l,coordinateSpace:c.Screen,renderOrder:(e.order|0)+1000,position:d1,width:e1,height:f1});var h1=this._getMaterialRef(e.labelMaterialId);g1.setMaterial(h1);this._addDynamicObject(l,g1._update.bind(g1));};S.prototype.insertLeaderLine=function(e,d1){this._resetCurrentScene(d1);var e1=this._callouts.get(e.annotationId);if(e1){var f1=[];for(var i=0,l=e.points.length;i<l;i++){f1.push(new THREE.Vector3().fromArray(e.points[i]));}var g1=this._getMaterialRef(e.materialId);var h1=this._nodes.get(e.startPointSid)||this._roteNode;e1.addLeaderLine(f1,h1,g1,W[e.startPointHeadStyle],W[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}};var _=[k.DetailView,k.Cutaway];var a1=[m.Box,m.Circle,m.CircleLine,m.CirclePointer,m.CircleArrow,m.CircleBubbles,m.BoxLine,m.BoxNoOutline,m.SolidPointer,m.SolidArrow];S.prototype.createDetailView=function(i,e){this._resetCurrentScene(e);var l=this._nodes.get(i.nodeId);if(l){if(!i.properlyAligned){if(!i.shape){i.shape=i.leaderStyle?m.BoxLine:m.Box;}else{i.shape=[m.Circle,m.CircleLine,m.CirclePointer,m.CircleArrow,m.CircleBubbles][i.leaderStyle||0];}i.type=i.cutaway?k.Cutaway:k.DetailView;i.camera=i.camera?this.createCamera(i.camera):null;i.origin=new THREE.Vector2(l.position.x*2-1+l.scale.x,l.position.y*-2+1-l.scale.x);i.size=new THREE.Vector2(l.scale.x,l.scale.y);i.renderOrder=l.renderOrder;}else{i.type=_[i.type];i.shape=a1[i.shape];i.camera=this._cameras.get(i.cameraId);i.origin=new THREE.Vector2().fromArray(i.origin);i.size=new THREE.Vector2().fromArray(i.size);}var d1=[];if(i.visibleNodes){i.visibleNodes.forEach(function(g1){var l=this._nodes.get(g1);if(l){d1.push(l);}else{L.warning("Unknown detailView visible node reference",g1);}}.bind(this));}var e1=[];if(i.targetNodes){i.targetNodes.forEach(function(g1){var l=this._nodes.get(g1);if(l){e1.push(l);}else{L.warning("Unknown detailView target node reference",g1);}}.bind(this));}var f1=new D({name:i.name,camera:i.camera,type:i.type,shape:i.shape,borderWidth:i.borderWidth||0,backgroundColor:Z(i.backgroundColour),borderColor:Z(i.borderColour),origin:i.origin,size:i.size,attachmentPoint:new THREE.Vector3().fromArray(i.attachment),metadata:i.metadata,veId:i.veid,visibleNodes:d1,targetNodes:e1});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[];}this._rootNode.userData._vkDetailViews.push({detailView:f1,node:l,renderOrder:i.renderOrder||0});}};S.prototype.insertThrustline=function(i){var e=this._nodes.get(i.thrustlineId);if(e&&!this._thrustlines.get(i.thrustlineId)){var l=new a({node:e,principleAxis:new THREE.Vector3().fromArray(i.principleAxis),material:this._getMaterialRef(i.materialId)});var d1=[];var e1=0;var f1=0;var g1=0;for(var ii=0;ii<i.itemCount;ii++){var i1={};i1.target=this._nodes.get(i.targets[ii]);i1.majorAxisIndex=i.itemMajorAxisesIndices[ii];var bi;i1.basisAxises=[];g1=e1+i.itemBasisAxisesCounts[ii];for(bi=e1;bi<g1;bi++){var k1={};k1.x=i.itemBasisAxisesCoordinates[bi*3];k1.y=i.itemBasisAxisesCoordinates[bi*3+1];k1.z=i.itemBasisAxisesCoordinates[bi*3+2];i1.basisAxises.push(k1);}e1=g1;i1.dimension={};i1.dimension.x=i.itemDimensionsCoordinates[ii*3];i1.dimension.y=i.itemDimensionsCoordinates[ii*3+1];i1.dimension.z=i.itemDimensionsCoordinates[ii*3+2];i1.center={};i1.center.x=i.itemCentersCoordinates[ii*3];i1.center.y=i.itemCentersCoordinates[ii*3+1];i1.center.z=i.itemCentersCoordinates[ii*3+2];i1.boundPoints=[];g1=f1+i.itemBoundPointsCounts[ii];for(bi=f1;bi<g1;bi++){var l1={};l1.x=i.itemBoundPointsCoordinates[bi*3];l1.y=i.itemBoundPointsCoordinates[bi*3+1];l1.z=i.itemBoundPointsCoordinates[bi*3+2];i1.boundPoints.push(l1);}f1=g1;d1.push(i1);}l.setItems(d1);var m1=0;var n1=[];for(var si=0;si<i.segmentCount;si++){var p1={};p1.startItemIndex=i.segmentsStartItemIndices[si];p1.endItemIndex=i.segmentsEndItemIndices[si];p1.startBoundIndex=i.segmentsStartBoundIndices[si];p1.endBoundIndex=i.segmentsEndBoundIndices[si];p1.ratios=[];g1=m1+i.segmentRatioCounts[si];for(var ri=0;ri<g1;ri++){var r1={};r1.x=i.segmentRatiosCoordinates[ri*2];r1.y=i.segmentRatiosCoordinates[ri*2+1];p1.ratios.push(r1);}m1=g1;n1.push(p1);}l.setSegments(n1);this._thrustlines.set(i.thrustlineId,l);this._addDynamicObject(e,l._update.bind(l));}};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(e,i){this._resetCurrentScene(i);var l=this;e=[].concat(e);e.forEach(function(id){var d1=l._nodes.get(id);if(d1){l._decrementResourceCounters(d1);l._nodes.delete(id);}});return this;};S.prototype.remove=function(e,l){this._resetCurrentScene(l);var d1=this;e=[].concat(e);e.forEach(function(id){var e1=d1._nodes.get(id);if(e1){d1._decrementResourceCounters(e1);if(e1.parent){e1.parent.remove(e1);}d1._nodes.delete(id);for(var i=0;i<e1.children.length;i++){var f1=e1.children[i];if(f1.userData&&f1.userData.treeNode&&f1.userData.treeNode.sid){d1.remove(f1.userData.treeNode.sid,l);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var l=i.userData.geometryUsed;if(l<=0){i.dispose();}});return this;};S.prototype.createCamera=function(e,i){this._resetCurrentScene(i);var l;if(e.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{l=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}if(e.origin){var d1=new THREE.Vector3().fromArray(e.origin);l.position.copy(d1);}if(e.up){var up=new THREE.Vector3().fromArray(e.up);if(e.notUseDirectionVector){up.sub(l.position);}l.up.copy(up.normalize());}if(e.target){if(e.notUseDirectionVector){l.lookAt(new THREE.Vector3().fromArray(e.target));}else{l.lookAt((new THREE.Vector3().fromArray(e.target)).add(l.position));}}if(e.ortho){l.zoom=e.zoom||0.02;}this._rootNode.userData.camera=l;var f1=null;if(l.isOrthographicCamera){f1=new O();}else if(l.isPerspectiveCamera){f1=new P();}f1.setCameraRef(l);f1.setUsingDefaultClipPlanes(true);if(e.zoom===-1){f1.setZoomNeedRecalculate(true);}var g1=e.id;if(g1){this._cameras.set(g1,f1);}this._rootNode.userData.camera=f1;return f1;};S.prototype.insertCamera=function(e,i,l){this._resetCurrentScene(l);var d1=this._nodes.get(e);var e1=this._cameras.get(i);if(d1&&e1){(d1||this._rootNode).add(e1.parent?e1.clone():e1);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(e){var i=this._getMaterialRef(e);if(i&&i.emissive){i.emissive.copy(i.color);i.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(e){var i=[];var l=e.id;var d1=this._getMaterialRef(l);if(e.lineWidth>0){if(!d1||!d1.isLineBasicMaterial){d1=new THREE.LineBasicMaterial();var e1=new M(true);e1.setMaterialRef(d1);this._vkScene.setMaterial(l,e1);}d1.color=new THREE.Color(e.lineColour[0],e.lineColour[1],e.lineColour[2]);d1.linewidth=e.lineWidth;d1.userData.lineStyle={width:e.lineWidth,haloWidth:e.lineHaloWidth||0,endCapStyle:e.lineEndRound?1:0,dashPattern:e.lineDashPattern||[],dashPatternScale:e.lineDashPatternScale,widthCoordinateSpace:e.lineWidthCoordinateSpace};d1.userData.materialInfo=e;d1.userData.materialId=l;return i;}if(!d1){d1=this._createTemporaryMaterial(l);}delete d1.userData.toBeUpdated;d1.userData.materialInfo=e;if(e.diffuseColour){d1.color.fromArray(e.diffuseColour);}if(e.specularColour){d1.specular.fromArray(e.specularColour);}var f1=true;if(e.emissiveColour){d1.emissive.fromArray(e.emissiveColour);if(d1.emissive.r!==0||d1.emissive.g!==0||d1.emissive.b!==0){f1=false;}}if(f1&&e.ambientColour){d1.emissive.fromArray(e.ambientColour);d1.emissive.multiplyScalar(0.2);}if(d1.opacity!==undefined){d1.opacity=e.opacity;d1.transparent=e.opacity<0.99;if(d1.transparent){d1.side=THREE.DoubleSide;}}var g1=d1.glossiness?d1.glossiness:0;var h1=d1.specularLevel?d1.specularLevel:0;d1.shininess=g1*2+h1*3;d1.userData.defaultHighlightingEmissive=w;d1.userData.defaultHighlightingSpecular=x;i=this.updateTextureMaps(l);if(i.length>0){d1.userData.imageIdsToLoad=new Set();for(var ti=0;ti<i.length;ti++){var j1=i[ti];T.pushElementIntoMapArray(this._imageTextures,j1.imageId,{textureType:j1.textureType,materialId:l});d1.userData.imageIdsToLoad.add(j1.imageId);}}var k1=this._materialMeshes.get(l);if(k1){for(var mi=0;mi<k1.length;mi++){var m1=k1[mi];var n1=this._meshNodes.get(m1);if(n1){for(var ni=0;ni<n1.length;ni++){H(n1[ni],l,d1,this._materialClones);}}}}return i;};S.prototype.getMaterial=function(e){return this._getMaterialRef(e);};var b1=function(i){var l="";try{var d1=0x8000;var e1=0;var f1=i.length;var g1;while(e1<f1){g1=i.slice(e1,Math.min(e1+d1,f1));l+=String.fromCharCode.apply(null,g1);e1+=d1;}}catch(e){l="";}return l;};S.prototype.createImage=function(e){var l=new DataView(e.binaryData.buffer);var d1=true;if(l.getUint8(0,true)===parseInt("0xFF",16)&&l.getUint8(1,true)===parseInt("0xD8",16)){d1=false;}var e1=b1(e.binaryData);var f1="data:image/"+(d1?"png":"jpeg")+";base64,"+btoa(e1);this._images.set(e.id,f1);var g1=this._imageTextures.get(e.id);if(g1){this._imageTextures.delete(e.id);for(var i=0;i<g1.length;i++){var h1=g1[i];this.updateTextureMap(h1.materialId,h1.textureType);}}return this;};var c1=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(e){var i=[];var l=this._getMaterialRef(e);if(!l){return i;}var d1=l.userData.materialInfo;if(!d1){return i;}if(d1.textureDiffuse){var e1=this.updateTextureMap(e,S.TextureType.Diffuse);if(e1.imageId){i.push(e1);}}if(d1.textureBump){var f1=this.updateTextureMap(e,S.TextureType.Bump);if(f1.imageId){i.push(f1);}}if(d1.textureOpacity){var g1=this.updateTextureMap(e,S.TextureType.Opacity);if(g1.imageId){i.push(g1);}}if(d1.textureEmissive){var h1=this.updateTextureMap(e,S.TextureType.Emissive);if(h1.imageId){i.push(h1);}}if(d1.textureAmbientOcclusion){var i1=this.updateTextureMap(e,S.TextureType.AmbientOcclusion);if(i1.imageId){i.push(i1);}}if(d1.textureReflection){var j1=this.updateTextureMap(e,S.TextureType.Reflection);if(j1.imageId){i.push(j1);}}return i;};S.prototype.updateTextureMap=function(e,i){var l={textureType:i,imageId:null};var d1=this._getMaterialRef(e);if(!d1){return l;}var e1=d1.userData.materialInfo;if(!e1){return l;}var f1=null;switch(i){case S.TextureType.Diffuse:f1=e1.textureDiffuse;break;case S.TextureType.Bump:f1=e1.textureBump;break;case S.TextureType.Opacity:f1=e1.textureOpacity;break;case S.TextureType.Reflection:f1=e1.textureReflection;break;case S.TextureType.Emissive:f1=e1.textureEmissive;break;case S.TextureType.AmbientOcclusion:f1=e1.textureAmbientOcclusion;break;default:break;}if(!f1){return l;}var g1=f1[0];if(!g1){g1=f1;}var h1=this._images.get(g1.imageId);if(!h1){l.imageId=g1.imageId;return l;}var i1=c1.load(h1,this._fireSceneUpdated);i1.wrapS=g1.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;i1.wrapT=g1.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;i1.magFilter=g1.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;i1.minFilter=g1.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;i1.anisotropy=4;var j1=g1.influence!==undefined?g1.influence:0;var k1=g1.uvHorizontalScale!==undefined?g1.uvHorizontalScale:1;var l1=g1.uvVerticalScale!==undefined?g1.uvVerticalScale:1;var m1=g1.uvHorizontalOffset!==undefined?g1.uvHorizontalOffset:0;var n1=g1.uvVerticalOffset!==undefined?g1.uvVerticalOffset:0;i1.repeat.set(k1,l1);i1.center.set(-m1,-n1);i1.offset.set(m1,n1);i1.rotation=-g1.uvRotationAngle;switch(i){case S.TextureType.Diffuse:d1.map=i1;d1.transparent|=h1.startsWith("data:image/png");break;case S.TextureType.Bump:d1.bumpMap=i1;d1.bumpScale=j1;break;case S.TextureType.Opacity:d1.alphaMap=i1;break;case S.TextureType.Reflection:i1.mapping=THREE.SphericalReflectionMapping;d1.envMap=i1;d1.combine=THREE.AddOperation;d1.reflectivity=j1;break;case S.TextureType.Emissive:d1.emissiveMap=i1;d1.emissive.setRGB(1,1,1);break;case S.TextureType.AmbientOcclusion:d1.aoMap=i1;break;default:}d1.userData.textureAdded=true;d1.needsUpdate=true;if(d1.userData.imageIdsToLoad){d1.userData.imageIdsToLoad.delete(g1.imageId);if(d1.userData.imageIdsToLoad.size===0){delete d1.userData.imageIdsToLoad;}}var o1=this._materialClones.get(e);if(o1){o1.forEach(function(p1){p1.copy(d1);p1.needsUpdate=true;});}return l;};S.prototype.insertPlayback=function(e,i,l){this._resetCurrentScene(l);var d1=this._vkScene.findSequence(e.sequenceId);var e1=new n(e.id,{sequence:d1,timeScale:e.speed?1.0/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var f1=this._views.get(i);if(f1){f1.addPlayback(e1);}if(!d1){T.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,e1);}return this;};S.prototype.insertSequence=function(i,e){var l;if(i.endTime){l=i.endTime;}else{l=1.0;}var d1=this._vkScene.createSequence(i.id,{name:i.name,duration:l});if(Array.isArray(i.joints)){i.joints.forEach(function(e1){var h1=this._joints[e1];if(h1&&h1.node&&h1.parent){d1.setJoint(h1);}}.bind(this));}if(i.nodes&&i.nodes.length>0){for(var ni=0;ni<i.nodes.length;ni++){var f1=i.nodes[ni];T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,f1.trackId,{sequenceId:i.id,targetId:f1.sid,type:f1.binding,pivot:f1.pivot});}}var g1=this._sequenceIdToPlaybacks.get(i.id);if(g1){g1.forEach(function(e1){e1.setSequence(d1);});}return this;};S.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this;};S.prototype.insertJoints=function(e,i){this._resetCurrentScene(i);this._joints=[];e.forEach(function(l){this._joints.push({id:l.id,node:this._nodes.get(l.childSid),parent:this._nodes.get(l.parentSid),translation:new Float32Array(l.t?l.t:[0,0,0]),quaternion:new Float32Array(l.q?l.q:[0,0,0,1]),scale:new Float32Array(l.s?l.s:[1,1,1])});}.bind(this));return this;};S.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}e.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent;}if(!e.userData){e.userData={};}}else{return this;}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map();}var i;var l=this._viewGroups.entries();var d1=l.next();while(!d1.done){i=d1.value[1];d1=l.next();var e1=[];for(var vi=0;vi<i.getViews().length;vi++){if(i.getViews()[vi].id){var g1=this._views.get(i.getViews()[vi].id);if(g1){e1.push(g1);}}}}return this;};S.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var i=this._viewGroups.entries();var l=i.next();while(!l.done){var d1=l.value[1];var e1=l.value[0];if(!d1||!d1.views||!d1.views.length){l=i.next();continue;}d1.removeViews();for(var vi=0;vi<d1.views.length;vi++){var g1=d1.views[vi].id;var h1=this._views.get(g1);if(h1&&h1.userData.viewInfo.thumbnailId&&!h1.thumbnailData){var i1=this._images.get(h1.userData.viewInfo.thumbnailId);if(i1){h1.thumbnailData=i1;}}if(h1){h1.viewGroupId=e1;d1.addView(h1);}}l=i.next();}return this;};S.prototype.insertViewGroup=function(i,e){this._resetCurrentScene(e);var l=this._viewGroups.get(i.id);if(!l){l=this._vkScene.createViewGroup({viewGroupId:i.id,name:i.name,description:i.description});this._viewGroups.set(i.id,l);}else{l.setViewGroupId(i.id);l.setName(i.name);l.setDescription(i.description);}l.type=i.type;l.metadata=i.metadata;l.veids=i.veids;l.views=i.views;l.sceneId=i.sceneId;return this;};S.prototype.getViewGroup=function(e,i){this._resetCurrentScene(i);var l=this._viewGroups.get(e);var d1=[];if(l&&l.views){for(var vi=0;vi<l.views.length;vi++){var f1=l.views[vi].id;var g1=this._views.get(f1);if(g1){d1.push(g1);}}}return d1;};S.prototype.insertView=function(e,i){this._resetCurrentScene(i);if(e.description){var l=new RegExp("^<[^>]*?>");if(l.test(e.description)){var d1=new RegExp("(^(<[^>]*?>\s*)+)|((<[^>]*?>\s*)+$)","g");var e1=e.description.replace(d1,"");if(!e1){e.description=e1;}}}var f1=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?"<pre style=\"white-space: pre-wrap;\">"+e.description+"</pre>":e.description});f1.userData={};f1.userData.viewInfo=e;if(e.thumbnailId){var g1=this._images.get(e.thumbnailId);if(g1){f1.thumbnailData=g1;}else{this._viewThumbnails.set(e.thumbnailId,f1);}}if(e.animatedThumbnailId){var h1=this._images.get(e.animatedThumbnailId);if(h1){f1.animatedThumbnailData=h1;f1.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId);}}if(e.cameraId){f1.setCamera(this._cameras.get(e.cameraId));}f1.type=e.type;f1.flyToTime=e.flyToTime;f1.preDelay=e.preDelay;f1.postDelay=e.postDelay;f1.navigationMode=e.navigationMode;f1.topColor=e.topColor;f1.bottomColor=e.bottomColor;f1.renderMode=u[e.renderMethod];f1.dimension=e.dimension;f1.query=e.query;f1.metadata=e.metadata;f1.veids=e.veids;f1.viewGroupId=e.viewGroupId;f1.id=e.viewId;this._views.set(e.viewId,f1);if(f1.viewGroupId){var i1=this._viewGroups.get(f1.viewGroupId);if(i1){i1.addView(f1);}}return this;};S.prototype.setModelViewVisibilitySet=function(i){var e=this._views.get(i.viewId);var l=[];i.visibleNodes.forEach(function(d1){var e1=this._nodes.get(d1);if(e1){l.push({target:e1,visible:true});}else{L.warning("Unknown modelView visible node reference",d1);}}.bind(this));e.updateNodeInfos(l);};S.prototype.recordHighlightedNodeInView=function(e,i,l,d1){this._resetCurrentScene(d1);var e1=this._views.get(l);if(!e1){return this;}var f1=this._nodes.get(i);if(!f1){return this;}e1.addHighlightedNodes(e,f1);return this;};S.prototype.insertHighlightStyle=function(i){var e=this._vkScene.getHighlight(i.id);if(e){return this;}this._vkScene.createHighlight(i.id,i);return this;};S.prototype.insertModelViewHighlight=function(i){var e=this._views.get(i.viewId);if(e){var l=[];i.highlightNodes.forEach(function(g1){var h1=this._nodes.get(g1);if(h1){l.push(h1);}else{}}.bind(this));var d1={duration:i.duration,cycles:i.cycles};if(!i.id){i.id=THREE.Math.generateUUID().toLowerCase();}var e1=new THREE.Color(i.color1).toArray();var f1=new THREE.Color(i.color2).toArray();e1[3]=((i.color1>>>24)&255)/255;f1[3]=((i.color2>>>24)&255)/255;d1.colours=[e1,f1];d1.opacities=[i.opacity1,i.opacity2];this._vkScene.createHighlight(i.id,d1);e.addHighlightedNodes(i.id,l);}};S.prototype.createThumbnail=function(i){var e=this._viewThumbnails.get(i.imageId);if(e){e.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:e});}}};S.prototype.highlightStyleExists=function(i){var e=this._vkScene.getHighlight(i);return e!==undefined;};S.prototype.getView=function(e,i){this._resetCurrentScene(i);return this._views.get(e);};S.prototype.getSequence=function(e){return this._vkScene.findSequence(e);};S.prototype.setViewCamera=function(e,i,l){this._resetCurrentScene(l);var d1=this._cameras.get(e);var e1=this._views.get(i);if(d1&&e1){e1.setCamera(d1);}return this;};S.prototype.setViewNodeInfos=function(e,i,l){this._resetCurrentScene(l);var d1=this._views.get(i);d1.setNodeInfos(e);return this;};S.prototype.setViewThumbnail=function(i,e,l,d1){this._resetCurrentScene(l);var e1=this._views.get(e);var f1=this._images.get(i);if(e1&&f1){if(e1.userData!==undefined){if(e1.userData.viewInfo.thumbnailId===i){e1.thumbnailData=f1;}else if(e1.userData.viewInfo.animatedThumbnailId===i){e1.animatedThumbnailData=f1;e1.tileWidth=d1;}}}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._vkScene){this._vkScene.clearMaterials();}this._callouts.clear();this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._tracks){this._tracks.clear();}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();S._map.delete(this._id);};S.prototype.insertAnimationGroup=function(i){var e=this._vkScene.findSequence(i.animationGroupRef.toString());if(!e){var l;if(i.endTime){if(!i.startTime){i.startTime=0;}l=i.endTime-i.startTime;}e=this._vkScene.createSequence(i.animationGroupRef.toString(),{name:i.name,duration:l});if(!e.userData){e.userData={};}e.userData.animations=[];}if(i.modelViewRef){var d1=this._views.get(i.modelViewRef);if(d1){var e1=this._vkScene.findSequence(i.animationGroupRef.toString());var f1=new n({sequence:e1,timeScale:i.playbackSpeed?1.0/i.playbackSpeed:1,preDelay:i.playbackPreDelay?i.playbackPreDelay:0,postDelay:i.playbackPostDelay?i.playbackPostDelay:0,repeat:i.playbackRepeat?Math.abs(i.playbackRepeat):0,reversed:i.playbackReversed?true:false,startTime:0});d1.addPlayback(f1);}}};S.prototype.insertAnimation=function(i){var e=this._animations.get(i.animationRef);if(!e){e={};e.type=i.animationType;e.targetRefs=[];e.targetPivots=[];e.sequenceId=i.animationGroupRef.toString();e.animationTracks=new Set();this._animations.set(i.animationRef,e);}if(i.animationGroupRef){var l=this._vkScene.findSequence(i.animationGroupRef.toString());if(!l.userData.animations.includes(i.animationRef)){l.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var e=this._animations.get(i.animationRef);if(e){if(!e.targetRefs.includes(i.targetRef)){e.targetRefs.push(i.targetRef);e.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var e=this._animationTracks.get(i.animationTrackRef);var l=i.animationRef;if(!e){delete i.animationRef;e=i;this._animationTracks.set(i.animationTrackRef,e);}if(!l){return;}var d1=this._animations.get(l);if(!d1||!d1.sequenceId){return;}if(d1.animationTracks.has(e.animationTrackRef)){return;}else{d1.animationTracks.add(e.animationTrackRef);}var e1=this._vkScene.findSequence(d1.sequenceId);if(!e1){return;}if(!e1.userData){e1.userData={};}if(!e1.userData.tracks){e1.userData.tracks=[];}for(var ti=0;d1.targetRefs&&ti<d1.targetRefs.length;ti++){var g1=d1.targetRefs[ti];var h1=d1.targetPivots[ti];var i1=this._nodes.get(g1);if(!i1){continue;}var j1;if(h1.x!==0||h1.y!==0||h1.z!==0){j1=[h1.x,h1.y,h1.z];}var k1=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][e.type]||"";T.pushElementIntoMapArray(this._trackIdSequenceNodeMap,i.animationTrackRef,{sequenceId:d1.sequenceId,targetId:g1,type:k1,pivot:j1});var l1={};l1.times=Array.prototype.slice.call(e.times);l1.values=Array.prototype.slice.call(e.values);l1.id=i.animationTrackRef;l1.cyclicInfo={};l1.cyclicInfo.cyclicStart=e.cyclicStart;l1.cyclicInfo.cyclicEnd=e.cyclicEnd;var ki;if(d1.type===0){if(e.dataType===0){if(e.values.length!==e.keyCount||e.times.length!==e.keyCount){continue;}if(e.type===3){l1.values=[];for(ki=0;ki<e.keyCount;ki++){l1.values.push(e.values[ki]);l1.values.push(e.values[ki]);l1.values.push(e.values[ki]);}}}else if(e.dataType===1||e.dataType===3){if(e.values.length!==3*e.keyCount||e.times.length!==e.keyCount){continue;}}else if(e.dataType===4||e.dataType===5||e.dataType===6){if(e.values.length!==4*e.keyCount||e.times.length!==e.keyCount){continue;}if(e.dataType===4){l1.rotateType=o.AngleAxis;}else if(e.dataType===6){l1.rotateType=o.Euler;}else{l1.rotateType=o.Quaternion;for(var vi=3;vi<l1.values.length;vi=vi+4){l1.values[vi]=-l1.values[vi];}}}}e1.userData.tracks.push(l1);}};S.prototype.setAnimationTracks=function(e){var i=this._animations.get(e);if(!i||!i.sequenceId){return;}var l=this._vkScene.findSequence(i.sequenceId);if(l){if(l.userData&&l.userData.tracks){this._animationHelper.insertTracks(l.userData.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);}}};S.prototype.setAnimationPlaybacks=function(i){var e=this._viewGroups.get(i.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(e.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(e.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(e.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(e.getViews(),this._vkScene);};return S;});
