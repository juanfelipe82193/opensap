/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ContentConnector","../ViewStateManagerBase","./thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight"],function(v,C,V,t,a,b,d,e,S,O,R,N,f,H,g,h){"use strict";var j;var k=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var m=k.getMetadata().getParent().getClass().prototype;k.prototype.init=function(){if(m.init){m.init.call(this);}this._channel=0;this._layers=new THREE.Layers();this._layers.set(this._channel);this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._outlineRenderer=new f(1.0);this._outlinedNodes=new Set();this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1.0);this._visibilityTracker=new j();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this._selectionColor=new THREE.Color(0xC0C000);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._customPositionedNodes=new Set();this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new H();this._transitionHighlightPlayer=new H();v.getEventBus().subscribe("sap.ui.vk","activateView",this._onViewActivated,this);};k.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onViewActivated,this);};k.prototype._setContent=function(c){var s=null;if(c&&c instanceof S){s=c;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}};k.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};k.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};k.prototype._handleContentReplaced=function(c){var i=c.getParameter("newContent");this._setContent(i);};k.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};k.prototype._setNodeHierarchy=function(c){var i=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear();}if(c){this._nodeHierarchy=c;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._initialState={visible:[],hidden:[]};var l=this;var q=c.findNodesByName();q.forEach(function(r){(r.layers.test(l._layers)?l._initialState.visible:l._initialState.hidden).push(r);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(c!==i){this.fireNodeHierarchyReplaced({oldNodeHierarchy:i,newNodeHierarchy:c});}return this;};k.prototype._handleNodeReplaced=function(c){var r=c.getParameter("ReplacedNodeRef");var i=c.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};k.prototype._handleNodeUpdated=function(c){var i=c.getParameter("nodeRef");if(this.getSelectionState(i)){this.setSelectionState(i,false);this.setSelectionState(i,true);}};k.prototype._renderOutline=function(r,s,i){var c=d(this._outlineColorABGR);var l=new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0);this._outlineRenderer.render(r,s,i,Array.from(this._outlinedNodes),l,this._jointCollection);};k.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};k.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};k.prototype.getVisibilityComplete=function(){var c=this.getNodeHierarchy(),i=c.findNodesByName(),l=[],q=[];i.forEach(function(r){var s=c.createNodeProxy(r);var u=s.getVeId();c.destroyNodeProxy(s);if(u){if(this.getVisibilityState(r)){l.push(u);}else{q.push(u);}}},this);return{visible:l,hidden:q};};k.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};k.prototype.getVisibilityState=function(c){var l=this._layers;return Array.isArray(c)?c.map(function(i){return i.layers.test(l);}):c.layers.test(l);};k.prototype.setVisibilityState=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=Array.isArray(i);var q=[];var s=c;if(r){s=[];c.forEach(function(B,D){var E=this._collectNodesRecursively(B);s=s.concat(E);var F=q.length;q.length=F+E.length;q.fill(l?i[D]:i,F);},this);}else if(!l){q.length=s.length;q.fill(i);}else{q=i;}var u=[];var w=new Set();var x=this._layers,y=this._channel;var z=s.filter(function(B,D){if(w.has(B)){return false;}w.add(B);var z=B?B.layers.test(x)!=q[D]:false;if(z){u.push(q[D]);}return z;},this);if(z.length>0){var A={visible:[],hidden:[]};z.forEach(function(B,D){if(u[D]){B.layers.enable(y);A.visible.push(B);}else{B.layers.disable(y);A.hidden.push(B);}},this);if(this.getShouldTrackVisibilityChanges()){z.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(A);}return this;};k.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};k.prototype.enumerateOutlinedNodes=function(c){this._outlinedNodes.forEach(c);return this;};k.prototype.getSelectionState=function(c){var s=this._selectedNodes;function i(l){return s.has(l);}return Array.isArray(c)?c.map(i):i(c);};k.prototype._isAChild=function(c,i){var l=c.parent;while(l){if(i.has(l)){return true;}l=l.parent;}return false;};k.prototype._AddBoundingBox=function(c){if(c.userData.boundingBox===undefined){c.userData.boundingBox=new THREE.Box3();c._vkCalculateObjectOrientedBoundingBox();}if(!c.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&c.userData.boxHelper===undefined){var i=new THREE.Box3Helper(c.userData.boundingBox,0xffff00);i.material.color=this._selectionColor;this._boundingBoxesScene.add(i);i.parent=c;c.userData.boxHelper=i;}};k.prototype._RemoveBoundingBox=function(c){if(c.userData.boundingBox!==undefined){delete c.userData.boundingBox;}if(c.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(c.userData.boxHelper);delete c.userData.boxHelper;}};k.prototype._updateBoundingBoxesIfNeeded=function(){var u=new Set();this._selectedNodes.forEach(function(c){var i=c.parent;while(i){if(this._selectedNodes.has(i)){u.add(i);}i=i.parent;}}.bind(this));u.forEach(function(c){c._vkCalculateObjectOrientedBoundingBox();});};k.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(c){if(c.userData.boundingBox){c._vkCalculateObjectOrientedBoundingBox();}});};k.prototype.setShowSelectionBoundingBox=function(c){this._showSelectionBoundingBox=c;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(i){this._AddBoundingBox(i);}.bind(this));}else{this._selectedNodes.forEach(function(i){this._RemoveBoundingBox(i);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};k.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};k.prototype._isAncestorSelected=function(c){c=c.parent;while(c){if(this._selectedNodes.has(c)){return true;}c=c.parent;}return false;};k.prototype._updateHighlightColor=function(c,q){var s=q||this._selectedNodes.has(c);c.userData.highlightColor=s?this._highlightColorABGR:undefined;c._vkUpdateMaterialColor();var r=c.children;for(var i=0,l=r.length;i<l;i++){var u=r[i].userData;if(u&&u.objectType===O.Hotspot){continue;}this._updateHighlightColor(r[i],s);}};k.prototype.setSelectionState=function(c,s,r,i){if(!Array.isArray(c)){c=[c];}c=(r||this.getRecursiveSelection()?this._collectNodesRecursively(c):c).filter(function(q,u,w){return w.indexOf(q)===u;});if(this.getRecursiveSelection()&&!s){c=this._nodeHierarchy._appendAncestors(c);}var l=c.filter(function(q){return this._selectedNodes.has(q)!==s;},this);if(l.length>0){l.forEach(function(q){if(q){this._selectedNodes[s?"add":"delete"](q);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](q);}}},this);l.forEach(function(q){if(q){this._updateHighlightColor(q,s||this._isAncestorSelected(q));}},this);if(!i){this.fireSelectionChanged({selected:s?l:[],unselected:s?[]:l});}}return this;};k.prototype.setSelectionStates=function(s,u,r,c){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var i=s.filter(function(q){return this._selectedNodes.has(q)===false;},this);var l=u.filter(function(q){return this._selectedNodes.has(q)===true;},this);if(i.length>0||l.length>0){i.forEach(function(q){this._selectedNodes.add(q);this._updateHighlightColor(q,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(q);}},this);l.forEach(function(q){this._selectedNodes.delete(q);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(q);}},this);l.forEach(function(q){this._updateHighlightColor(q,this._isAncestorSelected(q));},this);if(!c){this.fireSelectionChanged({selected:i,unselected:l});}}return this;};k.prototype.setOutlineColor=function(c){switch(typeof c){case"number":this._outlineColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._outlineColorABGR=e(a(c));}break;default:return this;}this.fireOutlineColorChanged({outlineColor:b(d(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this;};k.prototype.getOutlineColor=function(i){return i?this._outlineColorABGR:b(d(this._outlineColorABGR));};k.prototype.getOutliningState=function(c){var i=this._outlinedNodes;function l(q){return i.has(q);}return Array.isArray(c)?c.map(l):l(c);};k.prototype.setOutliningStates=function(c,u,r,i){if(!Array.isArray(c)){c=[c];}if(!Array.isArray(u)){u=[u];}c=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(c):c);u=(r||this.getRecursiveOutlining()?this._collectNodesRecursively(u):u);if(this.getRecursiveOutlining()){u=this._nodeHierarchy._appendAncestors(u,c);}var l=c.filter(function(s){return this._outlinedNodes.has(s)===false;},this);var q=u.filter(function(s){return this._outlinedNodes.has(s)===true;},this);if(l.length>0||q.length>0){l.forEach(function(s){this._outlinedNodes.add(s);},this);q.forEach(function(s){this._outlinedNodes.delete(s);},this);if(!i){this.fireOutliningChanged({outlined:l,unoutlined:q});}}return this;};k.prototype.setOutlineWidth=function(w){this._outlineWidth=w;this._outlineRenderer.setOutlineWidth(w);this.fireOutlineWidthChanged({width:w});return this;};k.prototype.getOutlineWidth=function(){return this._outlineWidth;};k.prototype._collectNodesRecursively=function(c){var r=[],i=this;if(!Array.isArray(c)){c=[c];}c.forEach(function collectChildNodes(l){r.push(l);i._nodeHierarchy.enumerateChildren(l,collectChildNodes,false,true);});return r;};k.prototype._getOpacity=function(c){return c.userData.opacity!==undefined?c.userData.opacity:null;};k.prototype.getOpacity=function(c){if(Array.isArray(c)){return c.map(this._getOpacity,this);}else{return this._getOpacity(c);}};k.prototype.setOpacity=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=Array.isArray(i);if(i==null){i=undefined;}else if(l){i.forEach(function(z,A){if(z==null){i[A]=undefined;}});}var q=[];var s=c;if(!l){q.length=s.length;q.fill(i);}else{q=i;}var u=[];var w=new Set();var x=s.filter(function(z,A){if(w.has(z)){return false;}w.add(z);var x=z?z.userData.opacity!==q[A]:false;if(x){u.push(q[A]);}return x;},this);if(x.length>0){x.forEach(function(z,A){z._vkSetOpacity(u[A],this._jointCollection);},this);var y={changed:x,opacity:l?u:u[0]};this.fireOpacityChanged(y);}return this;};k.prototype._getTintColorABGR=function(c){return c.userData.tintColor!==undefined?c.userData.tintColor:null;};k.prototype._getTintColor=function(c){return c.userData.tintColor!==undefined?b(d(c.userData.tintColor)):null;};k.prototype.getTintColor=function(c,i){var l=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(c)){return c.map(this[l],this);}else{return this[l](c);}};k.prototype.setTintColor=function(c,i,r){if(!Array.isArray(c)){c=[c];}var l=function(B){var D=null;switch(typeof B){case"number":D=B;break;case"string":if(sap.ui.core.CSSColor.isValid(B)){D=e(a(B));}break;default:D=undefined;break;}return D;};var q=Array.isArray(i);var s=[];var u=c;if(r){u=[];c.forEach(function(B,D){var E=this._collectNodesRecursively(B);u=u.concat(E);var F=s.length;s.length=F+E.length;s.fill(q?i[D]:i,F);},this);}else if(!q){s.length=u.length;s.fill(i);}else{s=i;}var w=[];var x=new Set();var y=u.filter(function(B,D){if(x.has(B)){return false;}x.add(B);var y=B?B.userData.tintColor!==l(s[D]):false;if(y){w.push(s[D]);}return y;},this);if(y.length>0){var z=[];y.forEach(function(B,D){var E=l(w[D]);B._vkSetTintColor(E);z.push(E);},this);var A={changed:y,tintColor:q?w:w[0],tintColorABGR:q?z:z[0]};this.fireTintColorChanged(A);}return this;};k.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=e(a(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(i){this._updateHighlightColor(i,true);},this);}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};k.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:b(d(this._highlightColorABGR));};k.prototype.getTransformation=function(c){var i=function(l){return{translation:this.getTranslation(l),quaternion:this.getRotation(l,R.Quaternion),scale:this.getScale(l)};}.bind(this);if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getTranslation=function(c){var i=function(l){return!l.userData.position?l.position.toArray():l.userData.position.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getScale=function(c){var i=function(l){return!l.userData.scale?l.scale.toArray():l.userData.scale.toArray();};if(!Array.isArray(c)){return i(c);}var r=[];c.forEach(function(l){r.push(i(l));});return r;};k.prototype.getRotation=function(c,r){var i=function(q){var u=!q.userData.quaternion?q.quaternion:q.userData.quaternion;var l;switch(r){case R.AngleAxis:if(u.w>1){u.normalize();}var w=2*Math.acos(u.w);var x;var y;var z;var s=Math.sqrt(1-u.w*u.w);if(s<0.0001){x=1;y=0;z=0;}else{x=u.x/s;y=u.y/s;z=u.z/s;}l=[x,y,z,w];break;case R.Euler:var A=new THREE.Euler();A.setFromQuaternion(u);l=A.toArray();break;default:l=u.toArray();}return l;};if(!Array.isArray(c)){return i(c);}var l=[];c.forEach(function(q){l.push(i(q));});return l;};k.prototype.setTransformation=function(c,i){var l=Array.isArray(c);if(!Array.isArray(c)){c=[c];}var q={changed:[],transformation:[]};var r=function(s){return{position:s.position.toArray(),quaternion:s.quaternion.toArray(),scale:s.scale.toArray()};};if(!i){c.forEach(function(s){if(s.userData.position&&s.userData.quaternion&&s.userData.scale){s.position=s.userData.position;s.quaternion=s.userData.quaternion;s.scale=s.userData.scale;delete s.userData.position;delete s.userData.quaternion;delete s.userData.scale;}this._customPositionedNodes.delete(s);q.changed.push(s);q.transformation.push(r(s));},this);}else{if(!Array.isArray(i)){i=[i];}c.forEach(function(s,u){if(!(s.userData.position||s.userData.quaternion||s.userData.scale)){s.userData.position=s.position.clone();s.userData.quaternion=s.quaternion.clone();s.userData.scale=s.scale.clone();}var w=i[u];s.position.fromArray(w.translation);s.scale.fromArray(w.scale);if(w.quaternion){s.quaternion.fromArray(w.quaternion);}else if(w.angleAxis){var x=new THREE.Vector3(w.angleAxis[0],w.angleAxis[1],w.angleAxis[2]);s.quaternion.setFromAxisAngle(x,w.angleAxis[3]);}else if(w.euler){var y=new THREE.Euler();y.fromArray(w.euler[0],w.euler[1],w.euler[2],w.euler[3]);s.quaternion.setFromEuler(y);}this._customPositionedNodes.add(s);q.changed.push(s);q.transformation.push(r(s));},this);}if(!l){q.changed=q.changed[0];q.transformation=q.transformation[0];}this.fireTransformationChanged(q);return this;};k.prototype.getJoints=function(){return this._jointCollection;};k.prototype.setJoints=function(c){this._jointCollection=[];if(!c){return this;}var i=new Set();var l=new Map();c.forEach(function(r){i.add(r.node);l.set(r.node,r);});while(i.size>0){var q=i.values().next().value;i.delete(q);var r=l.get(q);var s=[r];var u=[];var w=r.parent;while(w){r=l.get(w);if(r!==undefined){if(i.delete(w)){s.push(r);}if(u.length>0){r.nodesToUpdate=r.nodesToUpdate||[];while(u.length>0){var x=u.pop();if(r.nodesToUpdate.indexOf(x)>=0){break;}r.nodesToUpdate.push(x);}}u.length=0;w=r.parent;}else{u.push(w);w=w.parent;}}while(s.length>0){this._jointCollection.push(s.pop());}}return this;};var n=new THREE.Vector3();var o=new THREE.Quaternion();var p=new THREE.Vector3();k.prototype._updateJointNodes=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(c){var i=c.node;c.parent.updateMatrixWorld(true);i.updateMatrixWorld(true);i.matrix.compose(n.fromArray(c.translation),o.fromArray(c.quaternion),p.fromArray(c.scale));i.matrixWorld.multiplyMatrices(c.parent.matrixWorld,i.matrix);i.matrix.getInverse(i.parent.matrixWorld).multiply(i.matrixWorld);i.matrix.decompose(i.position,i.quaternion,i.scale);i.matrixWorldNeedsUpdate=false;if(c.nodesToUpdate){c.nodesToUpdate.forEach(function(s){if(s.matrixAutoUpdate){s.updateMatrix();}s.matrixWorld.multiplyMatrices(s.parent.matrixWorld,s.matrix);s.matrixWorldNeedsUpdate=false;});}});}};k.prototype._recalculateJointsForNodes=function(c){if(this._jointCollection&&this._jointCollection.length>0){var i=new Map();this._jointCollection.forEach(function(q){i.set(q.node,q);});var l=new THREE.Matrix4();c.forEach(function(q){var r=i.get(q);if(r){q.updateMatrixWorld();r.parent.updateMatrixWorld();l.getInverse(r.parent.matrixWorld).multiply(q.matrixWorld);var n=new THREE.Vector3();var o=new THREE.Quaternion();var p=new THREE.Vector3();l.decompose(n,o,p);n.toArray(r.translation);o.toArray(r.quaternion);p.toArray(r.scale);}});}};k.prototype._updateMaterialInNode=function(c){var l=c.target;var i,q;if(l&&l.children){for(i=0;i<l.children.length;i++){q=l.children[i];if(q.userData&&(q.userData.animatedOpacity||q.userData.animatedColor)){q._vkUpdateMaterialColor();q._vkUpdateMaterialOpacity();if(q.userData.animatedOpacity){q.material.transparent=true;}}}}var r=l.userData.materialId;var s=l.userData.opacity;l.userData.materialId=c.materialId;l.userData.opacity=c.opacity;var u=false;if(r===undefined){if(l.userData.materialId!==undefined){u=true;}}else if(r!==l.userData.materialId){u=true;}var w=false;if(s===undefined){if(l.userData.opacity!==undefined||l.userData.animatedOpacity){w=true;}}else if(s!==l.userData.opacity){w=true;}if(!u&&!w){return;}var x=null;if(l.userData.materialId){var y=this._scene.getMaterial(l.userData.materialId);if(y){x=y.getMaterialRef();}}if(l&&l.children){for(i=0;i<l.children.length;i++){q=l.children[i];if(x){q.material=x;q.userData.materialId=c.materialId;}else if(q.userData&&q.userData.initialMaterialId){var z=this._scene.getMaterial(q.userData.initialMaterialId);if(z){var A=z.getMaterialRef();q.material=A;q.userData.materialId=q.userData.initialMaterialId;}}if(q.material&&q.material.userData){q.userData.originalMaterial=q.material;q.material=q.material.clone();if(l.userData.opacity!==undefined){q.userData.opacity=l.userData.opacity;q.material.opacity*=q.userData.opacity;q.material.transparent=q.material.opacity<0.99;}if(q.userData.animatedOpacity){q.material.transparent=true;}}}}};k.prototype._resetNodesStatusByCurrenView=function(c,s,i){function l(D){return new THREE.Matrix4().set(D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],0,0,0,1);}var q=this.getNodeHierarchy();if(q){var r;if(c){r=c.getPlaybacks();}var u=c.getNodeInfos();if(u){this._nodesTransitionHelper.clear();var w={nodeRefs:[],positions:[]};var x=new THREE.Vector3();var y=new THREE.Quaternion();var z=new THREE.Vector3();u.forEach(function(D){if(D.target===null){return;}function E(I,J,K){for(var L=0;L<I.elements.length;L++){if(Math.abs(I.elements[L]-J.elements[L])>K){return false;}}return true;}if(D.transform){var F=l(D.transform);if(!E(F,D.target.matrix,1e-6)){if((!r||!r.length)&&i){var G=q.createNodeProxy(D.target);this._nodesTransitionHelper.setNodeForDisplay(G,F);}else{F.decompose(x,y,z);w.nodeRefs.push(D.target);w.positions.push({translation:x.toArray(),quaternion:y.toArray(),scale:z.toArray()});}}}else if(D.scale&&D.rotate&&D.translate){w.nodeRefs.push(D.target);w.positions.push({translation:D.translate.slice(),quaternion:D.rotate.slice(),scale:D.scale.slice()});}}.bind(this));if(c.userData&&c.userData.nodeStartDataByAnimation){c.userData.nodeStartDataByAnimation.forEach(function(D,E){if(D.translate&&D.rotate&&D.scale){w.nodeRefs.push(E);w.positions.push({translation:D.translate.slice(),quaternion:D.rotate.slice(),scale:D.scale.slice()});}},this);}if(w.nodeRefs.length){this.setTransformation(w.nodeRefs,w.positions);}if(s){var A=[];var B=[];u.forEach(function(D){(D.visible?A:B).push(D.target);});this.setVisibilityState(q.getChildren()[0].children,false,true);this.setVisibilityState(A,true,false);this.setVisibilityState(B,false,false);this._startViewChangeNodeTransition();}}}};k.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var c=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){c=false;});var i=function(){if(c){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(i);}}.bind(this);window.requestAnimationFrame(i);};k.prototype._resetNodesMaterialAndOpacityByCurrenView=function(c){if(!c){return;}var i=c.getNodeInfos();if(i){i.forEach(function(l){if(l.target===null){return;}this._updateMaterialInNode(l);}.bind(this));}};k.prototype._onViewActivated=function(c,i,l){var q=this.getViewManager();if(!q||l.source.getId()!==q){return;}this.activateView(l.view,false,l.playViewGroup,l.notAnimateCameraChange);};k.prototype.activateView=function(c,i,l,q){this.fireViewStateApplying({view:c});this.setJoints(undefined);this._customPositionedNodes.clear();this._resetNodesMaterialAndOpacityByCurrenView(c);this._resetTransitionHighlight(c);this._resetNodesStatusByCurrenView(c,true,true);this._highlightPlayer.reset(c,this._scene);this.fireViewStateApplied({view:c,ignoreAnimationPosition:i,notAnimateCameraChange:q,playViewGroup:l});v.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:c,ignoreAnimationPosition:i,notAnimateCameraChange:q,playViewGroup:l});return this;};k.prototype.setHighlightDisplayState=function(s){if(s===g.playing){this._highlightPlayer.start((new Date()).getTime());}else if(s===g.stopped){this._highlightPlayer.stop();}else if(s===g.pausing){this._highlightPlayer.pause((new Date()).getTime());}this.fireHighlightColorChanged({highlightColor:b(d(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};k.prototype._startHighlight=function(){this._highlightPlayer.start((new Date()).getTime());return this;};k.prototype._playHighlight=function(){return this._highlightPlayer.play((new Date()).getTime());};k.prototype._resetTransitionHighlight=function(c){this._transitionHighlightPlayer.reset();this._transitionHighlightPlayer.fadeInNodes=[];this._transitionHighlightPlayer.fadeOutNodes=[];this._transitionHighlightPlayer.setViewStateManager(this);var l=c.getNodeInfos();if(!l){return;}var q=function(w,x,y){if(!w||!w.length){return;}for(var i=0;i<w.length;i++){var z=w[i];if(z.type==="Mesh"&&(!y||(y&&!y.includes(z)))){x.push(z);}q(z.children,x,y);}};var r=[];var s=[];var u=this;l.forEach(function(i){var w=i.target;var x=w.layers.test(u._layers);if(x&&!i.visible){r.push(w);}if(!x&&i.visible){s.push(w);}});q(s,this._transitionHighlightPlayer.fadeInNodes);q(r,this._transitionHighlightPlayer.fadeOutNodes,this._transitionHighlightPlayer.fadeInNodes);};k.prototype._startTransitionHighlight=function(c){var i=this._transitionHighlightPlayer.fadeInNodes;var l=this._transitionHighlightPlayer.fadeOutNodes;if(i&&i.length){var q=new h("FadeIn",{duration:c/500.0,opacities:[0.0,1.0],cycles:1});this._transitionHighlightPlayer.addHighlights(q,i);}if(l&&l.length){var r=new h("FadeOut",{duration:c/500.0,opacities:[1.0,0.0],cycles:1,fadeOut:true});this._transitionHighlightPlayer.addHighlights(r,l);}if((i&&i.length)||(l&&l.length)){this._transitionHighlightPlayer.start((new Date()).getTime());this._transitionHighlightPlayer.play((new Date()).getTime());return c;}else{return 0;}return 0;};k.prototype._playTransitionHighlight=function(){return this._transitionHighlightPlayer.play((new Date()).getTime());};j=function(){this._visibilityChanges=new Set();};j.prototype.getInfo=function(c){var i=[];this._visibilityChanges.forEach(function(l){var q=c.createNodeProxy(l);var r=q.getVeId();c.destroyNodeProxy(q);if(r){i.push(r);}else{i.push(c.getScene().nodeRefToPersistentId(l));}});return i;};j.prototype.clear=function(){this._visibilityChanges.clear();};j.prototype.trackNodeRef=function(c){if(this._visibilityChanges.has(c)){this._visibilityChanges.delete(c);}else{this._visibilityChanges.add(c);}};C.injectMethodsIntoClass(k);return k;});
