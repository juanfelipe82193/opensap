/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../threejs/thirdparty/three","./Gizmo","./RotateToolGizmoRenderer","./RotatableAxis","./CoordinateSystem","./AxisColours"],function(q,t,G,R,b,C,A){"use strict";var c=G.extend("sap.ui.vk.tools.RotateToolGizmo",{metadata:{library:"sap.ui.vk"}});c.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=0;this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._axis=b.All;this._coordinateSystem=C.World;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;this._gizmoRotation=new THREE.Vector3();function a(f,g,r,s){var h=new THREE.TorusBufferGeometry(r,1/96,4,s);if(f===0){h.rotateY(Math.PI/2);}else if(f===1){h.rotateX(Math.PI/2);}var j=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:g,transparent:true}));j.matrixAutoUpdate=false;j.userData.color=g;return j;}function d(f,r,s){var g=new THREE.TorusBufferGeometry(r,16/96,4,s);if(f===0){g.rotateY(Math.PI/2);}else if(f===1){g.rotateX(Math.PI/2);}return new THREE.Mesh(g,new THREE.MeshBasicMaterial({opacity:0.2,transparent:true}));}for(var i=0;i<3;i++){this._gizmo.add(a(i,A[["x","y","z"][i]],1,128));this._touchAreas.add(d(i,1,24));}this._gizmo.add(new THREE.AxesHelper(0.75));var e=new THREE.MeshBasicMaterial({color:0x0080FF,opacity:0.5,transparent:true,side:THREE.DoubleSide});this._arcMesh=new THREE.Mesh(new THREE.Geometry(),e);this._arcMesh.drawMode=THREE.TriangleFanDrawMode;this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);};c.prototype.hasDomElement=function(){return true;};c.prototype.setAxis=function(v){this._axis=v;var a=[b.All,b.X,b.Y,b.Z];if(this._coordinateSystem!==C.Screen){for(var i=0;i<3;i++){if(v!==b.All&&a[i+1]!==v){this._gizmo.children[i].visible=this._touchAreas.children[i].visible=false;}else{this._gizmo.children[i].visible=this._touchAreas.children[i].visible=true;}}}};c.prototype.setCoordinateSystem=function(a){this._coordinateSystem=a;var s=a===C.Screen;if(s){this._gizmo.children[0].visible=this._gizmo.children[1].visible=false;this._touchAreas.children[0].visible=this._touchAreas.children[1].visible=false;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=true;}else{this._gizmo.children[0].visible=this._touchAreas.children[0].visible=this._axis===b.All||this._axis===b.X;this._gizmo.children[1].visible=this._touchAreas.children[1].visible=this._axis===b.All||this._axis===b.Y;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=this._axis===b.All||this._axis===b.Z;}this._axisTitles.visible=!s;this._gizmoIndex=this._handleIndex=-1;};c.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._updateSelection(v._viewStateManager);};c.prototype.hide=function(){this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false);};c.prototype.getGizmoCount=function(){if(this._coordinateSystem===C.Local){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};c.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};c.prototype.getGizmoObject=function(){return this._nodes.length>0?this._gizmo:null;};c.prototype.highlightHandle=function(a,h){for(var i=0;i<3;i++){var d=this._gizmo.children[i];var e=i===a?0xFFFF00:d.userData.color;d.material.color.setHex(e);d.material.opacity=a===-1||i===a?1:0.35;d.material.visible=h||i===a;var f=this._axisTitles.children[i];f.material.color.setHex(e);f.material.opacity=a===-1||i===a?1:0.35;f.material.visible=h||i===a;}};c.prototype.selectHandle=function(i,g){this._gizmoIndex=g;this._handleIndex=i;this._value=0;this._viewport.setShouldRenderFrame();};c.prototype.beginGesture=function(){this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){n.node.parent.updateMatrixWorld(true);n.matOrigin=n.node.matrixWorld.clone();n.matLocalOrigin=n.node.matrix.clone();n.matParentInv=new THREE.Matrix4().getInverse(n.node.parent.matrixWorld);n.quaternion=n.node.quaternion.clone();});};c.prototype.endGesture=function(){this._arcMesh.visible=false;this._tool.fireRotated({x:this._gizmoRotation.x,y:this._gizmoRotation.y,z:this._gizmoRotation.z});};c.prototype._rotate=function(e){this._gizmoRotation.set(THREE.Math.radToDeg(e.x),THREE.Math.radToDeg(e.y),THREE.Math.radToDeg(e.z));var a=new THREE.Quaternion();if(this._coordinateSystem===C.Local){a.setFromEuler(e);this._nodes.forEach(function(j){j.node.quaternion.copy(j.quaternion).multiply(a);j.node.matrixWorldNeedsUpdate=true;});}else{e=e.toArray();for(var i=0;i<3;i++){var d=e[i];if(d){var f=e[3].charCodeAt(i)-88;if(f>=0&&f<3){var g=new THREE.Vector3().setFromMatrixColumn(this._matOrigin,f).normalize();var m=new THREE.Matrix4().makeRotationAxis(g,d);var p=new THREE.Vector3().setFromMatrixPosition(this._matOrigin);m.setPosition(p.sub(p.clone().applyMatrix4(m)));for(var n=0,h=this._nodes.length;n<h;n++){var j=this._nodes[n];if(!j.ignore){var k=j.node;k.position.setFromMatrixPosition(j.matOrigin).applyMatrix4(m).applyMatrix4(j.matParentInv);var s=new THREE.Vector3().setFromMatrixScale(j.matOrigin);var l=g.clone().transformDirection(new THREE.Matrix4().getInverse(j.matOrigin)).multiply(s).normalize();a.setFromAxisAngle(l,d);k.quaternion.copy(j.quaternion).multiply(a);k.matrixWorldNeedsUpdate=true;}}}}}}this._recalculateJoints(this._viewport._getViewStateManagerThreeJS());this._viewport.setShouldRenderFrame();};c.prototype._setRotationAxisAngle=function(d,e,f){var g=this._value=(f-e)%(Math.PI*2);var h=new THREE.Euler();h[["x","y","z"][d]]=g;if(this._tool.fireEvent("rotating",{x:THREE.Math.radToDeg(h.x),y:THREE.Math.radToDeg(h.y),z:THREE.Math.radToDeg(h.z)},true)){this._rotate(h);var v=[0,0,0];var j=new THREE.Vector3();var k=(d+1)%3,l=(d+2)%3;var n=Math.max(Math.ceil(Math.abs(g)*64/Math.PI),1);g*=this._coordinateSystem===C.Local?-1:1;for(var i=0;i<=n;i++){var a=e+g*(i/n);j.set(0,0,0).setComponent(k,Math.cos(a)).setComponent(l,Math.sin(a));v.push(j.x,j.y,j.z);}this._arcMesh.geometry=new THREE.BufferGeometry().addAttribute("position",new THREE.Float32BufferAttribute(v,3));this._arcMesh.visible=true;}};c.prototype.rotate=function(x,y,z){this.beginGesture();this._rotate(new THREE.Euler(THREE.Math.degToRad(x||0),THREE.Math.degToRad(y||0),THREE.Math.degToRad(z||0)));this._value+=THREE.Math.degToRad([x,y,z][this._handleIndex]||0);};c.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2};};c.prototype.getValue=function(){return THREE.Math.radToDeg(this._value);};c.prototype.setValue=function(v){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){v=THREE.Math.degToRad(v);this.beginGesture();var e=new THREE.Euler();e[["x","y","z"][this._handleIndex]]=v-this._value;this._rotate(e);this.endGesture();this._value=v;}};c.prototype.expandBoundingBox=function(a){if(this._viewport){this._expandBoundingBox(a,this._viewport.getCamera().getCameraRef(),this._viewport._getLayers());}};c.prototype.handleSelectionChanged=function(e){if(this._viewport){if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(this._viewport._viewStateManager);}this._updateSelection(this._viewport._viewStateManager);this._gizmoIndex=this._handleIndex=-1;}};c.prototype._getLevelingQuaternion=function(a,o){a.set(0,0,0,1);switch(this._coordinateSystem){case C.Local:a.setFromRotationMatrix(this._nodes[o].node.parent.matrixWorld);break;case C.Screen:a.copy(this._viewport.getCamera().getCameraRef().quaternion);break;case C.Custom:var d=this._getAnchorPoint();if(d){a.copy(d.quaternion);}break;default:break;}return false;};c.prototype._getObjectSize=function(o){var a=new THREE.Box3();if(this._nodes.length===1){this._nodes[0].node._expandBoundingBox(a,this._viewport._getLayers(),false);}else if(this._coordinateSystem===C.Local){this._nodes[0].node._expandBoundingBox(a,this._viewport._getLayers(),false);}if(a.isEmpty()){return 0;}var s=new THREE.Vector3();a.getSize(s);return s.length();};c.prototype._updateGizmoTransformation=function(i,a){var s=this._updateGizmoObjectTransformation(this._gizmo,i);this._updateAxisTitles(this._axisTitles,this._gizmo,a,this._gizmoSize-12,s);};c.prototype._getEditingFormPosition=function(){var s=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var d=new THREE.Vector3().setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return d.clone().multiplyScalar((this._gizmoSize-12)*s).add(this._gizmo.position).applyMatrix4(this._matViewProj);};c.prototype.render=function(){if(this._nodes.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,a);r.render(this._sceneGizmo,a);}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex);};return c;});
