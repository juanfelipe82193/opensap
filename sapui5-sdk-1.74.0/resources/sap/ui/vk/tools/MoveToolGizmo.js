/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../getResourceBundle","../threejs/thirdparty/three","./Gizmo","./MoveToolGizmoRenderer","./CoordinateSystem","./GizmoPlacementMode","./AxisColours"],function(q,g,t,G,M,C,d,A){"use strict";var e=G.extend("sap.ui.vk.tools.MoveToolGizmo",{metadata:{library:"sap.ui.vk"}});e.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(g().getText("TOOL_UNITS_MM"),84);this._gizmoIndex=-1;this._handleIndex=-1;this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();var l=new THREE.DirectionalLight(0xFFFFFF,0.5);l.position.set(1,3,2);this._sceneGizmo.add(l);this._sceneGizmo.add(new THREE.AmbientLight(0xFFFFFF,0.5));this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._coordinateSystem=C.World;this._placementMode=d.Default;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;this._gizmoOffset=new THREE.Vector3();function c(a,b,j){var k=96,n=1,o=24,p=4,r=48;a.multiplyScalar(1/k);var s=new THREE.MeshLambertMaterial({color:b,transparent:true});var u=new THREE.CylinderBufferGeometry(n,n,k-o,4);var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(a.y,a.z,a.x),a,new THREE.Vector3(a.z,a.x,a.y));m.setPosition(a.clone().multiplyScalar((k-o)*0.5));u.applyMatrix(m);var v=new THREE.Mesh(u,s);v.matrixAutoUpdate=false;v.userData.color=b;var w=new THREE.CylinderBufferGeometry(0,p,o,12,1);m.setPosition(a.clone().multiplyScalar(k-o*0.5));w.applyMatrix(m);var x=new THREE.Mesh(w,s);x.matrixAutoUpdate=false;v.add(x);var y=new THREE.CylinderGeometry(r*0.5,r*0.5,r,12,1);y.applyMatrix(m);var z=new THREE.CylinderGeometry(r*0.5,r*0.2,r,12,1);m.setPosition(a.clone().multiplyScalar(k*0.5));y.merge(z,m);j.add(new THREE.Mesh(y,s));return v;}function h(a,b,j){var k=new Float32Array(9);k[a]=k[b+6]=1;k[a+3]=k[b+3]=0.5;var v=new THREE.Vector3().setComponent(a,0.333);var m=new THREE.Vector3().setComponent(b,0.333);var i=new THREE.Geometry();i.vertices.push(new THREE.Vector3(),v,m,v.clone().add(m));i.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));var n=new THREE.MeshBasicMaterial({color:0xFFFF00,opacity:0.5,transparent:true,visible:false,side:THREE.DoubleSide});var p=new THREE.Mesh(i,n);p.matrixAutoUpdate=false;p.userData.colors=k;var o=new THREE.BufferGeometry();var r=new Float32Array(9);r[a]=r[a+3]=r[b+3]=r[b+6]=0.333;o.addAttribute("position",new THREE.Float32BufferAttribute(r,3));o.addAttribute("color",new THREE.Float32BufferAttribute(k,3));var s=new THREE.Line(o,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:true,linewidth:window.devicePixelRatio}));s.matrixAutoUpdate=false;p.add(s);var u=new THREE.Geometry();u.vertices.push(new THREE.Vector3(),v,m,v.clone().add(m));u.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(2,1,3));j.add(new THREE.Mesh(u,new THREE.MeshBasicMaterial({side:THREE.DoubleSide})));return p;}this._gizmo.add(c(new THREE.Vector3(1,0,0),A.x,this._touchAreas));this._gizmo.add(c(new THREE.Vector3(0,1,0),A.y,this._touchAreas));this._gizmo.add(c(new THREE.Vector3(0,0,1),A.z,this._touchAreas));this._gizmo.add(h(1,2,this._touchAreas));this._gizmo.add(h(2,0,this._touchAreas));this._gizmo.add(h(0,1,this._touchAreas));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);var i=new THREE.Geometry();i.vertices.push(new THREE.Vector3(),new THREE.Vector3());this._line=new THREE.LineSegments(i,new THREE.LineBasicMaterial());this._line.frustumCulled=false;this._line.visible=false;this._gizmo.add(this._line);};e.prototype.hasDomElement=function(){return true;};e.prototype.setCoordinateSystem=function(c){this._coordinateSystem=c;var s=c===C.Screen;var a=this._gizmo.children,b=this._touchAreas.children;a[2].visible=a[3].visible=a[4].visible=!s;b[2].visible=b[3].visible=b[4].visible=!s;this._axisTitles.children[2].visible=!s;this._gizmoIndex=this._handleIndex=-1;};e.prototype.setPlacementMode=function(p){this._placementMode=p;};e.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._updateSelection(v._viewStateManager);};e.prototype.hide=function(){this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false);};e.prototype.getGizmoCount=function(){if(this._coordinateSystem===C.Local){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};e.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};var f=[1,2,4,6,5,3];e.prototype.highlightHandle=function(a,h){var i;for(i=0;i<3;i++){var b=this._gizmo.children[i];var c=f[a]&(1<<i);var j=c?0xFFFF00:b.userData.color;b.material.color.setHex(j);b.material.opacity=(c||h)?1:0.35;b.children[0].material.color.setHex(j);b.children[0].material.opacity=(c||h)?1:0.35;var k=this._axisTitles.children[i];k.material.color.setHex(j);k.material.opacity=c||h?1:0.35;}for(i=3;i<6;i++){var p=this._gizmo.children[i];p.material.visible=i===a;var l=p.children[0].geometry.attributes.color;l.copyArray(i===a?[1,1,0,1,1,0,1,1,0]:p.userData.colors);l.needsUpdate=true;p.children[0].material.opacity=(i===a||h)?1:0.35;}};e.prototype.selectHandle=function(i,a){this._gizmoIndex=a;this._handleIndex=i;this._viewport.setShouldRenderFrame();};e.prototype.beginGesture=function(){this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){var a=n.node;n.matOrigin=a.matrixWorld.clone();n.originLocal=a.position.clone();n.origin=new THREE.Vector3().setFromMatrixPosition(a.matrixWorld);n.matParentInv=new THREE.Matrix4().getInverse(a.parent.matrixWorld);});};e.prototype.endGesture=function(){this._line.visible=false;this._tool.fireMoved({x:this._gizmoOffset.x,y:this._gizmoOffset.y,z:this._gizmoOffset.z});};e.prototype._setOffset=function(o,a){if(this._coordinateSystem===C.Local){var n=this._nodes[a];var m=new THREE.Matrix4().getInverse(n.node.matrixWorld);var s=new THREE.Vector3().setFromMatrixScale(n.node.matrixWorld);var b=n.origin.clone().applyMatrix4(m);o=n.origin.clone().add(o).applyMatrix4(m).sub(b).multiply(s);}else if(this._coordinateSystem===C.Screen){var c=this._viewport.getRenderer().getSize();var p=this._gizmo.position.clone().applyMatrix4(this._matViewProj);var h=this._gizmo.position.clone().add(o).applyMatrix4(this._matViewProj);o.set(Math.round((h.x-p.x)*0.5*c.width),Math.round((h.y-p.y)*0.5*c.height),0);}if(this._tool.fireEvent("moving",{x:o.x,y:o.y,z:o.z},true)){this._move(o);if(this._coordinateSystem===C.Screen){o.set(new THREE.Vector3().setFromMatrixColumn(this._matOrigin,0).normalize().dot(o),new THREE.Vector3().setFromMatrixColumn(this._matOrigin,1).normalize().dot(o),0);}else if(this._coordinateSystem===C.Custom){var i=this._getAnchorPoint();if(i){var j=new THREE.Matrix4().getInverse(i.matrixWorld);var k=new THREE.Vector3().setFromMatrixScale(i.matrixWorld);var l=i.position.clone().applyMatrix4(j);o.copy(i.position.clone().add(o).applyMatrix4(j).sub(l).multiply(k));}}this._line.geometry.vertices[0].setScalar(0).sub(o);this._line.geometry.verticesNeedUpdate=true;this._line.geometry.computeBoundingBox();o.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z));o.multiplyScalar(1/Math.max(o.x,o.y,o.z));this._line.material.color.setRGB(o.x,o.y,o.z);this._line.visible=true;}};e.prototype._move=function(o){this._gizmoOffset.copy(o);if(this._coordinateSystem===C.Local){this._nodes.forEach(function(n){var j=n.node;var k=this._extractBasis(j.matrixWorld);var p=n.origin.clone();p.add(k[0].multiplyScalar(o.x)).add(k[1].multiplyScalar(o.y)).add(k[2].multiplyScalar(o.z));j.matrixWorld.setPosition(p);j.matrix.multiplyMatrices(n.matParentInv,j.matrixWorld);j.position.setFromMatrixPosition(j.matrix);}.bind(this));}else{if(this._coordinateSystem===C.Screen){var s=this._viewport.getRenderer().getSize();var c=this._viewport.getCamera().getCameraRef();var a=new THREE.Vector4().copy(this._gizmo.position).applyMatrix4(this._matViewProj);var b=o.x*2*a.w/(c.projectionMatrix.elements[0]*s.width);var h=o.y*2*a.w/(c.projectionMatrix.elements[5]*s.height);o.setFromMatrixColumn(c.matrixWorld,0).multiplyScalar(b);o.add(new THREE.Vector3().setFromMatrixColumn(c.matrixWorld,1).multiplyScalar(h));}this._gizmo.position.setFromMatrixPosition(this._matOrigin).add(o);if(this._coordinateSystem===C.Custom){var i=this._getAnchorPoint();if(i){i.position.copy(this._gizmo.position);}}this._nodes.forEach(function(n){if(!n.ignore){var j=n.node;j.matrixWorld.setPosition(n.origin.clone().add(o));j.matrix.multiplyMatrices(n.matParentInv,j.matrixWorld);j.position.setFromMatrixPosition(j.matrix);}});}this._recalculateJoints(this._viewport._getViewStateManagerThreeJS());this._viewport.setShouldRenderFrame();};e.prototype.move=function(x,y,z){this.beginGesture();this._move(new THREE.Vector3(x,y,z||0));};e.prototype.getValue=function(){var v=0,p,o,a;if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){switch(this._coordinateSystem){default:case C.World:v=this._gizmo.position.getComponent(this._handleIndex);break;case C.Local:var n=this._nodes[this._gizmoIndex].node;p=new THREE.Vector3().setFromMatrixPosition(n.parent.matrixWorld);o=this._gizmo.position.clone().sub(p);a=new THREE.Vector3().setFromMatrixColumn(n.matrixWorld,this._handleIndex).normalize();v=a.dot(o);break;case C.Screen:var r=this._viewport.getRenderer();var s=r.getSize();p=this._gizmo.position.clone().applyMatrix4(this._matViewProj);p.x*=s.width*0.5;p.y*=s.height*0.5;v=p.getComponent(this._handleIndex);break;case C.Custom:var b=this._getAnchorPoint();if(b){p=new THREE.Vector3().setFromMatrixPosition(b.matrixWorld);o=this._gizmo.position.clone().sub(p);a=new THREE.Vector3().setFromMatrixColumn(b.matrixWorld,this._handleIndex).normalize();v=a.dot(o);}break;}}return v;};e.prototype.setValue=function(v){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){this.beginGesture();var o=new THREE.Vector3();if(this._coordinateSystem===C.Custom){var a=this._getAnchorPoint();if(a){o.setFromMatrixColumn(a.matrixWorld,this._handleIndex).normalize().multiplyScalar(v-this._lastEditValue);}}else{o.setComponent(this._handleIndex,v-this._lastEditValue);}this._move(o);this.endGesture();}};e.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef(),this._viewport._getLayers());}};e.prototype.handleSelectionChanged=function(a){if(this._viewport){if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(this._viewport._viewStateManager);}this._updateSelection(this._viewport._viewStateManager);this._gizmoIndex=this._handleIndex=-1;}};e.prototype._getSelectionCenter=function(a){G.prototype._getSelectionCenter.apply(this,arguments);var b=this;function h(c,l,w,k){var r=(w/2);var s=(k/2);c.project(l);c.x=(c.x*r)+r;c.y=-(c.y*s)+s;return c;}function i(c,l,w,k){var r=(w/2);var s=(k/2);c.x=(c.x-r)/r;c.y=-(c.y-s)/s;c.unproject(l);return c;}function j(l,w,k){var c=new THREE.Vector3(b._gizmoSize,b._gizmoSize,0);var r=new THREE.Vector3(w-b._gizmoSize,b._gizmoSize,0);var s=new THREE.Vector3(w-b._gizmoSize,k-b._gizmoSize,0);var u=new THREE.Vector3(b._gizmoSize,k-b._gizmoSize,0);var x=[i(c,l,w,k),i(r,l,w,k),i(s,l,w,k),i(u,l,w,k)];return x[0].add(x[1]).add(x[2]).add(x[3]).multiplyScalar(0.25);}if(this._placementMode===d.OnScreen){var v=this._viewport.getDomRef().getBoundingClientRect();var w=v.width;var k=v.height;var l=this._viewport.getCamera().getCameraRef();var p=h(a.clone(),l,w,k);var m=p.clone();var n=[m.x<this._gizmoSize&&m.setX(b._gizmoSize)||m.x>w-this._gizmoSize&&m.setX(w-b._gizmoSize),m.y<this._gizmoSize&&m.setY(b._gizmoSize)||m.y>k-this._gizmoSize&&m.setY(k-b._gizmoSize)].some(function(c){return c!==false;})&&a.copy(i(m,l,w,k));return p.z>1.0&&a.copy(j(l,w,k))||n||a;}else if(this._placementMode===d.ObjectCenter&&this._nodes.length===1&&this._nodes[0].node.userData.boundingBox){var o=new THREE.Vector3();this._nodes[0].node.userData.boundingBox.getCenter(o);a.copy(o.applyMatrix4(this._nodes[0].node.matrixWorld));}};e.prototype._updateGizmoTransformation=function(i,c){var s=this._updateGizmoObjectTransformation(this._gizmo,i);this._updateAxisTitles(this._axisTitles,this._gizmo,c,this._gizmoSize+18,s);this._line.scale.setScalar(1/(this._gizmoSize*s));};e.prototype._getEditingFormPosition=function(){var s=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var a=new THREE.Vector3().setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return a.clone().multiplyScalar((this._gizmoSize+18)*s).add(this._gizmo.position).applyMatrix4(this._matViewProj);};e.prototype.render=function(){if(this._nodes.length>0){var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,c);r.render(this._sceneGizmo,c);}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex);};return e;});
