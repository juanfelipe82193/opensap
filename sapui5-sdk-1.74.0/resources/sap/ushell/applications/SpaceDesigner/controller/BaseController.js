// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/UIComponent","../util/Transport","sap/m/MessageBox","sap/m/library","sap/base/Log"],function(C,U,T,M,s,L){"use strict";return C.extend("sap.ushell.applications.SpaceDesigner.controller.BaseController",{getSpaceRepository:function(){return this.getOwnerComponent().getSpaceRepository();},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getRootView:function(){return this.getOwnerComponent().getRootControl();},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getTransportHelper:function(){if(!this.oTransportHelper){this.oTransportHelper=new T();}return this.oTransportHelper;},_createEditDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/SpaceDesigner/controller/EditDialog.controller"],function(E){if(!this.oEditSpaceDialogController){this.oEditSpaceDialogController=new E(this.getRootView(),this.getResourceBundle());}this.oEditSpaceDialogController.attachCancel(a);this.oEditSpaceDialogController.attachConfirm(o);this.oEditSpaceDialogController.load().then(function(){r(this.oEditSpaceDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/SpaceDesigner/controller/CreateSpaceDialog.controller"],function(c){if(!this.oCreateSpaceDialogController){this.oCreateSpaceDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCreateSpaceDialogController.attachConfirm(o);this.oCreateSpaceDialogController.attachCancel(a);this.oCreateSpaceDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCreateSpaceDialogController,t,o);}.bind(this));}return this.oCreateSpaceDialogController;}.bind(this)).then(function(e){if(e){e.open();}r();}).catch(function(e){this.oCreateSpaceDialogController.destroy();this.handleBackendError(e);b();}.bind(this));}.bind(this));}.bind(this));},_createDeleteDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/SpaceDesigner/controller/DeleteDialog.controller"],function(D){if(!this.oDeleteSpaceDialogController){this.oDeleteSpaceDialogController=new D(this.getRootView(),this.getResourceBundle());}this.oDeleteSpaceDialogController.attachCancel(a);this.oDeleteSpaceDialogController.attachConfirm(o);this.oDeleteSpaceDialogController.load().then(function(){r(this.oDeleteSpaceDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(a,o,b){var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return Promise.resolve();}return this.getOwnerComponent().createTransportComponent(a.metadata.devclass).then(function(t){return Promise.all([t.showTransport(a),t.showLockedMessage(a)]).then(function(r){var S=r[0];var l=r[1];if(l){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LockedText",[l.foreignOwner]),true);}else if(S){this._createEditDialog(o,b).then(function(d){d.getModel().setProperty("/message",this.getResourceBundle().getText("EditDialog.TransportRequired"));var E=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);E.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},checkShowDeleteDialog:function(a,o,b){var r=this.getResourceBundle();var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return this._createDeleteDialog(o,b).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));d.open();});}return this.getOwnerComponent().createTransportComponent(a.metadata.devclass).then(function(t){return Promise.all([t.showTransport(a),t.showLockedMessage(a)]).then(function(R){var S=R[0];var l=R[1];if(l){this.showMessageBoxError(r.getText("DeleteDialog.LockedText",[l.foreignOwner]),true);}else{this._createDeleteDialog(o,b).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));if(S){d.getModel().setProperty("/message",r.getText("DeleteDialog.TransportRequired"));d=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);}d.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},showCopyDialog:function(S,o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/SpaceDesigner/controller/CopySpaceDialog.controller"],function(c){if(!this.oCopySpaceDialogController){this.oCopySpaceDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCopySpaceDialogController.attachConfirm(o);this.oCopySpaceDialogController.attachCancel(a);return this.oCopySpaceDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCopySpaceDialogController,t,o);}.bind(this));}return this.oCopySpaceDialogController;}.bind(this)).then(function(e){if(e){e.open();e.getModel().setProperty("/sourceId",S.content.id);e.getModel().setProperty("/sourceTitle",S.content.title);}r();}).catch(function(e){this.oCopySpaceDialogController.destroy();this.handleBackendError(e);b(e);}.bind(this));}.bind(this));}.bind(this));},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:function(){this.navigateToSpaceOverview();}.bind(this)});}else{M.error(e);}},navigateToSpaceOverview:function(){this.getRouter().navTo("overview");},navigateToErrorPage:function(S){this.getRouter().navTo("error",{spaceId:encodeURIComponent(S)},null,true);},checkMasterLanguageMismatch:function(a){var c=this.getOwnerComponent().getMetadata().getConfig().checkLanguageMismatch;var u=sap.ui.getCore().getConfiguration().getSAPLogonLanguage().toUpperCase();var S=a.content.masterLanguage.toUpperCase();if(c&&u!==S){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LanguageMismatch",[S,u]),true);return true;}return false;},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else{L.error(e);}},onRouteLeave:function(){this.getSpaceRepository().abortPendingBackendRequests();}});});
