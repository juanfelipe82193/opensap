// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(B,M,J,F,a){"use strict";return B.extend("sap.ushell.applications.SpaceDesigner.controller.Main",{aPropertiesToFilter:["id","title","description","createdByFullname","modifiedByFullname","BusinessRoleId","BusinessRole"],oDialogFactory:null,onInit:function(){this.setModel(new J({busy:false,pages:[],transportSupported:this.getOwnerComponent().isTransportSupported()}));this.getRouter().getRoute("overview").attachPatternMatched(this._onSpaceOverviewMatched,this);this.setModel(this._createInitialButtonStateModel(),"buttonStates");},onItemPress:function(e){var s=e.getParameter("listItem").getBindingContext().getObject();this._navigateToDetail(s.content.id);},_onSpaceOverviewMatched:function(){this._refreshModel();},_navigateToEdit:function(p){this.getRouter().navTo("edit",{pageId:encodeURIComponent(p)});},_navigateToDetail:function(s){this.getRouter().navTo("view",{spaceId:encodeURIComponent(s)});},onSelectionChange:function(e){this._setDeleteAndCopyButtonEnabled(true);},onEdit:function(e){var p=e.getSource().getBindingContext().getObject();this._navigateToEdit(p.content.id);},onAdd:function(){var r=this.getResourceBundle();this.showCreateDialog(function(p){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(p,[]);}).then(function(R){return this.getPageRepository().createPage(R);}.bind(this)).then(function(){this._navigateToEdit(p.content.id);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},_deletePage:function(e){var r=this.getResourceBundle();var d=e.getSource().getParent();var t=e.metadata&&e.metadata.transportId||"";var T=this.byId("table");var i=T.getSelectedItems().map(function(b){return b.getBindingContext().getObject();});var s=r.getText("Message.SuccessDeletePage");var D=i.map(function(I){return this.getPageRepository().deletePage(I.content.id,t);}.bind(this));return Promise.all(D).then(function(){return this._refreshModel();}.bind(this)).then(function(){T.removeSelections();this._setDeleteAndCopyButtonEnabled(false);T.fireSelectionChange();M.show(s,{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this));},onDelete:function(){var t=this.byId("table");var s=t.getSelectedItem();if(!s){return;}this.checkShowDeleteDialog(s.getBindingContext().getObject(),this._deletePage.bind(this));},onCopy:function(){var t=this.byId("table");var s=t.getSelectedItem();var r=this.getResourceBundle();if(!s){return;}var p=s.getBindingContext().getObject();this.showCopyDialog(p,function(b){this.pageInfo=b;sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(b,[]);}).then(function(R){return this.getPageRepository().copyPage(R);}.bind(this)).then(function(){return this._refreshModel();}.bind(this)).then(function(){this._navigateToDetail(this.pageInfo.content.targetId);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},onSearch:function(e){var t=this.byId("table");var b=t.getBinding("items");var r=this.getResourceBundle();var s=e.getSource().getValue();var f=this.aPropertiesToFilter.map(function(p){return new F({path:"content/"+p,operator:a.Contains,value1:s});});var o=new F({filters:f,and:false});b.filter([o]);if(b.getLength()===0){if(s){t.setNoDataText(r.getText("Message.NoPagesFound"));}else{t.setNoDataText(r.getText("Message.NoPages"));}}},_refreshModel:function(){this.getModel().setProperty("/busy",true);return this._loadAvailableSpaces().then(function(s){this.getModel().setSizeLimit(s.spaces.length);this.getModel().setProperty("/spaces",s.spaces);this.getModel().setProperty("/busy",false);}.bind(this),function(e){this.getModel().setProperty("/busy",false);this.showMessageBoxError(e);}.bind(this));},onTableUpdate:function(){var t=this.byId("table");if(t.getSelectedItems().length===0){t.removeSelections(true);this._setDeleteAndCopyButtonEnabled(false);}},_loadAvailableSpaces:function(){return this.getSpaceRepository().getSpaces().then(function(s){return{spaces:s};});},_createInitialButtonStateModel:function(){return new J({isDeleteAndCopyEnabled:false});},_setDeleteAndCopyButtonEnabled:function(e){this.getView().getModel("buttonStates").setProperty("/isDeleteAndCopyEnabled",e);}});});
