// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define([],function(){"use strict";var S=function(d,r){this._oODataModel=d;this._oResourceBundle=r;this._oEtags={};};S.prototype.getSpaces=function(){return this._readSpaces().then(function(s){for(var i=0;i<s.results.length;i++){this._storeETag(s.results[i]);}return s;}.bind(this)).then(this._convertODataToSpaceList).catch(this._rejectWithErrorMessage.bind(this));};S.prototype.getSpace=function(s){return this._readSpace(s).then(function(a){this._storeETag(a);return a;}.bind(this)).then(this._convertODataToReferenceSpace).catch(this._rejectWithErrorMessage.bind(this));};S.prototype.createSpace=function(s){var a=this._convertReferenceSpaceToOData(s);return this._createSpace(a).then(this._storeETag.bind(this));};S.prototype.updateSpace=function(u){var U=this._convertReferenceSpaceToOData(u);U.modifiedOn=this._oEtags[u.content.id].modifiedOn;return this._createSpace(U).then(this._storeETag.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};S.prototype.deleteSpace=function(s,t){return new Promise(function(r,a){this._oODataModel.callFunction("/deleteSpace",{method:"POST",urlParameters:{spaceId:s,transportId:t,modifiedOn:this._oEtags[s].modifiedOn},success:r,error:a});}.bind(this));};S.prototype.copySpace=function(s){return new Promise(function(r,a){this._oODataModel.callFunction("/copySpace",{method:"POST",urlParameters:{targetId:s.content.targetId.toUpperCase(),sourceId:s.content.sourceId,title:s.content.title,devclass:s.metadata.devclass,transportId:s.metadata.transportId},success:r,error:a});}.bind(this));};S.prototype._readSpaces=function(){return new Promise(function(r,a){this._oODataModel.read("/spaceSet",{success:r,error:a});}.bind(this));};S.prototype._readSpace=function(s){return new Promise(function(r,a){this._oODataModel.read("/spaceSet('"+encodeURIComponent(s)+"')",{urlParameters:{"$expand":"pages"},success:r,error:a});}.bind(this));};S.prototype._createSpace=function(n){return new Promise(function(r,a){this._oODataModel.create("/spaceSet",n,{success:r,error:a});}.bind(this));};S.prototype._convertODataToSpaceList=function(s){return s.results.map(function(o){return{content:{id:o.id,title:o.title,description:o.description,createdBy:o.createdBy,createdByFullname:o.createdByFullname,createdOn:o.createdOn,modifiedBy:o.modifiedBy,modifiedByFullname:o.modifiedByFullname,modifiedOn:o.modifiedOn,masterLanguage:o.masterLanguage},metadata:{devclass:o.devclass,transportId:o.transportId}};});};S.prototype._convertODataToReferenceSpace=function(s){return{content:{id:s.id,title:s.title,description:s.description,createdBy:s.createdBy,createdByFullname:s.createdByFullname,createdOn:s.createdOn,modifiedBy:s.modifiedBy,modifiedByFullname:s.modifiedByFullname,modifiedOn:s.modifiedOn,masterLanguage:s.masterLanguage,pages:s.pages.results.map(function(p){return{id:p.id,title:p.title};})},metadata:{transportId:s.transportId,devclass:s.devclass}};};S.prototype._convertReferenceSpaceToOData=function(s){var r=s.content,m=s.metadata;var o={id:r.id,title:r.title,description:r.description,devclass:m.devclass,transportId:m.transportId,pages:(r.pages||[]).map(function(p){return{id:p.id,title:p.title};})};return o;};S.prototype._storeETag=function(s){this._oEtags[s.id]={modifiedOn:s.modifiedOn,etag:s.__metadata.etag};};S.prototype.abortPendingBackendRequests=function(){if(this._oODataModel.hasPendingRequests()){for(var i=0;i<this._oODataModel.aPendingRequestHandles.length;i++){this._oODataModel.aPendingRequestHandles[i].abort();}}};S.prototype._rejectWithErrorMessage=function(e){var E;if(e.statusCode==="412"){E=this._oResourceBundle.getText("Message.SpaceIsOutdated");}else{try{E=JSON.parse(e.responseText).error.message.value||e.message;}catch(a){E=e.message;}}return Promise.reject(E);};return S;},true);
