// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define([],function(){"use strict";var P=function(d,r,m){this._oODataModel=d;this._oResourceBundle=r;this._oEtags={};this._oMessageModel=m;};P.prototype.getPages=function(){return this._readPages().then(function(p){for(var i=0;i<p.results.length;i++){this._storeETag(p.results[i]);}return p;}.bind(this)).then(this._convertODataToPageList.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.getPage=function(p){return this._readPage(p).then(function(a){this._storeETag(a);return a;}.bind(this)).then(this._convertODataToReferencePage.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.createPage=function(p){var a=this._convertReferencePageToOData(p);return this._createPage(a).then(this._storeETag.bind(this));};P.prototype.updatePage=function(u){var U=this._convertReferencePageToOData(u);U.modifiedOn=this._oEtags[u.content.id].modifiedOn;return this._createPage(U).then(this._storeETag.bind(this)).catch(this._rejectWithErrorMessage.bind(this));};P.prototype.deletePage=function(p,t){return new Promise(function(r,a){this._oODataModel.callFunction("/deletePage",{method:"POST",urlParameters:{pageId:p,transportId:t,modifiedOn:this._oEtags[p].modifiedOn},success:r,error:a});}.bind(this));};P.prototype.copyPage=function(p){return new Promise(function(r,a){this._oODataModel.callFunction("/copyPage",{method:"POST",urlParameters:{targetId:p.content.targetId.toUpperCase(),sourceId:p.content.sourceId,title:p.content.title,description:p.content.description,devclass:p.metadata.devclass,transportId:p.metadata.transportId},success:r,error:a});}.bind(this));};P.prototype.getCatalogs=function(p,r){return!r||r.length===1&&!r[0]?[this._getCatalogsByPage(p)]:this._getCatalogsByRole(r);};P.prototype._readPages=function(){return new Promise(function(r,a){this._oODataModel.read("/pageSet",{success:r,error:a});}.bind(this));};P.prototype._readPage=function(p){return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"sections/tiles"},success:r,error:a});}.bind(this));};P.prototype._createPage=function(n){return new Promise(function(r,a){this._oODataModel.create("/pageSet",n,{success:r,error:a});}.bind(this));};P.prototype._convertODataToPageList=function(p){return p.results.map(function(o){return{content:{id:o.id,title:o.title,description:o.description,createdBy:o.createdBy,createdByFullname:o.createdByFullname,createdOn:o.createdOn,modifiedBy:o.modifiedBy,modifiedByFullname:o.modifiedByFullname,modifiedOn:o.modifiedOn,masterLanguage:o.masterLanguage,editAllowed:this.checkErrorMessage(o.id)},metadata:{devclass:o.devclass,transportId:o.transportId}};}.bind(this));};P.prototype._convertODataToReferencePage=function(p){return{content:{id:p.id,title:p.title,description:p.description,createdBy:p.createdBy,createdByFullname:p.createdByFullname,createdOn:p.createdOn,modifiedBy:p.modifiedBy,modifiedByFullname:p.modifiedByFullname,modifiedOn:p.modifiedOn,masterLanguage:p.masterLanguage,editAllowed:this.checkErrorMessage(p.id),sections:p.sections.results.map(function(s){return{id:s.id,title:s.title,visualizations:s.tiles.results.map(function(t){return{id:t.id,vizId:t.catalogTile,inboundPermanentKey:t.targetMapping,title:t.title,subTitle:t.subTitle,iconUrl:t.iconUrl,tileType:t.tileType};})};})},metadata:{transportId:p.transportId,devclass:p.devclass}};};P.prototype._convertReferencePageToOData=function(p){var r=p.content,m=p.metadata;var o={id:r.id,title:r.title,description:r.description,devclass:m.devclass,transportId:m.transportId,sections:(r.sections||[]).map(function(s){return{id:s.id,title:s.title,tiles:(s.visualizations||[]).map(function(t){return{id:t.id,catalogTile:t.vizId,targetMapping:t.inboundPermanentKey};})};})};return o;};P.prototype._storeETag=function(p){this._oEtags[p.id]={modifiedOn:p.modifiedOn,etag:p.__metadata.etag};};P.prototype.abortPendingBackendRequests=function(){if(this._oODataModel.hasPendingRequests()){for(var i=0;i<this._oODataModel.aPendingRequestHandles.length;i++){this._oODataModel.aPendingRequestHandles[i].abort();}}};P.prototype._rejectWithErrorMessage=function(e){var E,s={};if(e.statusCode==="412"){E=this._oResourceBundle.getText("Message.OverwriteChanges");}else if(e.statusCode==="400"){E=this._oResourceBundle.getText("Message.OverwriteRemovedPage");}else{try{E=JSON.parse(e.responseText).error.message.value||e.message;}catch(a){E=e.message;}}s.message=E;s.statusCode=e.statusCode;s.statusText=e.statusText;return Promise.reject(s);};P.prototype.checkErrorMessage=function(p){function f(a,q){return a.filter(function(o){return o.target.toLowerCase().indexOf(q.toLowerCase())!==-1;});}var m=this._oMessageModel.getData();return!(f(m,"/pageSet('"+p+"')").length>0);};P.prototype._getCatalogsByRole=function(r){var p=[];r.forEach(function(R){p.push(new Promise(function(a,b){this._oODataModel.read("/roleSet('"+encodeURIComponent(R)+"')",{urlParameters:{"$expand":"catalogs/visualizations"},success:function(o){a(o.catalogs.results);},error:b});}.bind(this)));}.bind(this));return p;};P.prototype._getCatalogsByPage=function(p){return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"roles/catalogs/visualizations"},success:function(o){var R=o.roles.results;var c=R.reduce(function(b,d){return b.concat(d.catalogs.results);},[]);r(c);},error:a});}.bind(this));};P.prototype.getRoles=function(p){return new Promise(function(r,a){this._oODataModel.read("/pageSet('"+encodeURIComponent(p)+"')",{urlParameters:{"$expand":"roles/catalogs/visualizations"},success:function(o){var R=o.roles.results;r(R);},error:a});}.bind(this));};return P;},true);
