// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ushell/Config"],function(C,F,J,a,b){"use strict";var r={};var _;function c(t){var T=Object.assign(Object.create(null),t);if(T.subTitle){T.subtitle=T.subTitle;delete T.subTitle;}if(T.iconUrl){T.icon=T.iconUrl;delete T.iconUrl;}if(T.tileType!=="STATIC"&&T.tileType!=="DYNAMIC"&&!T.info){T.info="["+r.i18n.getText("Title.CustomTile")+"]";}return T;}function d(v){var o=v.getBindingContext(),i=o.getProperty(o.getPath()).inboundPermanentKey,t=v.getTarget();return i||!t||t[0]!=="#";}function e(){var A;var R;var f=new a({path:"vizId",caseSensitive:true,test:function(v){return!A||A.indexOf(v)>=0;}});var p=_&&_.getContent()[0];if(p){R=p.getModel("roles");if(R){A=R.getProperty("/availableVisualizations");}p.getSections().forEach(function(s){s.getBinding("visualizations").filter(f);});}}var P=C.extend("sap.ushell.applications.PageComposer.controller.PagePreviewDialog.controller",{load:function(p){return _?Promise.resolve(_):F.load({id:p,name:"sap.ushell.applications.PageComposer.view.PagePreviewDialog",controller:this});},open:function(s,p){this.load(p).then(function(D){_=D;r.i18n=s.getModel("i18n").getResourceBundle();s.addDependent(D);D.setModel(new J({sizeBehavior:b.last("/core/home/sizeBehavior")}),"viewSettings");e();D.open();});},close:function(){if(_){_.close();}},visualizationFactory:function(i,B){if(!this.oVisualizationLoadingService){this.oVisualizationLoadingService=sap.ushell.Container.getService("VisualizationLoading");}var t=B.getProperty(),v=this.oVisualizationLoadingService.instantiateVisualization({vizId:t.vizId,previewMode:true,localLoad:true,tileType:(t.tileType==="DYNAMIC"?"sap.ushell.ui.tile.DynamicTile":"sap.ushell.ui.tile.StaticTile"),properties:c(t)});v._getInnerControlPromise().then(function(){var I=v.getInnerControl().getContent?v.getInnerControl().getContent()[0]:v.getInnerControl();I.attachPress(function(E){v.fireEvent("press");});I.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");I.setScope("Display");if(v.getState()!=="Loading"&&!d(v)&&I.setState){I.setState("Failed");}});return v;}});return new P();});
