// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/Button","sap/m/List","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ushell/services/Container"],function(m,B,L,S,R,J,F,c,d){"use strict";var e=m.ButtonType;var P=m.PlacementType;var f=m.ListMode;var g=m.ListSeparators;return function(){var p,t,T,A,o,s,h,j,k,r={};this.init=function(C){p=C.getView();t=p.byId("tileSelectorList");T=p.byId("tileSelectorToolbar");A=p.byId("tileSelectorAddButton");r.i18n=C.getResourceBundle();t.setBusy(true);s=new L({mode:f.MultiSelect,showSeparators:g.None,includeItemInSelection:true,selectionChange:function(){h.getBeginButton().setEnabled(!!s.getSelectedItem());},items:{path:"/page/content/sections",template:new S({title:"{title}"})},noDataText:r.i18n.getText("Message.NoSections")}).setModel(p.getModel());A.setEnabled(false);t.attachSelectionChange(this._onSelectionChange);};this.initTiles=function(C){if(C.aTreeOverride){_(C.aTreeOverride);return;}var D=C.catalogTiles.reduce(function(E,G,i){if(G.length){E.push({catalogTitle:C.catalogTitles[i],tiles:G.map(function(a){return C.catalogTilesData[a.vizId];}).sort(function(a,b){if(a.title>b.title){return 1;}if(a.title<b.title){return-1;}return 0;})});}return E;},[]);_(D);};this.setRoleContext=function(a,b){var M=p.getModel("roles");var i=b?"("+r.i18n.getText("Message.AllRolesSelected")+")":"("+a.length.toString()+")";M.setProperty("/activeRoleContext",a);M.setProperty("/activeRoleContextInfo",i);M.setProperty("/showRoleContextInfo",!b);};this.onSearchTiles=function(){l();};this.onAddTiles=function(E){var a=s.getItems(),b=E.getSource().getBindingContext();if(b){var i=b.getPath();o=t.getItems().filter(function(C){return(C.getBindingContextPath()===i);})[0];}else{o=undefined;}if(a.length===1){a[0].setSelected(true);z();}else{w(E);}};this.onSortCatalogsToggle=function(){n();};this.onCollapseAllCatalogs=function(){q(true);};this.onExpandAllCatalogs=function(){q(false);};this.onCatalogItemPress=function(E){u(E.getParameters().listItem);};this._onSelectionChange=function(E){if(h&&h.isOpen()){h.getBeginButton().setEnabled(false);h.close();}if(E){E.getParameters().listItems.forEach(function(i){if(i.getBindingContext().getProperty().tiles){i.setSelected(false);u(i);}});}A.setEnabled(!!v().length);};this.setAddTileHandler=function(a){j=a;};this.onDragStart=function(E){var i=E.getParameter("target").getBindingContext().getProperty();if(!i.vizId){E.preventDefault();return;}E.getParameter("dragSession").setComplexData("callback",function callback(a,b){j(i,[b],a);});};function _(C){A.setEnabled(false);var M=new J({catalogs:C});M.setSizeLimit(Infinity);t.setModel(M);k=true;n();t.expandToLevel(1);t.setBusy(false);}function l(){var a=p.getModel().getProperty("/searchText")||"";t.getBinding("items").filter([new F([new F("title",c.Contains,a),new F("subTitle",c.Contains,a)],false)]);}function n(){k=!k;var i=t.getBinding("items"),a=new d("catalogTitle",k);i.sort(a);}function q(C){if(C){t.collapseAll();}else{t.expandToLevel(1);}}function u(a){var i=t.indexOfItem(a);if(a.getExpanded()){t.collapse(i);}else{t.expand(i);}}function v(){return t.getSelectedContextPaths().map(function(a){return t.getModel().getContext(a).getProperty();});}function w(E){if(!h||h.bIsDestroyed){y();}s.removeSelections(true);h.getBeginButton().setEnabled(false);h.getEndButton().setEnabled(true);if(!o&&x(A)){h.openBy(T.getAggregation("_overflowButton"));}else{h.openBy(E.getSource());}}function x(C){return(C.hasStyleClass("sapMOTAPButtonNoIcon")||C.hasStyleClass("sapMOTAPButtonWithIcon"));}function y(){h=new R({placement:P.Auto,title:r.i18n.getText("Tooltip.AddToSections"),beginButton:new B({type:e.Emphasized,text:r.i18n.getText("Button.Add"),press:function(){this.setEnabled(false);h.close();z();}}),endButton:new B({text:r.i18n.getText("Button.Cancel"),press:function(){this.setEnabled(false);h.close();}}),content:s,initialFocus:s});p.addDependent(h);}var z=function(){if(typeof j!=="function"){return;}var a=s.getSelectedItems().map(function(i){return s.indexOfItem(i);});var b;if(o){b=[o.getBindingContext().getProperty()];}else{b=v();}b.forEach(function(i){j(i,a);});if(!o){t.removeSelections(true);this._onSelectionChange();}else if(o.getSelected()){o.setSelected(false);this._onSelectionChange();}}.bind(this);};});
