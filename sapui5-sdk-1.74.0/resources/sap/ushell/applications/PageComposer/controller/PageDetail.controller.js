// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","./Page","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/base/Log","sap/base/strings/formatMessage"],function(B,P,J,M,L,f){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.PageDetail",{onInit:function(){var r=this.getRouter();r.getRoute("view").attachPatternMatched(this._onPageMatched,this);this.setModel(new J({page:{},editMode:false,transportSupported:this.getOwnerComponent().isTransportSupported()}));this.getView().addEventDelegate({onBeforeHide:this.onRouteLeave.bind(this)});this.Page.init(this);},onExit:function(){this.Page.exit();},Page:P,formatMessage:f,_onPageMatched:function(e){var a=e.getParameter("arguments");var p=a.pageId;var r=this.getOwnerComponent().getRole();this.getModel().setProperty("/page",{});this.getView().setBusy(true);L.info("The page with id "+p+" was opened in view mode scoped by the following role",r);this._loadPage(decodeURIComponent(p)).then(function(o){this.getModel().setProperty("/page",o);this.Page.init(this);}.bind(this)).catch(function(){this.navigateToErrorPage(p);}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));},_loadPage:function(p){return Promise.all([sap.ushell.Container.getServiceAsync("VisualizationLoading"),this.getPageRepository().getPage(p)]).then(function(a){this.oVisualizationLoadingService=a[0];this.oVisualizationLoadingService.loadVisualizationData().then(function(){this.getModel().updateBindings(true);}.bind(this));return a[1];}.bind(this));},_navigateToEdit:function(p){this.getRouter().navTo("edit",{pageId:encodeURIComponent(p)});},_deletePage:function(e){var d=e.getSource().getParent();var t=e.metadata&&e.metadata.transportId||"";var p=this.getModel().getProperty("/page/content/id");var s=this.getResourceBundle().getText("Message.SuccessDeletePage");return this.getPageRepository().deletePage(p,t).then(function(){this.navigateToPageOverview();M.show(s,{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this));},onEdit:function(){this._navigateToEdit(this.getModel().getProperty("/page/content/id"));},onDelete:function(){var p=this.getModel().getProperty("/page");this.checkShowDeleteDialog(p,this._deletePage.bind(this));},onCopy:function(){var p=this.getModel().getProperty("/page");this.showCopyDialog(p,function(a){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(b){return b.createReferencePage(a,[]);}).then(function(r){return this.getPageRepository().copyPage(r);}.bind(this)).then(function(){this._navigateToEdit(a.content.targetId);M.show(this.getResourceBundle().getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},onErrorMessageClicked:function(){var p=this.getModel().getProperty("/page");var F=this.onfilterErrorMessages(p.content.id);this.showMessageBoxWarning(F[0].message,false);}});});
