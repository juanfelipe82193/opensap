// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/MessagePopover","sap/m/MessageItem","./BaseController","./Page","./TileSelector","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/library","sap/m/MessageToast","sap/base/Log","./ConfirmChangesDialog.controller"],function(M,a,B,P,T,F,J,b,c,d,L,C){"use strict";function _(f){f.setData({page:{},edit:false,dirtyPage:false,errors:[],warnings:[],messages:[],headerExpanded:true,catalogsExpanded:true});}var m=new J();var e=B.extend("sap.ushell.applications.PageComposer.controller.PageDetailEdit",{_setDirtyFlag:function(v){sap.ushell.Container.setDirtyFlag(v);m.setProperty("/dirtyPage",v);},onInit:function(){var l=this.getView().byId("layoutContent"),t=this.getView().byId("toggleCatalogsButton"),r=this.getRouter();r.getRoute("edit").attachPatternMatched(this._onPageMatched,this);this.initModel();this.Page.init(this);this.TileSelector.init(this);this.TileSelector.setAddTileHandler(this.addVisualisationToSection.bind(this));this.getView().addEventDelegate({onBeforeHide:this.onRouteLeave.bind(this)});l.attachBreakpointChanged(function(E){t.setVisible(E.getParameters().currentBreakpoint!=="S");});},initModel:function(){m.setProperty=this.setModelProperty.bind(this);this.setModel(m);},setModelProperty:function(p,v,f){var r=f?f.getPath():p;if(r.indexOf("/page")===0&&!jQuery.isEmptyObject(m.getProperty("/page"))){this._setDirtyFlag(true);}J.prototype.setProperty.apply(m,arguments);},onExit:function(){this.Page.exit();},Page:P,TileSelector:new T(),oTileInfoPopover:undefined,oMessagePopover:new M("layoutMessagePopover",{items:{path:"/messages",template:new a({type:"{type}",title:"{title}",activeTitle:"{active}",description:"{description}",subtitle:"{subTitle}",counter:"{counter}"})},beforeOpen:function(){this.addStyleClass("sapUshellMessagePopoverNoResize");}}).setModel(m),handleMessagePopoverPress:function(E){this.oMessagePopover.toggle(E.getSource());},onUpdateSideContentVisibility:function(){m.setProperty("/catalogsExpanded",!m.getProperty("/catalogsExpanded"));},onTitleChange:function(E){var i=E.getSource();i.setValueStateText(this.getResourceBundle().getText("Message.EmptyTitle"));if(!i.getValue()){i.setValueState(c.ValueState.Error);}else{i.setValueState(c.ValueState.None);}},onSave:function(){var r=this.getResourceBundle();var s=function(g){if(g===b.Action.OK){this._setDirtyFlag(false);this.getView().setBusy(true);this._savePage(m.getProperty("/page")).then(function(){d.show(r.getText("Message.SavedChanges"),{closeOnBrowserNavigation:false});}).catch(function(S){if(S.statusCode==="412"||S.statusCode==="400"){this._showConfirmChangesDialog(S);}else{this.showMessageBoxError(S.message,false);}this._setDirtyFlag(true);}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));}}.bind(this);if(!m.getProperty("/page/content/title")){this.showMessageBoxError(r.getText("Message.EmptyTitle"));m.setProperty("/headerExpanded",true);return;}if(!window.navigator.onLine){this.showMessageBoxError(r.getText("Message.NoInternetConnection"));return;}if(m.getProperty("/errors").length>0){var t=r.getText("Title.TilesHaveErrors"),f=r.getText("Message.TilesHaveErrors");sap.ushell.Container.getService("Message").confirm(f,s,t);return;}s(b.Action.OK);},_showConfirmChangesDialog:function(s){if(!this.byId("confirmChangesDialog")){F.load({name:"sap.ushell.applications.PageComposer.view.ConfirmChangesDialog",controller:new C(this.getView(),this.getResourceBundle())}).then(function(D){if(s.statusCode==="412"){var o=sap.ui.getCore().byId("confirmChangesModifiedByText");o.setVisible(true);}this.getModel().setProperty("/simpleError",{message:s.message,statusCode:s.statusCode,modifiedBy:this.getModel().getProperty("/page").content.modifiedByFullname});this.getView().addDependent(D);D.open();}.bind(this));}else{this.byId("confirmChangesDialog").open();}},onCancel:function(){this.navigateToPageOverview();},onOpenTileInfo:function(E){var o=E.getSource(),f=o.getBindingContext();this._openTileInfo(o,f);},showContextSelector:function(o){return new Promise(function(r,f){sap.ui.require(["sap/ushell/applications/PageComposer/controller/ContextSelector.controller"],function(g){var p=this.getModel().getProperty("/page/content/id");this.fetchRoles(p).then(function(h){if(!this.oContextSelectorController){this.oContextSelectorController=new g(this.getRootView(),this.getResourceBundle());}this.oContextSelectorController.initRoles(h,this.getModel("roles").getData().activeRoleContext);this.oContextSelectorController.attachConfirm(o);return this.oContextSelectorController.load().then(function(){return this.oContextSelectorController;}.bind(this)).then(function(i){if(i){i.open();}r();}).catch(function(i){this.oContextSelectorController.destroy();this.handleBackendError(i);f(i);}.bind(this));}.bind(this)).catch(function(E){this.showMessageBoxError(E,false);}.bind(this));}.bind(this));}.bind(this));},onOpenContextSelector:function(){this.showContextSelector(function(s){this._resetRolesModel(s);this.TileSelector.setRoleContext(s.selected,s.allSelected);var p=this.getModel().getProperty("/page/content/id");this.fetchCatalogInfo(p,s.selected).then(this.TileSelector.initTiles).catch(function(E){this.showMessageBoxError(E,true);});this.getModel("roles").setProperty("availableVisualizations",s.availableVisualizations);this.collectPageMessages();}.bind(this));},_resetRolesModel:function(s){if(s){this.setModel(new J(s),"roles");}else{this.setModel(new J({}),"roles");}this.getModel("roles").setProperty("/activeRoleContextInfo","("+this.getResourceBundle().getText("Message.AllRolesSelected")+")");},_openTileInfo:function(o,f,s){if(!this.oTileInfoPopover){F.load({name:"sap.ushell.applications.PageComposer.view.TileInfoPopover",controller:this}).then(function(t){this.oTileInfoPopover=t;this.getView().addDependent(this.oTileInfoPopover);this._openTileInfo(o,f,s);}.bind(this));}else{this.oTileInfoPopover.setModel(f.getModel(s));this.oTileInfoPopover.setBindingContext(f);this.oTileInfoPopover.openBy(o);}},_formatTileType:function(v){var i=this.getResourceBundle();switch(v){case"STATIC":return i.getText("Title.StaticTile");case"DYNAMIC":return i.getText("Title.DynamicTile");case"CUSTOM":default:return i.getText("Title.CustomTile");}},_formatLength:function(o){return(o?o.length:undefined);},_updatePageWithMetadata:function(f){if(f&&f.metadata&&f.metadata.transportId){m.setProperty("/page/metadata/transportId",f.metadata.transportId);}},_onPageMatched:function(f){var A=f.getParameter("arguments");var p=decodeURIComponent(A.pageId);var r=this.getOwnerComponent().getRole();this.getView().setBusy(true);L.info("The page with id "+p+" was opened in edit mode in the context of the following role",r);_(m);this._resetRolesModel();this._loadPage(p).then(function(o){this._pageEditAllowed(o).then(function(g){if(!g){return;}m.setProperty("/page",o);m.setProperty("/edit",true);this.checkShowEditDialog(o,this._updatePageWithMetadata.bind(this),this.navigateToPageOverview.bind(this));this.Page.init(this);if(!m.getProperty("/page/content/sections").length){this.Page.addSection();}else{this.collectPageMessages();this._setDirtyFlag(false);}}.bind(this));}.bind(this)).catch(function(){this.navigateToErrorPage(p);}.bind(this)).finally(function(){this.getView().setBusy(false);}.bind(this));this.fetchCatalogInfo(p,[r]).then(this.TileSelector.initTiles).catch(function(E){this.showMessageBoxError(E,true);}.bind(this));},_pageEditAllowed:function(p){var E=!this.checkMasterLanguageMismatch(p)&&!this._checkPageHasErrors(p);return Promise.resolve(E);},_loadPage:function(p){return Promise.all([sap.ushell.Container.getServiceAsync("VisualizationLoading"),this.getPageRepository().getPage(p)]).then(function(f){this.oVisualizationLoadingService=f[0];this.oVisualizationLoadingService.loadVisualizationData().then(function(){m.updateBindings(true);this.collectPageMessages();}.bind(this));return f[1];}.bind(this));},_savePage:function(p){return this.getPageRepository().updatePage(p);},collectPageMessages:function(){var o=this.Page.collectMessages(),E=o.errors,w=o.warnings,f=E.concat(w);m.setProperty("/errors",E);m.setProperty("/warnings",w);m.setProperty("/messages",f);},addSectionAt:function(s){var S=this.getModel().getProperty("/page/content/sections");if(!S){L.warning("The Model is not ready yet.");return;}if(!s&&s!==0){s=S.length;}S.splice(s,0,{title:"",visualizations:[]});this.getModel().setProperty("/page/content/sections",S);},deleteSection:function(s){if(!s&&s!==0){return;}var S=m.getProperty("/page/content/sections");S.splice(s,1);m.setProperty("/page/content/sections",S);this.collectPageMessages();},moveSection:function(o,n){if(!o&&o!==0||!n&&n!==0){return;}var s=m.getProperty("/page/content/sections"),S=s.splice(o,1)[0];s.splice(n,0,S);m.setProperty("/page/content/sections",s);this.collectPageMessages();},addVisualisationToSection:function(v,s,f){if(!v||!s.length){return;}s.forEach(function(S){var V=m.getProperty("/page/content/sections/"+S+"/visualizations");if(!V){L.warning("The Model is not ready yet.");return;}if(!f&&f!==0){f=V.length;}V.splice(f,0,v);m.setProperty("/page/content/sections/"+S+"/visualizations",V);this.collectPageMessages();}.bind(this));},deleteVisualizationInSection:function(v,s){var p="/page/content/sections/"+s+"/visualizations",V=m.getProperty(p);V.splice(v,1);m.setProperty(p,V);this.collectPageMessages();},moveVisualizationInSection:function(o,n,f,g){if(!o&&o!==0||!n&&n!==0||!f&&f!==0||!g&&g!==0){return;}var O="/page/content/sections/"+f+"/visualizations",N="/page/content/sections/"+g+"/visualizations",h=m.getProperty(O),i=m.getProperty(N),j=h.splice(o,1);i.splice(n,0,j[0]);m.setProperty(O,h);m.setProperty(N,i);this.collectPageMessages();},openEditPageHeaderDialog:function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditPageHeaderDialog.controller"],function(E){if(!this.oEditPageHeaderDialogController){this.oEditPageHeaderDialogController=new E(this.getRootView());}this.oEditPageHeaderDialogController.attachConfirm(this.editPageHeaderConfirm.bind(this));this.oEditPageHeaderDialogController.load().then(function(){this.oEditPageHeaderDialogController.open();this.oEditPageHeaderDialogController.getModel().setProperty("/id",m.getProperty("/page/content/id"));this.oEditPageHeaderDialogController.getModel().setProperty("/title",m.getProperty("/page/content/title"));this.oEditPageHeaderDialogController.getModel().setProperty("/description",m.getProperty("/page/content/description"));this.oEditPageHeaderDialogController.initialTitleValidation();}.bind(this));}.bind(this));},editPageHeaderConfirm:function(r){if(m.getProperty("/page/content/title")!==r.title){m.setProperty("/page/content/title",r.title);}if(m.getProperty("/page/content/description")!==r.description){m.setProperty("/page/content/description",r.description||"");}},_checkPageHasErrors:function(p){var f=this.onfilterErrorMessages(p.content.id);if(f.length){this.showMessageBoxWarning(f[0].message,true);return true;}return false;}});return e;});
