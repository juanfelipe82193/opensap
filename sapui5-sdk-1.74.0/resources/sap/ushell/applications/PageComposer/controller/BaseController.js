// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/UIComponent","../util/Transport","sap/m/MessageBox","sap/base/Log"],function(C,U,T,M,L){"use strict";return C.extend("sap.ushell.applications.PageComposer.controller.BaseController",{getPageRepository:function(){return this.getOwnerComponent().getPageRepository();},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getRootView:function(){return this.getOwnerComponent().getRootControl();},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getTransportHelper:function(){if(!this.oTransportHelper){this.oTransportHelper=new T();}return this.oTransportHelper;},_createEditDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditDialog.controller"],function(E){if(!this.oEditPageDialogController){this.oEditPageDialogController=new E(this.getRootView(),this.getResourceBundle());}this.oEditPageDialogController.attachCancel(a);this.oEditPageDialogController.attachConfirm(o);this.oEditPageDialogController.load().then(function(){r(this.oEditPageDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CreatePageDialog.controller"],function(c){if(!this.oCreatePageDialogController){this.oCreatePageDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCreatePageDialogController.attachConfirm(o);this.oCreatePageDialogController.attachCancel(a);this.oCreatePageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCreatePageDialogController,t,o);}.bind(this));}return this.oCreatePageDialogController;}.bind(this)).then(function(e){if(e){e.open();}r();}).catch(function(e){this.oCreatePageDialogController.destroy();this.handleBackendError(e);b();}.bind(this));}.bind(this));}.bind(this));},_createDeleteDialog:function(o,a){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/DeleteDialog.controller"],function(D){if(!this.oDeletePageDialogController){this.oDeletePageDialogController=new D(this.getRootView(),this.getResourceBundle());}this.oDeletePageDialogController.attachCancel(a);this.oDeletePageDialogController.attachConfirm(o);this.oDeletePageDialogController.load().then(function(){r(this.oDeletePageDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(p,o,a){var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return Promise.resolve();}return this.getOwnerComponent().createTransportComponent(p.metadata.devclass).then(function(t){return Promise.all([t.showTransport(p),t.showLockedMessage(p)]).then(function(r){var s=r[0];var l=r[1];if(l){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LockedText",[l.foreignOwner]),true);}else if(s){this._createEditDialog(o,a).then(function(d){d.getModel().setProperty("/message",this.getResourceBundle().getText("EditDialog.TransportRequired"));var E=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);E.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},checkShowDeleteDialog:function(p,o,a){var r=this.getResourceBundle();var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));d.open();});}return this.getOwnerComponent().createTransportComponent(p.metadata.devclass).then(function(t){return Promise.all([t.showTransport(p),t.showLockedMessage(p)]).then(function(R){var s=R[0];var l=R[1];if(l){this.showMessageBoxError(r.getText("DeleteDialog.LockedText",[l.foreignOwner]),true);}else{this._createDeleteDialog(o,a).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));if(s){d.getModel().setProperty("/message",r.getText("DeleteDialog.TransportRequired"));d=this.getTransportHelper().enhanceDialogWithTransport(d,t,o);}d.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},showCopyDialog:function(p,o,a){return new Promise(function(r,b){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CopyPageDialog.controller"],function(c){if(!this.oCopyPageDialogController){this.oCopyPageDialogController=new c(this.getRootView(),this.getResourceBundle());}this.oCopyPageDialogController.attachConfirm(o);this.oCopyPageDialogController.attachCancel(a);return this.oCopyPageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCopyPageDialogController,t,o);}.bind(this));}return this.oCopyPageDialogController;}.bind(this)).then(function(e){if(e){e.open();e.getModel().setProperty("/sourceId",p.content.id);e.getModel().setProperty("/sourceTitle",p.content.title);}r();}).catch(function(e){this.oCopyPageDialogController.destroy();this.handleBackendError(e);b(e);}.bind(this));}.bind(this));}.bind(this));},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:function(){this.navigateToPageOverview();}.bind(this)});}else{M.error(e);}},showMessageBoxWarning:function(w,n){if(n){M.warning(w,{onClose:function(){this.navigateToPageOverview();}.bind(this)});}else{M.warning(w);}},navigateToPageOverview:function(){this.getRouter().navTo("overview");},navigateToErrorPage:function(p){this.getRouter().navTo("error",{pageId:encodeURIComponent(p)},null,true);},preview:function(e){var s=e.getSource();var p=this.getRootView().getId();sap.ui.require(["sap/ushell/applications/PageComposer/controller/PagePreviewDialog.controller"],function(P){P.open(s,p);});},checkMasterLanguageMismatch:function(p){var c=this.getOwnerComponent().getMetadata().getConfig().checkLanguageMismatch;var u=sap.ui.getCore().getConfiguration().getSAPLogonLanguage().toUpperCase();var P=p.content.masterLanguage.toUpperCase();if(c&&u!==P){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LanguageMismatch",[P,u]),true);return true;}return false;},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else{L.error(e);}},onRouteLeave:function(){this.getPageRepository().abortPendingBackendRequests();},fetchCatalogInfo:function(p,r){return Promise.all(this.getPageRepository().getCatalogs(p,r)).then(function(c){var a=[],v=[],V={},b=[],d=[],o={},e={};c.forEach(function(f){a.push.apply(a,f);});for(var j=0;j<a.length;j++){o=a[j];v=o.visualizations.results||[];d.push(v);b.push(o.title);for(var i=0;i<v.length;i++){e=v[i];delete e.__metadata;V[v[i].vizId]=v[i];}}return{catalogTiles:d,catalogTitles:b,catalogTilesData:V};}).catch(function(e){this.handleBackendError(e);return{catalogTiles:[],catalogTitles:[],catalogTilesData:{}};}.bind(this));},fetchRoles:function(p){return this.getPageRepository().getRoles(p).then(function(r){return r||[];}).catch(function(e){this.handleBackendError(e);return[];}.bind(this));},onfilterErrorMessages:function(p){function f(a,q){return a.filter(function(o){return o.target.toLowerCase().indexOf(q.toLowerCase())!==-1;});}var m=this.getModel("message").getData();var e=f(m,"/pageSet('"+p+"')");return e;}});});
