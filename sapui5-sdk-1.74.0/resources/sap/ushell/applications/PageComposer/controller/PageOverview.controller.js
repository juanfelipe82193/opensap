// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["./BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(B,M,J,F,a){"use strict";return B.extend("sap.ushell.applications.PageComposer.controller.Main",{aPropertiesToFilter:["id","title","description","createdByFullname","modifiedByFullname","BusinessRoleId","BusinessRole"],oDialogFactory:null,onInit:function(){this.setModel(new J({busy:false,pages:[],transportSupported:this.getOwnerComponent().isTransportSupported()}));this.getRouter().getRoute("overview").attachPatternMatched(this._onPageOverviewMatched,this);this.setModel(this._createInitialButtonStateModel(),"buttonStates");},onItemPress:function(e){var p=e.getParameter("listItem").getBindingContext().getObject();this._navigateToDetail(p.content.id);},_onPageOverviewMatched:function(){this._refreshModel();},_navigateToEdit:function(p){this.getRouter().navTo("edit",{pageId:encodeURIComponent(p)});},_navigateToDetail:function(p){this.getRouter().navTo("view",{pageId:encodeURIComponent(p)});},onSelectionChange:function(e){this._setDeleteAndCopyButtonEnabled(true);},onEdit:function(e){var p=e.getSource().getBindingContext().getObject();this._navigateToEdit(p.content.id);},onAdd:function(){var r=this.getResourceBundle();this.showCreateDialog(function(p){sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(p,[]);}).then(function(R){return this.getPageRepository().createPage(R);}.bind(this)).then(function(){this._navigateToDetail(p.content.id);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},_deletePage:function(e){var r=this.getResourceBundle();var d=e.getSource().getParent();var t=e.metadata&&e.metadata.transportId||"";var T=this.byId("table");var i=T.getSelectedItems().map(function(b){return b.getBindingContext().getObject();});var s=r.getText("Message.SuccessDeletePage");var D=i.map(function(I){return this.getPageRepository().deletePage(I.content.id,t);}.bind(this));return Promise.all(D).then(function(){return this._refreshModel();}.bind(this)).then(function(){T.removeSelections();this._setDeleteAndCopyButtonEnabled(false);T.fireSelectionChange();M.show(s,{closeOnBrowserNavigation:false});d.close();}.bind(this)).catch(this.handleBackendError.bind(this));},onDelete:function(){var t=this.byId("table");var s=t.getSelectedItem();if(!s){return;}this.checkShowDeleteDialog(s.getBindingContext().getObject(),this._deletePage.bind(this));},onCopy:function(){var t=this.byId("table");var s=t.getSelectedItem();var r=this.getResourceBundle();if(!s){return;}var p=s.getBindingContext().getObject();this.showCopyDialog(p,function(b){this.pageInfo=b;sap.ushell.Container.getServiceAsync("PageReferencing").then(function(P){return P.createReferencePage(b,[]);}).then(function(R){return this.getPageRepository().copyPage(R);}.bind(this)).then(function(){return this._refreshModel();}.bind(this)).then(function(){this._navigateToDetail(this.pageInfo.content.targetId);M.show(r.getText("Message.PageCreated"),{closeOnBrowserNavigation:false});}.bind(this)).catch(this.handleBackendError.bind(this));}.bind(this));},onSearch:function(e){var t=this.byId("table");var b=t.getBinding("items");var r=this.getResourceBundle();var s=e.getSource().getValue();var f=this.aPropertiesToFilter.map(function(p){return new F({path:"content/"+p,operator:a.Contains,value1:s});});this.oSearchFilter=new F({filters:f,and:false});this._applyCombinedFilters();if(b.getLength()===0){if(s){t.setNoDataText(r.getText("Message.NoPagesFound"));}else{t.setNoDataText(r.getText("Message.NoPages"));}}},_refreshModel:function(){this.getModel().setProperty("/busy",true);return this._loadAvailablePages().then(function(p){this.getModel().setSizeLimit(p.pages.length);this.getModel().setProperty("/pages",p.pages);this.getModel().setProperty("/busy",false);}.bind(this),function(e){this.getModel().setProperty("/busy",false);this.showMessageBoxError(e);}.bind(this));},onTableUpdate:function(){var t=this.byId("table");if(t.getSelectedItems().length===0){t.removeSelections(true);this._setDeleteAndCopyButtonEnabled(false);}},_loadAvailablePages:function(){return this.getPageRepository().getPages().then(function(p){return{pages:p};});},_createInitialButtonStateModel:function(){return new J({isDeleteAndCopyEnabled:false});},_setDeleteAndCopyButtonEnabled:function(e){this.getView().getModel("buttonStates").setProperty("/isDeleteAndCopyEnabled",e);},onErrorMessageClicked:function(e){var s=e.getSource().getBindingContext().getObject();var f=this.onfilterErrorMessages(s.content.id);if(f.length){this.showMessageBoxWarning("Page "+s.content.id+" : "+f[0].message,false);}},_removeDuplicates:function(p,P,m){var k={},K=[];p.forEach(function(o){var O=m?o.metadata:o.content,n=O[P];if(!k[n]){k[n]=true;K.push({key:n});}});return K;},showViewSettingsDialog:function(n){if(this._oViewSettingsDialog){this._oViewSettingsDialog.open(n);return;}sap.ui.require(["sap/ui/core/Fragment","sap/ui/Device","sap/ushell/applications/PageComposer/controller/ViewSettingsDialog.controller"],function(b,D,V){b.load({name:"sap.ushell.applications.PageComposer.view.ViewSettingsDialog",type:"XML",controller:new V(this)}).then(function(f){this._oViewSettingsDialog=f;if(D.system.desktop){f.addStyleClass("sapUiSizeCompact");}var p=this.getModel().getProperty("/pages");f.setModel(new J({editAllowed:this._removeDuplicates(p,"editAllowed"),devclass:this._removeDuplicates(p,"devclass",true),transportId:this._removeDuplicates(p,"transportId",true),createdByFullname:this._removeDuplicates(p,"createdByFullname"),modifiedByFullname:this._removeDuplicates(p,"modifiedByFullname")}),"uniqueValues");this.getView().addDependent(f);f.open(n);}.bind(this));}.bind(this));},_applyCombinedFilters:function(){var f=this.aViewSettingsFilters||[],t=this.byId("table"),b=t.getBinding("items");if(this.oSearchFilter){f=f.concat(this.oSearchFilter);}b.filter(new F({filters:f,and:true}));}});});
