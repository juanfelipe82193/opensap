// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/utils/clone"],function(m,J,C,c){"use strict";var L=m.LoadState;var M,p,r={};var v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")});var _=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function a(V){var P=V.getBindingContext().getPath().split("/"),i=P.pop();P.pop();return{visualizationIndex:i,sectionIndex:P.pop()};}function b(V){var o=V.getBindingContext(),i=o.getProperty(o.getPath()).inboundPermanentKey,t=V.getTarget();return i||!t||t[0]!=="#";}function d(t){var T=c(t);if(T.subTitle){T.subtitle=T.subTitle;delete T.subTitle;}if(T.iconUrl){T.icon=T.iconUrl;delete T.iconUrl;}if(T.tileType!=="STATIC"&&T.tileType!=="DYNAMIC"&&!T.info){T.info="["+r.i18n.getText("Title.CustomTile")+"]";}return T;}function e(f){var R=M.getModel("roles");var A=R&&R.getData().availableVisualizations;return!A||A.indexOf(f.getVisualizationId())>-1;}return{init:function(o){M=o;p=o.getView().byId("page");p.setModel(o.getModel());p.setModel(v,"viewSettings");r.i18n=o.getResourceBundle();var E=o.getModel().getProperty("/edit");p.toggleStyleClass("sapUshellPageComposing",!!E);},exit:function(){_.off();},visualizationFactory:function(i,B){if(!M.oVisualizationLoadingService){throw new Error("Visualization Service was not loaded yet!");}var t=B.getProperty(),V=M.oVisualizationLoadingService.instantiateVisualization({vizId:t.vizId,previewMode:true,localLoad:true,tileType:(t.tileType==="DYNAMIC"?"sap.ushell.ui.tile.DynamicTile":"sap.ushell.ui.tile.StaticTile"),properties:d(t)}),G={Press:"Press",Remove:"Remove"};V._getInnerControlPromise().then(function(){var I=V.getInnerControl().getContent?V.getInnerControl().getContent()[0]:V.getInnerControl();I.attachPress(function(E){switch(E.getParameter("action")){case G.Remove:var o=a(V);M.deleteVisualizationInSection(o.visualizationIndex,o.sectionIndex);break;case G.Press:default:V.fireEvent("press");break;}});I.bindProperty("sizeBehavior","viewSettings>/sizeBehavior");I.setScope(M.getModel().getProperty("/edit")?"Actions":"Display");if(V.getState()!==L.Loading&&!b(V)&&I.setState){I.setState(L.Failed);}});V.attachPress(function(E){var o=E.getSource(),B=o.getBindingContext();if(p.getProperty("edit")){M._openTileInfo(o,B);}});return V;},collectMessages:function(){var E=[],w=[];p.getSections().forEach(function(s,S){var o=s.byId("title-edit");if(s.getTitle()===""){o.setValueState("Warning");o.setValueStateText(r.i18n.getText("Message.InvalidSectionTitle"));w.push({type:"Warning",title:r.i18n.getText("Title.NoSectionTitle",S+1),description:r.i18n.getText("Message.NoSectionTitle",S+1)});}else{o.setValueState("None");}s.getVisualizations().forEach(function(V,i){if(V.getState()===L.Failed){E.push({type:"Error",title:r.i18n.getText("Title.UnsufficientRoles"),subtitle:r.i18n.getText("Title.VisualizationIsNotVisible"),description:r.i18n.getText("Message.LoadTileError",[(i+1)+".",s.getTitle()])});}else if(V.getState()!==L.Loading&&!b(V)){w.push({type:"Warning",title:r.i18n.getText("Message.NavigationTargetError"),subtitle:r.i18n.getText("Title.VisualizationNotNavigateable"),description:r.i18n.getText("Message.NavTargetResolutionError",V.getTitle()||V.getCatalogTile().getTitle())});}else if(!e(V)){w.push({type:"Warning",title:r.i18n.getText("Message.VisualizationNotAvailableInContext"),subtitle:r.i18n.getText("Message.VisualizationNotAvailableInContext"),description:r.i18n.getText("Message.VisualizationOutOfContextError",V.getTitle()||V.getCatalogTile().getTitle())});}});});return{errors:E,warnings:w};},addSection:function(E){var s=E?E.getParameter("index"):0;M.addSectionAt(s);},deleteSection:function(E){var s=E.getSource(),t=s.getTitle(),f=t?r.i18n.getText("Message.Section.Delete",t):r.i18n.getText("Message.Section.DeleteNoTitle");sap.ui.require(["sap/m/MessageBox"],function(g){function h(A){if(A===g.Action.DELETE){M.deleteSection(p.indexOfSection(s));}}sap.ushell.Container.getService("Message").confirm(f,h,r.i18n.getText("Button.Delete"),[g.Action.DELETE,g.Action.CANCEL]);});},moveSection:function(i){var D=i.getParameter("draggedControl"),o=i.getParameter("droppedControl"),I=i.getParameter("dropPosition"),f=p.indexOfSection(D),g=p.indexOfSection(o);if(I==="After"){if(g<f){g++;}}else if(g>f){g--;}M.moveSection(f,g);},moveVisualization:function(D){var o=D.getParameter("draggedControl"),f=D.getParameter("droppedControl"),i=D.getParameter("dropPosition");if(f.isA("sap.ushell.ui.launchpad.Section")){var g=a(o),s=p.indexOfSection(f),B=o.getBindingContext();M.addVisualisationToSection(B.getModel().getProperty(B.getPath()),[s],0);M.deleteVisualizationInSection(g.visualizationIndex,g.sectionIndex);return;}var h=a(f),j=h.visualizationIndex,k=h.sectionIndex;if(o.isA("sap.m.CustomTreeItem")){var l=D.getParameter("dragSession").getComplexData("callback");if(i==="After"){j++;}l(j,k);return;}var n=a(o),q=n.visualizationIndex,t=n.sectionIndex;if(t===k){if(i==="After"){if(j<q){j++;}}else if(j>q){j--;}}else if(i==="After"){j++;}M.moveVisualizationInSection(q,j,t,k);},addVisualization:function(D){var o=D.getParameter("draggedControl"),f=D.getParameter("droppedControl"),i=f.getVisualizations().length,g=p.indexOfSection(f);if(o.isA("sap.m.CustomTreeItem")){D.getParameter("dragSession").getComplexData("callback")(i,g);return;}var h=a(o),j=h.visualizationIndex,k=h.sectionIndex;M.moveVisualizationInSection(j,i,k,g);}};});
