// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/Bar","sap/m/Text","sap/m/List","sap/ushell/resources","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/ui/launchpad/ActionItem","sap/m/DisplayListItem","sap/ui/layout/VerticalLayout","sap/m/ObjectIdentifier","sap/ushell/EventHub","sap/ushell/Config","sap/ui/model/json/JSONModel","sap/ushell/ui/utils","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/Device","sap/ui/core/IconPool","./UserPreferencesButtonRenderer"],function(B,D,a,T,L,r,A,b,c,V,O,E,C,J,u,q,d,f,I){"use strict";var U=b.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"}});U.prototype.init=function(){if(b.prototype.init){b.prototype.init.apply(this,arguments);}this.setIcon("sap-icon://person-placeholder");this.translationBundle=r.i18n;this.setText(this.translationBundle.getText("userSettings"));this.setTooltip(this.translationBundle.getText("settings_tooltip"));this.attachPress(this.showUserPreferencesDialog);this.oModel=C.createModel("/core/shell/model/userPreferences",J);this.setModel(this.oModel);};U.prototype.createDialog=function(){var t=this;this.saveButton=this._createSaveButton();this.cancelButton=this._createCancelButton();this.oDialog=new D({id:"userPreferencesDialog",title:"{/dialogTitle}",contentWidth:"29.6rem",content:null,contentHeight:"17rem",buttons:[this.saveButton,this.cancelButton],afterClose:function(){this._destroyDialog();this.oUser.resetChangedProperties();}.bind(t),stretch:f.system.phone}).addStyleClass("sapUshellUserPreferencesDialog");this._addDialogBackButton();this.oDialog.setModel(this.getModel());this.oDialog.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_Dialog_Main_label"),writeToDom:true}));this.oDialog.addContent(this._getOriginalDialogContent());};U.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var o,e;o=this._getUserDetailsControl();e=this._getEntryListControl();this.oInitialContent=new V("userPreferencesLayout",{content:[o,e],width:"100%"});}return this.oInitialContent;};U.prototype._getEntryListControl=function(){var e=this._getUserPrefEntriesTemplate(),x=this.getModel()&&this.getModel().getProperty("/enableHelp"),t=this,i,s=this.oUser.getFullName(),o,g=new L("userPrefEnteryList",{items:{path:"/entries",template:e}});g.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_EntryList_label")+s,writeToDom:true}));o=g.onAfterRendering;g.onAfterRendering=function(){var h=this.getItems(),j;o.apply(this,arguments);for(i=0;i<h.length;i++){j=h[i].getBindingContext().getPath();if(!t.getModel().getProperty(j+"/valueResult")){t._setEntryValueResult(j);}if(x){t._addXRayHelpId(j,h[i]);}}};return g;};U.prototype._addXRayHelpId=function(e,l){var h=this.getModel().getProperty(e+"/entryHelpID");if(h){l.addStyleClass("help-id-"+h);}};U.prototype._setEntryValueResult=function(e){var t=this,i=this.getModel().getProperty(e+"/editable"),v=this.getModel().getProperty(e+"/valueArgument");if(typeof v==="function"){this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("genericLoading"));this.getModel().setProperty(e+"/editable",false);var o=v();o.done(function(g){t.getModel().setProperty(e+"/editable",i);t.getModel().setProperty(e+"/visible",typeof(g)==="object"?!!g.value:true);t.getModel().setProperty(e+"/valueResult",typeof(g)==="object"?g.displayText:g);});o.fail(function(){t.getModel().setProperty(e+"/valueResult",t.translationBundle.getText("loadingErrorMessage"));});}else if(v){this.getModel().setProperty(e+"/valueResult",v);this.getModel().setProperty(e+"/editable",i);}else{this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("loadingErrorMessage"));}};U.prototype._emitEntryOpened=function(e){var o=E.last("UserSettingsOpened")||{},p=e.split("/").pop();o[p]=true;E.emit("UserSettingsOpened",o);};U.prototype._getUserPrefEntriesTemplate=function(){var t=this,i,p=function(e){var o={};o=q.extend(true,{},{},e);sap.ui.require(["sap/m/FlexBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BusyIndicator"],function(F,g,h,j){var k=true,l,s,m=o.getSource().getLabel(),n=o.getSource().getBindingContext().getPath();t.getModel().setProperty("/activeEntryPath",n);t._setDetailedEntryModeMode(true,n,m,n);t.oDialog.removeAllContent();s=t.getModel().getProperty(n+"/contentResult");if(s){l=sap.ui.getCore().byId(s);t.oDialog.addContent(l);t._emitEntryOpened(n);}else{var v=null,w,S=true,x=false,y=t.getModel().getProperty(n+"/contentFunc");if(typeof y==="function"){t._emitEntryOpened(n);w=y();w.done(function(z){S=false;if(x===true){t.oDialog.removeAllContent();v.destroy();}if(z instanceof sap.ui.core.Control){t.getModel().setProperty(n+"/contentResult",z.getId());t.oDialog.addContent(z);}else{k=false;}});w.fail(function(){S=false;if(x===true){t.oDialog.removeAllContent();v.destroy();}k=false;});w.always(function(){if(k===false){var z=new F("userPrefErrorFlexBox",{height:"5rem",alignItems:g.Center,justifyContent:h.Center,items:[new T("userPrefErrorText",{text:t.translationBundle.getText("loadingErrorMessage")})]});t.getModel().setProperty(n+"/contentResult",z.getId());t.oDialog.addContent(z);}});if(S===true){v=new j("userPrefLoadingBusyIndicator",{size:"2rem"});t.oDialog.addContent(v);x=true;}}}});};i=new c({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(v){return typeof(v)==="string"?v:"";}},type:{path:"editable",formatter:function(e){return(e===true)?"Navigation":"Inactive";}},visible:{path:"visible",formatter:function(v){return(v!==undefined)?v:true;}},press:p,customData:new A({key:"aria-label",value:{parts:[{path:"title"},{path:"valueResult"}],formatter:function(s,v){v=v||"";return s+" "+v;}},writeToDom:true})});return i;};U.prototype._getUserDetailsControl=function(){return new O({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier");};U.prototype._createCancelButton=function(){var t=this;return new B({id:"cancelButton",text:{parts:["/entries"],formatter:function(e){if(!e){return"";}var g=e.some(function(o){return o.editable;});return g>0?t.translationBundle.getText("cancelBtn"):t.translationBundle.getText("close");}},press:t._dialogCancelButtonHandler.bind(t),visible:true});};U.prototype._createSaveButton=function(){var t=this;return new B({id:"saveButton",text:this.translationBundle.getText("saveBtn"),press:t._dialogSaveButtonHandler.bind(t),visible:{parts:["/entries"],formatter:function(e){if(!e){return false;}return e.some(function(o){return o.editable;});}}});};U.prototype._setDetailedEntryModeMode=function(i,e,g,h){this.getModel().setProperty("/isDetailedEntryMode",!!i);this.getModel().setProperty("/dialogTitle",g);};U.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open();};U.prototype._dialogBackButtonHandler=function(){var t=this;t.getModel().setProperty("/isDetailedEntryMode",false);t.getModel().setProperty("/dialogTitle",t.translationBundle.getText("userSettings"));t.oDialog.removeAllContent();t.oDialog.addContent(t._getOriginalDialogContent());t._setEntryValueResult(t.getModel().getProperty("/activeEntryPath"));t.getModel().setProperty("/activeEntryPath",null);};U.prototype._destroyDialog=function(){this.oHeadBar.destroy();this.oInitialContent.destroy();this.oInitialContent=null;this._modelCleanUpToInitial();this._entriesCleanUp();this.oDialog.destroy();this.saveButton.destroy();this.cancelButton.destroy();};U.prototype._entriesCleanUp=function(){var i,e=this.getModel().getProperty("/entries"),s,o;for(i=0;i<e.length;i++){s=e[i].contentResult;delete e[i].contentResult;if(s){o=sap.ui.getCore().byId(s);o.destroy();o=null;}e[i].valueResult=null;}this.getModel().setProperty("/entries",e);};U.prototype._modelCleanUpToInitial=function(){this.getModel().setProperty("/isDetailedEntryMode",false);this.getModel().setProperty("/dialogTitle",this.translationBundle.getText("userSettings"));};U.prototype._dialogSaveButtonHandler=function(){var t=this,i,e=this.getModel().getProperty("/entries"),s=u.saveUserPreferenceEntries(e);i=this.getModel().getProperty("/isDetailedEntryMode");if(i){this.getModel().setProperty("/activeEntryPath",null);}s.done(function(){t._showSaveMessageToast();});s.fail(function(g){sap.ui.require(["sap/m/MessageBox"],function(M){var h,j="";if(g.length===1){h=t.translationBundle.getText("savingEntryError")+" ";}else{h=t.translationBundle.getText("savingEntriesError")+"\n";}g.forEach(function(k){h+=k.entry+"\n";j+="Entry: "+k.entry+" - Error message: "+k.message+"\n";});M.show(h,{icon:M.Icon.ERROR,title:t.translationBundle.getText("Error"),actions:[M.Action.OK]});d.error("Failed to save the following entries",j,"sap.ushell.ui.footerbar.UserPreferencesButton");});});this.oDialog.close();this._destroyDialog();};U.prototype._dialogCancelButtonHandler=function(){var i,e=this.getModel().getProperty("/entries");for(i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}this.oDialog.close();this._destroyDialog();};U.prototype._addDialogBackButton=function(){var t=this,o=new B("userPrefBackBtn",{visible:"{/isDetailedEntryMode}",icon:I.getIconURI("nav-back"),press:t._dialogBackButtonHandler.bind(t),tooltip:this.translationBundle.getText("feedbackGoBackBtn_tooltip")}),e=new T("userPrefTitle",{text:"{/dialogTitle}"});this.oHeadBar=new a({contentLeft:[o],contentMiddle:[e]});this.oDialog.setCustomHeader(this.oHeadBar);};U.prototype._showSaveMessageToast=function(){var t=this;sap.ui.require(["sap/m/MessageToast"],function(M){var m=t.translationBundle.getText("savedChanges");M.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});});};return U;});
