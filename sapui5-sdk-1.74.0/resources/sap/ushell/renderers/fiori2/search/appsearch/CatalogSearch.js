// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/renderers/fiori2/search/appsearch/JsSearchFactory','sap/base/Log'],function(c,L){"use strict";var C=function(){this.init.apply(this,arguments);};C.prototype={init:function(p){this.launchPageService=sap.ushell.Container.getService("LaunchPage");this.optimizedAppSearch=p.optimizedAppSearch;this.searchEngines={};},prefetch:function(){return this._getTiles();},search:function(q){q.scope=q.scope||'allTiles';return this._getSearchEngine(q.scope).then(function(s){var a;try{a=s.search({searchFor:q.searchTerm,top:q.top,skip:q.skip});}catch(e){var b=new jQuery.Deferred();b.reject(e);return b;}var r=[];for(var i=0;i<a.results.length;++i){var d=a.results[i];var t=d.object;var h=d.highlighted.label;r.push(this._formatTile(t,h));}return{totalCount:a.totalCount,tiles:r};}.bind(this));},_getView:function(t){try{var a=t.tile.getContract('types');a.setType('tile');}catch(e){}var v=sap.ushell.Container.getService('LaunchPage').getCatalogTileView(t.tile);var b='app';if(t.tile.getTitle){b=t.tile.getTitle();}v.eventLoggingData={targetUrl:t.url,title:b};return v;},_getTiles:function(){var t=this;if(this.loadDeferred){return this.loadDeferred;}this.loadDeferred=this.launchPageService.getCatalogs().then(function(a){var b=[];for(var i=0;i<a.length;i++){b.push(this.launchPageService.getCatalogTiles(a[i]));}b.push(this._getPersonalizedGroupTiles());return jQuery.when.apply(jQuery,b).then(function(){var d=Array.prototype.slice.call(arguments);var a=d.slice(0,-1);var p=d.slice(-1);var f,g,h;try{h=[];return t._collectTilesOfCatalogs(a).then(function(r){f=[];for(var i=0;i<r.length;i++){f=f.concat(r[i]);}t._sortTiles(f);h.push.apply(h,f);h=t._removeDuplicateTiles(h);return t._collectTilesOfCatalogs(p);}).then(function(r){g=[];for(var j=0;j<r.length;j++){g=g.concat(r[j]);}t._sortTiles(g);h.push.apply(h,g);h=t._removeDuplicateTiles(h);t._sortTiles(h);return{catalogTiles:f,personalizedTiles:g,allTiles:h};});}catch(e){return jQuery.Deferred().reject(e);}});}.bind(this));return this.loadDeferred;},_getSearchEngine:function(s){return this._getTiles().then(function(t){var a=this.searchEngines[s];if(a){return a;}a=c.createJsSearch({objects:t[s],fields:['label','keywords']});this.searchEngines[s]=a;return a;}.bind(this));},_formatTile:function(t,h){var a=this;var r=jQuery.extend({},t);if(h){r.label=h;}r.type="catalog";r.getView=function(){return a._getView(this);};return r;},_isTileViewNeeded:function(t){if(this.optimizedAppSearch){return false;}return!this.launchPageService.getCatalogTilePreviewTitle(t);},_collectTilesOfCatalogs:function(a){var p=[];for(var i=0;i<a.length;i++){p.push(this._collectTilesOfCatalog(a[i]));}return jQuery.when.apply(null,p).then(function(){var t=[];for(var i=0;i<arguments.length;i++){if(arguments[i].length!==0){t.push(arguments[i]);}}return t;},function(e){});},_collectTilesOfCatalog:function(a){var p=[];for(var i=0;i<a.length;i++){p.push(this._getTileAsync(a[i]));}return jQuery.when.apply(null,p).then(function(){var t=[];for(var i=0;i<arguments.length;i++){if(arguments[i]!==null){t.push(arguments[i]);}}return t;},function(e){});},_getTileAsync:function(t){var p=new jQuery.Deferred();var a,b,k,d,s,f,i;try{a=null;if(this._isTileViewNeeded(t)){a=this.launchPageService.getCatalogTileView(t);}k=this.launchPageService.getCatalogTileKeywords(t);d=this.launchPageService.getCatalogTileTargetURL(t);b=this.launchPageService.getCatalogTilePreviewTitle(t)||this.launchPageService.getCatalogTileTitle(t);s=this.launchPageService.getCatalogTilePreviewSubtitle(t);f=this.launchPageService.getCatalogTileSize(t);i=this.launchPageService.getCatalogTilePreviewIcon(t)||"sap-icon://business-objects-experience";if(a){if(!a.destroy){var g=new Error('The tileview "'+b+'" with target url "'+d+'" does not implement mandatory function destroy!');g.name='Missing Impementation';throw g;}a.destroy();}if(t.getContract){var h=t.getContract("preview");if(h){h.setEnabled(false);}}if(!this._isValid(t)){p.resolve(null);}if(!d){p.resolve(null);}var l=b;if(s){l+=' - '+s;}p.resolve({tile:t,keywords:(k instanceof Array)?k.join(' '):k,url:d,label:l,title:b||'',subtitle:s||'',tooltip:b||'',icon:i,size:f});}catch(e){p.resolve(null);L.error(e);if(e.toString().indexOf('does not implement mandatory function destroy')>=0){throw e;}}return p;},_isValid:function(t){if(this.launchPageService.isTileIntentSupported){return this.launchPageService.isTileIntentSupported(t);}return true;},_getPersonalizedGroupTiles:function(){return this.launchPageService.getGroups().then(function(g){var r=[];for(var j=0;j<g.length;j++){var t=this.launchPageService.getGroupTiles(g[j])||[];r.push.apply(r,t);}return r;}.bind(this));},_calcKey:function(t){return t.title+'$$'+t.subtitle+'$$'+t.url+'$$'+t.icon;},_removeDuplicateTiles:function(t){var a={};var r=[];for(var i=0;i<t.length;++i){var b=t[i];var k=this._calcKey(b);if(a[k]){continue;}a[k]=b;r.push(b);}return r;},_sortTiles:function(t){t.sort(function(a,b){if(a.title.toUpperCase()<b.title.toUpperCase()){return-1;}if(a.title.toUpperCase()>b.title.toUpperCase()){return 1;}return 0;});}};return C;});
