// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/ui/launchpad/ShortcutsHelpContainer","sap/ui/thirdparty/jquery","sap/m/Label","sap/m/Text","sap/m/Dialog","sap/m/Button"],function(D,C,E,r,S,q,L,T,a,B){"use strict";var A=function(){};A.prototype={bFocusOnShell:true,bFocusPassedToExternalHandlerFirstTime:true,isFocusHandledByAnotherHandler:false,fnExternalKeysHandler:null,sLastExternalKeysHandlerUrl:null,fnExternalShortcuts:null,isleftAltPressed:false,bForwardNavigation:true,aShortcutsDescriptions:[],appOpenedHandler:function(){var c=hasher.getHash();if(c!==this.sLastExternalKeysHandlerUrl){this.fnExternalKeysHandler=null;}this.sLastExternalKeysHandlerUrl=c;},_focusItemInOverflowPopover:function(i,c){var o=sap.ui.getCore().byId("headEndItemsOverflow");if(o&&o.isOpen()){if(o.getContent().length){this._focusIteminPopover(i,o.getContent()[0].getItems());}}else if(c<10){var O=window.document.getElementById("endItemsOverflowBtn");if(O){O.click();var t=this;window.setTimeout(function(){t._focusItemInOverflowPopover(i,++c);},300);}}},_focusItemInUserMenu:function(i,c){var u=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(u&&u.isOpen()){if(u.getContent().length){this._focusIteminPopover(i,u.getContent()[0].getItems());}}else if(c<10){var t=this;E.emit("showMeArea",Date.now());window.setTimeout(function(){t._focusItemInUserMenu(i,++c);},300);}},_focusIteminPopover:function(I,c){for(var i=0;i<c.length;i++){var d=c[i].getId().split("-");if(d[d.length-1]===I){c[i].getDomRef().focus();return;}}},_handleAccessOverviewKey:function(c){var s=this.oModel.getProperty("/searchAvailable"),p=this.oModel.getProperty("/personalization"),e=C.last("/core/shell/model/enableNotifications");if(D.browser.msie){document.addEventListener("help",this._cancelHelpEvent);}var d=[];d=d.concat(this.aShortcutsDescriptions);var f,g;if(D.os.macintosh){f=r.i18n.getText("OptionKey");g=r.i18n.getText("CommandKey");}else{f=r.i18n.getText("AltKey");g=r.i18n.getText("ControlKey");}if(window.document.getElementById("shell-header")){if(p&&c){d.push({text:f+" + A",description:r.i18n.getText("hotkeyFocusOnAppFinderButton")});}if(s){d.push({text:f+" + F",description:r.i18n.getText("hotkeyFocusOnSearchButton")});}d.push({text:f+" + H",description:r.i18n.getText("hotkeyHomePage")});d.push({text:f+" + M",description:r.i18n.getText("hotkeyFocusOnUserActionMenu")});if(e){d.push({text:f+" + N",description:r.i18n.getText("hotkeyFocusOnNotifications")});}if(c){d.push({text:f+" + S",description:r.i18n.getText("hotkeyFocusOnSettingsButton")});d.push({text:r.i18n.getText("ControlKey")+" + "+r.i18n.getText("CommaKey"),description:r.i18n.getText("hotkeyOpenSettings")});}if(p){d.push({text:r.i18n.getText("ControlKey")+" + "+r.i18n.getText("EnterKey"),description:r.i18n.getText("hotkeySaveEditing")});}if(s){d.push({text:g+" + "+r.i18n.getText("ShiftKey")+" + F",description:r.i18n.getText("hotkeyFocusOnSearchField")});}}var o=new S();d.forEach(function(v){o.addContent(new L({text:v.description}));o.addContent(new T({text:v.text}));});var h=new a({id:"hotKeysGlossary",title:r.i18n.getText("hotKeysGlossary"),contentWidth:"29.6rem",content:o,afterClose:function(){h.destroy();}});h.setBeginButton(new B({text:r.i18n.getText("okBtn"),press:function(){h.close();}}));h.open();},_focusAppFinderButton:function(){var o=window.document.getElementById("openCatalogBtn");if(o){o.focus();return;}var c=sap.ushell.Container.getRenderer("fiori2").getShellConfig();if(c.moveAppFinderActionToShellHeader){this._focusItemInOverflowPopover("openCatalogBtn",0);return;}this._focusItemInUserMenu("openCatalogBtn",0);},_focusSettingsButton:function(){var s=window.document.getElementById("userSettingsBtn");if(s){s.focus();return;}var c=sap.ushell.Container.getRenderer("fiori2").getShellConfig();if(c.moveUserSettingsActionToShellHeader){this._focusItemInOverflowPopover("userSettingsBtn",0);return;}this._focusItemInUserMenu("userSettingsBtn",0);},_blockBrowserDefault:function(e){return new Promise(function(c){if(D.browser.name==="ie"){var s=window.document.getElementById("shell-header");if(s){s.setAttribute("accesskey",e.key);window.setTimeout(function(){s=window.document.getElementById("shell-header");if(s){s.removeAttribute("accesskey");c();}},0);}}else{c();}e.preventDefault();});},_handleAltShortcutKeys:function(e,c){var s=sap.ui.getCore().byId("shell-header"),u=sap.ui.getCore().byId("sapUshellMeAreaPopover"),n=sap.ui.getCore().byId("shellNotificationsPopover");if(s){if(c){if(e.keyCode===65){this._blockBrowserDefault(e).then(this._focusAppFinderButton.bind(this));}else if(e.keyCode===83){this._blockBrowserDefault(e).then(this._focusSettingsButton.bind(this));}}if(e.keyCode===70){this._blockBrowserDefault(e).then(function(){var o=window.document.getElementById("sf"),d=window.document.getElementById("searchFieldInShell-button");if(o){o.focus();}else if(d){d.focus();}else{this._focusItemInOverflowPopover("sf",0);}}.bind(this));}else if(e.keyCode===72){this._blockBrowserDefault(e).then(function(){window.hasher.setHash(s.getHomeUri());if(u&&u.isOpen()){E.emit("showMeArea",false);}if(n&&n.isOpen()){E.emit("showNotifications",false);}var o=window.document.getElementById("shellAppTitle");if(o){o.focus();}});}else if(e.keyCode===77){this._blockBrowserDefault(e).then(function(){if(!(u&&u.isOpen())){E.emit("showMeArea",Date.now());}});}else if(e.keyCode===78){this._blockBrowserDefault(e).then(function(){if(!(n&&n.isOpen())){E.emit("showNotifications",Date.now());}});}}},_handleCtrlShortcutKeys:function(e,c){if(e.shiftKey){if(e.keyCode===70){var s=sap.ui.getCore().byId("sf");if(s){s.firePress();e.preventDefault();e.stopPropagation();}}}else if(e.keyCode===188&&c){var o=sap.ui.getCore().byId("userSettingsBtn");if(o&&!q(window.document.activeElement).parents(".sapUiCompSmartTable, .sapUiMdcTable").length){o.firePress();e.preventDefault();e.stopPropagation();}}else if(e.keyCode===112){this._handleAccessOverviewKey(c);}else if(e.keyCode===83){var d=window.document.getElementById("appFinderSearch-I");if(d){d.focus();e.preventDefault();e.stopPropagation();}}else if(e.keyCode===13){var f=sap.ui.getCore().byId("sapUshellDashboardFooterDoneBtn");if(f&&f.getDomRef()){f.firePress();e.preventDefault();e.stopPropagation();}}},handleShortcuts:function(e,c){if(D.os.macintosh&&e.metaKey&&e.shiftKey&&e.keyCode===70){var s=window.document.getElementById("sf");if(s){s.firePress();e.preventDefault();e.stopPropagation();}e.preventDefault();}else if(e.altKey&&!e.shiftKey&&!e.ctrlKey){this._handleAltShortcutKeys(e,c);}else if(e.ctrlKey&&!e.altKey){this._handleCtrlShortcutKeys(e,c);}},registerAppKeysHandler:function(h){this.fnExternalKeysHandler=h;this.sLastExternalKeysHandlerUrl=hasher.getHash();},resetAppKeysHandler:function(){this.fnExternalKeysHandler=null;},getAppKeysHandler:function(){return this.fnExternalKeysHandler;},registerAppShortcuts:function(h,s){this.fnExternalShortcuts=h;this.aShortcutsDescriptions=s;},_handleFocusBackToMe:function(e,i){this.bFocusOnShell=true;var f;if(i){f=window.document.getElementById(i);}else{this.fromOutside=true;if(e){e.preventDefault();this.bForwardNavigation=!e.shiftKey||e.key==="F6";}f=window.document.getElementById("sapUshellHeaderAccessibilityHelper");}if(f){f.focus();this.fromOutside=false;}this.bFocusPassedToExternalHandlerFirstTime=true;},setIsFocusHandledByAnotherHandler:function(h){this.isFocusHandledByAnotherHandler=h;},sendFocusBackToShell:function(p){var e,i;if(typeof p==="string"){i=p;}else if(typeof p==="object"){e=p;}this._handleFocusBackToMe(e,i);},_handleEventUsingExternalKeysHandler:function(e){if(!this.bFocusOnShell&&!this.isFocusHandledByAnotherHandler){if(this.fnExternalKeysHandler&&q.isFunction(this.fnExternalKeysHandler)){this.fnExternalKeysHandler(e,this.bFocusPassedToExternalHandlerFirstTime);this.bFocusPassedToExternalHandlerFirstTime=false;}}this.setIsFocusHandledByAnotherHandler(false);},_cancelHelpEvent:function(e){e.preventDefault();document.removeEventListener("help",this._cancelHelpEvent);},init:function(m){this.oModel=m;document.addEventListener("keydown",function(e){if(e.keyCode===16){return;}for(var o=window.document.activeElement;o!==window.document.body;o=o.parentElement){if(o.classList.contains("sapMDialog")){return;}}this.bForwardNavigation=!e.shiftKey;if(e.key==="Tab"||e.key==="F6"){setTimeout(function(){this._handleEventUsingExternalKeysHandler(e);}.bind(this),0);}else{this._handleEventUsingExternalKeysHandler(e);}if(e.keyCode===18){if(e.location===window.KeyboardEvent.DOM_KEY_LOCATION_LEFT){this.isleftAltPressed=true;}else{this.isleftAltPressed=false;}}if(this.isleftAltPressed||!e.altKey){var c=C.last("/core/shell/model/currentState/stateName");if(c!=="headerless"&&c!=="headerless-home"){var d=(c==="home"||c==="app"||c==="minimal");this.handleShortcuts(e,d);}if(this.fnExternalShortcuts){this.fnExternalShortcuts(e);}}}.bind(this),true);this._cancelHelpEvent=this._cancelHelpEvent.bind(this);}};var b=new A();E.on("AppRendered").do(A.prototype.appOpenedHandler.bind(b));return b;},true);
