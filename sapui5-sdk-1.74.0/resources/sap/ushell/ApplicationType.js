// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/utils","sap/ushell/URLTemplateProcessor","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/systemAlias","sap/ushell/_ApplicationType/wdaResolution","sap/ushell/_ApplicationType/guiResolution","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/Config"],function(U,u,a,A,s,w,g,p,C){"use strict";function b(n,B,E){var I=n.inbound;var r=I&&I.resolutionResult;if(!(!I||!r||!(r["sap.wda"]))){return w.constructFullWDAResolutionResult(n,B,E);}if(!(!I||!r)){return w.constructWDAResolutionResult(n,B,E);}}function c(n,B,E){var q=new U(B),I=n.inbound,r=I&&I.resolutionResult,t=jQuery.extend(true,{},n.mappedIntentParamsPlusSimpleDefaults),S,v;if(t["sap-system"]){S=t["sap-system"][0];delete t["sap-system"];}if(t["sap-system-src"]){v=t["sap-system-src"][0];delete t["sap-system-src"];}return new Promise(function(R,x){s.spliceSapSystemIntoURI(q,r.systemAlias,S,v,"WCF",r.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).done(function(y){var P=A.getURLParsing().paramsToString(t),F=A.appendParametersToUrl(P,y.toString());var z={url:F,text:r.text||"",additionalInformation:r.additionalInformation||"",applicationType:"WCF",fullWidth:true};R(z);}).fail(function(y){x(y);});});}function d(n,B,E){var I=n.inbound,q,S,r,t,R={};["applicationType","additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){R[P]=I.resolutionResult[P];}});R.url=B;if(R.applicationDependencies&&typeof R.url==="undefined"){R.url="";}if(typeof R.url==="undefined"){return Promise.reject("Cannot resolve intent: url was not specified in matched inbound");}t=jQuery.extend(true,{},n.mappedIntentParamsPlusSimpleDefaults);R.reservedParameters={};var v={"sap-ui-fl-max-layer":true,"sap-ui-fl-control-variant-id":true};Object.keys(v).forEach(function(N){var V=t[N];if(V){delete t[N];R.reservedParameters[N]=V;}});n.mappedDefaultedParamNames=n.mappedDefaultedParamNames.filter(function(D){return!v[D];});if(n.mappedDefaultedParamNames.length>0){t["sap-ushell-defaultedParameterNames"]=[JSON.stringify(n.mappedDefaultedParamNames)];}S=t["sap-system"]&&t["sap-system"][0];r=t["sap-system-src"]&&t["sap-system-src"][0];R["sap-system"]=S;if(typeof r==="string"){R["sap-system-src"]=r;}n.effectiveParameters=t;q=A.getURLParsing().paramsToString(t);if(q){R.url=R.url+((R.url.indexOf("?")<0)?"?":"&")+q;}if(typeof I.resolutionResult.ui5ComponentName!=="undefined"){R.ui5ComponentName=I.resolutionResult.ui5ComponentName;}R.text=I.title;return Promise.resolve(R);}function e(){var H=new U().fragment();var n=H.lastIndexOf("&/");if(n>0){return H.substr(n+1);}}function f(){var n=sap.ushell.Container.getService("UserInfo");var q=n.getUser();var r=sap.ui.getCore().getConfiguration();var t=u.getUi5Version();var v=q.getContentDensity();var T=q.getTheme();if(T.indexOf("sap_")!==0){var x=sap.ushell.User.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;T=q.getTheme(x);}var L;var y;if(r){y=r.getLanguage&&r.getLanguage();L=r.getSAPLogonLanguage&&r.getSAPLogonLanguage();}var z=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";return{language:y,logonLanguage:L,theme:T,themeServiceRoot:z,isDebugMode:!!window["sap-ui-debug"],ui5Version:t,contentDensity:v};}function h(n,B,E){var I=n.inbound;var t=I.templateContext;var r={innerAppRoute:e()||n.parsedIntent.appSpecificRoute,defaultParameterNames:n.mappedDefaultedParamNames,startupParameter:n.mappedIntentParamsPlusSimpleDefaults,env:f()};var q=a.expand(t.payload,t.site,r,t.siteAppSection,"startupParameter");var R={applicationType:"URL",text:I.title,appCapabilities:t.payload.capabilities,url:q};return i(q).then(function(v){R.url=v;return R;},function(){return R;});}function i(n){return new Promise(function(r,R){var q=new U(n);var P=q.query(true);sap.ushell.Container.getService("ShellNavigation").compactParams(P,["sap-language","sap-theme","sap-ui-app-id","transaction"],undefined,true).done(function(t){if(!t.hasOwnProperty("sap-intent-param")){r(n);return;}q.query(t);var v=q.toString();r(v);}).fail(function(E){R(E);});});}function j(n,B,E){var I=n.inbound,q=I&&I.resolutionResult,r={};var t=new U(B);var v=jQuery.extend(true,{},n.mappedIntentParamsPlusSimpleDefaults);if(n.inbound&&n.inbound.action==="launchURL"&&n.inbound.semanticObject==="Shell"){delete v["sap-external-url"];}var S=v["sap-system"]&&v["sap-system"][0];var x=v["sap-system-src"]&&v["sap-system-src"][0];r["sap-system"]=S;delete v["sap-system"];if(typeof x==="string"){r["sap-system-src"]=x;delete v["sap-system-src"];}return(new Promise(function(R,y){if(A.absoluteUrlDefinedByUser(t,q.systemAlias,q.systemAliasSemantics)){R(B);}else{s.spliceSapSystemIntoURI(t,q.systemAlias,S,x,"URL",q.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,E).fail(y).done(function(z){var D=z.toString();R(D);});}})).then(function(y){var P=A.getURLParsing().paramsToString(v);var F=C.last("/core/navigation/flpURLDetectionPattern");var z=new RegExp(F);return z.test(y)?A.appendParametersToIntentURL(v,y):A.appendParametersToUrl(P,y);},Promise.reject.bind(Promise)).then(function(y){["additionalInformation","applicationDependencies"].forEach(function(P){if(I.resolutionResult.hasOwnProperty(P)){r[P]=I.resolutionResult[P];}});r.url=y;r.text=I.title;r.applicationType="URL";return Promise.resolve(r);},Promise.reject.bind(Promise));}var o={URL:{type:"URL",defaultFullWidthSetting:true,generateResolutionResult:function(n){var q=n.inbound.hasOwnProperty("templateContext");return q?h.apply(null,arguments):j.apply(null,arguments);},easyAccessMenu:{intent:"Shell-startURL",resolver:null,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:false,systemSelectionPriority:1}},WDA:{type:"WDA",defaultFullWidthSetting:true,generateResolutionResult:b,easyAccessMenu:{intent:"Shell-startWDA",resolver:w.resolveEasyAccessMenuIntentWDA,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:2}},TR:{type:"TR",defaultFullWidthSetting:true,generateResolutionResult:g.generateTRResolutionResult,easyAccessMenu:{intent:"Shell-startGUI",resolver:g.resolveEasyAccessMenuIntentWebgui,showSystemSelectionInUserMenu:true,showSystemSelectionInSapMenu:true,systemSelectionPriority:3}},NWBC:{type:"NWBC",defaultFullWidthSetting:true},WCF:{type:"WCF",generateResolutionResult:c,defaultFullWidthSetting:true},SAPUI5:{type:"SAPUI5",generateResolutionResult:d,defaultFullWidthSetting:false}};function k(){return Object.keys(o).map(function(n){return o[n];}).filter(function(n){return typeof n.easyAccessMenu==="object";});}function l(){var E={};k().forEach(function(n){E[n.easyAccessMenu.intent]=n.easyAccessMenu.resolver;});return function(n,r){if(E[n]&&(!r||r!=="SAPUI5")){return E[n];}return null;};}function m(n){if(!o[n]){return false;}return o[n].defaultFullWidthSetting;}Object.defineProperty(o,"enum",{value:Object.keys(o).reduce(function(n,q){if(o[q].type){n[q]=o[q].type;}return n;},{})});var M={getEasyAccessMenuResolver:l(),getEasyAccessMenuDefinitions:k,getDefaultFullWidthSetting:m};Object.keys(M).forEach(function(n){Object.defineProperty(o,n,{value:M[n]});});return o;});
