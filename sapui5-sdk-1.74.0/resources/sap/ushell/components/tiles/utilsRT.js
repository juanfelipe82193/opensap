// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/format/NumberFormat","sap/ui/core/library","sap/base/Log"],function(N,c,L){"use strict";var V=c.mvc.ViewType;var u={};u.getConfiguration=function(t,a,E){var r;var C=t.configuration.getParameterValueAsString("tileConfiguration");try{var o=JSON.parse(C||"{}");}catch(e){L.error("Error while trying to parse tile configuration",e,"sap.ushell.components.tiles.utilsRT");return{};}var U=sap.ui.require("sap/ushell/components/tiles/utils");o.editable=true;if(t.configurationUi&&t.configurationUi.isReadOnly){if(t.configurationUi.isReadOnly()){o.editable=false;}}var T=U.getTranslatedTitle(t);var s=U.getTranslatedSubtitle(t,o);var i=U.getTranslatedProperty(t,o,"display_info_text");var k=U.getTranslatedProperty(t,o,"display_search_keywords");if(a){r=U.getResourceBundleModel().getResourceBundle();if(E&&t.bag){var b=t.bag.getOriginalLanguage();var l=sap.ui.getCore().getConfiguration().getLocale().getSAPLogonLanguage();var d=sap.ui.getCore().getConfiguration().getLanguage();o.isLocaleSuitable=b===""||b.toLowerCase()===l.toLowerCase()||b.toLowerCase()===d.toLowerCase();o.orgLocale=b;o.userLocale=l;}}o.display_icon_url=o.display_icon_url||"";if(i!==undefined){o.display_info_text=i;}else if(o.display_info_text===undefined){if(a&&!E){o.display_info_text="["+r.getText("configuration.display_info_text")+"]";}else{o.display_info_text="";}}o.navigation_semantic_object=o.navigation_semantic_object||"";o.navigation_semantic_action=o.navigation_semantic_action||"";o.navigation_semantic_parameters=o.navigation_semantic_parameters||"";o.display_number_unit=o.display_number_unit||"";o.display_number_factor=o.display_number_factor||"";o.service_refresh_interval=o.service_refresh_interval?parseInt(o.service_refresh_interval,10):0;o.service_url=o.service_url||"";o.navigation_target_url=o.navigation_target_url||"";if(a&&U.isInitial(T)){o.display_title_text=E?"":"["+r.getText("configuration.display_title_text")+"]";o.display_subtitle_text=E?"":"["+r.getText("configuration.display_subtitle_text")+"]";}else{o.display_title_text=T||o.display_title_text||"";if(s!==undefined){o.display_subtitle_text=s;}else if(o.display_subtitle_text===undefined){o.display_subtitle_text="";}}o.navigation_use_semantic_object=(o.navigation_use_semantic_object!==false);o.display_search_keywords=k||o.display_search_keywords||"";if(a){o.display_number_value=o.display_number_value||1234;}o.form_factors=o.form_factors?o.form_factors:U.getDefaultFormFactors();o.desktopChecked=o.form_factors.manual.desktop;o.tabletChecked=o.form_factors.manual.tablet;o.phoneChecked=o.form_factors.manual.phone;o.manualFormFactor=!(o.form_factors.appDefault)&&o.editable;o.appFormFactor=o.form_factors.appDefault;o.formFactorConfigDefault=!!o.form_factors.defaultParam;if(o.signature){o.rows=U.getSignatureTableData(o.signature,E&&o.editable);}else{o.rows=(o.mapping_signature&&o.mapping_signature!=="*=*")?U.getMappingSignatureTableData(o.mapping_signature,E&&o.editable):[U.getEmptyRowObj(o.editable)];}if(o.signature){o.isUnknownAllowed=(o.signature.additional_parameters==="allowed"||o.signature.additionalParameters==="allowed");}else{o.isUnknownAllowed=(o.mapping_signature!==undefined)?U.getAllowUnknownParametersValue(o.mapping_signature):true;}if(a){o.tile_actions_rows=U.getTileNavigationActionsRows(t,o.editable);}else if(!o.actions){o.actions=U.getTileNavigationActions(t);}return o;};u.getDataToDisplay=function(C,d){var a=0,i,n,o,s,D={display_icon_url:d.icon||C.display_icon_url||"",display_title_text:d.title||C.display_title_text||"",display_number_value:!isNaN(d.number)?d.number:"...",display_number_unit:d.numberUnit||C.display_number_unit||"",display_info_text:d.info||C.display_info_text||"",display_info_state:d.infoState||"Neutral",display_subtitle_text:d.subtitle||C.display_subtitle_text||"",display_state_arrow:d.stateArrow||"None",display_number_state:d.numberState||"Neutral",display_number_digits:d.numberDigits>=0?d.numberDigits:4,display_number_factor:d.numberFactor||"",display_search_keyword:d.keywords||C.display_search_keyword||"",targetParams:[]};if(d.infoStatus){D.display_info_state=d.infoStatus;}if(d.targetParams){D.targetParams.push(d.targetParams);}if(d.results){for(i=0,n=d.results.length;i<n;i=i+1){o=d.results[i].number||0;if(typeof o==="string"){o=parseFloat(o,10);}a=a+o;s=d.results[i].targetParams;if(s){D.targetParams.push(s);}}D.display_number_value=a;}if(!isNaN(d.number)){if(typeof d.number==="string"){d.number=d.number.trim();}if(d.number===""){D.display_number_value="...";}else{var S=this._shouldProcessDigits(d.number,d.numberDigits),m=D.display_icon_url?4:5;if(d.number&&d.number.length>=m||S){var b=this._normalizeNumber(d.number,m,d.numberFactor,d.numberDigits);D.display_number_factor=b.numberFactor;D.display_number_value=b.displayNumber;}else{var e=N.getFloatInstance({maxFractionDigits:m});D.display_number_value=e.format(d.number);}}}if(D&&D.display_number_state){switch(D.display_number_state){case"Positive":D.display_number_state="Good";break;case"Negative":D.display_number_state="Error";break;}}return D;};u.getTileSettingsAction=function(m,s,t){var a=sap.ui.require("sap/ushell/components/tiles/utils");var r=a.getResourceBundleModel().getResourceBundle();return{text:(!t||t==="tile")?r.getText("tileSettingsBtn"):r.getText("linkSettingsBtn"),press:function(){sap.ui.require(["sap/ui/layout/form/SimpleForm","sap/ui/layout/form/SimpleFormLayout","sap/m/Button","sap/m/Dialog"],function(S,b,B,D){var A={showGroupSelection:false,title:m.getProperty("/config/display_title_text"),subtitle:m.getProperty("/config/display_subtitle_text")};if(!t||t==="tile"){A.info=m.getProperty("/config/display_info_text");A.icon=m.getProperty("/config/display_icon_url");A.keywords=m.getProperty("/config/display_search_keywords");}else if(t==="link"){A.showInfo=false;A.showIcon=false;A.showPreview=false;}var d=sap.ui.view({type:V.JS,viewName:"sap.ushell.ui.footerbar.SaveAsTile",viewData:{appData:A}});var o=new S({id:"tileSettings",layout:b.GridLayout,content:[d]}).addStyleClass("sapUshellAddBookmarkForm");var e=new B("bookmarkOkBtn",{text:r.getText("okBtn"),press:function(){s(d);h.close();},enabled:true}),f=new B("bookmarkCancelBtn",{text:r.getText("cancelBtn"),press:function(){h.close();}});var g=function(i){e.setEnabled(!!i.trim());};d.getTitleInput().attachLiveChange(function(){g(this.getValue());});var h=new D({id:"settingsDialog",title:(!t||t==="tile")?r.getText("tileSettingsDialogTitle"):r.getText("linkSettingsDialogTitle"),contentWidth:"400px",content:o,beginButton:e,endButton:f,horizontalScrolling:false,afterClose:function(){h.destroy();}});h.open();});}};};u.getSemanticNavigationUrl=function(C){var U="#"+jQuery.trim(C.navigation_semantic_object);U+="-"+jQuery.trim(C.navigation_semantic_action);if(C.navigation_semantic_parameters&&jQuery.trim(C.navigation_semantic_parameters).length>0){U+="?"+jQuery.trim(C.navigation_semantic_parameters);}return U;};u.addParamsToUrl=function(U,d){var p="",b=U.indexOf("?")!==-1,t=d.targetParams,i;if(t&&t.length>0){for(i=0;i<t.length;i=i+1){p+=t[i];if(i<t.length-1){p+="&";}}}if(p.length>0){if(!b){U+="?";}else{U+="&";}U+=p;}return U;};u._normalizeNumber=function(n,m,a,i){var b;if(isNaN(n)){b=n;}else{var o=N.getFloatInstance({maxFractionDigits:i});if(!a){var d=Math.abs(n);if(d>=1000000000){a="B";n/=1000000000;}else if(d>=1000000){a="M";n/=1000000;}else if(d>=1000){a="K";n/=1000;}}b=o.format(n);}var e=b;var f=e[m-1];m-=(f==="."||f===",")?1:0;e=e.substring(0,m);return{displayNumber:e,numberFactor:a};};u._shouldProcessDigits=function(d,D){var n;d=typeof(d)!=="string"?d.toString():d;if(d.indexOf(".")!==-1){n=d.split(".")[1].length;if(n>D){return true;}}return false;};return u;},true);
