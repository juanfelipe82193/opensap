// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/applicationIntegration/elements/model","sap/ushell/components/applicationIntegration/Storage","sap/ushell/components/applicationIntegration/application/BlueBoxHandler","sap/ushell/ui5service/ShellUIService","sap/ushell/components/applicationIntegration/application/Application","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices","sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements","sap/ushell/components/applicationIntegration/configuration/AppMeta","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ui/Device","sap/ushell/Config","sap/ushell/ui5service/AppIsolationService","sap/ushell/ApplicationType","sap/ushell/components/applicationIntegration/DelegationBootstrap","sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/base/Log"],function(E,S,B,a,A,R,b,c,d,u,D,C,e,f,g,U,q,L){"use strict";function h(){var v,i=["URL"],r,s,j,I={},o,k=false,l={},m={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},n,G=[],p={},t=false;this.shellElements=function(){return b;};this.service=function(){return R;};this.isCurrentApp=function(w){return(l.appId===w);};this.isAppWithSimilarShellHashInCache=function(w,F){var x=S.get(w);if(x){if(x.shellHash===F){return true;}return false;}return false;};this.isAppInCache=function(w){return!!S.get(w);};this.normalizeAppId=function(w){var x="-component",y=w.endsWith(x);if(y){return w.substring(0,w.length-x.length);}return w;};this.onComponentCreated=function(w,x,y){var z=y.component,F=this.normalizeAppId(z.getId());if(this.isAppInCache(F)){S.get(F).app=z;this.active(F);}else{l.app=z;if(z.active){z.active();}}};this.onGetMe=function(w,x,y){y.AppLifeCycle=this;};this.store=function(w){var x=S.get(w);if(x){A.store(x.app);R.store(x.service);c.store(x.meta);}};this.destroy=function(w,F){var x=S.get(w),y;function z(){A.destroy(F);b.destroy(F);c.destroy(F);}this.removeControl(w);if(x){y=B.getStateFul(F.getUrl());if(y&&B.isStatefulContainerSupported(y)){var H=B.getHandler();H.destroy(y,w);}else{x.container.destroy();B.deleteStateFul(F.getUrl());}S.remove(w);}else{var P=F&&F.sendBeforeAppCloseEvent&&F.sendBeforeAppCloseEvent();if(P===undefined){z();}else{P.then(function(){z();},function(J){z();q.sap.log.error("FLP got a failed response from the iframe for the 'sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent' message sent",J,"sap.ushell.components.applicationIntegration.AppLifeCycle.js");});}}};this.restore=function(w){var x=S.get(w);if(x){A.restore(x.app);R.restore(x.service);c.restore(x.meta);}};this.active=function(w){var x=S.get(w);if(x){A.active(x.app);}};this.handleExitStateful=function(F,w){var x,H=B.getHandler();if(S.get(F)){x=B.getStorageKey(w);if(x&&B.isKeepAliveSupported(w)){return H.store(w,x);}return Promise.resolve();}return H.destroy(w);};this.handleExitApplication=function(F,w,x){var y;if(F&&w){if(w.getUrl()&&B.isStatefulContainerSupported(B.getStateFul(w.getUrl()))){this.handleExitStateful(F,w);}else if(S.get(F)){this.store(F);}else if((w.getIsStateful&&w.getIsStateful())||(w.getApplicationType&&this.applicationIsStatefulType(w.getApplicationType()))){if(x){w.postMessageRequest("sap.gui.triggerCloseSessionImmediately");}}else{y=i.indexOf(w.getApplicationType)>=0;if(this.isAppOfTypeCached(F,y)===false){this.destroy(F,w);}}if(F.indexOf("Shell-appfinder-component")>0){sap.ui.getCore().getEventBus().publish("sap.ushell","appFinderAfterNavigate");}}};this.onAfterNavigate=function(F,w,T,x){var y=T.indexOf("Shell-appfinder-component")>0||T.indexOf("Shell-home-component")>0;this.handleExitApplication(F,w,y);if(T){if(S.get(T)){this.restore(T);}else{}}};this.storeApp=function(w,x,T,F){if(!this.isAppInCache(w)){S.set(w,{service:R.create(),shellHash:F,appId:w,stt:"loading",appRelatedElements:b.getAppRelatedElement(),container:x,meta:d.getMetadata(T),app:undefined});I[F]=w;B.setStorageKey(x,w);return true;}return false;};this.restoreApp=function(w){if(this.isAppInCache(w)){l=S.get(w);if(B.getStorageKey(l.container)){B.setStorageKey(l.container,w);}}};this.isAppOfTypeCached=function(w,x){if(!k&&w.indexOf(r)!==-1){return true;}if(!k&&w.indexOf("Shell-appfinder")!==-1){return true;}if(new U(window.location.href).get("sap-keep-alive")=="true"&&x){return true;}return false;};h.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};this.calculateAppType=function(T){if(T.applicationType==="URL"&&T.additionalInformation&&T.additionalInformation.startsWith("SAPUI5.Component=")){return"SAPUI5";}return T.applicationType;};this.getStatefulCapabilities=function(T){if(T.appCapabilities&&T.appCapabilities&&T.appCapabilities.statefulContainer){return T.appCapabilities.statefulContainer;}return undefined;};this.isNotifyInnerAppRouteChangeEnabled=function(T){if(T.appCapabilities&&T.appCapabilities.notifyInnerAppRouteChange){return true;}return false;};this.isStatefulCapabilityEnabled=function(T){var w=this.getStatefulCapabilities(T);if(w&&(w.enabled===true||w===true)){return true;}return false;};this.isGUICapabilityEnabled=function(T){var w=this.getStatefulCapabilities(T);if(w&&w.protocol==="GUI"){return true;}return false;};this.isFLPCapabilityEnabled=function(T){return!this.isGUICapabilityEnabled(T)&&this.isStatefulCapabilityEnabled(T);};this.isGUIStatefulCapabilityEnabled=function(T){return this.isGUICapabilityEnabled(T)&&this.isStatefulCapabilityEnabled(T);};this.openApp=function(w,T,x,F){var y,z,H=i.indexOf(T.applicationType)>=0;var J="application"+w;y=B.getStateFul(T.url);if(y&&B.isStatefulContainerSupported(y)){if(this.isAppOfTypeCached(J,H)||this.isCachedEnabledAsAppParameter(x,T)){if(!this.isAppInCache(J)){this.storeApp(J,y,T,F);}this.restoreApp(J);}else{l={appId:J,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}}else if(this.isAppOfTypeCached(J,H)||this.isCachedEnabledAsAppParameter(x,T)){if(!this.isAppInCache(J)){y=this.createApplicationContainer(w,T);this.storeApp(J,y,T,F);B.set(T.url,y);}this.restoreApp(J);}else if(this.applicationIsStatefulType(T.applicationType)||B.isCapByTarget(T,"isGUIStateful")){y=this.getStatefulContainer(T.applicationType);if(!y){y=this.createApplicationContainer(w,T);this.setStatefulContainer(T.applicationType,y);y.setIsStateful(true);}l={appId:J,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}else{if(y){z=x.semanticObject+"-"+x.action;this.removeApplication(z);}y=this.createApplicationContainer(w,T);B.set(T.url,y);if(B.isCapUT(y,"isFLP")){B.setCapabilities(y,[{service:"sap.ushell.services.appLifeCycle",action:"create"},{service:"sap.ushell.services.appLifeCycle",action:"destroy"}]);}l={appId:J,stt:"loading",container:y,meta:d.getMetadata(T),app:undefined};}};this.getAppMeta=function(){return c;};this.evict=function(w){var x,y=w.value,z=w.key;this.removeControl(z);if(y.container.getUrl&&y.container.getUrl()){x=B.getStateFul(y.container.getUrl());}if(x){var H=B.getHandler();H.destroy(x,z);}else{y.container.destroy();}};this.init=function(w,x,y,z,F,H,J){var K=this,M;if(D.system.phone){M=10;if(J&&J.limit&&J.limit.phone){M=J.limit.phone;}}else if(D.system.tablet){M=10;if(J&&J.limit&&J.limit.tablet){M=J.limit.tablet;}}else if(D.system.desktop){M=15;if(J&&J.limit&&J.limit.desktop){M=J.limit.desktop;}}else{M=10;}g.init(this.registerShellCommunicationHandler,this.postMessageToIframeApp);g.bootstrap();s=new a({scopeObject:F.ownerComponent,scopeType:"component"});o=new e({scopeObject:F.ownerComponent,scopeType:"component"});j=w;v=x;r=y;c.init(r);k=z;B.init({oShellUIService:s,oAppIsolationService:o},J,this);S.init(M,function(O){this.evict(O);}.bind(this));this.registerShellCommunicationHandler({"sap.ushell.services.appLifeCycle":{oRequestCalls:{"create":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.create:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.create:"+O);});}},"destroy":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.destroy:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.destroy:"+O);});}},"store":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.store:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.store:"+O);});}},"restore":{isActiveOnly:true,distributionType:["URL"],fnResponseHandler:function(P){P.then(function(O){L.info("sap.ushell.services.appLifeCycle.restore:"+O);}).catch(function(O){L.error("Error: sap.ushell.services.appLifeCycle.restore:"+O);});}}},oServiceCalls:{"subscribe":{executeServiceCallFn:function(O){B.mapCapabilities(O.oContainer,O.oMessageData.body);return new q.Deferred().resolve({}).promise();}},"setup":{executeServiceCallFn:function(O){return new q.Deferred().resolve().promise();}}}}});this.registerShellCommunicationHandler({"sap.ushell.eventDelegation":{oRequestCalls:{"registerEventHandler":{isActiveOnly:false,distributionType:["URL"]}},oServiceCalls:{"registerEventHandler":{executeServiceCallFn:function(O){var P=N(O);return new q.Deferred().resolve(P).promise();}}}}});function N(O){var P=O.oMessageData.body.eventSerObj;return K.registerEventHandler(P);}sap.ui.getCore().getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);b.init(this.getElementsModel(),H);};this.addControl=function(w){v.addCenterViewPort(w);};this.removeControl=function(w){var x=B.getById(w),y=B.isStatefulContainerSupported(x);if(!y){v.removeCenterViewPort(w,true);}};this.removeApplication=function(w){var x=this.getControl(w);if(x){this.removeControl(x.getId());x.destroy();}};this.getControl=function(w){return v&&(v.getViewPortControl("centerViewPort","application-"+w)||v.getViewPortControl("centerViewPort","applicationShellPage-"+w));};this.getViewPortContainer=function(){return v;};this.navTo=function(w){v.navTo("centerViewPort",w,"show");};this.getCurrentApplication=function(){return l;};this.setApplicationFullWidth=function(w){var x=this.getCurrentApplication();if(x.container){x.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!w);}};this.createComponent=function(w,P){this.shellElements().setDangling(true);return A.createComponent(w,P);};this.getAppContainer=function(w,x,y,z,F){x.shellUIService=s.getInterface();x.appIsolationService=o.getInterface();x.targetNavigationMode=y?"explace":"inplace";this.openApp(w,x,z,F);if(G.length>0){l.container.registerShellCommunicationHandler(G);}if(p.UI5APP){l.container.setIframeHandlers(p.UI5APP);}return l.container;};this.getShellUIService=function(){return s;};this.getAppIsolationService=function(){return o;};this.initShellUIService=function(w){s._attachHierarchyChanged(c.onHierarchyChange.bind(this));s._attachTitleChanged(c.onTitleChange.bind(this));s._attachRelatedAppsChanged(c.onRelatedAppsChange.bind(this));s._attachBackNavigationChanged(w.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(w){var x={};if(w){var y={"GUI":true};Object.keys(w).filter(function(z){return w[z]===true&&y[z];}).map(function(z){var F=z;if(F==="GUI"){F="TR";}return F;}).forEach(function(z){x[z]=null;});}n=x;};this.setStatefulApplicationContainer=function(w){n=w;};this.getStatefulApplicationContainer=function(){return n;};this.applicationIsStatefulType=function(w){return n.hasOwnProperty(w);};this.getStatefulContainer=function(w){return n[w];};this.setStatefulContainer=function(w,x){n[w]=x;};this.statefulContainerForTypeExists=function(w){return!!this.getStatefulContainer(w);};this.getAllApplicationContainers=function(){return Object.keys(n).map(function(K){return n[K];}).filter(function(w){return!!w;});};this.getElementsModel=function(){return E;};this.activeContainer=function(w){var x=this.getAllApplicationContainers();x.forEach(function(y){L.info("Deactivating container "+y.getId());y.setActive(false);});if(w){L.info("Activating container "+w.getId());w.setActive(true);}};this.showApplicationContainer=function(w){this.navTo(w.getId());w.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");};this.reuseStateFulContainerAndRestore=function(w,T,H,F){var x=this,y=I[F];if(B.getStorageKey(w)){B.setStorageKey(w,y);}return H.restore(w,y).then(function(){x.showApplicationContainer(w);},function(z){L.error(z&&z.message||z);});};this.reuseStateFulContainer=function(w,x,T,H,F){var y=this;I[F]=T;if(B.getStorageKey(w)){B.setStorageKey(w,T);}this.initAppMetaParams();return H.create(w,x,T).then(function(){y.showApplicationContainer(w);},function(z){L.error(z&&z.message||z);});};this.initAppMetaParams=function(){if(!this.getAppMeta().getIsHierarchyChanged()){s.setHierarchy();}if(!this.getAppMeta().getIsTitleChanged()){s.setTitle();}if(!this.getAppMeta().getIsRelatedAppsChanged()){s.setRelatedApps();}if(!t){s.setBackNavigation();}};this.reuseApplicationContainer=function(w,x,y){var z=this;return w.setNewApplicationContext(x,y).then(function(){z.navTo(w.getId());w.toggleStyleClass("hidden",false);L.info("New application context opened successfully in an existing transaction UI session.");},function(F){L.error(F&&F.message||F);});};this.createApplicationContainer=function(w,x){return A.createApplicationContainer(w,x);};this.publishNavigationStateEvents=function(w,x,O){var y,z=w.getId?w.getId():"",F=this;var H=d.getMetadata(),J=H.icon,T=H.title;w.addEventDelegate({onAfterRendering:O});y=w.exit;w.exit=function(){if(y){y.apply(this,arguments);}F.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var K=q.extend(true,{},x);delete K.componentHandle;K.appId=z;K.usageIcon=J;K.usageTitle=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",K);L.info("app was closed");},0);var P=F._publicEventDataFromResolutionResult(x);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(w){var P={};if(!w){return w;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(x){P[x]=w[x];});Object.freeze(P);return P;};this.isCachedEnabledAsAppParameter=function(w,T){if(w&&w.params&&w.params["sap-keep-alive"]){if(w.params["sap-keep-alive"]=="true"){return true;}}if(T&&T.url){if(new U(T.url).get("sap-keep-alive")=="true"){return true;}}return false;};this.getInMemoryInstance=function(w,F){var x="application-"+w,y=S.get(x);if(y){if(y.shellHash===F){return{isInstanceSupported:true,appId:y.appId,container:y.container};}return{isInstanceSupported:false,appId:y.appId,container:y.container};}return{isInstanceSupported:false,appId:undefined,container:undefined};};this.handleOpenStateful=function(w,x,T,y,z,F){var H=B.getHandler();if(S.get(T)&&w===false){this.reuseStateFulContainerAndRestore(y,T,H,F);}else{this.reuseStateFulContainer(y,z.url,T,H,F);if(x){if(!this.isAppInCache(T)){this.storeApp(T,y,z,F);}}}};this.leave=function(w,x){var y=B.isStatefulContainerSupported(w);if(y){return this.handleExitStateful(x,w);}return Promise.resolve();};this.open=function(w,x,y,T,W,F,M){var z,H=this.statefulContainerForTypeExists(T.applicationType),J,K=i.indexOf(T.applicationType)>=0,N="application-"+w,O,P=this.isAppOfTypeCached(N,K)||this.isCachedEnabledAsAppParameter(y,T),Q,V=false,X;Q=this.calculateAppType(T);X=f.getDefaultFullWidthSetting(Q);z=B.getStateFul(T.url);J=B.isStatefulContainerSupported(z);if(!J){z=undefined;O=S.get("application"+x);if(O){z=O.container;}}if(J){if(!z){z=W(w,M,y,T,x,T.fullWidth||M.fullWidth||X,F);this.restoreApp(z.getId());this.navTo(z.getId());V=true;}}else if(!H&&z&&!P){this.destroy(z.getId(),z);z=W(w,M,y,T,x,T.fullWidth||M.fullWidth||X,F);}else if(!z){z=W(w,M,y,T,x,T.fullWidth||M.fullWidth||X,F);}if(!H&&!J){this.restoreApp(z.getId());this.navTo(z.getId());}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(z);if(J){this.handleOpenStateful(V,P,"application"+x,z,T,F);}else if(H){this.reuseApplicationContainer(z,T.applicationType,T.url);}return Promise.resolve();};this.handleControl=function(w,x,y,T,W,F){var z=this,M=d.getMetadata(T),H=v.getCurrentCenterPage?v.getCurrentCenterPage():undefined,J=sap.ui.getCore().byId(H);var P=z.leave(J,H).then(function(){z.open(w,x,y,T,W,F,M);},function(K){L.error(K&&K.message||K);});return P;};this.switchViewState=function(w,x,y){var z=w,F;if(m[w]&&m[w][j]){z=m[w][j];}var H=C.last("/core/shell/model/currentState/stateName")==="home";if(!H&&(!l.appId||!S.get(l.appId))){E.destroyManageQueue();}F=S.get("application"+y);if(F){b.restore(F);}else{b.assignNew(w);}E.switchState(z,x,y);this.shellElements().setDangling(false);this.shellElements().processDangling();if(w==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen","");if(!window.hasher.getHash().indexOf("Action-search")===0){var J=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+J.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(J.getProperty("/uiFilter/dataSource").getJson()));}}};this.registerShellCommunicationHandler=function(w){A.registerShellCommunicationHandler(w);};this.registerIframeCommunicationHandler=function(H,T){p[T]=H;};this.postMessageToIframeApp=function(w,x,M,W){var y,z=A.getActiveAppContainer(),F=[];if(B.hasIFrame(z)&&(B.isCapabilitySupported(z,w,x)||A.isAppTypeSupported(z,w,x))){F.push(A.postMessageToIframeApp(z,w,x,M,W));}if(!A.isActiveOnly(w,x)){B.forEach(function(O){if(B.hasIFrame(O)){if(B.isCapabilitySupported(O,w,x)||A.isAppTypeSupported(O,w,x)){F.push(A.postMessageToIframeApp(O,w,x,M,W));}}});}y=A.getResponseHandler(w,x);var H=Promise.all(F);if(y){y(H);}return H;};this.postMessageToIframeAppAccordingToPolicy=function(w,x,M,W,P){var y,z=A.getActiveAppContainer(),F=[];if(B.hasIFrame(z)&&A.isAppTypeSupportedByPolicy(z,P)){F.push(A.postMessageToIframeApp(z,w,x,M,W));}if(!P.isActiveOnly){B.forEach(function(O){if(B.hasIFrame(O)){if(B.isCapabilitySupported(O,w,x)||A.isAppTypeSupported(O,w,x)){F.push(A.postMessageToIframeApp(O,w,x,M,W));}}});}y=A.getResponseHandler(w,x);var H=Promise.all(F);if(y){y(H);}return H;};this.registerTunnels=function(T){g.registerTunnels(T,this.registerShellCommunicationHandler);};this.registerEvents=function(w){g.registerEvents(w,this.registerShellCommunicationHandler);};this.setBackNavigationChanged=function(w){t=w;};this.getBackNavigationChanged=function(){return t;};}return new h();},true);
