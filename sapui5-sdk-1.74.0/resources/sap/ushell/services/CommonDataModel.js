// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_CommonDataModel/PersonalizationProcessor","sap/base/util/ObjectPath","sap/base/util/extend","sap/ui/thirdparty/jquery","sap/base/Log","sap/base/util/isPlainObject"],function(P,O,e,q,L,a){"use strict";var S="sap.ushell.services.CommonDataModel",b={"STATIC_LAUNCHER":"sap.ushell.StaticAppLauncher","DYNAMIC_LAUNCHER":"sap.ushell.DynamicAppLauncher","CARD":"sap.ushell.Card"};function C(A,c,p,s){var t=this,o=new q.Deferred();function f(m){o.reject(m);}this._oAdapter=A;this._oPersonalizationProcessor=new P();this._oSitePromise=o.promise();this._oContentProviderIndex={};A.getSite().done(function(d){t._oOriginalSite=q.extend(true,{},d);A.getPersonalization().done(function(g){t._oPersonalizationProcessor.mixinPersonalization(d,g).done(function(h){t._oPersonalizedSite=t._ensureCompleteSite(h);t._oPersonalizedSite=t._ensureGroupsOrder(t._oPersonalizedSite);t._oPersonalizedSite=t._ensureStandardVizTypesPresent(t._oPersonalizedSite);o.resolve(t._oPersonalizedSite);}).fail(f);}).fail(f);}).fail(f);}C.prototype.getHomepageGroups=function(){var d=new q.Deferred();this._oSitePromise.then(function(s){var g=(s&&s.site&&s.site.payload&&s.site.payload.groupsOrder)?s.site.payload.groupsOrder:[];d.resolve(g);});return d.promise();};C.prototype.getGroups=function(){var d=new q.Deferred();this._oSitePromise.then(function(s){var g=[];Object.keys(s.groups).forEach(function(k){g.push(s.groups[k]);});d.resolve(g);});return d.promise();};C.prototype.getGroup=function(i){var d=new q.Deferred();this._oSitePromise.then(function(s){var g=s.groups[i];if(g){d.resolve(g);}else{d.reject("Group "+i+" not found");}});return d.promise();};C.prototype.getSite=function(){return this._oSitePromise;};C.prototype._getPage=function(p){return new Promise(function(r,c){this._oAdapter._getPage(p).then(function(s){s=e({},s);s=this._ensureCompleteSite(s);s=this._ensureGroupsOrder(s);s=this._ensureStandardVizTypesPresent(s);r(s);}.bind(this)).catch(function(m){c(m);});}.bind(this));};C.prototype.getGroupFromOriginalSite=function(g){var d=new q.Deferred();if(typeof g==="string"&&this._oOriginalSite&&this._oOriginalSite.groups&&this._oOriginalSite.groups[g]){d.resolve(q.extend(true,{},this._oOriginalSite.groups[g]));}else{d.reject("Group does not exist in original site.");}return d.promise();};C.prototype.save=function(){var d=new q.Deferred(),t=this;this._oPersonalizationProcessor.extractPersonalization(this._oPersonalizedSite,this._oOriginalSite).done(function(E){if(E){t._oAdapter.setPersonalization(E).done(function(){d.resolve();}).fail(function(m){d.reject(m);});}else{d.resolve();}});return d.promise();};function l(){var p=sap.ushell.Container.getService("PluginManager");return p.loadPlugins("ContentProvider");}C.prototype._getUnreferencedCatalogApplications=function(E){var u={};var A=Object.keys(E.applications).map(function(s){return E.applications[s]["sap.app"].id;}).reduce(function(i,s){i[s]=true;return i;},{});var c=E.catalogs;Object.keys(c).forEach(function(s){var d=c[s].payload.appDescriptors;d.map(function(o){return o.id;}).filter(function(f){return!A[f];}).forEach(function(B){if(!u.hasOwnProperty(s)){u[s]={};}u[s][B]=true;});});return u;};C.prototype._formatUnreferencedApplications=function(c,u){return"One or more apps from "+c+" content provider are not listed among the applications section "+"of the extended site and will be discarded - "+Object.keys(u).map(function(s){var B=Object.keys(u[s]).map(function(U){return"'"+U+"'";});return"From catalog '"+s+"': "+B.join(", ");}).join("; ");};C.prototype._removeUnreferencedApplications=function(E,u){Object.keys(E.catalogs).forEach(function(c){var o=E.catalogs[c].payload;var A=o.appDescriptors;o.appDescriptors=A.filter(function(d){return u[c]&&!u[c][d.id];});});};C.prototype.getExtensionSites=function(){var t=this;var d=new q.Deferred();l().done(function(){var c=Object.keys(t._oContentProviderIndex),T=c.length;if(T===0){d.resolve([]);return;}var g=c.map(function(s,i){var o=t._oContentProviderIndex[s];var G;try{G=o.getSite();if(!G||typeof G.then!=="function"){throw"getSite does not return a Promise";}}catch(E){G=Promise.reject("call to getSite failed: "+E);}return G.then(function(s,f){var h=q.extend(true,{},f);var u=t._getUnreferencedCatalogApplications(f);if(Object.keys(u).length>0){var j=t._formatUnreferencedApplications(s,u);q.sap.log.error(j,null,S);t._removeUnreferencedApplications(h,u);}var k={providerId:s,success:true,site:h};d.notify(k);return k;}.bind(null,s),function(s,f){return{providerId:s,success:false,error:f};}.bind(null,s));});Promise.all(g).then(function(f){d.resolve(f);});});return d.promise();};C.prototype.registerContentProvider=function(i,s){if(this._oContentProviderIndex[i]){q.sap.log.error("a content provider with ID '"+i+"' is already registered",null,S);return;}this._oContentProviderIndex[i]=s;q.sap.log.debug("ContentProvider '"+i+"' was registered",null,S);};C.prototype._ensureCompleteSite=function(p){if(p.groups){var g=p.groups;Object.keys(g).forEach(function(k){if(!g[k]){delete g[k];}else{if(!g[k].payload){g[k].payload={};}if(!g[k].payload.links){g[k].payload.links=[];}if(!g[k].payload.tiles){g[k].payload.tiles=[];}if(!g[k].payload.groups){g[k].payload.groups=[];}}});}return p;};C.prototype._ensureGroupsOrder=function(s){var g=O.get("site.payload.groupsOrder",s),G=s.groups,c,i=0;if(!g){return s;}while(i<g.length){c=g[i];if(!G[c]){g.splice(i,1);}else{i++;}}return s;};C.prototype.getPlugins=(function(){var d,E,p;E=function(s,o){var c,n=Object.keys(o).length;if(n===0){return{};}if(!o.hasOwnProperty("Shell-plugin")){q.sap.log.error("Cannot find inbound with id 'Shell-plugin' for plugin '"+s+"'","plugin startup configuration cannot be determined correctly",S);return{};}if(n>1){q.sap.log.warning("Multiple inbounds are defined for plugin '"+s+"'","plugin startup configuration will be determined using "+"the signature of 'Shell-plugin' inbound.",S);}c=O.get("signature.parameters",o["Shell-plugin"])||{};return Object.keys(c).reduce(function(r,N){var D=O.get(N+".defaultValue.value",c);if(typeof D==="string"){r[N]=D;}return r;},{});};d=function(o){Object.keys(o).filter(function(s){return typeof o[s]==="object";}).forEach(function(s){o[s]=d(o[s]);});return Object.freeze(o);};return function(o){if(o!==undefined){p=o;}if(p){return q.when(p);}p={};return this.getSite().then(function(s){var A=s.applications||{};Object.keys(A).filter(function(c){return O.get("type",this[c]["sap.flp"])==="plugin";},A).forEach(function(c){var f,g,h=this[c],i={};if(!a(h["sap.platform.runtime"])){q.sap.log.error("Cannot find 'sap.platform.runtime' section for plugin '"+c+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else if(!a(h["sap.platform.runtime"].componentProperties)){q.sap.log.error("Cannot find 'sap.platform.runtime/componentProperties' "+"section for plugin '"+c+"'","plugin might not be started correctly","sap.ushell.services.CommonDataModel");}else{i=h["sap.platform.runtime"].componentProperties;}p[c]={url:i.url,component:h["sap.ui5"].componentName};var j=O.get("crossNavigation.inbounds",h["sap.app"])||{};g=E(c,j);f=q.extend(i.config||{},g);if(f){p[c].config=f;}if(i.asyncHints){p[c].asyncHints=i.asyncHints;}},A);return d(p);},function(v){return v;});};})();C.prototype._ensureStandardVizTypesPresent=function(s){if(!(s._version&&s._version.startsWith("3."))){return s;}if(!s.vizTypes){s.vizTypes={};}if(!s.vizTypes[b.STATIC_LAUNCHER]){s.vizTypes[b.STATIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncher/manifest.json");}if(!s.vizTypes[b.DYNAMIC_LAUNCHER]){s.vizTypes[b.DYNAMIC_LAUNCHER]=q.sap.loadResource("sap/ushell/components/tiles/cdm/applauncherdynamic/manifest.json");}if(!s.vizTypes[b.CARD]){s.vizTypes[b.CARD]=q.sap.loadResource("sap/ushell/services/_CommonDataModel/vizTypeDefaults/cardManifest.json");}return s;};C.hasNoAdapter=false;return C;},true);
