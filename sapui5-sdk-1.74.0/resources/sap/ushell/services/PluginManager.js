// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_PluginManager/Extensions","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils"],function(g,q,U,u){"use strict";var S="sap.ushell.services.PluginManager",a="sap-ushell-plugin-type",b="RendererExtensions",c="sap.ushell.components.shell.defaults",s=[b,"UserDefaults","UserImage","ContentProvider","AppWarmup"];function P(){var t=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};s.forEach(function(p){t._oPluginCollection[p]={};t._oCategoryLoadingProgress[p]=new q.Deferred();});this._handlePluginCreation=function(C,p,o){var t=this,d=(t._oPluginCollection[C])[p];try{if(d.hasOwnProperty("component")){if(t._mInitializedComponentPromise.hasOwnProperty(d.component)){t._mInitializedComponentPromise[d.component].then(function(){t._instantiateComponent(d,o);},function(){t._instantiateComponent(d,o);});}else{t._mInitializedComponentPromise[d.component]=t._instantiateComponent(d,o);}}else{q.sap.log.error("Invalid plugin configuration. The plugin "+p+" must contain a <component> key",S);}}catch(e){q.sap.log.error("Error while loading bootstrap plugin: "+d.component||"",S);if(o){o.reject(e);}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js";};this._handleXhrAuthentication=function(A,C){var x;if(A&&["true",true,"X"].indexOf(A["sap-ushell-xhr-authentication"])>-1){if(!C){q.sap.log.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,S);return q.when();}if(A.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){x=parseInt(A["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(x)){q.sap.log.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",C,"': '",A["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,S);}else{sap.ushell.Container.setXhrLogonTimeout(C,x);}}return q.ajax(C+"/"+this._getFileNameForXhrAuth());}return q.when();};this._instantiateComponent=function(p,o){var d=new q.Deferred(),C=JSON.parse(JSON.stringify(p)),A={ui5ComponentName:C.component,url:C.url,getExtensions:g};function e(E){return function(f){E=E||"Cannot create UI5 plugin component: (componentId/appdescrId :"+A.ui5ComponentName+")\n"+f+" properties "+JSON.stringify(A)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";f=f||"";q.sap.log.error(E,f.stack,S);if(o){o.reject.apply(this,arguments);}d.reject.apply(this,arguments);};}function l(){sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(A).done(function(){if(o){o.resolve();}d.resolve.apply(this,arguments);}).fail(e());}C.name=C.component;delete C.component;A.applicationDependencies=C;if(C.config){A.applicationConfiguration=C.config;delete C.config;}A.loadDefaultDependencies=false;this._handleXhrAuthentication(A.applicationConfiguration,C.url).done(l).fail(e("XHR logon for FLP plugin failed"));return d.promise();};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(s));};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection));};this.registerPlugins=function(p){var t=this,C,o,d,e=[];if(!p){return;}u.addTime("PluginManager.registerPlugins");Object.keys(p).sort().forEach(function(f){C=p[f]||{};o=C.config||{};d=o[a]||"";if(C.enabled===false){return;}if(C.enabled===undefined){C.enabled=true;}if(C&&C.hasOwnProperty("module")){q.sap.log.error("Plugin "+f+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",S);q.sap.require(C.module);return;}if(o&&o.hasOwnProperty(a)){if(s&&Array.prototype.indexOf.call(s,d)!==-1){if(e.indexOf(d)===-1){e.push(d);}t._oPluginCollection[d][f]=JSON.parse(JSON.stringify(C));}else{q.sap.log.warning("Plugin "+f+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+d,S);}}else{t._oPluginCollection[b][f]=JSON.parse(JSON.stringify(C));if(e.indexOf(b)===-1){e.push(b);}}});e.forEach(function(f){if(t._oCategoryLoadingProgress.hasOwnProperty(f)&&t._oCategoryLoadingProgress[f].state()==="resolved"){t.loadPlugins(f);}});};this.getPluginLoadingPromise=function(p){if(this._oCategoryLoadingProgress.hasOwnProperty(p)){return this._oCategoryLoadingProgress[p].promise();}};this.loadPlugins=function(p){var t=this,d,o,e;u.setPerformanceMark("FLP -- PluginManager.startLoadPlugins");u.addTime("PluginManager.startLoadPlugins["+p+"]");if(s&&Array.prototype.indexOf.call(s,p)!==-1){if(t._oCategoryLoadingProgress[p].pluginLoadingTriggered===undefined){t._oCategoryLoadingProgress[p].pluginLoadingTriggered=true;}if(Object.keys(t._oPluginCollection[p]).length>0){d=[];e=Object.keys(t._oPluginCollection[p]);if(new U(window.location.href).get("sap-ushell-xx-pluginmode")==="discard"&&p==="RendererExtensions"){e=e.filter(function(i){return(t._oPluginCollection[p][i].component===c);});}e.forEach(function(f){var h=t._oPluginCollection[p][f];if(!h.loaded){h.loaded=true;o=new q.Deferred();d.push(o.promise());t._handlePluginCreation(p,f,o);}});q.when.apply(undefined,d).done(function(){u.addTime("PluginManager.endLoadPlugins["+p+"]");u.setPerformanceMark("FLP -- PluginManager.endLoadPlugins");t._oCategoryLoadingProgress[p].resolve();}).fail(t._oCategoryLoadingProgress[p].reject.bind());}else{t._oCategoryLoadingProgress[p].resolve();}}else{q.sap.log.error("Plugins with category "+p+" cannot be loaded by the PluginManager",S);t._oCategoryLoadingProgress[p].reject("Plugins with category "+p+" cannot be loaded by the PluginManager");}return t._oCategoryLoadingProgress[p].promise();};}P.hasNoAdapter=true;return P;},true);
