/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Metadata","sap/ui/core/CustomData","sap/ui/base/ManagedObjectObserver","./AnchorBar","sap/m/Button","sap/m/MenuButton","sap/m/Menu","sap/m/MenuItem","sap/ui/core/IconPool"],function(q,M,C,a,A,B,b,c,d,I){"use strict";var e=M.createClass("sap.uxap._helpers.AB",{constructor:function(o){this._oObjectPageLayout=o;this._iScrollDuration=o._iScrollToSectionDuration;this._iFocusMoveDelay=this._iScrollDuration-100;this._oObserver=new a(this._proxyStateChanges.bind(this));this._aMenusWithAttachPressHandler=[];}});e.prototype.getObjectPageLayout=function(){return this._oObjectPageLayout;};e.prototype._proxyStateChanges=function(o){var O=o.object,g=this._findExistingClone(O),p=o.name,v=o.current,s="set"+f(p);if(g){g[s].call(g,v);}};e.prototype._findExistingClone=function(o){var g,s=o.getId()+"-__clone",h=this._getAnchorBar(),i=h.getContent();i.some(function(j){if(j.getId().indexOf(s)===0){g=j;return true;}});return g;};e.prototype._getAnchorBar=function(){var o=this.getObjectPageLayout(),g=o.getAggregation("_anchorBar");if(!g){g=new A({id:o.getId()+"-anchBar",showPopover:o.getShowAnchorBarPopover(),backgroundDesign:o.getBackgroundDesignAnchorBar()});this.getObjectPageLayout().setAggregation("_anchorBar",g,true);}return g;};e.prototype._setCustomData=function(o,s,O,i){O._oSectionInfo[s.getId()].buttonId=o.getId();o.addCustomData(new C({key:"sectionId",value:s.getId()}));o.addCustomData(new C({key:"bTitleVisible",value:s._getInternalTitleVisible()}));if(!i){o.addCustomData(new C({key:"secondLevel",value:true}));}};e.prototype._buildAnchorBar=function(){var o=this.getObjectPageLayout(),s=o.getSections()||[],g=this._getAnchorBar(),p=q.proxy(g._handleDirectScroll,g),h,i,m,j;if(g&&this.getObjectPageLayout().getShowAnchorBar()){g._resetControl();this._oObserver.disconnect();s.forEach(function(S){if(!S.getVisible()||!S._getInternalVisible()){return;}var k,l=S.getSubSections()||[];k=this._buildAnchorBarButton(S,true);if(k){g.addContent(k);if(k instanceof b){var n=new c({}),r=sap.ui.getCore().getLibraryResourceBundle("sap.uxap");k.enhanceAccessibilityState=function(E,t){var u=g.getContent(),v=u.indexOf(E.getParent());if(v!==-1){t.role="menuitemradio";t.roledescription=r.getText("ANCHOR_BAR_MENUITEM");t.setsize=u.length;t.posinset=v+1;}};n._setCustomEnhanceAccStateFunction(function(E,t){t.controls=E.data("sectionId");});k.setMenu(n);}l.forEach(function(t){if(!t.getVisible()||!t._getInternalVisible()){return;}var u=this._buildAnchorBarButton(t,false),v=g.getId()+"-"+t.getId()+"-anchor";if(u){g.addContent(u);}if(k instanceof b){j=t.getCustomAnchorBarButton();if(j){h=j.getText();i=j.getIcon();}else{h=t._getInternalTitle()||t.getTitle();i='';}m=new d(v,{"text":h,"icon":i});m.addCustomData(new C({key:"sectionId",value:t.getId()}));m.attachPress(p);this._setCustomData(m,t,o,false);k.getMenu().addItem(m);}},this);}},this);}};e.prototype._moveFocusOnSection=function(s){var S=s.data(),o=sap.ui.getCore().byId(S.sectionId),O=this.getObjectPageLayout(),i=o.isA("sap.uxap.ObjectPageSubSection"),g=(o&&!O.getUseIconTabBar())||(O.getUseIconTabBar()&&i),F=this._iFocusMoveDelay;if(g){setTimeout(o.$()["focus"].bind(o.$()),F);}if(O.getUseIconTabBar()&&i){var D={"onAfterRendering":function(){this.removeEventDelegate(D);setTimeout(this.$()["focus"].bind(this.$()),F);}.bind(o)};o.addEventDelegate(D);}};e.prototype._instantiateAnchorBarButton=function(i,s,g){var h,S;if(i){h=b;S={type:"Transparent",buttonMode:"Split",useDefaultActionOnly:true,ariaDescribedBy:s};}else{h=B;S={ariaDescribedBy:s};}if(g){S.id=g;}return new h(S);};e.prototype._buildAnchorBarButton=function(s,i){var o=null,O=this.getObjectPageLayout(),g,h=this._getAnchorBar(),j,H,v,S=s.getAggregation("subSections"),p=q.proxy(h._handleDirectScroll,h);if(s.getVisible()&&s._getInternalVisible()){g=s.getCustomAnchorBarButton();if(!g){j=h.getId()+"-"+s.getId()+"-anchor";if(i){if(S&&S.length>1){v=S.filter(function(k){return k.getVisible()&&k._getInternalVisible();}).length;}}H=i&&v>1&&h.getShowPopover();if(H){o=this._instantiateAnchorBarButton(true,s,j);o.attachDefaultAction(p);o._getButtonControl().attachPress(function(){this.getParent().focus();});o._getButtonControl().attachArrowPress(function(){var k=o._getButtonControl();if(this._aMenusWithAttachPressHandler[k.getId()]){return;}o.getMenu().attachItemSelected(function(E){this._moveFocusOnSection(E.getParameter("item"));},this);this._aMenusWithAttachPressHandler[k.getId()]=true;},this);o.addCustomData(new C({key:"bHasSubMenu",value:true}));}else if(i){o=this._instantiateAnchorBarButton(false,s,j);o.attachPress(p);o.attachPress(function(E){this._moveFocusOnSection(E.getSource());},this);}else{o=this._instantiateAnchorBarButton(false,s);}var t=(s._getInternalTitle()!="")?s._getInternalTitle():s.getTitle();o.setText(t);}else{o=g.clone();o.attachPress(p);o.attachPress(function(E){this._moveFocusOnSection(E.getSource());},this);this._oObserver.observe(g,{properties:true});}this._setCustomData(o,s,O,i);}return o;};function f(n){return n.substring(0,1).toUpperCase()+n.substring(1);}return e;});
