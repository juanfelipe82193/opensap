/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/MessageScope","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/DataLossHandler","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library","sap/base/Log","sap/base/util/extend","sap/base/util/isPlainObject"],function(U,N,F,M,a,b,c,J,R,A,d,B,D,e,P,T,C,V,t,f,g,L,h,j){"use strict";A=t.observableConstructor(A);var k=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function l(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function m(){return new P({processObservers:[]});}var n=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function p(q,s){var u={oAppComponent:q,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:l,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:n.bindList("/",null,null,v)};u.oDataLossHandler=new D(u);u.oValidationMessageBinding.attachChange(Function.prototype);var w;var x;var y;function z(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");u.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:k.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});q.setModel(u.oTemplatePrivateGlobalModel,"_templPrivGlobal");u.oShellServicePromise.catch(function(){u.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function E(){u.fnAddSideEffectPromise=function(j1){var i=0;for(;u.aRunningSideEffectExecutions[i];){i++;}u.aRunningSideEffectExecutions[i]=j1;var k1=function(){u.aRunningSideEffectExecutions[i]=null;};j1.then(k1,k1);};w.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var j1=i.getParameter("promise");setTimeout(u.oBusyHelper.setBusy.bind(null,j1),1000);u.fnAddSideEffectPromise(j1);}});var h1=q.getModel("_templPrivGlobal");var i1="/generic/draftIndicatorState";w.attachBeforeQueueItemProcess(function(i){if(i.draftSave){h1.setProperty(i1,k.Saving);}});w.attachOnQueueCompleted(function(){if(h1.getProperty(i1)===k.Saving){h1.setProperty(i1,k.Saved);}});w.attachOnQueueFailed(function(){if(h1.getProperty(i1)===k.Saving){h1.setProperty(i1,k.Clear);}});h1.setProperty("/generic/appComponentName",q.getMetadata().getComponentName());}function G(){var i={appComponent:q,oTemplateContract:u,application:new d(u),oViewDependencyHelper:new V(u)};u.oViewDependencyHelper=i.oViewDependencyHelper;u.oShellServicePromise=q.getService("ShellUIService").catch(function(){var k1=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((k1&&k1.createInstance())||Promise.reject());});u.oShellServicePromise.catch(function(){L.warning("No ShellService available");});var h1=_().settings||Object.create(null);q.applySettings(h1);(U.prototype.init||Function.prototype).apply(q,arguments);u.appSettings=new M(q);u.oBusyHelper.setBusy(u.oShellServicePromise);y=r(i);var i1=q.getModel();u.bCreateRequestsCanonical=true;var j1=i1.messageScopeSupported();u.oBusyHelper.setBusy(j1);j1.then(function(k1){if(k1){i1.setMessageScope(c.BusinessObject);u.bCreateRequestsCanonical=false;}w=new A(i1);z();x=new e(u);E();C.enableAutomaticDraftSaving(u);if((!i1.oMetadata||!i1.oMetadata.isLoaded())||i1.oMetadata.isFailed()){i1.attachMetadataFailed(function(){x.navigateToMessagePage({title:l("ST_GENERIC_ERROR_TITLE"),text:l("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:l("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var l1 in u.componentRegistry){u.componentRegistry[l1].fnViewRegisteredResolve(true);}});}if(q&&q.getMetadata()&&q.getMetadata().getManifest()){f.setAppComponent(q);}f.setApplicationStatus(f.mApplicationStatus.LOADING);f.publishEvent("elements","ViewRenderingStarted",{});});}function H(){if(u.oNavigationHost){return"";}if(u.sRoutingType==="f"){var i=new F();u.oNavigationHost=i;u.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];u.oNavigationObserver=new P({processObservers:u.aNavigationObservers});u.aHeaderLoadingObservers=[m(),m(),m()];}else{var h1=new N({id:q.getId()+"-appContent"});u.oNavigationHost=h1;u.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:h1.attachNavigate.bind(h1),attachProcessStop:h1.attachAfterNavigate.bind(h1)}});}u.oHeaderLoadingObserver=new P({processObservers:u.aHeaderLoadingObservers||[]});u.oPagesDataLoadedObserver=new P({processObservers:[u.oHeaderLoadingObserver,u.oNavigationObserver]});u.oNavigationHost.addStyleClass(u.oApplicationProxy.getContentDensityClass());u.oBusyHelper=new B(u);u.oBusyHelper.setBusyReason("HashChange",true,true);u.oBusyHelper.getUnbusy().then(function(){u.oShellServicePromise.then(function(i1){i1.setBackNavigation(u.oApplicationProxy.onBackButtonPressed);});});return u.oNavigationHost;}function I(){if(u.oNavigationHost){u.oNavigationHost.destroy();}if(w){w.destroy();}if(x){x.destroy();}if(u.oValidationMessageBinding){u.oValidationMessageBinding.destroy();}f.setAppComponent(null);(U.prototype.exit||Function.prototype).apply(q,arguments);y();t.endApp(s);}function K(i){var h1=Object.keys(i).map(function(i1){var j1=i[i1];if(j1.pages){j1.pages=K(j1.pages);}return i[i1];});return h1;}function O($){if($._version==="1.3.0"&&$.pages&&j($.pages)){$.pages=K($.pages);}}function Q(h1,i1){if(!h1){return;}for(var i=0;i<h1.length;i++){var j1=h1[i];if(j1.routingSpec&&j1.routingSpec.noOData){j1.entitySet=j1.routingSpec.routeName;if(i1>1){j1.navigationProperty=j1.routingSpec.routeName;}}Q(j1.pages,i1+1);if(j1.embeddedComponents){for(var k1 in j1.embeddedComponents){var l1=j1.embeddedComponents[k1];if(l1.pages){l1.pages=K(l1.pages);Q(l1.pages,i1+1);}}}if(j1.implementingComponent&&j1.implementingComponent.pages){j1.implementingComponent.pages=K(j1.implementingComponent.pages);Q(j1.implementingComponent.pages,i1+1);}}}function S($){Q($.pages,0);}function W(i){if(i){var h1=i.entitySet;var i1=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var j1=function(i1){for(var k1 in i1){var l1=i1[k1];if(l1.entitySet){return true;}}return false;};if(j1(i1)){for(var k1 in i1){var l1=i1[k1];if(l1.entitySet===undefined){l1.entitySet=h1;}}}}}function X($){W($.pages[0]);}function Y(i){if(i&&i.objectPageDynamicHeaderTitleWithVM){i.objectPageHeaderType=i.objectPageHeaderType||"Dynamic";i.objectPageVariantManagement=i.objectPageVariantManagement||"VendorLayer";}}function Z(h1){var i1;if(h1.component){i1=h1.component.settings;}else{i1=h1;if(!i1.tableSettings&&!i1.tableType&&i1.multiSelect===undefined){return;}}i1=i1||{};i1.tableType=i1.tableType||(i1.gridTable?"GridTable":undefined);i1.tableType=i1.tableType||(i1.treeTable?"TreeTable":undefined);i1.tableSettings=i1.tableSettings||{};i1.tableSettings.type=i1.tableSettings.type||i1.tableType;i1.tableSettings.multiSelect=(i1.tableSettings.multiSelect===undefined?i1.multiSelect:i1.tableSettings.multiSelect);i1.tableType=i1.tableSettings.type;i1.multiSelect=i1.tableSettings.multiSelect;i1.tableSettings.selectAll=(i1.tableSettings.selectAll===undefined?false:i1.tableSettings.selectAll);for(var i in h1.pages){Z(h1.pages[i]);}for(var i in i1.sections){Z(i1.sections[i]);}}var $;function _(){if(!$){var i=q.getMetadata();$=i.getManifestEntry("sap.ui.generic.app");if(!$){return Object.create(null);}O($);S($);X($);Y($.settings);Z($.pages[0]);}return $;}var a1;function b1(){if(!a1){a1=h({},q.getMetadata().getManifest());a1["sap.ui.generic.app"]=_();}return a1;}function c1(){var i=q.getFlexibleColumnLayout();u.sRoutingType=i?"f":"m";return"sap."+u.sRoutingType+".routing.Router";}var d1=Promise.resolve();function e1(){var i=new Promise(function(h1){d1.then(function(){var i1=[];u.oNavigationControllerProxy.getActiveComponents().forEach(function(j1){var k1=u.componentRegistry[j1];var l1=k1.oComponent.getComponentContainer();var m1=l1.getParent();if(m1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var n1=u.oNavigationControllerProxy.createComponentInstance(u,k1.routeConfig,u.oNavigationControllerProxy.mRouteToComponentResolve[k1.route]);i1.push(n1.loaded().then(function(n1){var o1=l1.getComponentInstance().getBindingContext();m1.removePage(l1);m1.addPage(n1);m1.to(n1);l1.destroy();var p1=n1.getComponentInstance();var q1=u.componentRegistry[p1.sId];u.mRouteToTemplateComponentPromise[k1.route]=Promise.resolve(p1);if(o1){Promise.all([q1.viewRegistered,q1.reuseComponentsReady]).then(function(){q1.utils.bindComponent(o1.getPath(),true);});}return q1.oViewRenderedPromise;}));});h1(Promise.all(i1));});});d1=i.then(Function.prototype);return d1;}var f1={init:G,createContent:H,exit:I,_getRouterClassName:c1,getConfig:_,getInternalManifest:b1,getTransactionController:function(){return w.getTransactionController();},getApplicationController:function(){return w;},getNavigationController:function(){return x;}};var g1={retemplateActiveComponents:e1};if(sap.ui.getCore().getConfiguration().getDesignMode()){h(f1,g1);}var O=t.testable(O,"fnNormalizePagesMapToArray");_=t.testable(_,"getConfig");return f1;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},considerAnalyticalParameters:{type:"boolean",defaultValue:false},showDraftToggle:{type:"boolean",defaultValue:false},objectPageHeaderType:{type:"string",defaultValue:"Static"},objectPageVariantManagement:{type:"string",defaultValue:"None"},flexibleColumnLayout:{type:"object",defaultValue:null},inboundParameters:{type:"object",defaultValue:null}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();h(this,p(this,i));(U.prototype.constructor||Function.prototype).apply(this,arguments);}});});
