sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/lib/MetadataAnalyser","sap/base/Log","sap/suite/ui/generic/template/lib/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,b,L,t,e,c,D,d){"use strict";function g(C,T,o){var s=Object.create(null);var f=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";f.setProperty(o.pathInTemplatePrivateModel,Object.create(null));f.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);f.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var h=T.oServices.oApplication.getBusyHelper().getBusyDelay();var m=C.getOwnerComponent().getModel();var k;var l;var n;function u(){if(l){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var Z in s){var $=s[Z];var _=$.getPath();$.numberOfUpdates++;$.updateStartFunction($.numberOfUpdates);m.read(_+"/$count",{urlParameters:j,filters:$.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:$.updateSuccessFunction.bind(null,$.numberOfUpdates),error:$.errorFunction.bind(null,$.numberOfUpdates)});}}}function r(i,j){var Z="";var $=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||$.length<1){Z="/"+i.name;return Z;}var _=o.smartFilterbar&&o.smartFilterbar.getAnalyticalParameters();if(_&&_.length>0){var a1=o.smartFilterbar&&o.smartFilterbar.getUiState({allFilters:false});var b1=a1?JSON.stringify(a1.getSelectionVariant()):"{}";var c1=new a(b1);var d1=[];$.forEach(function(e1){_.forEach(function(f1){if(f1&&(f1.name===e1)){var g1=f1.name;var h1=c1.getParameter(g1);if(f1.type==='Edm.DateTime'){h1=new Date(h1);h1=D.localToUtc(h1);h1=c(f1.control.getModel().formatValue(h1,f1.type));d1.push(g1+'='+h1);}else{d1.push(g1+'='+"'"+h1+"'");}}});});Z='/'+j.entitySetName+'('+d1.join(',')+')/'+j.navPropertyName;}else{Z="/"+i.name;L.error("SelectionParameters","There are no parameters to resolve");return Z;}return Z;}function G(i){var j;var Z=i.getEntitySet();if(o.smartFilterbar&&o.smartFilterbar.getConsiderAnalyticalParameters&&o.smartFilterbar.getConsiderAnalyticalParameters()){var $=m.getMetaModel();var _=$.getODataEntitySet(Z);var a1=new b(C);var b1=a1.getParametersByEntitySet(Z);j=r(_,b1);return j;}var c1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=c1?c1:"/"+Z;var d1=i.getBindingContext();return d1?d1.getPath()+'/'+j:j;}function q(Z,$){var _=m.getMetaModel();var a1=Z.getEntitySet();var b1=_.getODataEntitySet(a1);var c1=_.getODataEntityType(b1.entityType);var d1=[],e1;var f1=$.variantAnnotationPath;if(f1){var g1=c1[f1];if(!g1){return[];}if(!g1.SelectOptions&&g1.SelectionVariant){g1=g1.SelectionVariant;if(g1.Path){f1=g1.Path.split("@")[1];g1=f1&&c1[f1];}}if(g1.AnnotationPath){e1=g1.AnnotationPath.split("@")[1];g1=c1[e1];}for(var i in g1.SelectOptions){if(g1.SelectOptions[i].PropertyName){var h1=g1.SelectOptions[i].PropertyName.PropertyPath;for(var j in g1.SelectOptions[i].Ranges){var i1=g1.SelectOptions[i].Ranges[j].Option;i1.EnumMember=i1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var j1=g1.SelectOptions[i].Ranges[j].Low;var k1=g1.SelectOptions[i].Ranges[j].High;var l1=Object.keys(j1)[0];if(k1){var m1=Object.keys(k1)[0];d1.push(new F(h1,i1.EnumMember,j1[l1],k1[m1]));}else{d1.push(new F(h1,i1.EnumMember,j1[l1]));}}}}}return d1;}function H(i){for(var j in s){var Z=s[j];if(Z.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var Z=i.filters.slice(0);var $=w();i.filters=A(i.filters,$,j,false);if(l){for(var _ in s){var a1=s[_];v(Z,a1,j);}}}function v(i,j,Z){j.getFiltersForCount=function(){return A(i,j,Z,true);};}function A(i,j,Z,$){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,Z,$);}return i.concat(j.selectionVariantFilters);}function w(){return s[n];}function x(i,n){return I.formatMessageStrip(i,n);}function y(){return n;}function z(n){f.setProperty(P,n||k);}function E(){return I.getContentForIappState(n);}function J(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var Z=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=Z.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function R(i){n=I.getSelectedKeyAndRestoreFromIappState(i);if(s[n]){f.setProperty(P,n);}}function K(){return s[n].templateSortOrder;}function N(i){var j=w();var Z=T.oCommonUtils.isSmartTable(j.smartControl);if(i!==2){j.smartControl[Z?"rebindTable":"rebindChart"]();}if(i>1){if(Z){T.oCommonUtils.refreshModel(j.smartControl);T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function Q(i,j,Z){var $=Array.isArray(j);var _=T.oComponentUtils.isComponentActive();if(($&&j.length===0)||(Z&&d(Z))){return;}I.refreshOperation(i,j,Z,n,$,_,N);}function U(){var i=w();return I.setActiveButtonState(i);}function V(){var i=w();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function W(i,j,Z){if(I.setControlVariant){I.setControlVariant(i,j,Z);}}function X(i,j,Z,$){return T.oCommonUtils.getCustomDataText(i).then(function(_){Z.text=_;$.text=_;return{modelEntry:Z,pathToTheItem:j};});}function Y(i){f.setProperty(i.pathToTheItem,i.modelEntry);}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return l;},"getShowCounts");t.testable(function(){return s[n];},"getCurrentViewMeta");var j=function(a1,g1,h1,i1){if(a1.numberOfUpdates!==h1){return;}var d1=p+"/"+a1.switchingKey;var e1=e({},f.getProperty(d1));if(!e1.state&&g1=="busy"){setTimeout(function(){if(f.getProperty(d1).state==="busy"){e1=e({},f.getProperty(d1));e1.state="busyLong";f.setProperty(d1,e1);}},h);}e1.state=g1;if(!g1){e1.count=i1;}f.setProperty(d1,e1);};var Z=o.switchingControl.getItems();for(var i=0;i<Z.length;i++){var $=Z[i];var _=$.getKey();if(i===0){k=_;}var a1={smartControl:o.smartControl||o.getSmartControl(_),switchingKey:_};var b1=I.getCustomDataHost(a1.smartControl,$);var c1=T.oCommonUtils.getElementCustomData(b1);var d1=p+"/"+a1.switchingKey;var e1=Object.create(null);e1.text=c1.text;e1.count=0;e1.state="";e1.facetId=o.sectionKey;X(b1,d1,e1,a1).then(Y);a1.templateSortOrder=c1.TemplateSortOrder;a1.getPath=G.bind(null,a1.smartControl);a1.selectionVariantFilters=q(a1.smartControl,c1);a1.numberOfUpdates=0;a1.updateStartFunction=j.bind(null,a1,"busy");a1.updateSuccessFunction=j.bind(null,a1,"");a1.errorFunction=j.bind(null,a1,"error");s[_]=a1;}if(I.init){I.init(s,Q,w);}if(o.manifestSettings.showCounts===undefined){l=I.getDefaultShowCounts();}else{l=o.manifestSettings.showCounts;}z();n=f.getProperty(P);var f1=f.bindProperty(P);f1.attachChange(function(g1){var h1=g1.getSource().getValue();if(h1===n){return;}n=h1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(h1);}var i1=o.isDataToBeShown();var j1=I.getRefreshMode(n);if(o.adaptRefreshRequestMode){j1=o.adaptRefreshRequestMode(j1);if(i1&&j1>0){N(j1);}else{var k1=w().smartControl;T.oCommonUtils.setEnabledToolbarButtons(k1);}}o.appStateChange();});})();return{updateCounts:u,refreshOperation:Q,onRebindContentControl:O,formatMessageStrip:x,getSelectedKey:y,setSelectedKey:z,getContentForIappState:E,restoreFromIappState:R,formatItemTextForMultipleView:J,determineSortOrder:K,setActiveButtonState:U,restoreActiveButtonState:V,setControlVariant:W,hasEntitySet:H};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
