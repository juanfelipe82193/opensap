sap.ui.define(["sap/ui/base/Object","sap/m/MessageToast","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/base/util/extend"],function(B,M,a,A,b,c,C,t,e){"use strict";var r=Promise.reject();r.catch(Function.prototype);function g(o,d,s,f,h){function l(O,i,j,P){b.handleError(O,o,s,j,P);return(i||Function.prototype)(j);}var E;function m(i){return new Promise(function(j,k){var H=o.getOwnerComponent();var I=H.getBindingContext();var J=H.getModel();J.read(I.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(R){if(!R.DraftAdministrativeData){if(i){return l(b.operations.editEntity,k,i);}return j({});}if(R.DraftAdministrativeData.InProcessByUser){var U=R.DraftAdministrativeData.InProcessByUserDescription||R.DraftAdministrativeData.InProcessByUser;i=i||new Error(f.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",U]));return l(b.operations.editEntity,k,i,i);}return j({draftAdministrativeData:R.DraftAdministrativeData});},error:l.bind(null,b.operations.editEntity,k)});});}function n(i,U,P){if(P.draftAdministrativeData){return Promise.resolve(P);}return new Promise(function(j,k){s.oTransactionController.editEntity(o.getView().getBindingContext(),!U).then(function(R){if(i){var V=o.getView();var H=V.getBindingContext();var I=function(){H.getModel().invalidateEntry(H);V.detachEvent("modelContextChange",I);};V.attachEvent("modelContextChange",I);}return j({context:R.context});},function(R){if(R&&R.response&&R.response.statusCode==="409"&&i&&!U){b.removeTransientMessages();return m(R).then(j,k);}else{l(b.operations.editEntity,k,R,R);}});});}E=function(U){var i=d.isDraftEnabled();var R;var j=o.getOwnerComponent();var k=j.getBindingContext();if(i&&!U){var H=s.oDraftController.getDraftContext();var P=H.hasPreserveChanges(k);if(!P){R=m().then(n.bind(null,true,true));}}R=R||n(i,U,{});if(i){s.oApplication.editingStarted(k,R);}return R;};function p(U){if(h.isBusy()){return r;}var R=E(U);h.setBusy(R);return R;}function q(i,H,j,k,S){var R=new Promise(function(I,J){var K=function(L){return l(b.operations.deleteEntity,J,L);};if(i&&k){s.oDraftController.getDraftForActiveEntity(j).then(function(L){s.oTransactionController.deleteEntity(L.context).then(function(){if(!S){b.showSuccessMessageIfRequired(f.getText("ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED"),s);}return I();});},K);}else{s.oTransactionController.deleteEntity(j).then(function(){var L=a.getEntitySetFromContext(j);var N=s.oDraftController.getDraftContext();var O=N.isDraftRoot(L);var P=f.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&O){P=f.getText(H?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}if(!S){b.showSuccessMessageIfRequired(P,s);}return I();},K);}});return R;}function u(i,S){var R=new Promise(function(j,k){var H=o.getView().getBindingContext();var I=s.oDraftController.isActiveEntity(H);var J=s.oDraftController.hasActiveEntity(H);var K;if(i){K=Promise.resolve(H);}else if(J&&!I){K=s.oApplication.getDraftSiblingPromise(H);}else{K=Promise.resolve();}K.then(function(L){var N=q(I,J,H,i,S);N.then(j,k);if(!I){var T=function(){return{context:L};};var O=N.then(T);s.oApplication.cancellationStarted(H,O);}},k);});return R;}function v(P){var R=Object.create(null);var H=new Promise(function(I,J){var O=Object.create(null);var K=function(L,i,j){R[L]={resolve:i,reject:j};};for(var k=0;k<P.length;k++){var L=P[k];O[L]=new Promise(K.bind(null,L));}s.oApplication.prepareDeletion(O);s.oTransactionController.deleteEntities(P).then(function(N){var Q=[];var S=sap.ui.getCore().getMessageManager().getMessageModel().getData();for(var i=0;i<S.length;i++){var T=S[i].getTarget();for(var j=0;j<P.length;j++){var U=S[i].getType()||"";if(T.indexOf(P[j])>-1&&(U!=="Information"&&U!=="Success")){Q.push(T);break;}}}return I(Q);},function(i){return J(i);});});H.then(function(j){var k=[];for(var i=0;i<P.length;i++){var I=R[P[i]];if(j.indexOf(P[i])===-1){k.push(P[i]);I.resolve();s.oApplication.markCurrentDraftAsModified();}else{I.reject();}}},Function.prototype);return H;}function w(i,j){if(h.isBusy()){j();return;}var k,H,I,J;var K=s.oTemplateCapabilities.oMessageButtonHelper&&s.oTemplateCapabilities.oMessageButtonHelper.getContextFilter();if(K){k=sap.ui.getCore().getMessageManager();H=function(P){var L=k.getMessageModel();var N=L.bindList("/",null,null,[K]);var O=N.getContexts();return O.map(function(Q){var R=Q.getObject();P(R);return R;});};J=Object.create(null);I=H(function(L){J[L.getId()]=L;});}s.oTransactionController.triggerSubmitChanges().then(function(R){if(k){k.removeMessages(I);}i(R.context);},function(){if(k){var N=[];var L=H(function(O){if(!J[O.getId()]){O.persistent=false;O.technical=false;N.push(O);}});if(N.length){k.removeMessages(L);k.addMessages(N);s.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}}j();});}function x(){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(w.bind(null,i,j));});h.setBusy(R);return R;}function y(S){if(h.isBusy()){return r;}var R=new Promise(function(i,j){var k=o.getView().getBindingContext();var W=false;var H=function(){W=true;var I=function(){var J=s.oDraftController.activateDraftEntity(k,true);s.oApplication.activationStarted(k,J);J.then(function(K){i(K);},function(K){b.handleError(b.operations.activateDraftEntity,o,s,K,null);j();});h.setBusy(J);};S.handleSaveScenario(4,I,j);};s.oApplication.getDraftSiblingPromise(k).then(function(I){if(I){o.getOwnerComponent().getModel().invalidateEntry(I);}var J=s.oDraftController.activateDraftEntity(k,false);h.setBusy(J);s.oApplication.activationStarted(k,J);J.then(function(K){i(K);},function(K){b.handleError(b.operations.activateDraftEntity,o,s,K,null,{"412":H});if(!W){j();}});});});return R;}function z(P){return new A(P);}function D(P,S,R,j){if(h.isBusy()){j();return;}var k=P.functionImportPath;var H=P.contexts;var I=P.sourceControl;var J=P.label;var O=P.operationGrouping;var K=z({controller:o,contexts:H,applicationController:s.oApplicationController,operationGrouping:O});var L=function(W,X){if(W.pages){for(var i in W.pages){var Y=W.pages[i];if(Y.component.list!=true&&Y.entitySet===X){return true;}else{var Z=L(Y,X);if(Z){return true;}}}}return false;};var N=function(i,W){var X=i.getAppComponent().getConfig();if(W&&W.sPath){var Y=W.sPath.split("(")[0].replace("/","");return L(X.pages[0],Y);}return false;};var Q=function(i){var W,X,Y,Z;if(Array.isArray(i)&&i.length===1){W=i[0];}else{W={response:{context:i.context}};}X=W.response&&W.response.context;var $;if(X&&X.getObject()){$=d.registerContext(X);}Y=o.getOwnerComponent();Z=N(Y,X);if(Z&&X&&X!==W.actionContext&&X.getPath()!=="/undefined"){if(I){f.navigateFromListItem(X);}else{s.oApplication.navigateToSubContext(X,false,$.bIsDraft?2*(1+$.bIsCreate):1,$);}}if(i.length>0){var _=f.getTableBindingInfo(I);var a1=_&&_.binding;if(a1&&a1.oEntityType){f.setEnabledToolbarButtons(I);if(d.isListReportTemplate()){f.setEnabledFooterButtons(I);}}}R(i);};var T=function(){if(H&&H[0]){var i=H[0].oModel;if(i&&i.hasPendingChanges()){i.resetChanges();}}};var U=function(i){T();j(i);};var V=function(i){if(Array.isArray(i)){if(i.length===1){i=i[0].error;}else{i=null;}}var W={context:H};T();l(b.operations.callAction,null,i,W);j(i);};K.call(k,J,d.isDraftEnabled()).then(function(i){var W={};W.actionLabel=J;h.setBusy(i.executionPromise,null,W);i.executionPromise.then(Q,V);},U);}function F(P,S){var R=new Promise(function(i,j){s.oApplication.performAfterSideEffectExecution(D.bind(null,P,S,i,j));});return R;}function G(T,P){if(!T){throw new Error("Unknown Table");}var i="";var j="";var k;var H=o.getOwnerComponent();if(H.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){k=(H.getCreationEntitySet&&H.getCreationEntitySet())||(T.getEntitySet&&T.getEntitySet());}else{k=(H.getCreationEntitySet&&H.getCreationEntitySet())||H.getEntitySet();}var I,J,N,K;var V=o.getView();var L=V.getModel();var O=V.getBindingContext();if(O){j=f.getTableBindingInfo(T).path;K=L.getMetaModel();J=K.getODataEntitySet(k);I=K.getODataEntityType(J.entityType);N=K.getODataAssociationSetEnd(I,j);if(N){k=N.entitySet;}j="/"+j;i=H.getComponentContainer().getElementBinding().getPath()+j;}else{i="/"+k;}var Q=C.create(s.oDraftController,k,i,L,s.oApplication,P);s.oApplication.getBusyHelper().setBusy(Q);return Q.then(function(R){s.oApplication.markCurrentDraftAsModified();return{newContext:R,tableBindingPath:j};},l.bind(null,b.operations.addEntry,function(R){throw R;}));}var l=t.testable(l,"handleError");var z=t.testable(z,"getActionUtil");return{editEntity:p,deleteEntity:u,deleteEntities:v,saveEntity:x,activateDraftEntity:y,callAction:F,addEntry:G};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,d,s,f,h){e(this,g(o,d,s,f,h));}});});
