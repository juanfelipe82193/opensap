sap.ui.define(["sap/base/Log","sap/ui/core/routing/HashChanger","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/suite/ui/generic/template/extensionAPI/NavigationController","sap/suite/ui/generic/template/lib/MessageButtonHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/detailTemplates/DiscardEditHandler","sap/suite/ui/generic/template/detailTemplates/PaginatorButtonsHelper","sap/suite/ui/generic/template/ObjectPage/extensionAPI/DraftTransactionController","sap/suite/ui/generic/template/ObjectPage/extensionAPI/NonDraftTransactionController","sap/m/DraftIndicator"],function(L,H,F,a,N,M,t,D,P,b,c){"use strict";var d=sap.m.DraftIndicatorState;var p=new F({path:"persistent",operator:a.EQ,value1:false});function g(C,o,v){function i(){var T=o.getTemplatePrivateModel();T.setProperty("/objectPage",{displayMode:0,headerInfo:{objectTitle:"",objectSubtitle:""}});o.setStatePreserverPromise(v);}function f(B,I){if(!o.isDraftEnabled()){var U=C.getModel("ui");var T=o.getTemplatePrivateModel();var s=o.getNonDraftCreateBindingPath();var m=!!s;U.setProperty("/createMode",m);if(s||o.getEditableNDC()){U.setProperty("/editable",true);T.setProperty("/objectPage/displayMode",m?4:2);if(m){B=s;}}else{U.setProperty("/editable",false);T.setProperty("/objectPage/displayMode",1);}}(v.onComponentActivate||Function.prototype)(B,I);}function u(){var B=C.getBindingContext();var m=o.registerContext(B);var T=C.getModel("_templPrivGlobal");T.setProperty("/generic/draftIndicatorState",d.Clear);(v.applyHeaderContextToSmartTablesDynamicColumnHide||Function.prototype)(B);var U=C.getModel("ui");var I;var q=o.getTemplatePrivateModel();if(m.bIsDraft){I=true;U.setProperty("/enabled",true);q.setProperty("/objectPage/displayMode",m.bIsCreate?4:2);}else{I=o.getEditableNDC();q.setProperty("/objectPage/displayMode",I?2:1);U.setProperty("/enabled",true);}U.setProperty("/createMode",m.bIsCreate);U.setProperty("/editable",I);}function h(){return o.getDraftRootPath();}function n(){v.navigateUp();}function j(s,A){return v.oStatePreserverPromise.then(function(S){return S.getUrlParameterInfo(s,A);});}function k(O){return v.getMessageFilters(O);}function l(m){return v.getScrollFunction&&v.getScrollFunction(m);}return{init:i,onActivate:f,getTitle:o.getTitleFromTreeNode,updateBindingContext:u,currentDraftModified:h,navigateUp:n,getUrlParameterInfo:j,getMessageFilters:k,getScrollFunction:l};}function e(v,T,C){var o;var f;var h;function G(){return h||H.getInstance();}function s(i){var I=!T.oComponentUtils.isDraftEnabled();if(I||!i){var U=C.getView().getModel("ui");U.setProperty("/editable",i);}if(I){T.oComponentUtils.setEditableNDC(i);}}function O(){T.oServices.oApplication.onBackButtonPressed();}function A(){var E=T.oServices.oApplication.getLinksToUpperLayers();var V=T.oComponentUtils.getViewLevel();var I;if(T.oComponentUtils.isDraftEnabled()){var J=T.oComponentUtils.getTemplatePrivateModel();I=J.getProperty("/objectPage/displayMode");}else{I=1;}v.navigateUp=E[V-1].navigate.bind(null,I);var K=v.aBreadCrumbs;var Q=K?K.length:0;for(var i=0;i<Q;i++){var R=K[i];var S=E[i+1];S.adaptBreadCrumbLink(R);var U=T.oCommonUtils.getControlInformation(R,function(W){});U.navigate=S.navigate.bind(null,I);}}function j(i){var E=i.getBindingContext();var I=G().getHash();return T.oServices.oApplicationController.propertyChanged(I,E);}function n(){v.navigateUp();}function k(i){var E=T.oServices.oApplication.getBusyHelper();var U=C.getView().getModel("ui");var I=C.getOwnerComponent().getModel("_templPrivGlobal");var J=j(i).then(function(R){if(!o.fclInfo.isContainedInFCL||I.getProperty("/generic/FCL/isVisuallyFullScreen")){n();}},function(){E.getUnbusy().then(function(R){if(!o.fclInfo.isContainedInFCL||I.getProperty("/generic/FCL/isVisuallyFullScreen")){T.oCommonUtils.processDataLossTechnicalErrorConfirmation(function(){n();U.setProperty("/enabled",true);},Function.prototype,o.state);}else{T.oCommonUtils.processDataLossTechnicalErrorConfirmation(Function.prototype,Function.prototype,o.state,"StayOnPage");}});});E.setBusy(J);}function l(E){var i=E.getSource();o.state.saveScenarioHandler.handleSaveScenario(2,k.bind(null,i));}var m;function q(i){m=m||new D(C,T,v,o.state);return m.discardEdit(i);}function r(){o.state.messageButtonHelper.toggleMessagePopover();}function u(i){return o.state.messageButtonHelper&&o.state.messageButtonHelper.getMessageFilters(i);}function w(){var i;return function(){i=i||new N(T,C,o.state);return i;};}function x(){var i;return function(){if(!i){var E=T.oComponentUtils.isDraftEnabled()?b:c;i=new E(T,C,o.state);}return i;};}function y(){f.handleShowNextObject();}function z(){f.handleShowPrevObject();}var G=t.testable(G,"getHashChangerInstance");var A=t.testable(A,"adaptLinksToUpperLevels");o={onInit:function(R,i,E,I){if(!R||R.footerBar){var J=T.oComponentUtils.isODataBased();var K={controller:C,prepareAllMessagesForNavigation:i,messageSorter:E,getGroupTitle:I};o.state.messageButtonHelper=new M(T,K,J);if(!T.oComponentUtils.isDraftEnabled()){var U=C.getOwnerComponent().getModel("ui");var Q=U.bindProperty("/editable");var S=sap.ui.getCore().getMessageManager();var V=S.getMessageModel();Q.attachChange(function(){if(!Q.getValue()){var W=o.state.messageButtonHelper.getContextFilter();var X=V.bindList("/",null,null,[W,p]);var Y=X.getContexts();var Z=Y.map(function($){return $.getObject();});S.removeMessages(Z);}});}o.state.saveScenarioHandler=T.oServices.oApplication.getSaveScenarioHandler(C,T.oCommonUtils);T.oServices.oTemplateCapabilities.oMessageButtonHelper=o.state.messageButtonHelper;o.state.onCancel=q;}if(!R||R.paginatorButtons){f=new P(o,C,T);}v.getScrollFunction=function(W){var X=T.oCommonUtils.getPositionableControlId(W);return X&&T.oCommonUtils.focusControl.bind(null,X);};},handlers:{handleShowNextObject:y,handleShowPrevObject:z,onShowMessages:r,applyAndUp:l,onSave:function(){L.error("Save for this floorplan not implemented yet");},onBack:O},extensionAPI:{getNavigationControllerFunction:w,getTransactionControllerFunction:x},fclInfo:{isContainedInFCL:false},state:{},onComponentActivate:function(i,I){if(o.state.messageButtonHelper){o.state.messageButtonHelper.adaptToContext(i);}A();if(f){f.computeAndSetVisibleParamsForNavigationBtns();}v.oStatePreserverPromise.then(function(S){S.applyAppState(i,I);});}};v.navigateUp=n;v.setEditable=s;v.getMessageFilters=u;var B=T.oComponentUtils.getFclProxy();if(B.oActionButtonHandlers){o.handlers.fclActionButtonHandlers=B.oActionButtonHandlers;o.fclInfo.isContainedInFCL=true;}o.stateChanged=function(){v.oStatePreserverPromise.then(function(S){S.stateChanged();});};return o;}return{getComponentBase:g,getControllerBase:e};});
