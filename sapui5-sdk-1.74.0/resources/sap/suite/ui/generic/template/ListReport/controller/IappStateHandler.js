sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/base/Log","sap/base/util/deepEqual","sap/base/util/extend"],function(B,C,N,S,U,L,d,e){"use strict";var a="sap.suite.ui.generic.template.customData",b="sap.suite.ui.generic.template.extensionData",c="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var i=L.getLevel();if(i<L.Level.INFO){L.setLevel(L.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var h="";for(var k in D){s=s+h+k+": "+D[k];h="; ";}}L.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,o,t){var h=t.oCommonUtils.getNavigationHandler();var j=o.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var k=false;var m=null;var A=Promise.resolve();var D=false;var p=false;var E=o.byId("editStateFilter");var q;var u=null;var v=null;s.oSmartFilterbar.setSuppressSelection(true);var w=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function x(){return D;}function y(){var j1={};var k1=[];var l1=w();for(var i=0;i<l1.length;i++){var m1=l1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(m1)){k1.push(m1);}}var n1={suppressDataSelection:!D,visibleCustomFields:k1};j1[c]=n1;if(E){n1.editStateFilter=E.getSelectedKey();var o1=t.oComponentUtils.getTemplatePrivateModel();var p1=o1.getProperty("/listReport/activeObjectEnabled");n1.activeStateFilter=p1;}var q1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(q1){var r1=s.oMultipleViewsHandler.getContentForIappState();if(r1){n1[q1]=r1.state;}}if(s.oWorklistData.bWorkListEnabled){var s1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var t1={"searchString":s1};n1.Worklist=t1;}var u1={};j1[a]=u1;o.getCustomAppStateDataExtension(u1);var v1;var w1=true;var x1=function(y1,z1){if(!(y1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!w1){throw new Error("State must always be provided synchronously");}if(z1){v1=v1||Object.create(null);var A1=y1.getMetadata().getNamespace();v1[A1]=z1;}};o.templateBaseExtension.provideExtensionAppStateData(x1);w1=false;if(v1){j1[b]=v1;}return j1;}function z(){var j1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var k1=new S(j1);var l1=o.getVisibleSelectionsWithDefaults();for(var i=0;i<l1.length;i++){if(!k1.getValue(l1[i])){k1.addSelectOption(l1[i],"I","EQ","");}}if(o.byId('template::PageVariant')&&o.byId('template::PageVariant').currentVariantGetModified()&&k1.getID()){k1.setID("");}if(s.oWorklistData.bWorkListEnabled){var m1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";k1.addSelectOption("Worklist.SearchField","I","EQ",m1);}var n1={selectionVariant:k1.toJSONString(),tableVariantId:(!j&&s.oSmartTable.getCurrentVariantId())||"",customData:y()};return n1;}function F(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:p,bDataAreShownInTable:D});if(!p){return;}p=false;try{u=h.storeInnerAppStateWithImmediateReturn(z(),true);}catch(i){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(u instanceof N){p=true;u=null;return;}u.promise.fail(function(j1){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+j1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:u.appStateKey,sAppStateKeyInUrl:v});if(v===u.appStateKey){u=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:u.appStateKey});h.replaceHash(u.appStateKey);}}function R(j1,k1){var l1=t.oComponentUtils.getTemplatePrivateModel();if(j1&&j1.editStateFilter!==undefined){if(E){E.setSelectedKey((j1.editStateFilter===null)?0:j1.editStateFilter);l1.setProperty("/listReport/vDraftState",(j1.editStateFilter===null)?0:j1.editStateFilter);}l1.setProperty("/listReport/activeObjectEnabled",!!j1.activeStateFilter);s.oMultipleViewsHandler.restoreActiveButtonState(j1);}var m1=j1&&j1.visibleCustomFields;if(m1&&m1.length>0){var n1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<n1.length;i++){var o1=n1[i];var p1=o1.getName();if(m1.indexOf(p1)!==-1){o1.setVisibleInFilterBar(true);}}}D=k1&&!(j1&&j1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();c1(D);}}function G(i,j){if(j){var j1=i['sap-ui-fe-variant-id'];if(j1&&j1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(j1[0]);}}else{var k1=i['sap-ui-fe-variant-id'],l1=i['sap-ui-fe-filterbar-variant-id'],m1=i['sap-ui-fe-chart-variant-id'],n1=i['sap-ui-fe-table-variant-id'];H(l1&&l1[0],m1&&m1[0],n1&&n1[0],k1&&k1[0]);}}function H(i,j1,k1,l1){if(i||l1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||l1);}if(s.oSmartTable&&(k1||l1)){s.oSmartTable.attachAfterVariantInitialise(function(m1){s.oSmartTable.setCurrentVariantId(k1||l1);});s.oSmartTable.setCurrentVariantId(k1||l1);}s.oMultipleViewsHandler.setControlVariant(j1,k1,l1);}function J(i){o.restoreCustomAppStateDataExtension(i||{});}function K(i){if(!i){return;}var j1=true;var k1=function(l1){if(!(l1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var m1=l1.getMetadata().getNamespace();if(!j1){throw new Error("State must always be restored synchronously");}return i[m1];};o.templateBaseExtension.restoreExtensionAppStateData(k1);j1=false;}function M(i,j1){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(c)){K(i[b]);J(i[a]);R(i[c],j1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}J(i);}s.oSmartFilterbar.fireFilterChange();}function O(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":r.appStateKey};}return{};});}function P(i){var j1=t.oComponentUtils.getTemplatePrivateModel();j1.setProperty("/generic/bDataAreShownInTable",i);}function Q(i,j1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:j1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:k,bAppStateDirty:p});P(j1);if(k){return;}if(i||j1!==D){D=j1;if(!p){p=true;if(!s.oSmartFilterbar.isDialogOpen()){if(m){F();}else{setTimeout(F,0);}}}}}function T(i){var j1=s.oSmartFilterbar.determineMandatoryFilterItems(),k1;for(var l1=0;l1<j1.length;l1++){if(j1[l1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){k1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(k1){i.oSelectionVariant.addParameter("P_DisplayCurrency",k1);}}break;}}}function V(i,j1,k1){l("fnAdaptToAppState called",{sNavType:k1,sAppStateKeyInUrl:v,sAppStateKey:i.appStateKey,storingInformationAppStateKey:u&&u.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=k1;var l1=i.appStateKey||"";if(k){return;}if(v===null){v=l1;}else if(l1!==v){return;}var m1=(!l1&&j1)||{};G(m1,j);k=true;var n1=i.selectionVariant||"";var o1=(!j&&i.tableVariantId)||"";var p1=i.oSelectionVariant||"";var q1={selectionVariant:p1,urlParameters:j1,selectedQuickVariantSelectionKey:""};var r1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var s1=JSON.parse(JSON.stringify(r1));var t1=r1.getSelectOption(a);var u1=r1.getSelectOption(c);if((r.appStateKey!==l1||r.selectionVariant!==n1||r.tableVariantId!==o1||f(r.urlParams,m1))&&k1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!u||u.appStateKey!==l1){var v1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){T(i);}if(!s.oWorklistData.bWorkListEnabled){if(!v1||s.oSmartFilterbar.isCurrentVariantStandard()){q1.selectionVariant=i.oSelectionVariant;if(k1!==sap.ui.generic.app.navigation.service.NavType.iAppState){o.modifyStartupExtension(q1);i1(q1.selectionVariant,r,n1,true);}else{i1(q1.selectionVariant,r,n1,!v1);}}else{e1(r1,t1,u1,true);q1.selectionVariant=r1;o.modifyStartupExtension(q1);e1(q1.selectionVariant,t1,u1,false);if(!d(JSON.parse(JSON.stringify(q1.selectionVariant)),s1)){i1(q1.selectionVariant,r,n1,true);}}}if(o1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(o1);}i.customData=i.customData||{};var w1=s.oMultipleViewsHandler.getSelectedKeyPropertyName();if(w1&&i.customData[c]&&i.customData[c][w1]){s.oMultipleViewsHandler.restoreFromIappState(i.customData[c][w1]);}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[c]&&i.customData[c]["Worklist"]?i.customData[c]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}M(i.customData,true);}r={appStateKey:l1,urlParams:m1,selectionVariant:n1,tableVariantId:o1};}if(k1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(k1===sap.ui.generic.app.navigation.service.NavType.initial){e1(r1,t1,u1,true);q1.selectionVariant=r1;o.modifyStartupExtension(q1);e1(q1.selectionVariant,t1,u1,false);if(!d(JSON.parse(JSON.stringify(q1.selectionVariant)),s1)){i1(q1.selectionVariant,r,n1,true);}}s.oMultipleViewsHandler.handleStartUpObject(q1);}if(m){m();m=null;}if(s.oWorklistData.bWorkListEnabled){if(k1==="initial"&&s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}else if(k1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var x1=(k1===sap.ui.generic.app.navigation.service.NavType.xAppState||k1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;D=x1||s.bLoadListAndFirstEntryOnStartup||q||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();P(D);if(D){s.oSmartFilterbar.search();c1(D);}}u=null;k=false;}function W(){if(!m){A=new Promise(function(j1){m=j1;});}var i=new Promise(function(j1,k1){var l1=v;var m1=h.parseNavigation();m1.done(function(n1,o1,p1){V(n1,o1,p1);j1();});m1.fail(function(n1,o1,p1){L.warning(n1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");V({appStateKey:l1},o1,sap.ui.generic.app.navigation.service.NavType.initial);j1();});});return i;}function X(){var i=s.oSmartFilterbar.getFilterData();var j1,k1=s.oSmartFilterbar.getBasicSearchControl();if(k1&&k1.getValue){j1=k1.getValue();}var l1=z();i._CUSTOM=l1.customData;s.oSmartFilterbar.setFilterData(i,true);if(j1){k1.setValue(j1);}s.oSmartFilterbar.fireFilterChange();}function Y(){Q(true,D);}function Z(i){var j1=i.getParameter("context");var k1=s.oSmartFilterbar.getFilterData();if(k1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var l1=k1._CUSTOM[c]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(l1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{M(k1._CUSTOM);}}else{var m1=y();n(m1[a]);n(m1[c]);M(m1);}if(I.indexOf(j1)<0){D=i.getParameter("executeOnSelect");Q(true,D);}}function $(){if(!j){Q(true,D);}}function _(){if(!j){Q(true,D);}}function a1(i){v=i["sap-iapp-state"]||"";if(u){if(u.appStateKey!==v){L.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+v+" expected "+u.appStateKey);return false;}W();return true;}return false;}function b1(){q=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(F);}function c1(D){var i=o.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}function d1(i,j1,k1){var l1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(l1,{replace:j1,strictMode:k1});}function e1(i,j1,k1,l1){if(i&&(j1||k1)){if(l1){i.removeSelectOption(a);i.removeSelectOption(c);}else{i.massAddSelectOption(a,j1);i.massAddSelectOption(c,k1);}}}function f1(j1,r,k1){if(j1&&(r.selectionVariant!==k1||s.sNavType==="initial")){var l1=j1.getParameterNames().concat(j1.getSelectOptionsPropertyNames());for(var i=0;i<l1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(l1[i]);}}}function g1(i,j1,k1){if(i.getParameter(j1)&&!i.getParameter(k1)){i.addParameter(k1,i.getParameter(j1));}if(i.getSelectOption(j1)&&!i.getSelectOption(k1)){var l1=i.getSelectOption(j1);l1.forEach(function(m1){i.addSelectOption(k1,m1.Sign,m1.Option,m1.Low,m1.High);});}}function h1(i){var j1=o.getOwnerComponent().getModel().getMetaModel();var k1=o.getOwnerComponent().getEntitySet();var l1=j1.getODataEntityType(j1.getODataEntitySet(k1).entityType);l1.property.forEach(function(m1){if(m1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var n1=m1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var o1=m1.name;g1(i,n1,o1);g1(i,o1,n1);}});}function i1(i,r,j1,k1){h1(i);f1(i,r,j1);d1(i.toJSONObject(),k1,false);}s.getCurrentAppState=z;return{areDataShownInTable:x,parseUrlAndApplyAppState:W,getUrlParameterInfo:O,changeIappState:Q,onSmartFilterBarInitialise:b1,onBeforeSFBVariantFetch:X,onAfterSFBVariantSave:Y,onAfterSFBVariantLoad:Z,onAfterTableVariantSave:$,onAfterApplyTableVariant:_,isStateChange:a1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,o,t){e(this,g(s,o,t));}});});
